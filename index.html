<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== 보고서 인쇄를 위한 CSS 추가 (print-only는 사용하지 않음) ========== */
    .print-only { display: none; } /* 기존 코드에서 남아있는 print-only는 display:none; 상태 유지 */
    @media print {
      /* 앱의 기본 배경과 테두리를 숨겨 인쇄 영역을 깔끔하게 만듭니다. */
      .print-container, #main-app-container { /* 인쇄 문제 해결: 메인 컨테이너 강제 표시 */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* 인쇄 시 숨겨야 할 요소 (버튼, 메뉴 등) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* 인쇄 시 상세 보고서 내용만 표시를 위해 report-page와 detail-view를 강제 표시 */
      #report-page, #report-detail-view { /* 인쇄 문제 해결: 보고서 관련 요소 강제 표시 및 정리 */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      /* [수정] 보고서 상세 내용이 인쇄 시 표시되지 않는 문제 수정 */
      #report-detail-content, #report-rtu-list, #report-inspection-list, #report-repair-list, #report-detail-viewer {
          display: block !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* 상태 태그의 배경색은 인쇄 시 제거 */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* 인쇄 시 잘 보이도록 테두리 추가 */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">보고서 현황 및 인쇄</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="reportRtuSummary" class="p-5 rounded-xl shadow-lg border border-blue-200 cursor-pointer bg-blue-50 hover:bg-blue-100 transition duration-150">
              <p class="text-sm font-medium text-blue-600">RTU 등록 총 기록건수</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div id="reportInspectionSummary" class="p-5 rounded-xl shadow-lg border border-green-200 cursor-pointer bg-green-50 hover:bg-green-100 transition duration-150">
              <p class="text-sm font-medium text-green-600">점검 기록 총 기록건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div id="reportRepairSummary" class="p-5 rounded-xl shadow-lg border border-red-200 cursor-pointer bg-red-50 hover:bg-red-100 transition duration-150">
              <p class="text-sm font-medium text-red-600">수리 기록 총 기록건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>

          <div id="report-detail-view" class="hidden mt-8 p-6 bg-white rounded-xl shadow-lg border">
            <div class="flex justify-between items-center mb-6 print-hidden">
              <h3 id="report-detail-title" class="text-xl font-bold text-gray-800">상세 보고서 - RTU 등록 목록</h3>
              <button id="report-print-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"/>
                </svg>
                보고서 인쇄
              </button>
            </div>
            
            <div id="report-detail-content">
              <p class="text-gray-500">데이터를 로딩 중이거나 선택된 보고서가 없습니다.</p>
            </div>

            <div id="report-rtu-list" class="hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID/등록번호</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">지역/장소</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">모델명</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">용량</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">종류</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">설치일</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">고압설정</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">저압설정</th>
                  </tr>
                </thead>
                <tbody id="report-rtu-list-body" class="bg-white divide-y divide-gray-200">
                  </tbody>
              </table>
            </div>

            <div id="report-inspection-list" class="hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RTU ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">점검일</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">점검자</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">고압(HP)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">저압(LP)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">전류(A)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">과열도(F)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">과냉도(F)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">결과</th>
                  </tr>
                </thead>
                <tbody id="report-inspection-list-body" class="bg-white divide-y divide-gray-200">
                  </tbody>
              </table>
            </div>

            <div id="report-repair-list" class="hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RTU ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">수리일</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담당자</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">문제/조치 내용 요약</th>
                  </tr>
                </thead>
                <tbody id="report-repair-list-body" class="bg-white divide-y divide-gray-200">
                  </tbody>
              </table>
            </div>

            <pre id="report-detail-viewer" class="text-sm whitespace-pre-wrap p-4 bg-gray-50 border rounded-lg hidden"></pre>

          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="image-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-bg transition-opacity duration-300">
    <div class="relative max-w-4xl max-h-[90vh] mx-auto p-4 bg-white rounded-lg shadow-2xl">
      <button id="close-modal" class="absolute top-2 right-2 text-white bg-gray-800 rounded-full p-2 hover:bg-gray-600 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <img id="modal-image" src="" alt="Full size image" class="max-w-full max-h-[85vh] object-contain">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase 설정은 여기에 있습니다. (주석 처리 또는 실제 키로 대체)
    const firebaseConfig = {
      // apiKey: "YOUR_API_KEY",
      // authDomain: "YOUR_AUTH_DOMAIN",
      // projectId: "YOUR_PROJECT_ID",
      // storageBucket: "YOUR_STORAGE_BUCKET",
      // messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      // appId: "YOUR_APP_ID"
    };

    let app;
    let db;
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    // [중요] Firebase 설정 유효성 검사
    const isFirebaseConfigValid = firebaseConfig.apiKey && firebaseConfig.projectId;

    if (isFirebaseConfigValid) {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase App initialized successfully.");
      } catch (error) {
        console.error("Firebase initialization failed:", error);
      }
    } else {
      console.warn("Firebase configuration is missing or incomplete. Data will be handled locally (in-memory).");
      // 로컬 스토리지를 사용하여 데이터 유지 (선택 사항, 여기서는 단순 인메모리 사용)
      loadLocalData();
    }

    // ==================== DOM 요소 정의 ====================
    const elements = {
      // Tabs
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      
      // Dashboard
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      
      // RTU Manage
      rtuForm: document.getElementById('rtu-form'),
      rtuList: document.getElementById('rtu-list'),
      rtuCount: document.getElementById('rtu-count'),
      rtuPagination: document.getElementById('rtu-pagination'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdContainer: document.getElementById('rtu-id-container'),
      rtuNameInput: document.getElementById('rtu-name'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),
      rtuImage1: document.getElementById('rtu-image1'),
      rtuImage2: document.getElementById('rtu-image2'),
      rtuImage3: document.getElementById('rtu-image3'),
      
      // Inspection Manage
      inspectionForm: document.getElementById('inspection-form'),
      inspectionRtuId: document.getElementById('inspection-rtu-id'),
      inspectionList: document.getElementById('inspection-list'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionPagination: document.getElementById('inspection-pagination'),
      
      // Repair Manage
      repairForm: document.getElementById('repair-form'),
      repairRtuId: document.getElementById('repair-rtu-id'),
      repairList: document.getElementById('repair-list'),
      repairCount: document.getElementById('repair-count'),
      repairPagination: document.getElementById('repair-pagination'),

      // CSV & Download
      csvUpload: document.getElementById('csv-upload'),
      downloadDataBtn: document.getElementById('download-data-btn'),

      // Report Page
      reportRtuSummary: document.getElementById('reportRtuSummary'),
      reportInspectionSummary: document.getElementById('reportInspectionSummary'),
      reportRepairSummary: document.getElementById('reportRepairSummary'),
      reportDetailView: document.getElementById('report-detail-view'),
      reportDetailTitle: document.getElementById('report-detail-title'),
      reportDetailContent: document.getElementById('report-detail-content'),
      reportPrintBtn: document.getElementById('report-print-btn'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair'),
      
      // Report Lists (The full lists shown inside the report view)
      reportRtuList: document.getElementById('report-rtu-list'),
      reportInspectionList: document.getElementById('report-inspection-list'),
      reportRepairList: document.getElementById('report-repair-list'),
      reportRtuListBody: document.getElementById('report-rtu-list-body'),
      reportInspectionListBody: document.getElementById('report-inspection-list-body'),
      reportRepairListBody: document.getElementById('report-repair-list-body'),

      // Single Report Detail Viewer
      reportDetailViewer: document.getElementById('report-detail-viewer'),

      // Image Modal
      imageModal: document.getElementById('image-modal'),
      modalImage: document.getElementById('modal-image'),
      closeModal: document.getElementById('close-modal'),
    };

    // ==================== 상수 및 상태 변수 ====================
    const ITEMS_PER_PAGE = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;
    let rtuMode = 'new'; // 'new' or 'modify'


    // ==================== 헬퍼 함수 ====================

    // 탭 전환
    function switchTab(targetTabId) {
      elements.tabPages.forEach(page => {
        page.classList.add('hidden');
      });
      elements.tabBtns.forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.remove('border-blue-500', 'text-blue-600', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      });

      document.getElementById(targetTabId).classList.remove('hidden');
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${targetTabId}"]`);
      if (activeBtn) {
        activeBtn.classList.add('tab-active');
        activeBtn.classList.add('border-blue-500', 'text-blue-600', 'font-semibold');
        activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      }

      // 보고서 탭이 아닐 경우 상세 뷰 숨기기
      if (targetTabId !== 'report-page') {
        elements.reportDetailView.classList.add('hidden');
      }

      // 탭 전환 시 대시보드 업데이트
      if (targetTabId === 'dashboard') {
        updateDashboard();
      }
    }
    
    // 상태에 따른 TailwindCSS 클래스 반환
    function getStatusColor(status) {
      switch (status) {
        case '작동중':
        case '정상':
        case '양호':
        case '완료':
          return 'bg-green-100 text-green-800';
        case '주의':
        case '정지됨':
          return 'bg-yellow-100 text-yellow-800';
        case '점검필요':
        case '요청':
        case '불량':
          return 'bg-red-100 text-red-800';
        case '진행중':
          return 'bg-indigo-100 text-indigo-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    // 날짜 포맷팅
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
      } catch (e) {
        return dateString;
      }
    }

    // 고유 ID 생성 (UUID v4 유사)
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ==================== 데이터 관리 (Firebase/Local) ====================

    // Firebase에서 데이터 불러오기
    async function loadFromFirebase() {
      if (!isFirebaseConfigValid) {
        loadLocalData();
        return;
      }
      try {
        const rtuSnapshot = await getDocs(collection(db, "rtuList"));
        rtuList = rtuSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const inspectionSnapshot = await getDocs(collection(db, "inspectionList"));
        inspectionList = inspectionSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const repairSnapshot = await getDocs(collection(db, "repairList"));
        repairList = repairSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        console.log("Data loaded from Firebase.");
      } catch (error) {
        console.error("Error loading data from Firebase:", error);
      }
    }

    // 로컬 데이터 로드 (Firebase 미사용 시 초기화)
    function loadLocalData() {
        // 인메모리 리스트 초기화는 전역 변수에서 이미 처리됨
        // rtuList, inspectionList, repairList 에 더미 데이터 등을 넣을 수 있음
        console.log("Local (in-memory) data context initialized.");
    }

    // RTU 저장 (신규/수정)
    async function saveRtu(rtuData, isNew) {
      if (!isFirebaseConfigValid) {
        // 로컬 저장 로직 (여기서는 인메모리 리스트 직접 수정)
        if (isNew) {
          rtuList.push(rtuData);
        } else {
          const index = rtuList.findIndex(r => r.id === rtuData.id);
          if (index !== -1) {
            rtuList[index] = rtuData;
          }
        }
        renderRtuList(rtuCurrentPage);
        populateRtuSelects();
        updateDashboard();
        return;
      }

      try {
        // Firestore 저장 로직
        const id = rtuData.id;
        delete rtuData.id; // setDoc에 ID를 문서 이름으로 사용

        await setDoc(doc(db, "rtuList", id), rtuData, { merge: true });

        // 로컬 리스트 업데이트
        const existingIndex = rtuList.findIndex(r => r.id === id);
        if (existingIndex > -1) {
            rtuList[existingIndex] = { id: id, ...rtuData };
        } else {
            rtuList.push({ id: id, ...rtuData });
        }

        renderRtuList(rtuCurrentPage);
        populateRtuSelects();
        updateDashboard();
        alert(isNew ? 'RTU 장비가 성공적으로 등록되었습니다.' : 'RTU 장비 정보가 성공적으로 수정되었습니다.');
        
        // 폼 초기화 및 신규 모드로 전환
        elements.rtuForm.reset();
        elements.rtuIdForModification.value = '';
        elements.rtuNameInput.disabled = false;
        elements.rtuNameInput.classList.remove('bg-gray-100');
        elements.rtuModifySelect.classList.add('hidden');
        elements.rtuNameInput.classList.remove('hidden');
        elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
        elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
        elements.imagePreviewContainer.classList.add('hidden');
        rtuMode = 'new';


      } catch (e) {
        console.error("Error adding/updating document: ", e);
        alert('데이터 저장 중 오류가 발생했습니다: ' + e.message);
      }
    }

    // 점검 기록 저장
    async function saveInspection(inspectionData) {
      if (!isFirebaseConfigValid) {
        // 로컬 저장 로직
        inspectionList.push(inspectionData);
        renderInspectionList(inspectionCurrentPage);
        updateDashboard();
        return;
      }
      
      try {
        const docRef = doc(collection(db, "inspectionList"));
        inspectionData.rtuName = rtuList.find(r => r.id === inspectionData.rtuId)?.name || inspectionData.rtuId;
        await setDoc(docRef, inspectionData);

        // 로컬 리스트 업데이트
        inspectionList.push({ id: docRef.id, ...inspectionData });
        
        // RTU 상태 업데이트 (점검 결과가 '점검필요'가 아니면 RTU 상태도 '작동중'으로 변경)
        if (inspectionData.result !== '점검필요') {
             await setRtuStatus(inspectionData.rtuId, '작동중');
        }

        renderInspectionList(inspectionCurrentPage);
        updateDashboard();
        alert('점검 기록이 성공적으로 등록되었습니다.');
        elements.inspectionForm.reset();
      } catch (e) {
        console.error("Error adding inspection document: ", e);
        alert('점검 기록 저장 중 오류가 발생했습니다: ' + e.message);
      }
    }

    // 수리 기록 저장
    async function saveRepair(repairData) {
      if (!isFirebaseConfigValid) {
        // 로컬 저장 로직
        repairList.push(repairData);
        renderRepairList(repairCurrentPage);
        updateDashboard();
        return;
      }
      
      try {
        const docRef = doc(collection(db, "repairList"));
        repairData.rtuName = rtuList.find(r => r.id === repairData.rtuId)?.name || repairData.rtuId;
        await setDoc(docRef, repairData);

        // 로컬 리스트 업데이트
        repairList.push({ id: docRef.id, ...repairData });

        // RTU 상태 업데이트 (수리 완료 시 '작동중'으로 변경)
        if (repairData.status === '완료') {
             await setRtuStatus(repairData.rtuId, '작동중');
        } else if (repairData.status === '요청') {
             await setRtuStatus(repairData.rtuId, '점검필요');
        }
        
        renderRepairList(repairCurrentPage);
        updateDashboard();
        alert('수리 기록이 성공적으로 등록되었습니다.');
        elements.repairForm.reset();
      } catch (e) {
        console.error("Error adding repair document: ", e);
        alert('수리 기록 저장 중 오류가 발생했습니다: ' + e.message);
      }
    }

    // RTU 상태 업데이트
    async function setRtuStatus(rtuId, newStatus) {
      const rtuIndex = rtuList.findIndex(r => r.id === rtuId);
      if (rtuIndex === -1) return;

      if (!isFirebaseConfigValid) {
        rtuList[rtuIndex].status = newStatus;
        rtuList[rtuIndex].lastUpdated = new Date().toISOString().split('T')[0];
        renderRtuList(rtuCurrentPage);
        updateDashboard();
        return;
      }

      try {
        const rtuRef = doc(db, "rtuList", rtuId);
        await setDoc(rtuRef, { 
          status: newStatus, 
          lastUpdated: new Date().toISOString().split('T')[0] // 'YYYY-MM-DD' 형식
        }, { merge: true });

        // 로컬 리스트 업데이트
        rtuList[rtuIndex].status = newStatus;
        rtuList[rtuIndex].lastUpdated = new Date().toISOString().split('T')[0];
        
        renderRtuList(rtuCurrentPage);
        updateDashboard();
      } catch (e) {
        console.error("Error updating RTU status: ", e);
      }
    }

    // ==================== 대시보드 업데이트 ====================
    function updateDashboard() {
      // Total Counts
      elements.dashboardTotal.textContent = rtuList.length;
      elements.dashboardRunning.textContent = rtuList.filter(rtu => rtu.status === '작동중').length;
      elements.dashboardStopped.textContent = rtuList.filter(rtu => rtu.status === '정지됨').length;
      elements.dashboardNeedsInspection.textContent = rtuList.filter(rtu => rtu.status === '점검필요').length;
      
      // Monthly Inspection Count
      const startOfMonth = new Date();
      startOfMonth.setDate(1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;
      
      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;

      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }

      // Report Page Update
      elements.reportTotalRtu.textContent = rtuList.length;
      elements.reportTotalInspection.textContent = inspectionList.length;
      elements.reportTotalRepair.textContent = repairList.length;
    }

    // ==================== 셀렉트 옵션 채우기 ====================
    function populateRtuSelects() {
      // RTU 수정 셀렉트
      const modifyOptions = rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');
      elements.rtuModifySelect.innerHTML = '<option value="">-- 수정할 RTU를 선택하세요 --</option>' + modifyOptions;

      // 점검 기록 RTU 셀렉트
      const inspectionOptions = rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');
      elements.inspectionRtuId.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>' + inspectionOptions;

      // 수리 기록 RTU 셀렉트
      elements.repairRtuId.innerHTML = elements.inspectionRtuId.innerHTML; // 동일한 옵션 사용
    }

    // ==================== 리스트 렌더링 및 페이지네이션 ====================

    function createPagination(list, currentPage, containerElement, renderFunction) {
      containerElement.innerHTML = '';
      const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);

      if (totalPages <= 1) return;

      const maxPageButtons = 5; // 최대 5개 페이지 버튼 표시
      let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

      if (endPage - startPage + 1 < maxPageButtons) {
        startPage = Math.max(1, endPage - maxPageButtons + 1);
      }

      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn px-3 py-1 text-sm rounded-lg text-gray-600 hover:bg-gray-100 transition duration-150';
      prevBtn.textContent = '이전';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => renderFunction(currentPage - 1));
      containerElement.appendChild(prevBtn);

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pagination-btn px-3 py-1 text-sm rounded-lg mx-1 transition duration-150 ${i === currentPage ? 'bg-blue-600 text-white font-semibold' : 'text-gray-600 hover:bg-gray-100'}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => renderFunction(i));
        containerElement.appendChild(pageBtn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn px-3 py-1 text-sm rounded-lg text-gray-600 hover:bg-gray-100 transition duration-150';
      nextBtn.textContent = '다음';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => renderFunction(currentPage + 1));
      containerElement.appendChild(nextBtn);
    }

    // RTU 리스트 렌더링
    function renderRtuList(page = 1) {
      rtuCurrentPage = page;
      elements.rtuCount.textContent = rtuList.length;
      elements.rtuList.innerHTML = '';

      if (rtuList.length === 0) {
        elements.rtuList.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>';
        elements.rtuPagination.innerHTML = '';
        return;
      }

      // 날짜를 기준으로 최신순 정렬 (date 또는 lastUpdated 사용)
      const sortedList = [...rtuList].sort((a, b) => {
        const dateA = new Date(b.lastUpdated || b.date);
        const dateB = new Date(a.lastUpdated || a.date);
        return dateA - dateB;
      });

      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const paginatedList = sortedList.slice(startIndex, startIndex + ITEMS_PER_PAGE);

      const html = paginatedList.map(rtu => {
        const imagesHtml = [rtu.image1, rtu.image2, rtu.image3]
          .filter(url => url)
          .map((url, index) => `<img src="${url}" alt="RTU Image ${index + 1}" class="thumb-detail" data-image-url="${url}">`)
          .join('');

        return `
          <div id="rtu-${rtu.id}" class="p-4 border rounded-xl shadow-sm hover:shadow-md transition duration-150 bg-white">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
              <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                <h3 class="text-xl font-bold text-gray-900">${rtu.name}</h3>
                <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(rtu.status)}">${rtu.status}</span>
              </div>
              <div class="flex space-x-2">
                <button data-rtu-id="${rtu.id}" class="btn-delete-rtu text-red-600 hover:text-red-800 text-sm font-medium">삭제</button>
                <button data-rtu-id="${rtu.id}" class="btn-modify-rtu text-blue-600 hover:text-blue-800 text-sm font-medium">수정</button>
              </div>
            </div>
            <p class="text-sm text-gray-600 mt-1">지역: ${rtu.region} | 모델: ${rtu.model || '-'} | 종류: ${rtu.unitType || '-'} | 설치일: ${formatDate(rtu.date)}</p>
            <div class="text-sm text-gray-500 mt-2">${rtu.notes ? '메모: ' + rtu.notes : '특이사항 없음'}</div>
            ${imagesHtml ? `<div class="mt-4 flex flex-wrap gap-3 image-gallery">${imagesHtml}</div>` : ''}
          </div>
        `;
      }).join('');

      elements.rtuList.innerHTML = html;

      // 이벤트 리스너 추가
      document.querySelectorAll('.btn-delete-rtu').forEach(btn => {
        btn.addEventListener('click', (e) => deleteRtu(e.currentTarget.dataset.rtuId));
      });
      document.querySelectorAll('.btn-modify-rtu').forEach(btn => {
        btn.addEventListener('click', (e) => loadRtuForModification(e.currentTarget.dataset.rtuId));
      });
      document.querySelectorAll('.image-gallery .thumb-detail').forEach(img => {
        img.addEventListener('click', (e) => showImageModal(e.currentTarget.dataset.imageUrl));
      });

      createPagination(rtuList, page, elements.rtuPagination, renderRtuList);
    }

    // 점검 기록 리스트 렌더링
    function renderInspectionList(page = 1) {
      inspectionCurrentPage = page;
      elements.inspectionCount.textContent = inspectionList.length;
      elements.inspectionList.innerHTML = '';

      if (inspectionList.length === 0) {
        elements.inspectionList.innerHTML = '<p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>';
        elements.inspectionPagination.innerHTML = '';
        return;
      }

      const sortedList = [...inspectionList].sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const paginatedList = sortedList.slice(startIndex, startIndex + ITEMS_PER_PAGE);

      const html = paginatedList.map(inspection => `
          <div id="inspection-${inspection.id}" class="p-4 border rounded-xl shadow-sm hover:shadow-md transition duration-150 bg-white">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-bold text-gray-900">${inspection.rtuName}</h3>
              <div class="flex space-x-2">
                <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(inspection.result)}">${inspection.result}</span>
                <button data-inspection-id="${inspection.id}" class="btn-detail-inspection text-indigo-600 hover:text-indigo-800 text-sm font-medium">상세보기</button>
              </div>
            </div>
            <p class="text-sm text-gray-600">점검일: ${formatDate(inspection.inspectionDate)} | 점검자: ${inspection.inspector}</p>
            <p class="text-sm text-gray-500 truncate mt-1">특이사항: ${inspection.notes || '없음'}</p>
          </div>
        `).join('');

      elements.inspectionList.innerHTML = html;
      
      document.querySelectorAll('.btn-detail-inspection').forEach(btn => {
        btn.addEventListener('click', (e) => showInspectionDetail(e.currentTarget.dataset.inspectionId));
      });

      createPagination(inspectionList, page, elements.inspectionPagination, renderInspectionList);
    }

    // 수리 기록 리스트 렌더링
    function renderRepairList(page = 1) {
      repairCurrentPage = page;
      elements.repairCount.textContent = repairList.length;
      elements.repairList.innerHTML = '';

      if (repairList.length === 0) {
        elements.repairList.innerHTML = '<p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>';
        elements.repairPagination.innerHTML = '';
        return;
      }

      const sortedList = [...repairList].sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const paginatedList = sortedList.slice(startIndex, startIndex + ITEMS_PER_PAGE);

      const html = paginatedList.map(repair => `
          <div id="repair-${repair.id}" class="p-4 border rounded-xl shadow-sm hover:shadow-md transition duration-150 bg-white">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-bold text-gray-900">${repair.rtuName}</h3>
              <div class="flex space-x-2">
                <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(repair.status)}">${repair.status}</span>
                <button data-repair-id="${repair.id}" class="btn-detail-repair text-indigo-600 hover:text-indigo-800 text-sm font-medium">상세보기</button>
              </div>
            </div>
            <p class="text-sm text-gray-600">수리일: ${formatDate(repair.repairDate)} | 담당자: ${repair.engineer}</p>
            <p class="text-sm text-gray-500 truncate mt-1">문제/조치: ${repair.issue || '내용 없음'}</p>
          </div>
        `).join('');

      elements.repairList.innerHTML = html;

      document.querySelectorAll('.btn-detail-repair').forEach(btn => {
        btn.addEventListener('click', (e) => showRepairDetail(e.currentTarget.dataset.repairId));
      });

      createPagination(repairList, page, elements.repairPagination, renderRepairList);
    }

    // 점검 상세 정보 보기 (Inspection Manage 탭)
    function showInspectionDetail(id) {
        const inspection = inspectionList.find(i => i.id === id);
        if (!inspection) return;

        // 1. 점검 기록 목록을 숨기고 상세 뷰를 표시
        elements.inspectionList.classList.add('hidden');
        elements.inspectionPagination.classList.add('hidden');
        
        // 상세 내용을 임시로 report-detail-viewer에 렌더링하고 report-page로 이동하는 대신,
        // 사용자 편의를 위해 '보고서' 탭으로 이동시키고 상세 뷰를 렌더링하도록 수정 (가정)
        // 기존 탭에서 상세 뷰를 보여주는 HTML이 없으므로, report-page의 detail-viewer를 활용하여 렌더링
        
        // 2. 보고서 탭으로 전환
        switchTab('report-page');
        
        // 3. report-detail-view 표시
        elements.reportDetailView.classList.remove('hidden');

        // 4. 리스트 테이블 숨기기 (상세 뷰를 보여줄 때는 테이블을 숨깁니다)
        elements.reportRtuList.classList.add('hidden');
        elements.reportInspectionList.classList.add('hidden');
        elements.reportRepairList.classList.add('hidden');
        elements.reportDetailContent.innerHTML = '';
        
        // 5. 상세 텍스트를 구성하여 report-detail-viewer에 렌더링하고 표시
        elements.reportDetailTitle.textContent = `점검 기록 상세 보고서: ${inspection.rtuName} (${formatDate(inspection.inspectionDate)})`;
        
        let detailText = `=== RTU 점검 보고서 ===\n\n`;
        detailText += `RTU 등록번호/ID: ${inspection.rtuName}\n`;
        detailText += `점검 날짜: ${formatDate(inspection.inspectionDate)}\n`;
        detailText += `점검자: ${inspection.inspector}\n`;
        detailText += `최종 결과: ${inspection.result}\n\n`;

        detailText += `--- 부품 점검 상태 ---\n`;
        detailText += `1. 필터: ${inspection.check1 || '-'}\n`;
        detailText += `2. 콘텍터: ${inspection.check2 || '-'}\n`;
        detailText += `3. 콘덴싱 코일: ${inspection.check3 || '-'}\n`;
        detailText += `4. 송풍 모터: ${inspection.check4 || '-'}\n`;
        detailText += `5. 증발기 코일: ${inspection.check5 || '-'}\n`;
        detailText += `6. 고압 센서: ${inspection.check6 || '-'}\n`;
        detailText += `7. 저압 센서: ${inspection.check7 || '-'}\n`;
        detailText += `8. 캐패시터: ${inspection.check8 || '-'}\n\n`;
        
        detailText += `--- 운전 상태/온도 ---\n`;
        detailText += `Comp1 고/저/전류: ${inspection.comp1Hp || '-'} / ${inspection.comp1Lp || '-'} / ${inspection.comp1Amp || '-'} \n`;
        detailText += `Comp2 고/저/전류: ${inspection.comp2Hp || '-'} / ${inspection.comp2Lp || '-'} / ${inspection.comp2Amp || '-'} \n`;
        detailText += `과열도/과냉도: ${inspection.superheat || '-'}℉ / ${inspection.subcool || '-'}℉\n\n`;
        
        detailText += `--- 특이사항/조치 내용 ---\n`;
        detailText += `${inspection.notes || '특이사항 및 조치 내용 없음'}\n\n`;

        elements.reportDetailViewer.textContent = detailText;
        elements.reportDetailViewer.classList.remove('hidden');
    }

    // 수리 상세 정보 보기 (Repair Manage 탭)
    function showRepairDetail(id) {
        const repair = repairList.find(r => r.id === id);
        if (!repair) return;

        // 1. 수리 기록 목록을 숨기고 상세 뷰를 표시
        elements.repairList.classList.add('hidden');
        elements.repairPagination.classList.add('hidden');

        // 2. 보고서 탭으로 전환
        switchTab('report-page');

        // 3. report-detail-view 표시
        elements.reportDetailView.classList.remove('hidden');
        
        // 4. 리스트 테이블 숨기기
        elements.reportRtuList.classList.add('hidden');
        elements.reportInspectionList.classList.add('hidden');
        elements.reportRepairList.classList.add('hidden');
        elements.reportDetailContent.innerHTML = '';

        // 5. 상세 텍스트를 구성하여 report-detail-viewer에 렌더링하고 표시
        elements.reportDetailTitle.textContent = `수리 기록 상세 보고서: ${repair.rtuName} (${formatDate(repair.repairDate)})`;
        
        let detailText = `=== RTU 수리 보고서 ===\n\n`;
        detailText += `RTU 등록번호/ID: ${repair.rtuName}\n`;
        detailText += `수리 요청/완료 날짜: ${formatDate(repair.repairDate)}\n`;
        detailText += `수리 담당자: ${repair.engineer}\n`;
        detailText += `처리 상태: ${repair.status}\n\n`;
        
        detailText += `--- 문제 및 조치 내용 ---\n`;
        detailText += `${repair.issue || '내용 없음'}\n\n`;

        elements.reportDetailViewer.textContent = detailText;
        elements.reportDetailViewer.classList.remove('hidden');
    }


    // ==================== RTU 수정 모드 관리 ====================
    function setRtuMode(mode) {
      rtuMode = mode;
      elements.rtuNameInput.value = '';
      elements.rtuForm.reset();
      elements.imagePreviewContainer.classList.add('hidden');
      elements.rtuIdForModification.value = '';

      if (mode === 'new') {
        elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
        elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
        elements.rtuNameInput.classList.remove('hidden');
        elements.rtuNameInput.disabled = false;
        elements.rtuNameInput.classList.remove('bg-gray-100');
        elements.rtuModifySelect.classList.add('hidden');
        elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
        elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
      } else {
        elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
        elements.rtuSubmitBtn.textContent = 'RTU 정보 수정 완료';
        elements.rtuNameInput.classList.add('hidden');
        elements.rtuModifySelect.classList.remove('hidden');
        elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
        elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
        elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
      }
    }

    function loadRtuForModification(id) {
      // RTU 목록에서 수정 버튼을 눌렀을 경우, 수정 모드로 전환하고 해당 RTU를 선택
      setRtuMode('modify');
      elements.rtuModifySelect.value = id;
      elements.rtuModifySelect.dispatchEvent(new Event('change')); // 변경 이벤트 강제 발생
    }

    // RTU 수정 폼에 데이터 로드
    function loadRtuDataToForm(rtu) {
      if (!rtu) {
        elements.rtuForm.reset();
        elements.rtuNameInput.value = '';
        elements.rtuIdForModification.value = '';
        elements.imagePreviewContainer.classList.add('hidden');
        elements.rtuNameInput.disabled = false;
        elements.rtuNameInput.classList.remove('bg-gray-100');
        return;
      }
      
      elements.rtuIdForModification.value = rtu.id;
      
      // 이름은 수정 불가하도록 비활성화
      elements.rtuNameInput.value = rtu.name;
      elements.rtuNameInput.disabled = true;
      elements.rtuNameInput.classList.add('bg-gray-100');

      document.getElementById('rtu-region').value = rtu.region || '';
      document.getElementById('rtu-model').value = rtu.model || '';
      document.getElementById('rtu-capacity').value = rtu.capacity || '';
      document.getElementById('rtu-unit-type').value = rtu.unitType || '패키지';
      document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
      document.getElementById('rtu-electric-phase').value = rtu.electricPhase || '단상';
      document.getElementById('rtu-date').value = rtu.date || '';
      document.getElementById('rtu-status').value = rtu.status || '작동중';
      document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
      document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
      document.getElementById('rtu-notes').value = rtu.notes || '';

      // 이미지 미리보기 업데이트 (URL이 있는 경우)
      updateImagePreview(rtu.image1, rtu.image2, rtu.image3);
    }
    
    // 이미지 미리보기 업데이트
    function updateImagePreview(url1, url2, url3) {
        const urls = [url1, url2, url3].filter(url => url);
        if (urls.length > 0) {
            elements.imagePreviewContainer.classList.remove('hidden');
            const previews = [elements.imagePreview1, elements.imagePreview2, elements.imagePreview3];
            
            previews.forEach((img, index) => {
                if (urls[index]) {
                    img.src = urls[index];
                    img.style.display = 'block';
                } else {
                    img.src = '';
                    img.style.display = 'none';
                }
            });
        } else {
            elements.imagePreviewContainer.classList.add('hidden');
        }
    }


    // ==================== 보고서 기능 ====================
    
    // 보고서 상세 내용 렌더링
    function renderReportDetail(type) {
      // 기존 내용 초기화
      elements.reportDetailContent.innerHTML = '';
      elements.reportDetailViewer.classList.add('hidden');
      
      // 모든 리스트 테이블 숨기기
      elements.reportRtuList.classList.add('hidden');
      elements.reportInspectionList.classList.add('hidden');
      elements.reportRepairList.classList.add('hidden');

      let dataList = [];
      let title = '';
      let targetListBodyElement;
      let targetListContainerElement;
      let headers = [];

      if (type === 'rtu') {
        dataList = rtuList;
        title = 'RTU 등록 목록';
        targetListBodyElement = elements.reportRtuListBody;
        targetListContainerElement = elements.reportRtuList;
        headers = ['name', 'region', 'model', 'capacity', 'unitType', 'date', 'status', 'pressureHighLimit', 'pressureLowLimit'];
      } else if (type === 'inspection') {
        dataList = inspectionList;
        title = '점검 기록 목록';
        targetListBodyElement = elements.reportInspectionListBody;
        targetListContainerElement = elements.reportInspectionList;
        // comp1Hp/Lp/Amp는 Comp1 압력/전류, comp2는 Comp2 압력/전류
        headers = ['rtuName', 'inspectionDate', 'inspector', 'comp1Hp', 'comp1Lp', 'comp1Amp', 'superheat', 'subcool', 'result'];
      } else if (type === 'repair') {
        dataList = repairList;
        title = '수리 기록 목록';
        targetListBodyElement = elements.reportRepairListBody;
        targetListContainerElement = elements.reportRepairList;
        headers = ['rtuName', 'repairDate', 'engineer', 'status', 'issue'];
      }

      elements.reportDetailTitle.textContent = `상세 보고서 - ${title}`;

      if (dataList.length === 0) {
        elements.reportDetailContent.innerHTML = '<p class="text-gray-500">기록된 데이터가 없습니다.</p>';
        return;
      }
      
      // 데이터를 HTML 테이블 행으로 변환
      const tableRows = dataList.map(item => {
        const cells = headers.map(key => {
          let value = item[key] !== undefined ? item[key] : '-';
          let displayValue = value;
          let className = 'px-6 py-4 whitespace-nowrap text-sm';
          
          if (key === 'status' || key === 'result') {
            displayValue = `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(value)}">${value}</span>`;
            className += ' text-center';
          } else if (key.includes('Date') || key === 'date') {
            displayValue = formatDate(value);
          } else if (key === 'issue') {
            // 문제/조치 내용은 길 수 있으므로 truncate 후 마우스를 올리면 전체 툴팁 표시
            const truncated = value.length > 50 ? value.substring(0, 50) + '...' : value;
            displayValue = `<span title="${value}">${truncated}</span>`;
          } else if (key === 'capacity') {
            displayValue = `${value || '-'} RT`;
          }
          
          return `<td class="${className}">${displayValue}</td>`;
        }).join('');
        
        return `<tr class="hover:bg-gray-50 transition duration-100">${cells}</tr>`;
      }).join('');

      targetListBodyElement.innerHTML = tableRows;
      targetListContainerElement.classList.remove('hidden');
    }

    // ==================== CSV 기능 ====================

    // 배열을 CSV 형식 문자열로 변환
    function convertToCSV(data, headers) {
      if (data.length === 0) return '';
      
      const headerKeys = headers.map(h => h.key);
      const headerRow = headers.map(h => h.name).join(',');
      
      const rows = data.map(item => {
        return headerKeys.map(key => {
          let value = item[key] !== undefined ? item[key] : '';
          // 쉼표나 큰따옴표가 포함된 값은 큰따옴표로 묶음
          if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
            value = `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        }).join(',');
      }).join('\n');
      
      return headerRow + '\n' + rows;
    }

    // CSV 다운로드
    function downloadCSV() {
      // 모든 데이터를 담을 단일 CSV 파일 생성
      const allData = [
        { 
          name: "RTU 목록", 
          list: rtuList, 
          headers: [
            { name: "ID", key: "id" }, { name: "등록번호/ID", key: "name" }, { name: "지역/장소", key: "region" }, 
            { name: "모델명", key: "model" }, { name: "용량", key: "capacity" }, { name: "유닛 종류", key: "unitType" }, 
            { name: "냉매 종류", key: "refrigerant" }, { name: "전기 종류", key: "electricPhase" }, 
            { name: "설치(등록) 날짜", key: "date" }, { name: "현재 상태", key: "status" }, 
            { name: "고압 상한 설정(PSI)", key: "pressureHighLimit" }, { name: "저압 하한 설정(PSI)", key: "pressureLowLimit" }, 
            { name: "특이사항 및 메모", key: "notes" }, { name: "이미지1", key: "image1" }, 
            { name: "이미지2", key: "image2" }, { name: "이미지3", key: "image3" },
          ]
        },
        { 
          name: "점검 기록 목록", 
          list: inspectionList, 
          headers: [
            { name: "ID", key: "id" }, { name: "RTU ID", key: "rtuId" }, { name: "RTU 등록번호/ID", key: "rtuName" }, 
            { name: "점검 날짜", key: "inspectionDate" }, { name: "점검자 이름", key: "inspector" }, 
            { name: "1. 필터", key: "check1" }, { name: "2. 콘텍터", key: "check2" }, 
            { name: "3. 콘덴싱 코일", key: "check3" }, { name: "4. 송풍 모터", key: "check4" }, 
            { name: "5. 증발기 코일", key: "check5" }, { name: "6. 고압 센서", key: "check6" }, 
            { name: "7. 저압 센서", key: "check7" }, { name: "8. 캐패시터", key: "check8" }, 
            { name: "Comp1 고압(PSI)", key: "comp1Hp" }, { name: "Comp1 저압(PSI)", key: "comp1Lp" }, 
            { name: "Comp1 전류(A)", key: "comp1Amp" }, { name: "Comp2 고압(PSI)", key: "comp2Hp" }, 
            { name: "Comp2 저압(PSI)", key: "comp2Lp" }, { name: "Comp2 전류(A)", key: "comp2Amp" }, 
            { name: "과열도(F)", key: "superheat" }, { name: "과냉도(F)", key: "subcool" }, 
            { name: "최종 점검 결과", key: "result" }, { name: "특이사항 및 조치 내용", key: "notes" },
          ]
        },
        { 
          name: "수리 기록 목록", 
          list: repairList, 
          headers: [
            { name: "ID", key: "id" }, { name: "RTU ID", key: "rtuId" }, { name: "RTU 등록번호/ID", key: "rtuName" }, 
            { name: "수리 요청/완료 날짜", key: "repairDate" }, { name: "수리 담당자", key: "engineer" }, 
            { name: "처리 상태", key: "status" }, { name: "문제 및 조치 내용", key: "issue" },
          ]
        }
      ];

      let combinedCSV = '';
      allData.forEach(data => {
        combinedCSV += `\n\n=== ${data.name} ===\n`;
        combinedCSV += convertToCSV(data.list, data.headers);
      });

      const blob = new Blob(['\ufeff' + combinedCSV], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `RTU_통합_관리_시스템_데이터_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // CSV 파일 업로드 및 데이터 병합
    function uploadCSV(file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const csvData = event.target.result;
        processCSVData(csvData);
      };
      reader.onerror = function(event) {
        alert("파일을 읽는 도중 오류가 발생했습니다: " + event.target.error.name);
      };
      reader.readAsText(file, 'utf-8');
    }

    // CSV 데이터 파싱 및 리스트 병합 (복잡하므로 간소화된 로직만 포함)
    function processCSVData(csv) {
        alert("CSV 업로드 기능은 구현되었지만, 데이터 파싱 및 병합 로직은 복잡하여 현재 데모 버전에서는 지원되지 않습니다. 콘솔에서 데이터를 확인하세요.");
        console.log("Uploaded CSV Content:", csv);
    }
    
    // ==================== 이벤트 핸들러 ====================

    // 탭 클릭 이벤트
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;
        switchTab(targetTab);
      });
    });

    // RTU 폼 제출
    elements.rtuForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      
      const isNew = rtuMode === 'new';
      
      let id = isNew ? generateUUID() : elements.rtuIdForModification.value;
      
      // 필수 필드 유효성 검사
      if (isNew && rtuList.some(r => r.name === data.name)) {
        alert('이미 동일한 RTU 등록번호/ID가 존재합니다.');
        return;
      }
      if (!isNew && !id) {
        alert('수정할 RTU를 선택해주세요.');
        return;
      }
      
      // 이미지 처리 (간소화: 파일 이름만 저장)
      // 실제 구현 시에는 Firebase Storage 또는 다른 클라우드 저장소에 파일을 업로드하고 URL을 저장해야 합니다.
      const existingRtu = rtuList.find(r => r.id === id) || {};
      const image1Url = existingRtu.image1 || (data.image1.name ? 'local_url_1' : ''); // 실제 URL 대신 플레이스홀더 사용
      const image2Url = existingRtu.image2 || (data.image2.name ? 'local_url_2' : '');
      const image3Url = existingRtu.image3 || (data.image3.name ? 'local_url_3' : '');
      
      // 새로운 데이터 객체 구성
      const rtuData = {
        id: id,
        name: data.name,
        region: data.region,
        model: data.model || '',
        capacity: data.capacity || '',
        unitType: data.unitType || '패키지',
        refrigerant: data.refrigerant || 'R-410A',
        electricPhase: data.electricPhase || '단상',
        date: data.date || new Date().toISOString().split('T')[0],
        status: data.status || '작동중',
        pressureHighLimit: data.pressureHighLimit || '',
        pressureLowLimit: data.pressureLowLimit || '',
        notes: data.notes || '',
        image1: image1Url,
        image2: image2Url,
        image3: image3Url,
        lastUpdated: new Date().toISOString().split('T')[0]
      };

      await saveRtu(rtuData, isNew);
    });

    // RTU 수정/신규 모드 버튼 클릭
    elements.modeNewBtn.addEventListener('click', () => setRtuMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => setRtuMode('modify'));
    
    // RTU 수정 셀렉트 변경 시 데이터 로드
    elements.rtuModifySelect.addEventListener('change', (e) => {
      const id = e.target.value;
      const rtu = rtuList.find(r => r.id === id);
      loadRtuDataToForm(rtu);
    });

    // 점검 기록 폼 제출
    elements.inspectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      
      const rtuName = rtuList.find(r => r.id === data.rtuId)?.name;
      if (!rtuName) {
        alert('유효한 RTU를 선택해주세요.');
        return;
      }

      const inspectionData = {
        id: generateUUID(),
        rtuId: data.rtuId,
        rtuName: rtuName,
        inspectionDate: data.inspectionDate,
        inspector: data.inspector,
        check1: data.check1, check2: data.check2, check3: data.check3, check4: data.check4,
        check5: data.check5, check6: data.check6, check7: data.check7, check8: data.check8,
        comp1Hp: data.comp1Hp, comp1Lp: data.comp1Lp, comp1Amp: data.comp1Amp,
        comp2Hp: data.comp2Hp, comp2Lp: data.comp2Lp, comp2Amp: data.comp2Amp,
        superheat: data.superheat, subcool: data.subcool,
        result: data.result,
        notes: data.notes || '',
      };
      
      await saveInspection(inspectionData);
    });

    // 수리 기록 폼 제출
    elements.repairForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());

      const rtuName = rtuList.find(r => r.id === data.rtuId)?.name;
      if (!rtuName) {
        alert('유효한 RTU를 선택해주세요.');
        return;
      }

      const repairData = {
        id: generateUUID(),
        rtuId: data.rtuId,
        rtuName: rtuName,
        repairDate: data.repairDate,
        engineer: data.engineer,
        status: data.status,
        issue: data.issue,
      };

      await saveRepair(repairData);
    });
    
    // CSV 다운로드 버튼
    elements.downloadDataBtn.addEventListener('click', downloadCSV);

    // CSV 업로드
    elements.csvUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            uploadCSV(e.target.files[0]);
            e.target.value = ''; // 파일 선택 초기화
        }
    });

    // 보고서 요약 클릭 이벤트 리스너
    elements.reportRtuSummary.addEventListener('click', () => {
      elements.reportDetailView.classList.remove('hidden');
      renderReportDetail('rtu');
    });
    elements.reportInspectionSummary.addEventListener('click', () => {
      elements.reportDetailView.classList.remove('hidden');
      renderReportDetail('inspection');
    });
    elements.reportRepairSummary.addEventListener('click', () => {
      elements.reportDetailView.classList.remove('hidden');
      renderReportDetail('repair');
    });

    // 보고서 인쇄 버튼
    elements.reportPrintBtn.addEventListener('click', () => {
      window.print();
    });

    // 이미지 모달 표시 및 닫기
    function showImageModal(url) {
        elements.modalImage.src = url;
        elements.imageModal.classList.remove('hidden');
        elements.imageModal.classList.add('flex');
    }

    elements.closeModal.addEventListener('click', () => {
        elements.imageModal.classList.add('hidden');
        elements.imageModal.classList.remove('flex');
    });
    
    // 모달 배경 클릭 시 닫기
    elements.imageModal.addEventListener('click', (e) => {
        if (e.target.id === 'image-modal') {
            elements.closeModal.click();
        }
    });


    // ==================== 초기화 ====================

    // 모든 리스트를 렌더링하고 대시보드를 업데이트합니다.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();

      // [신규] 보고서 요약 클릭 이벤트 리스너 추가
      elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
      });
      elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
      });
      elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
      });
    });

  </script>
</body>
</html>