<!DOCTYPE TML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (로컬 저장소 - 최적화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    /* 활성화된 탭 스타일 */
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
             <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                데이터 CSV 업로드
            </label>
            <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file" onchange="handleDataUpload(event)">

            <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                데이터 CSV 다운로드
            </button>
        </div>
      </div>

      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
                <div class="flex justify-center mb-4 border-b pb-4">
                    <button id="mode-new-btn" onclick="switchRtuMode('new')" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                    <button id="mode-modify-btn" onclick="switchRtuMode('modify')" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
                </div>

                <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
                <form id="rtu-form" class="space-y-4">
                    <input type="hidden" id="rtu-id-for-modification" name="rtuId" value=""> 

                    <div id="rtu-id-container">
                        <div>
                            <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                            <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                        <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                        <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                        <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                        <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                            <option value="패키지">패키지</option>
                            <option value="칠러">칠러</option>
                            <option value="냉각탑">냉각탑</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                     <div>
                        <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                        <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                    </div>
                    <div>
                        <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                        <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                            <option value="단상">단상 (Single Phase)</option>
                            <option value="삼상">삼상 (Three Phase)</option>
                        </select>
                    </div>
                    <div>
                        <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                        <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                        <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                            <option value="작동중">작동중</option>
                            <option value="정지됨">정지됨</option>
                            <option value="점검필요">점검필요</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                            <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                            <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                        <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                        <div class="flex space-x-2">
                            <input type="file" id="rtu-image1" name="image1" accept="image/*" onchange="previewImage(event, 1)" class="hidden-file">
                            <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                        </div>
                        <div class="flex space-x-2">
                            <input type="file" id="rtu-image2" name="image2" accept="image/*" onchange="previewImage(event, 2)" class="hidden-file">
                            <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                        </div>
                        <div class="flex space-x-2">
                            <input type="file" id="rtu-image3" name="image3" accept="image/*" onchange="previewImage(event, 3)" class="hidden-file">
                            <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                        </div>
                    </div>

                    <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                        <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                        <div class="flex flex-wrap gap-4">
                            <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                            <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                            <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                        </div>
                    </div>


                    <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
                </form>
            </div>

            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>

                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                    <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div>
                            <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                            <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="교체필요">교체필요</option>
                            </select>
                        </div>
                        <div>
                            <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                            <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="소손/교체필요">소손/교체필요</option>
                            </select>
                        </div>
                        <div>
                            <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                            <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="양호">양호</option>
                                <option value="오염/청소필요">오염/청소필요</option>
                            </select>
                        </div>
                        <div>
                            <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                            <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="소음/수리필요">소음/수리필요</option>
                            </select>
                        </div>
                         <div>
                            <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                            <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="양호">양호</option>
                                <option value="오염/청소필요">오염/청소필요</option>
                            </select>
                        </div>
                        <div>
                            <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                            <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="오류">오류</option>
                            </select>
                        </div>
                        <div>
                            <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                            <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="오류">오류</option>
                            </select>
                        </div>
                         <div>
                            <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                            <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                                <option value="정상">정상</option>
                                <option value="불량">불량</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
                    <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label for="comp1-hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
                            <input type="number" step="0.1" id="comp1-hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="comp1-lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
                            <input type="number" step="0.1" id="comp1-lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="comp1-amp" class="block text-sm font-medium text-gray-700">암페어 (A)</label>
                            <input type="number" step="0.1" id="comp1-amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                    </div>
                </div>

                <div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
                    <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2 - 선택 사항)</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label for="comp2-hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
                            <input type="number" step="0.1" id="comp2-hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="comp2-lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
                            <input type="number" step="0.1" id="comp2-lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="comp2-amp" class="block text-sm font-medium text-gray-700">암페어 (A)</label>
                            <input type="number" step="0.1" id="comp2-amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                    </div>
                </div>
                
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                    <h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                            <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                            <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                         <div>
                            <label for="evap-temp" class="block text-sm font-medium text-gray-700">증발 온도 (℉)</label>
                            <input type="number" step="0.1" id="evap-temp" name="evapTemp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                    </div>
                </div>
                
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                      <option value="정상">정상</option>
                      <option value="주의">주의</option>
                      <option value="점검필요">점검필요</option>
                  </select>
                </div>
                
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>


                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>

            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div id="repair-manage" class="tab-page hidden">
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                      <option value="요청">요청 (미처리)</option>
                      <option value="진행중">진행중</option>
                      <option value="완료">완료</option>
                  </select>
                </div>
                
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>


                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>

            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">시스템 운영 보고서</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200">
                    <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
                    <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
                </div>
                <div class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200">
                    <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
                    <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
                </div>
                <div class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200">
                    <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
                    <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
                </div>
            </div>

            <p class="text-gray-600 border-t pt-4">보다 상세한 데이터 분석 및 보고는 상단의 **데이터 CSV 다운로드/업로드** 버튼을 통해 데이터를 추출하여 진행하실 수 있습니다.</p>
        </div>

      </div>

    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>로딩 중...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // ============================ 전역 변수 및 DOM 요소 정의 ============================ 
    const STORAGE_KEYS = { RTU: 'rtuList', INSPECTION: 'inspectionList', REPAIR: 'repairList' };
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    let rtuMode = 'new'; // 'new' 또는 'modify'
    let currentRtuIdForModification = null;
    
    // 점검 항목 레이블
    const INSPECTION_CHECK_LABELS = [
        '필터', '콘텍터', '콘덴싱 코일', '송풍 모터', '증발기 코일', '고압 센서', '저압 센서', '캐패시터'
    ];
    
    // 이미지 로드 실패 시 사용할 Base64 Placeholder 이미지
    const PLACEHOLDER_IMG_SRC = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSIyIiBkPSJNNCAxNmw0LjU4Ni00LjU4NmEyIDIgMCAwMTIuODQ5IDBMMTYgMTZtLTItMmwxLjU4Ni0xLjU4NmEyIDIgMCAwMTIuODQ5IDBMMjAgMTRtLTUgNGguMDFNNiAyMGgxMmEyIDIgMCAwMDItMlY2YTIgMiAwIDAwLTItMkH2YTIgMiAwIDAwLTIgMnYxMmEyIDIgMCAwMDIgMnoiLz48L3N2Zy4=";


    // 모든 DOM 요소를 한 번에 가져와서 변수에 저장 (최적화)
    const elements = {
        // Tabs & Pages
        tabButtons: document.querySelectorAll('.tab-btn'),
        rtuListDiv: document.getElementById('rtu-list'),
        inspectionList: document.getElementById('inspection-list'),
        repairList: document.getElementById('repair-list'),
        
        // RTU Form
        rtuForm: document.getElementById('rtu-form'),
        rtuNameInput: document.getElementById('rtu-name'),
        rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
        rtuFormTitle: document.getElementById('rtu-form-title'),
        modeNewBtn: document.getElementById('mode-new-btn'),
        modeModifyBtn: document.getElementById('mode-modify-btn'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        
        // Form Selects
        inspectionRtuSelect: document.getElementById('inspection-rtu-id'),
        repairRtuSelect: document.getElementById('repair-rtu-id'),
        
        // Record Forms
        inspectionForm: document.getElementById('inspection-form'),
        repairForm: document.getElementById('repair-form'),
        
        // Dashboard
        dashboardTotal: document.getElementById('dashboard-total'),
        dashboardRunning: document.getElementById('dashboard-running'),
        dashboardStopped: document.getElementById('dashboard-stopped'),
        dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
        dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
        dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
        dashboardLatestList: document.getElementById('dashboard-latest-list'),
        
        // Counts
        rtuCountSpan: document.getElementById('rtu-count'),
        inspectionCountSpan: document.getElementById('inspection-count'),
        repairCountSpan: document.getElementById('repair-count'),
        
        // Report
        reportTotalRtu: document.getElementById('report-total-rtu'),
        reportTotalInspection: document.getElementById('report-total-inspection'),
        reportTotalRepair: document.getElementById('report-total-repair'),

        // Modal
        detailModal: document.getElementById('detail-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),

        // Data Handling
        downloadDataBtn: document.getElementById('download-data-btn'),
        csvUploadInput: document.getElementById('csv-upload'),
    };
    
    // Firebase 관련 (주석 처리됨. 실제 기능을 사용하려면 SDK 추가 및 설정 필요)
    const storage = undefined;


    // ============================ 로컬 저장소 함수 ============================ 

    function loadList(key) {
        try {
            const json = localStorage.getItem(key);
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error(`로컬 저장소 (${key}) 로드 실패`, e);
            return [];
        }
    }

    function saveList(key, list) {
        try {
            localStorage.setItem(key, JSON.stringify(list));
        } catch (e) {
            console.error(`로컬 저장소 (${key}) 저장 실패`, e);
            alert("데이터 저장에 실패했습니다. 브라우저 저장 공간이 부족할 수 있습니다.");
        }
    }

    // ============================ Firebase Storage 처리 (개선) ============================
    
    /**
     * 파일을 Firebase Storage에 업로드하고 다운로드 URL을 반환합니다.
     * @param {File} file - 업로드할 File 객체
     * @param {string} rtuId - RTU ID (저장소 경로로 사용)
     * @param {number} index - 이미지 순서 (파일 이름에 사용)
     * @returns {Promise<string|null>} 다운로드 URL 또는 실패 시 null
     */
    async function uploadFileToStorage(file, rtuId, index) {
        if (!file) return null;
        if (typeof storage === 'undefined' || !storage.ref) { 
            console.warn("Firebase Storage가 정의되지 않아 파일 업로드를 건너뜁니다.");
            return null;
        }

        try {
            // 경로는 rtuId/image_1_파일명 형식으로 유지
            const storageRef = storage.ref(`${rtuId}/image_${index}_${file.name}`);
            const snapshot = await storageRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            console.log('파일 업로드 성공:', downloadURL);
            return downloadURL;
        } catch (e) {
            console.error('파일 업로드 실패:', e);
            // 모바일 환경에서 에러 코드를 정확히 진단하기 위함
            alert(`[파일 업로드 실패] 에러코드: ${e.code || 'UNKNOWN'} 메시지: ${e.message}`);
            return null;
        }
    }

    // ============================ 데이터 관리 및 UI 이벤트 ============================

    // RTU 등록/수정 폼 제출 핸들러
    elements.rtuForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const rtuData = new FormData(form);
        const data = {};
        
        // 폼 데이터 수집
        rtuData.forEach((value, key) => {
            if (!key.startsWith('image')) { // 파일 인풋은 제외
                 data[key] = value.trim();
            }
        });

        // 1. 등록번호 (ID) 처리 및 유효성 검사
        const newRtuId = data.name.toUpperCase().replace(/\s/g, ''); // 공백 제거 후 대문자
        data.id = newRtuId;
        data.name = data.name.trim(); 

        if (!data.name) {
             alert('RTU 등록번호/ID를 입력해야 합니다.');
             return;
        }

        if (rtuMode === 'new' && rtuList.some(rtu => rtu.id === data.id)) {
            alert('이미 등록된 RTU 등록번호입니다. 다른 번호를 사용해 주세요.');
            return;
        } 
        if (rtuMode === 'modify' && data.id !== currentRtuIdForModification) {
            // 수정 모드에서 ID 변경 시도 방지 (이미 readOnly지만 한 번 더 체크)
            alert('RTU ID는 수정할 수 없습니다.');
            return;
        }

        // 2. 파일 업로드 및 URL 확보
        const imageFiles = [
            document.getElementById('rtu-image1').files[0],
            document.getElementById('rtu-image2').files[0],
            document.getElementById('rtu-image3').files[0]
        ];
        
        const existingRtu = rtuMode === 'modify' ? rtuList.find(r => r.id === data.id) : {};

        try {
            const urls = await Promise.all(imageFiles.map(async (file, index) => {
                const urlKey = `imageUrl${index + 1}`;
                
                if (file) {
                    return await uploadFileToStorage(file, data.id, index + 1); // 새 파일 업로드
                }
                // 파일 인풋이 비어 있고 수정 모드일 때 기존 URL 유지
                return existingRtu ? existingRtu[urlKey] || null : null;
            }));
            
            data.imageUrl1 = urls[0];
            data.imageUrl2 = urls[1];
            data.imageUrl3 = urls[2];
            data.lastModified = new Date().toISOString(); // 최종 수정/등록 시간 기록

        } catch (error) {
            console.error("최종 이미지 처리 중 오류 발생:", error);
            alert("이미지 처리 중 치명적인 오류가 발생하여 저장을 취소합니다.");
            return; 
        }

        // 3. 데이터 저장 (로컬 저장소)
        if (rtuMode === 'new') {
            rtuList.push(data);
            alert(`${data.name} (ID: ${data.id}) 장비가 신규 등록되었습니다.`);
        } else {
            const index = rtuList.findIndex(rtu => rtu.id === data.id);
            if (index !== -1) {
                // 기존 데이터에 덮어쓰기
                rtuList[index] = data;
                alert(`${data.name} (ID: ${data.id}) 장비 정보가 수정되었습니다.`);
            }
        }

        saveList(STORAGE_KEYS.RTU, rtuList);
        
        // 4. UI 업데이트 및 초기화
        form.reset();
        elements.imagePreviewContainer.classList.add('hidden');
        switchRtuMode('new'); 
        updateAllUI();
    });

    // 점검 기록 폼 제출 핸들러
    elements.inspectionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value.trim());

        data.id = generateId(20);
        data.timestamp = new Date().toISOString();

        // 숫자형 데이터 변환 및 빈 값이면 빈 문자열로 유지
        const numberFields = ['comp1Hp', 'comp1Lp', 'comp1Amp', 'comp2Hp', 'comp2Lp', 'comp2Amp', 'superheat', 'subcool', 'evapTemp'];
        numberFields.forEach(key => {
            data[key] = parseFloat(data[key]) || '';
        });

        inspectionList.push(data);
        saveList(STORAGE_KEYS.INSPECTION, inspectionList);
        
        // RTU 상태 업데이트
        const rtu = rtuList.find(r => r.id === data.rtuId);
        if (rtu && rtu.status !== data.result) {
            rtu.status = data.result;
            rtu.lastModified = new Date().toISOString();
            saveList(STORAGE_KEYS.RTU, rtuList);
        }

        alert(`점검 기록이 저장되었습니다. 대상 RTU 상태: ${data.result}`);
        form.reset();
        updateAllUI();
    });

    // 수리 기록 폼 제출 핸들러
    elements.repairForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value.trim());

        data.id = generateId(20);
        data.timestamp = new Date().toISOString();

        repairList.push(data);
        saveList(STORAGE_KEYS.REPAIR, repairList);
        
        alert('수리 기록이 저장되었습니다.');
        form.reset();
        updateAllUI();
    });
    
    // ============================ UI 헬퍼 함수 ============================

    function generateId(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    /**
     * RTU 목록 항목 HTML을 생성하는 헬퍼 함수
     * @param {Object} rtu - RTU 데이터 객체
     * @returns {string} RTU 항목의 HTML 문자열
     */
    function createRtuListItem(rtu) {
        const imageSrc = rtu.imageUrl1 || PLACEHOLDER_IMG_SRC;
        // 이미지가 깨지면 Placeholder를 로드 (무한 루프 방지 포함)
        const onErrorAttr = `this.onerror=null;this.src='${PLACEHOLDER_IMG_SRC}'`;

        const statusClass = rtu.status === '작동중' ? 'bg-green-100 text-green-800' : 
                            rtu.status === '점검필요' ? 'bg-red-100 text-red-800' : 
                            'bg-gray-100 text-gray-800';

        return `
            <div class="rtu-item flex items-center p-3 border rounded-lg bg-white shadow-sm hover:bg-gray-50 cursor-pointer" 
                 data-id="${rtu.id}" 
                 onclick="showRtuDetail('${rtu.id}')">
                
                <img src="${imageSrc}" 
                     alt="${rtu.name} 대표 이미지" 
                     class="thumb flex-shrink-0 mr-4" 
                     onerror="${onErrorAttr}">

                <div class="flex-grow min-w-0">
                    <h3 class="text-lg font-semibold text-gray-800 truncate">${rtu.name} (${rtu.region})</h3>
                    <p class="text-sm text-gray-500">${rtu.model || '모델 정보 없음'}</p>
                    <div class="flex space-x-2 mt-1">
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusClass}">${rtu.status}</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">${rtu.unitType || '유닛 종류 없음'}</span>
                    </div>
                </div>
                
                <button class="text-blue-500 hover:text-blue-700 text-sm font-semibold ml-4" onclick="event.stopPropagation(); loadRtuForModification('${rtu.id}')">
                    수정
                </button>
            </div>
        `;
    }

    // ============================ 목록 렌더링 함수 ============================

    function renderRtuList() {
        if (rtuList.length === 0) {
            elements.rtuListDiv.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>';
        } else {
            elements.rtuListDiv.innerHTML = rtuList.map(createRtuListItem).join('');
        }
        elements.rtuCountSpan.textContent = rtuList.length;
    }
    
    function createInspectionListItem(inspection) {
        const rtu = rtuList.find(r => r.id === inspection.rtuId) || { name: '알 수 없음', region: 'N/A' };
        
        let statusClass;
        if (inspection.result === '정상') statusClass = 'bg-green-100 text-green-800';
        else if (inspection.result === '점검필요') statusClass = 'bg-red-100 text-red-800';
        else statusClass = 'bg-yellow-100 text-yellow-800';

        const date = inspection.inspectionDate || inspection.timestamp.split('T')[0];

        return `
            <div class="p-3 border rounded-lg bg-white shadow-sm hover:bg-gray-50 cursor-pointer" 
                 data-id="${inspection.id}" 
                 onclick="showDetailModal('${inspection.id}', 'inspection')">
                <div class="flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-gray-800">${rtu.name} (${rtu.region})</h4>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusClass}">${inspection.result}</span>
                </div>
                <p class="text-sm text-gray-600 mt-1">점검일: ${date} / 점검자: ${inspection.inspector}</p>
                <p class="text-xs text-gray-500 mt-1 truncate">내용: ${inspection.notes || '특이사항 없음'}</p>
            </div>
        `;
    }

    function renderInspectionList() {
        // 최근 기록이 위로 오도록 정렬
        const sortedList = [...inspectionList].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (sortedList.length === 0) {
            elements.inspectionList.innerHTML = '<p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>';
        } else {
            elements.inspectionList.innerHTML = sortedList.map(createInspectionListItem).join('');
        }
        elements.inspectionCountSpan.textContent = inspectionList.length;
    }

    function createRepairListItem(repair) {
        const rtu = rtuList.find(r => r.id === repair.rtuId) || { name: '알 수 없음', region: 'N/A' };

        let statusClass;
        if (repair.status === '완료') statusClass = 'bg-green-100 text-green-800';
        else if (repair.status === '요청') statusClass = 'bg-red-100 text-red-800';
        else statusClass = 'bg-yellow-100 text-yellow-800';
        
        const date = repair.repairDate || repair.timestamp.split('T')[0];

        return `
            <div class="p-3 border rounded-lg bg-white shadow-sm hover:bg-gray-50 cursor-pointer" 
                 data-id="${repair.id}" 
                 onclick="showDetailModal('${repair.id}', 'repair')">
                <div class="flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-gray-800">${rtu.name} (${rtu.region})</h4>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusClass}">${repair.status}</span>
                </div>
                <p class="text-sm text-gray-600 mt-1">처리일: ${date} / 담당자: ${repair.engineer}</p>
                <p class="text-xs text-gray-500 mt-1 truncate">이슈: ${repair.issue || '내용 없음'}</p>
            </div>
        `;
    }

    function renderRepairList() {
        // 최근 기록이 위로 오도록 정렬
        const sortedList = [...repairList].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (sortedList.length === 0) {
            elements.repairList.innerHTML = '<p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>';
        } else {
            elements.repairList.innerHTML = sortedList.map(createRepairListItem).join('');
        }
        elements.repairCountSpan.textContent = repairList.length;
    }

    // ============================ 상세 정보 모달 및 UI 상태 변경 ============================

    function showRtuDetail(rtuId) {
        showDetailModal(rtuId, 'rtu');
    }

    function showDetailModal(id, type) {
        let data, title, contentHtml;
        const rtu = rtuList.find(r => r.id === id);

        if (type === 'rtu') {
            data = rtuList.find(r => r.id === id);
            if (!data) return;
            title = `${data.name} (${data.region}) 상세 정보`;
            
            const imageHtml = `
                <div class="flex space-x-3 mt-4">
                    ${data.imageUrl1 ? `<img src="${data.imageUrl1}" alt="장비 이미지 1" class="w-24 h-24 object-cover rounded-lg">` : ''}
                    ${data.imageUrl2 ? `<img src="${data.imageUrl2}" alt="장비 이미지 2" class="w-24 h-24 object-cover rounded-lg">` : ''}
                    ${data.imageUrl3 ? `<img src="${data.imageUrl3}" alt="장비 이미지 3" class="w-24 h-24 object-cover rounded-lg">` : ''}
                </div>
            `;

            contentHtml = `
                ${imageHtml}
                <p><strong>상태:</strong> <span class="font-bold text-lg ${data.status === '작동중' ? 'text-green-600' : data.status === '점검필요' ? 'text-red-600' : 'text-gray-600'}">${data.status}</span></p>
                <p><strong>등록번호:</strong> ${data.id}</p>
                <p><strong>모델명:</strong> ${data.model || '-'}</p>
                <p><strong>용량:</strong> ${data.capacity || '-'} (냉동톤/kW)</p>
                <p><strong>유닛 종류:</strong> ${data.unitType || '-'}</p>
                <p><strong>냉매:</strong> ${data.refrigerant || '-'}</p>
                <p><strong>전기 종류:</strong> ${data.electricPhase || '-'}</p>
                <p><strong>설치 날짜:</strong> ${data.date || '-'}</p>
                <p><strong>압력 설정 (고/저):</strong> ${data.pressureHighLimit || '-'} PSI / ${data.pressureLowLimit || '-'} PSI</p>
                <p><strong>특이사항:</strong> ${data.notes || '없음'}</p>
                <p class="text-xs text-gray-400">최종 수정: ${data.lastModified ? new Date(data.lastModified).toLocaleString() : '정보 없음'}</p>
            `;
        
        } else if (type === 'inspection') {
            data = inspectionList.find(i => i.id === id);
            if (!data || !rtu) return;
            title = `${rtu.name} 점검 기록 (${data.inspectionDate})`;

            const checkHtml = INSPECTION_CHECK_LABELS.map((label, index) => {
                const key = `check${index + 1}`;
                const result = data[key] || '점검 안됨';
                const color = result.includes('정상') || result.includes('양호') ? 'text-green-600' : 'text-red-600';
                return `<p><span class="w-24 inline-block font-medium">${index + 1}. ${label}</span>: <span class="${color}">${result}</span></p>`;
            }).join('');

            contentHtml = `
                <p><strong>대상 RTU:</strong> ${rtu.name} (${rtu.region})</p>
                <p><strong>점검 날짜:</strong> ${data.inspectionDate}</p>
                <p><strong>점검자:</strong> ${data.inspector}</p>
                <p class="text-lg"><strong>최종 결과:</strong> <span class="font-bold ${data.result === '정상' ? 'text-green-600' : 'text-red-600'}">${data.result}</span></p>
                
                <h4 class="font-bold mt-4 border-t pt-2">부품 점검 상세</h4>
                <div class="grid grid-cols-2 gap-y-1 text-sm">${checkHtml}</div>

                <h4 class="font-bold mt-4 border-t pt-2">운전 상태 측정 (Comp 1)</h4>
                <p>고압: ${data.comp1Hp || '-'} PSI / 저압: ${data.comp1Lp || '-'} PSI / 암페어: ${data.comp1Amp || '-'} A</p>
                ${data.comp2Hp ? `
                    <h4 class="font-bold mt-2">운전 상태 측정 (Comp 2)</h4>
                    <p>고압: ${data.comp2Hp || '-'} PSI / 저압: ${data.comp2Lp || '-'} PSI / 암페어: ${data.comp2Amp || '-'} A</p>
                ` : ''}
                <h4 class="font-bold mt-2">온도 측정</h4>
                <p>과열도: ${data.superheat || '-'} ℉ / 과냉도: ${data.subcool || '-'} ℉ / 증발 온도: ${data.evapTemp || '-'} ℉</p>

                <h4 class="font-bold mt-4 border-t pt-2">특이사항 및 조치 내용</h4>
                <p class="whitespace-pre-wrap">${data.notes || '없음'}</p>
            `;

        } else if (type === 'repair') {
            data = repairList.find(r => r.id === id);
            if (!data || !rtu) return;
            title = `${rtu.name} 수리 기록 (${data.repairDate})`;
            
            const statusClass = data.status === '완료' ? 'text-green-600' : data.status === '요청' ? 'text-red-600' : 'text-yellow-600';

            contentHtml = `
                <p><strong>대상 RTU:</strong> ${rtu.name} (${rtu.region})</p>
                <p><strong>수리 날짜:</strong> ${data.repairDate}</p>
                <p><strong>담당자:</strong> ${data.engineer}</p>
                <p class="text-lg"><strong>처리 상태:</strong> <span class="font-bold ${statusClass}">${data.status}</span></p>
                <h4 class="font-bold mt-4 border-t pt-2">문제 및 조치 내용</h4>
                <p class="whitespace-pre-wrap">${data.issue || '내용 없음'}</p>
            `;
        } else {
            return;
        }

        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = contentHtml;
        elements.detailModal.classList.remove('hidden');
    }
    
    // RTU 수정 모드로 전환 및 데이터 로드
    function loadRtuForModification(rtuId) {
        event.stopPropagation();
        switchRtuMode('modify');
        
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) {
            alert('RTU 정보를 찾을 수 없습니다.');
            switchRtuMode('new');
            return;
        }

        currentRtuIdForModification = rtuId;
        
        // 폼 필드에 값 채우기
        document.getElementById('rtu-id-for-modification').value = rtuId;
        elements.rtuNameInput.value = rtu.name;
        document.getElementById('rtu-region').value = rtu.region;
        document.getElementById('rtu-model').value = rtu.model;
        document.getElementById('rtu-capacity').value = rtu.capacity;
        document.getElementById('rtu-unit-type').value = rtu.unitType;
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant;
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase;
        document.getElementById('rtu-date').value = rtu.date;
        document.getElementById('rtu-status').value = rtu.status;
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit;
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit;
        document.getElementById('rtu-notes').value = rtu.notes;
        
        // RTU ID 수정 방지
        elements.rtuNameInput.readOnly = true; 

        // 이미지 미리보기 업데이트 및 기존 URL을 Hidden 필드에 저장
        elements.imagePreviewContainer.classList.remove('hidden');

        for(let i = 1; i <= 3; i++) {
            const urlKey = `imageUrl${i}`;
            const previewEl = document.getElementById(`image-preview-${i}`);
            let hiddenUrlInput = document.querySelector(`#rtu-form input[name="${urlKey}"]`);

            if (rtu[urlKey]) {
                previewEl.src = rtu[urlKey];
                previewEl.style.display = 'block';
                
                if (!hiddenUrlInput) {
                    hiddenUrlInput = document.createElement('input');
                    hiddenUrlInput.type = 'hidden';
                    hiddenUrlInput.name = urlKey;
                    elements.rtuForm.appendChild(hiddenUrlInput);
                }
                hiddenUrlInput.value = rtu[urlKey];
            } else {
                previewEl.src = '';
                previewEl.style.display = 'none';
                if (hiddenUrlInput) hiddenUrlInput.remove();
            }
            // 파일 input은 초기화 (새 파일을 선택하지 않으면 기존 URL 유지)
            document.getElementById(`rtu-image${i}`).value = '';
        }

        // 해당 탭으로 자동 이동
        document.querySelector('.tab-btn[data-tab="rtu-manage"]').click();
    }
    
    // RTU 등록/수정 모드 전환
    function switchRtuMode(mode) {
        rtuMode = mode;

        if (mode === 'new') {
            elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
            elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
            elements.rtuNameInput.readOnly = false;
            currentRtuIdForModification = null;
            elements.rtuForm.reset(); // 폼 초기화
            elements.imagePreviewContainer.classList.add('hidden');
        } else {
            elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
            elements.rtuSubmitBtn.textContent = 'RTU 정보 수정 및 저장';
            elements.rtuNameInput.readOnly = true; 
        }
    }

    // 이미지 파일 미리보기
    function previewImage(event, index) {
        const file = event.target.files[0];
        const previewEl = document.getElementById(`image-preview-${index}`);

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewEl.src = e.target.result;
                previewEl.style.display = 'block';
                elements.imagePreviewContainer.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        } else {
            previewEl.src = '';
            previewEl.style.display = 'none';
        }

        // 모든 이미지가 없으면 미리보기 컨테이너 숨김
        const hasVisibleImage = Array.from({length: 3}, (_, i) => document.getElementById(`image-preview-${i + 1}`))
                                     .some(img => img.style.display === 'block');
        
        if (!hasVisibleImage) {
            elements.imagePreviewContainer.classList.add('hidden');
        }
    }
    
    // ============================ 대시보드 및 리포트 업데이트 ============================

    function updateDashboard() {
        const total = rtuList.length;
        
        // 상태별 카운트
        const statusCounts = rtuList.reduce((acc, rtu) => {
            acc[rtu.status] = (acc[rtu.status] || 0) + 1;
            return acc;
        }, {});
        
        elements.dashboardTotal.textContent = total;
        elements.dashboardRunning.textContent = statusCounts['작동중'] || 0;
        elements.dashboardStopped.textContent = statusCounts['정지됨'] || 0;
        elements.dashboardNeedsInspection.textContent = statusCounts['점검필요'] || 0;
        
        // 최근 처리 현황
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthlyInspection = inspectionList.filter(i => new Date(i.timestamp) >= startOfMonth).length;
        const pendingRepair = repairList.filter(r => r.status === '요청').length;
        
        elements.dashboardMonthlyInspection.textContent = monthlyInspection;
        elements.dashboardPendingRepair.textContent = pendingRepair;
        
        // 최근 등록/수정 목록 (5개)
        const latestRtuList = [...rtuList]
            .sort((a, b) => new Date(b.lastModified || 0) - new Date(a.lastModified || 0)) // lastModified가 없는 경우 대비
            .slice(0, 5);

        if (latestRtuList.length === 0) {
            elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
        } else {
            elements.dashboardLatestList.innerHTML = latestRtuList.map(rtu => {
                let statusClass;
                if (rtu.status === '작동중') statusClass = 'bg-green-100 text-green-800';
                else if (rtu.status === '점검필요') statusClass = 'bg-red-100 text-red-800';
                else statusClass = 'bg-gray-100 text-gray-800';
                
                return `
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusClass}">${rtu.status}</span>
                    </div>
                `;
            }).join('');
        }

        // 리포트 페이지 업데이트
        elements.reportTotalRtu.textContent = total;
        elements.reportTotalInspection.textContent = inspectionList.length;
        elements.reportTotalRepair.textContent = repairList.length;
    }
    
    // 점검/수리 폼의 RTU 선택 박스 채우기
    function populateRtuSelects() {
        const optionsHtml = rtuList.map(rtu => 
            `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`
        ).join('');

        elements.inspectionRtuSelect.innerHTML = `<option value="">-- RTU를 선택하세요 --</option>` + optionsHtml;
        elements.repairRtuSelect.innerHTML = `<option value="">-- RTU를 선택하세요 --</option>` + optionsHtml;
    }

    // ============================ 탭 전환 및 데이터 처리 ============================

    elements.tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // 탭 스타일 초기화 및 적용
            elements.tabButtons.forEach(b => {
                b.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
                b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            btn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
            btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

            // 페이지 숨김/표시
            document.querySelectorAll('.tab-page').forEach(page => {
                page.classList.add('hidden');
            });

            const targetTab = btn.getAttribute('data-tab');
            document.getElementById(targetTab).classList.remove('hidden');

            // 탭 전환 시 각 목록을 다시 렌더링
            if (targetTab === 'rtu-manage') renderRtuList();
            if (targetTab === 'inspection-manage') renderInspectionList();
            if (targetTab === 'repair-manage') renderRepairList();
            if (targetTab === 'dashboard' || targetTab === 'report-page') updateDashboard();
        });
    });

    // CSV 다운로드 핸들러
    elements.downloadDataBtn.addEventListener('click', function() {
        if (confirm("RTU, 점검, 수리 데이터를 모두 CSV 파일로 다운로드하시겠습니까?")) {
            downloadCsv(rtuList, 'rtu');
            downloadCsv(inspectionList, 'inspection');
            downloadCsv(repairList, 'repair');
            alert('3개의 데이터 파일 다운로드가 완료되었습니다.');
        }
    });
    
    // CSV 생성 및 다운로드 함수
    function downloadCsv(list, type) {
        if (list.length === 0) return;

        // 1. 헤더 생성
        const headers = Object.keys(list[0]);
        let csv = headers.map(header => `"${header}"`).join(',') + '\n';
        
        // 2. 데이터 행 생성
        list.forEach(item => {
            const row = headers.map(header => {
                let value = item[header] || '';
                // 텍스트 필드의 따옴표 및 줄바꿈 처리
                value = String(value).replace(/"/g, '""');
                return `"${value}"`;
            }).join(',');
            csv += row + '\n';
        });

        // 3. 파일로 다운로드
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // 파일 이름 설정
        const now = new Date();
        const filename = `${type}_data_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}T${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}-${now.getSeconds().toString().padStart(2, '0')}.csv`;

        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // CSV 업로드 핸들러
    function handleDataUpload(event) {
        const files = event.target.files;
        if (files.length === 0) return;

        if (!confirm(`${files.length}개의 파일을 로컬 저장소에 업로드 및 덮어쓰기 하시겠습니까? (기존 데이터가 손실될 수 있습니다)`)) {
            event.target.value = '';
            return;
        }

        let uploadedCount = 0;
        let successCount = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedCount++;
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    console.warn(`${file.name}: 내용이 부족합니다. 스킵합니다.`);
                    return;
                }

                // 1. 헤더 파싱 (첫 번째 줄)
                const headerLine = lines[0].replace(/"/g, '');
                let targetKey = null;
                if (headerLine.includes('rtuId') && headerLine.includes('issue')) {
                    targetKey = STORAGE_KEYS.REPAIR;
                } else if (headerLine.includes('rtuId') && headerLine.includes('inspector')) {
                    targetKey = STORAGE_KEYS.INSPECTION;
                } else if (headerLine.includes('region') && headerLine.includes('unitType')) {
                    targetKey = STORAGE_KEYS.RTU;
                } 

                if (!targetKey) {
                    console.warn(`${file.name}: 파일 유형을 식별할 수 없습니다. 스킵합니다.`);
                    return;
                }

                const headers = headerLine.split(',').map(h => h.trim());

                // 2. 데이터 파싱
                const newList = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line.trim()) continue;

                    // 정규식을 사용하여 따옴표 안의 콤마 무시하며 값 분리
                    const values = line.match(/(?:"[^"]*"|[^,]+)/g) || [];
                    
                    if (values.length !== headers.length) {
                        console.warn(`Line ${i+1} of ${file.name} has column mismatch. Skipping.`);
                        continue;
                    }
                    
                    const item = {};
                    values.forEach((val, index) => {
                        let cleanVal = val.replace(/^"|"$/g, '').replace(/""/g, '"').trim();
                        if (cleanVal === 'null' || cleanVal === 'undefined') {
                            cleanVal = '';
                        }
                        item[headers[index]] = cleanVal;
                    });
                    // 필수 ID 필드 확인
                    if (!item.id || item.id === 'id') continue; 
                    newList.push(item);
                }
                
                // 3. 데이터 저장
                if (targetKey === STORAGE_KEYS.RTU) {
                    rtuList = newList;
                    saveList(STORAGE_KEYS.RTU, rtuList);
                } else if (targetKey === STORAGE_KEYS.INSPECTION) {
                    inspectionList = newList;
                    saveList(STORAGE_KEYS.INSPECTION, inspectionList);
                } else if (targetKey === STORAGE_KEYS.REPAIR) {
                    repairList = newList;
                    saveList(STORAGE_KEYS.REPAIR, repairList);
                }
                
                successCount++;
                
                // 4. 모든 파일 처리가 끝나면 UI 업데이트
                if (uploadedCount === files.length) {
                    alert(`${successCount}개의 데이터 파일 업로드가 완료되었습니다.\n(RTU, 점검, 수리 데이터가 갱신되었습니다.)`);
                    updateAllUI();
                    // 현재 활성화된 탭을 다시 클릭하여 목록을 새로고침
                    document.querySelector('.tab-btn.tab-active').click();
                }
            };
            reader.readAsText(file, 'utf-8');
        });
        
        event.target.value = ''; // 파일 입력 초기화
    }

    function updateAllUI() {
        // 모든 리스트를 로컬 저장소에서 새로 로드하여 최신 상태를 반영
        rtuList = loadList(STORAGE_KEYS.RTU);
        inspectionList = loadList(STORAGE_KEYS.INSPECTION);
        repairList = loadList(STORAGE_KEYS.REPAIR);

        updateDashboard();
        populateRtuSelects();
        renderRtuList();
        // 나머지 목록은 탭 전환 시 렌더링됨
    }


    // ============================ 페이지 초기화 ============================
    document.addEventListener('DOMContentLoaded', function() {
        
        updateAllUI();
        
        // 초기 날짜 설정
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rtu-date').value = today;
        document.getElementById('inspection-date').value = today;
        document.getElementById('repair-date').value = today;
        
        // 초기 탭 설정 (대시보드를 먼저 보여줌)
        document.getElementById('dashboard').classList.remove('hidden');
        
        // --- 모달 이벤트 리스너 ---
        elements.closeModalBtn.addEventListener('click', () => { 
            elements.detailModal.classList.add('hidden');
        });

        elements.detailModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-bg')) {
                elements.detailModal.classList.add('hidden');
            }
        });

        // --- CSV 업로드 리스너 ---
        elements.csvUploadInput.addEventListener('change', handleDataUpload);
    });
  </script>
</body>
</html>