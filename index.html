<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase + 테스트 데이터 포함)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">RTU 통합 관리 시스템</h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
             <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
                CSV 업로드
            </label>
            <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file" onchange="handleDataUpload(event)">

            <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm" onclick="exportAllCSV()">데이터 CSV 다운로드</button>
        </div>
      </div>

      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard" onclick="switchTab('dashboard')">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage" onclick="switchTab('rtu-manage')">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage" onclick="switchTab('inspection-manage')">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage" onclick="switchTab('repair-manage')">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page" onclick="switchTab('report-page')">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>

          <!-- 🔄 테스트 데이터 생성 버튼 -->
          <div class="mt-6 text-center">
            <button onclick="generateSampleData()" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition">
              🔄 테스트용 기본 데이터 생성
            </button>
            <p class="text-sm text-gray-500 mt-1">(Firebase에 샘플 RTU / 점검 / 수리 데이터가 자동 추가됩니다)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688",
      measurementId: "G-L58S7K0264"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    function snapObjToArray(obj){ return obj ? Object.keys(obj).map(k=>({ ...obj[k], id:k })) : []; }

    onValue(ref(db,'rtuList'), snap=>{ rtuList = snapObjToArray(snap.val()); renderDashboard(); });
    onValue(ref(db,'inspectionList'), snap=>{ inspectionList = snapObjToArray(snap.val()); renderDashboard(); });
    onValue(ref(db,'repairList'), snap=>{ repairList = snapObjToArray(snap.val()); renderDashboard(); });

    async function saveRtuToDB(rtu){ if(!rtu.id) rtu.id='RTU-'+Date.now(); await set(ref(db,`rtuList/${rtu.id}`),rtu); }
    async function saveInspectionToDB(ins){ if(!ins.id) ins.id='INS-'+Date.now(); await set(ref(db,`inspectionList/${ins.id}`),ins); }
    async function saveRepairToDB(rep){ if(!rep.id) rep.id='REP-'+Date.now(); await set(ref(db,`repairList/${rep.id}`),rep); }

    window.generateSampleData = async function(){
      const sampleRtu=[
        {id:'RTU-001',name:'서울-01',region:'서울',status:'작동중',model:'GMX-1000',capacity:'10RT',date:new Date().toISOString()},
        {id:'RTU-002',name:'부산-02',region:'부산',status:'정지됨',model:'GMX-800',capacity:'8RT',date:new Date().toISOString()},
        {id:'RTU-003',name:'대전-03',region:'대전',status:'점검필요',model:'GMX-500',capacity:'5RT',date:new Date().toISOString()}
      ];
      const sampleInspection=[
        {id:'INS-001',rtuId:'RTU-001',inspectionDate:'2025-10-01',inspector:'김점검',result:'정상',notes:'팬 작동 양호'},
        {id:'INS-002',rtuId:'RTU-002',inspectionDate:'2025-09-25',inspector:'박엔지니어',result:'주의',notes:'필터 오염'},
        {id:'INS-003',rtuId:'RTU-003',inspectionDate:'2025-10-10',inspector:'이테스트',result:'불량',notes:'컴프레서 이상'}
      ];
      const sampleRepair=[
        {id:'REP-001',rtuId:'RTU-003',repairDate:'2025-10-15',engineer:'조수리',status:'진행중',issue:'압축기 교체 예정'},
        {id:'REP-002',rtuId:'RTU-002',repairDate:'2025-09-27',engineer:'최수리',status:'완료',issue:'필터 교체 완료'},
        {id:'REP-003',rtuId:'RTU-001',repairDate:'2025-09-20',engineer:'김정비',status:'완료',issue:'냉매 보충'}
      ];
      for(const r of sampleRtu) await saveRtuToDB(r);
      for(const i of sampleInspection) await saveInspectionToDB(i);
      for(const rp of sampleRepair) await saveRepairToDB(rp);
      alert('✅ 테스트 데이터가 Firebase에 추가되었습니다!');
    }

    function renderDashboard(){
      document.getElementById('dashboard-total').textContent = rtuList.length;
      document.getElementById('dashboard-running').textContent = rtuList.filter(r=>r.status==='작동중').length;
      document.getElementById('dashboard-stopped').textContent = rtuList.filter(r=>r.status==='정지됨').length;
      document.getElementById('dashboard-needs-inspection').textContent = rtuList.filter(r=>r.status==='점검필요').length;
      document.getElementById('dashboard-monthly-inspection').textContent = inspectionList.length;
      document.getElementById('dashboard-pending-repair').textContent = repairList.filter(r=>r.status!=='완료').length;
      const latest=document.getElementById('dashboard-latest-list');
      if(!rtuList.length){ latest.innerHTML='<p class="text-gray-500">등록된 장비가 없습니다.</p>'; return; }
      latest.innerHTML=rtuList.map(r=>`<div class='flex justify-between items-center border-b pb-2'><span>${r.name} (${r.region})</span><span class='text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full'>${r.status}</span></div>`).join('');
    }

    window.switchTab=function(tab){ document.querySelectorAll('.tab-page').forEach(e=>e.classList.add('hidden')); document.getElementById(tab).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active','border-blue-500','text-blue-600')); document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('tab-active','border-blue-500','text-blue-600'); };
  </script>
</body>
</html>
