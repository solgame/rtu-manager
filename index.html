<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase Cloud 버전)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    /* 활성화된 탭 스타일 */
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    /* 로딩 인디케이터 */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">RTU 통합 관리 시스템</h1>
        <div class="flex space-x-2">
            <button id="export-data" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-3 py-1.5 rounded-lg text-sm font-medium transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                데이터 내보내기 (JSON)
            </button>
            <label for="import-file" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-3 py-1.5 rounded-lg text-sm font-medium cursor-pointer transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                데이터 불러오기 (JSON)
            </label>
            <input type="file" id="import-file" accept=".json" class="hidden-file" onchange="importData(event)"/>
        </div>
      </div>

      <!-- 탭 네비게이션 -->
      <nav class="flex space-x-4 border-b">
        <button onclick="changeTab('dashboard', this)" class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 tab-active" data-tab="dashboard">대시보드</button>
        <button onclick="changeTab('rtu-manage', this)" class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 관리</button>
        <button onclick="changeTab('inspection-manage', this)" class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 관리</button>
        <button onclick="changeTab('repair-manage', this)" class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 관리</button>
        <button onclick="changeTab('report-page', this)" class="tab-button border-b-2 border-transparent px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
      </nav>

      <!-- 로딩 인디케이터 -->
      <div id="loading-indicator" class="mt-8 text-center hidden">
          <div class="loader"></div>
          <p class="text-sm text-gray-500 mt-3">데이터를 불러오는 중...</p>
      </div>

      <!-- 1. 대시보드 탭 -->
      <div id="dashboard" class="mt-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">통합 현황 대시보드</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- 총 RTU 개수 -->
          <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-100">
            <p class="text-sm font-medium text-blue-600">총 RTU 개수</p>
            <p id="stat-total-rtu" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
          </div>
          <!-- 점검 예정/필요 RTU -->
          <div class="bg-amber-50 p-4 rounded-xl shadow-md border border-amber-100">
            <p class="text-sm font-medium text-amber-600">점검 예정/필요</p>
            <p id="stat-inspection-needed" class="text-3xl font-extrabold text-amber-900 mt-1">0</p>
          </div>
          <!-- 수리 필요 RTU -->
          <div class="bg-red-50 p-4 rounded-xl shadow-md border border-red-100">
            <p class="text-sm font-medium text-red-600">수리 필요</p>
            <p id="stat-repair-needed" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
          </div>
          <!-- 가동률 (%) -->
          <div class="bg-green-50 p-4 rounded-xl shadow-md border border-green-100">
            <p class="text-sm font-medium text-green-600">평균 가동률 (%)</p>
            <p id="stat-avg-uptime" class="text-3xl font-extrabold text-green-900 mt-1">0%</p>
          </div>
        </div>

        <h3 class="text-xl font-bold mt-8 mb-3 border-b pb-2 text-gray-800">RTU 목록 및 상태</h3>
        <div id="dashboard-rtu-list" class="space-y-3">
            <!-- RTU 리스트가 여기에 렌더링 됩니다 -->
            <p id="loading-rtu-message" class="text-gray-500">RTU 목록을 불러오는 중입니다...</p>
        </div>
      </div>

      <!-- 2. RTU 관리 탭 -->
      <div id="rtu-manage" class="mt-8 hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">RTU 등록 및 수정</h2>
        <form id="rtu-form" class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
          <input type="hidden" id="rtu-id">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="rtu-code" class="block text-sm font-medium text-gray-700 mb-1">RTU 코드 (고유 번호)</label>
              <input type="text" id="rtu-code" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="rtu-location" class="block text-sm font-medium text-gray-700 mb-1">설치 위치</label>
              <input type="text" id="rtu-location" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="rtu-model" class="block text-sm font-medium text-gray-700 mb-1">모델명</label>
              <input type="text" id="rtu-model" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="rtu-install-date" class="block text-sm font-medium text-gray-700 mb-1">설치일자</label>
              <input type="date" id="rtu-install-date" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="rtu-status" class="block text-sm font-medium text-gray-700 mb-1">현재 상태</label>
              <select id="rtu-status" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                <option value="정상">정상</option>
                <option value="점검 필요">점검 필요</option>
                <option value="수리 필요">수리 필요</option>
                <option value="가동 중지">가동 중지</option>
              </select>
            </div>
            <div>
              <label for="rtu-uptime" class="block text-sm font-medium text-gray-700 mb-1">평균 가동률 (%)</label>
              <input type="number" id="rtu-uptime" min="0" max="100" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- 이미지 파일 업로드 -->
            <div class="col-span-full">
                <label for="rtu-image" class="block text-sm font-medium text-gray-700 mb-1">RTU 설치 사진</label>
                <input type="file" id="rtu-image" accept="image/*" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <div id="rtu-image-preview" class="mt-3">
                    <!-- 이미지 미리보기 표시 영역 -->
                </div>
            </div>

          </div>
          
          <div class="mt-6 flex space-x-3 justify-end">
            <button type="button" onclick="resetRtuForm()" class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-lg font-medium transition duration-150">새 RTU 등록</button>
            <button type="submit" id="rtu-submit-btn" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-300/50 transition duration-150">RTU 등록</button>
          </div>
        </form>

        <h3 class="text-xl font-bold mt-8 mb-3 border-b pb-2 text-gray-800">RTU 목록</h3>
        <div id="rtu-list" class="space-y-3">
          <!-- RTU 목록이 여기에 렌더링 됩니다 -->
        </div>
      </div>

      <!-- 3. 점검 관리 탭 -->
      <div id="inspection-manage" class="mt-8 hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">점검 기록 등록 및 관리</h2>
        <form id="inspection-form" class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
          <input type="hidden" id="inspection-id">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700 mb-1">RTU 코드 선택</label>
              <select id="inspection-rtu-id" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                <!-- RTU 코드 옵션이 여기에 로드됩니다 -->
              </select>
            </div>
            <div>
              <label for="inspection-date" class="block text-sm font-medium text-gray-700 mb-1">점검 일자</label>
              <input type="date" id="inspection-date" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div class="md:col-span-2">
              <label for="inspection-details" class="block text-sm font-medium text-gray-700 mb-1">점검 상세 내용</label>
              <textarea id="inspection-details" rows="3" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></textarea>
            </div>
            <div>
              <label for="inspection-result" class="block text-sm font-medium text-gray-700 mb-1">점검 결과</label>
              <select id="inspection-result" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                <option value="정상">정상</option>
                <option value="재점검 필요">재점검 필요</option>
                <option value="수리 필요">수리 필요</option>
              </select>
            </div>
            <div>
              <label for="inspection-inspector" class="block text-sm font-medium text-gray-700 mb-1">점검 담당자</label>
              <input type="text" id="inspection-inspector" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
          </div>

          <div class="mt-6 flex space-x-3 justify-end">
            <button type="button" onclick="resetInspectionForm()" class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-lg font-medium transition duration-150">새 점검 등록</button>
            <button type="submit" id="inspection-submit-btn" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-300/50 transition duration-150">점검 기록 등록</button>
          </div>
        </form>

        <h3 class="text-xl font-bold mt-8 mb-3 border-b pb-2 text-gray-800">점검 기록 목록</h3>
        <div id="inspection-list" class="space-y-3">
          <!-- 점검 목록이 여기에 렌더링 됩니다 -->
        </div>
      </div>

      <!-- 4. 수리 관리 탭 -->
      <div id="repair-manage" class="mt-8 hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">수리 기록 등록 및 관리</h2>
        <form id="repair-form" class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
          <input type="hidden" id="repair-id">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700 mb-1">RTU 코드 선택</label>
              <select id="repair-rtu-id" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                <!-- RTU 코드 옵션이 여기에 로드됩니다 -->
              </select>
            </div>
            <div>
              <label for="repair-date" class="block text-sm font-medium text-gray-700 mb-1">수리 일자</label>
              <input type="date" id="repair-date" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div class="md:col-span-2">
              <label for="repair-details" class="block text-sm font-medium text-gray-700 mb-1">수리 상세 내용 및 부품 교체 내역</label>
              <textarea id="repair-details" rows="3" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></textarea>
            </div>
            <div>
              <label for="repair-cost" class="block text-sm font-medium text-gray-700 mb-1">수리 비용 (원)</label>
              <input type="number" id="repair-cost" min="0" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="repair-technician" class="block text-sm font-medium text-gray-700 mb-1">수리 담당자</label>
              <input type="text" id="repair-technician" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            </div>
          </div>

          <div class="mt-6 flex space-x-3 justify-end">
            <button type="button" onclick="resetRepairForm()" class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-lg font-medium transition duration-150">새 수리 등록</button>
            <button type="submit" id="repair-submit-btn" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-300/50 transition duration-150">수리 기록 등록</button>
          </div>
        </form>

        <h3 class="text-xl font-bold mt-8 mb-3 border-b pb-2 text-gray-800">수리 기록 목록</h3>
        <div id="repair-list" class="space-y-3">
          <!-- 수리 목록이 여기에 렌더링 됩니다 -->
        </div>
      </div>

      <!-- 5. 보고서 탭 -->
      <div id="report-page" class="mt-8 hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">보고서 생성</h2>
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="report-rtu-id" class="block text-sm font-medium text-gray-700 mb-1">RTU 선택</label>
              <select id="report-rtu-id" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <option value="all">전체 RTU</option>
                <!-- RTU 코드 옵션이 여기에 로드됩니다 -->
              </select>
            </div>
            <div>
              <label for="report-duration" class="block text-sm font-medium text-gray-700 mb-1">기간 선택</label>
              <select id="report-duration" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <option value="all">전체 기간</option>
                <option value="last_month">지난 1개월</option>
                <option value="last_3_months">지난 3개월</option>
                <option value="last_6_months">지난 6개월</option>
                <option value="last_year">지난 1년</option>
              </select>
            </div>
          </div>
          <button onclick="generateReport()" class="mt-4 bg-green-600 text-white hover:bg-green-700 px-4 py-2 rounded-lg font-bold shadow-md shadow-green-300/50 transition duration-150">보고서 생성</button>
        </div>
        
        <div id="report-output" class="mt-8 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
          <h3 class="text-xl font-bold mb-3 text-gray-800">생성된 보고서 요약</h3>
          <p id="report-summary" class="text-gray-500">조건을 선택하고 '보고서 생성' 버튼을 눌러주세요.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 상세 정보 모달 (Modal) -->
  <div id="detail-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl w-11/12 md:max-w-xl mx-auto shadow-2xl p-6 relative">
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-3">
        <!-- 상세 내용이 여기에 로드됩니다 -->
      </div>
    </div>
  </div>

  <!-- JavaScript Modules (Firebase v9) -->
  <script type="module">
    // Firebase SDK v9+ Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        onSnapshot, 
        doc, 
        setDoc, 
        deleteDoc, 
        getDocs
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL, 
        deleteObject 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";


    // ============================
    // Firebase 초기화 설정 (고객님의 설정 정보)
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.appspot.com", // storageBucket은 firebasestorage.app이 아닌 appspot.com 형식으로 사용됩니다.
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:06932b3da09391c9b0c688",
      measurementId: "G-C2MDK46FFF"
    };

    // Firebase 초기화 및 서비스 가져오기
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ============================
    // Global Data and Variables
    // ============================
    const elements = {
        rtuList: document.getElementById('rtu-list'),
        inspectionList: document.getElementById('inspection-list'),
        repairList: document.getElementById('repair-list'),
        rtuForm: document.getElementById('rtu-form'),
        inspectionForm: document.getElementById('inspection-form'),
        repairForm: document.getElementById('repair-form'),
        rtuImagePreview: document.getElementById('rtu-image-preview'),
        dashboardRtuList: document.getElementById('dashboard-rtu-list'),
        inspectionRtuId: document.getElementById('inspection-rtu-id'),
        repairRtuId: document.getElementById('repair-rtu-id'),
        reportRtuId: document.getElementById('report-rtu-id'),
        detailModal: document.getElementById('detail-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        modalTitle: document.getElementById('modal-title'),
        modalContent: document.getElementById('modal-content'),
        loadingIndicator: document.getElementById('loading-indicator'),
    };
    
    let rtuData = [];
    let inspectionData = [];
    let repairData = [];
    let currentRtuImageURL = null; // 수정 시 기존 이미지 URL 저장
    let currentModalData = { id: null, type: null }; // 현재 모달에 표시된 데이터

    // ============================
    // Utility Functions (유틸리티 함수)
    // ============================

    // Firebase Storage에 파일 업로드
    async function uploadRtuImage(file, rtuCode) {
        if (!file) return null;
        
        const storageRef = ref(storage, `rtu-images/${rtuCode}/${file.name}`);
        
        // 파일을 업로드하고 업로드 완료 대기
        const snapshot = await uploadBytes(storageRef, file);
        
        // 다운로드 URL 반환
        return await getDownloadURL(snapshot.ref);
    }

    // Firebase Storage에서 파일 삭제
    async function deleteRtuImage(imageUrl) {
        if (!imageUrl) return;
        try {
            const imageRef = ref(storage, imageUrl);
            await deleteObject(imageRef);
            console.log("Image deleted successfully:", imageUrl);
        } catch (error) {
            // 파일이 존재하지 않아도 무시
            if (error.code !== 'storage/object-not-found') {
                console.error("Error deleting image:", error);
            }
        }
    }

    // ============================
    // CRUD Functions (RTU, 점검, 수리)
    // ============================

    // RTU 데이터 저장/업데이트
    async function saveRtu(e) {
        e.preventDefault();
        elements.loadingIndicator.classList.remove('hidden');

        const id = document.getElementById('rtu-id').value || doc(collection(db, "rtu")).id;
        const code = document.getElementById('rtu-code').value;
        const location = document.getElementById('rtu-location').value;
        const model = document.getElementById('rtu-model').value;
        const installDate = document.getElementById('rtu-install-date').value;
        const status = document.getElementById('rtu-status').value;
        const uptime = parseFloat(document.getElementById('rtu-uptime').value);
        const imageFile = document.getElementById('rtu-image').files[0];
        let imageUrl = currentRtuImageURL; // 기존 이미지 URL 유지

        try {
            // 1. 이미지 처리
            if (imageFile) {
                // 새 파일이 있으면 기존 이미지 삭제 후 새 이미지 업로드
                if (currentRtuImageURL && currentRtuImageURL !== 'placeholder') {
                    await deleteRtuImage(currentRtuImageURL);
                }
                imageUrl = await uploadRtuImage(imageFile, code);
            } else if (!imageUrl) {
                // 이미지 파일이 없고 기존 URL도 없으면 placeholder URL 사용
                imageUrl = 'placeholder'; 
            }

            const data = {
                code,
                location,
                model,
                installDate,
                status,
                uptime,
                imageUrl,
                updatedAt: new Date().toISOString()
            };

            // 2. Firestore 저장 (setDoc 사용)
            await setDoc(doc(db, "rtu", id), data);

            showMessage('RTU 정보가 성공적으로 저장되었습니다!', 'bg-green-500');
            resetRtuForm();
        } catch (error) {
            console.error("RTU 저장 중 오류 발생: ", error);
            showMessage('RTU 저장 중 오류가 발생했습니다.', 'bg-red-500');
        } finally {
            elements.loadingIndicator.classList.add('hidden');
        }
    }

    // RTU 데이터 삭제
    async function deleteRtu(id, code, imageUrl) {
        if (!window.confirm(`RTU 코드 [${code}]를 정말로 삭제하시겠습니까? 관련 점검/수리 기록도 삭제됩니다.`)) return;

        elements.loadingIndicator.classList.remove('hidden');
        try {
            // 1. Firestore에서 RTU 문서 삭제
            await deleteDoc(doc(db, "rtu", id));
            
            // 2. Storage에서 이미지 삭제
            if (imageUrl && imageUrl !== 'placeholder') {
                await deleteRtuImage(imageUrl);
            }

            // 3. 관련 점검/수리 기록 삭제 (RTU ID를 기준으로 쿼리하여 삭제)
            await deleteRelatedRecords("inspection", id);
            await deleteRelatedRecords("repair", id);
            
            showMessage('RTU 및 관련 기록이 성공적으로 삭제되었습니다.', 'bg-green-500');
        } catch (error) {
            console.error("RTU 삭제 중 오류 발생: ", error);
            showMessage('RTU 삭제 중 오류가 발생했습니다.', 'bg-red-500');
        } finally {
            elements.loadingIndicator.classList.add('hidden');
        }
    }

    // 관련 기록 삭제 유틸리티
    async function deleteRelatedRecords(collectionName, rtuId) {
        const q = query(collection(db, collectionName), where('rtuId', '==', rtuId));
        const querySnapshot = await getDocs(q);
        const deletePromises = [];
        querySnapshot.forEach((document) => {
            deletePromises.push(deleteDoc(doc(db, collectionName, document.id)));
        });
        await Promise.all(deletePromises);
    }
    
    // 점검 기록 저장/업데이트
    async function saveInspection(e) {
        e.preventDefault();
        elements.loadingIndicator.classList.remove('hidden');

        const id = document.getElementById('inspection-id').value || doc(collection(db, "inspection")).id;
        const rtuId = document.getElementById('inspection-rtu-id').value;
        const date = document.getElementById('inspection-date').value;
        const details = document.getElementById('inspection-details').value;
        const result = document.getElementById('inspection-result').value;
        const inspector = document.getElementById('inspection-inspector').value;

        try {
            const data = {
                rtuId,
                date,
                details,
                result,
                inspector,
                updatedAt: new Date().toISOString()
            };

            await setDoc(doc(db, "inspection", id), data);

            // 점검 결과에 따라 RTU 상태 업데이트
            const rtuStatus = result === '수리 필요' ? '수리 필요' : (result === '재점검 필요' ? '점검 필요' : '정상');
            await setDoc(doc(db, "rtu", rtuId), { status: rtuStatus }, { merge: true });

            showMessage('점검 기록이 성공적으로 저장되었습니다!', 'bg-green-500');
            resetInspectionForm();
        } catch (error) {
            console.error("점검 저장 중 오류 발생: ", error);
            showMessage('점검 저장 중 오류가 발생했습니다.', 'bg-red-500');
        } finally {
            elements.loadingIndicator.classList.add('hidden');
        }
    }
    
    // 수리 기록 저장/업데이트
    async function saveRepair(e) {
        e.preventDefault();
        elements.loadingIndicator.classList.remove('hidden');

        const id = document.getElementById('repair-id').value || doc(collection(db, "repair")).id;
        const rtuId = document.getElementById('repair-rtu-id').value;
        const date = document.getElementById('repair-date').value;
        const details = document.getElementById('repair-details').value;
        const cost = parseFloat(document.getElementById('repair-cost').value);
        const technician = document.getElementById('repair-technician').value;

        try {
            const data = {
                rtuId,
                date,
                details,
                cost,
                technician,
                updatedAt: new Date().toISOString()
            };

            await setDoc(doc(db, "repair", id), data);

            // 수리가 완료되었으므로 RTU 상태를 '정상'으로 업데이트
            await setDoc(doc(db, "rtu", rtuId), { status: '정상' }, { merge: true });

            showMessage('수리 기록이 성공적으로 저장되었습니다!', 'bg-green-500');
            resetRepairForm();
        } catch (error) {
            console.error("수리 저장 중 오류 발생: ", error);
            showMessage('수리 저장 중 오류가 발생했습니다.', 'bg-red-500');
        } finally {
            elements.loadingIndicator.classList.add('hidden');
        }
    }


    // ============================
    // Data Loading (Firestore Snapshot)
    // ============================

    // Firestore에서 실시간 데이터 구독 및 동기화
    function setupRealtimeListeners() {
        elements.loadingIndicator.classList.remove('hidden');
        
        // RTU 컬렉션 구독
        onSnapshot(collection(db, "rtu"), (snapshot) => {
            rtuData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRtuList();
            populateRtuSelects();
            updateDashboard();
            elements.loadingIndicator.classList.add('hidden');
        }, (error) => {
            console.error("Error listening to RTU data:", error);
            showMessage('RTU 데이터 로딩 중 오류 발생.', 'bg-red-500');
            elements.loadingIndicator.classList.add('hidden');
        });

        // 점검 컬렉션 구독
        onSnapshot(collection(db, "inspection"), (snapshot) => {
            inspectionData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderInspectionList();
            updateDashboard();
        }, (error) => {
            console.error("Error listening to Inspection data:", error);
        });

        // 수리 컬렉션 구독
        onSnapshot(collection(db, "repair"), (snapshot) => {
            repairData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRepairList();
            updateDashboard();
        }, (error) => {
            console.error("Error listening to Repair data:", error);
        });
    }


    // ============================
    // UI Rendering Functions (렌더링)
    // ============================

    // 대시보드 통계 업데이트
    function updateDashboard() {
        const totalRtu = rtuData.length;
        const inspectionNeeded = rtuData.filter(r => r.status === '점검 필요').length;
        const repairNeeded = rtuData.filter(r => r.status === '수리 필요').length;
        const totalUptime = rtuData.reduce((sum, r) => sum + (r.uptime || 0), 0);
        const avgUptime = totalRtu > 0 ? (totalUptime / totalRtu).toFixed(1) : 0;

        document.getElementById('stat-total-rtu').textContent = totalRtu;
        document.getElementById('stat-inspection-needed').textContent = inspectionNeeded;
        document.getElementById('stat-repair-needed').textContent = repairNeeded;
        document.getElementById('stat-avg-uptime').textContent = `${avgUptime}%`;

        // 대시보드 RTU 리스트 렌더링
        const dashboardListHTML = rtuData.sort((a, b) => a.code.localeCompare(b.code))
            .map(rtu => {
                const statusClass = {
                    '정상': 'bg-green-100 text-green-800 border-green-300',
                    '점검 필요': 'bg-amber-100 text-amber-800 border-amber-300',
                    '수리 필요': 'bg-red-100 text-red-800 border-red-300',
                    '가동 중지': 'bg-gray-100 text-gray-800 border-gray-300',
                }[rtu.status] || 'bg-gray-100 text-gray-800 border-gray-300';

                return `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold text-gray-900">${rtu.code} - ${rtu.location}</p>
                            <p class="text-sm text-gray-500 truncate">${rtu.model} | 설치: ${rtu.installDate}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass} border">
                                ${rtu.status} (${rtu.uptime}%)
                            </span>
                            <button onclick="showDetailModal('${rtu.id}', 'rtu')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">상세 보기</button>
                        </div>
                    </div>
                `;
            }).join('');

        elements.dashboardRtuList.innerHTML = dashboardListHTML || '<p class="text-gray-500">등록된 RTU가 없습니다.</p>';
    }

    // RTU 관리 목록 렌더링
    function renderRtuList() {
        const listHTML = rtuData.sort((a, b) => a.code.localeCompare(b.code))
            .map(rtu => {
                const thumbUrl = rtu.imageUrl && rtu.imageUrl !== 'placeholder' 
                    ? rtu.imageUrl 
                    : 'https://placehold.co/96x72/e5e7eb/6b7280?text=NO+IMG';

                return `
                    <div class="flex items-center space-x-4 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <img src="${thumbUrl}" class="thumb" alt="RTU 이미지" onerror="this.onerror=null;this.src='https://placehold.co/96x72/e5e7eb/6b7280?text=NO+IMG';" loading="lazy">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold text-gray-900">${rtu.code} (${rtu.model})</p>
                            <p class="text-sm text-gray-500 truncate">위치: ${rtu.location} | 상태: ${rtu.status}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editRtu('${rtu.id}')" class="text-amber-600 hover:text-amber-800 text-sm font-medium">수정</button>
                            <button onclick="deleteRtu('${rtu.id}', '${rtu.code}', '${rtu.imageUrl || ''}')" class="text-red-600 hover:text-red-800 text-sm font-medium">삭제</button>
                        </div>
                    </div>
                `;
            }).join('');

        elements.rtuList.innerHTML = listHTML || '<p class="text-gray-500">등록된 RTU가 없습니다.</p>';
    }

    // 점검 관리 목록 렌더링
    function renderInspectionList() {
        const listHTML = inspectionData.sort((a, b) => new Date(b.date) - new Date(a.date))
            .map(item => {
                const rtu = rtuData.find(r => r.id === item.rtuId);
                const rtuCode = rtu ? rtu.code : '알 수 없음';
                const resultClass = item.result === '정상' ? 'text-green-600' : 'text-red-600';

                return `
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start">
                            <p class="text-lg font-semibold text-gray-900">${rtuCode} - ${item.date}</p>
                            <div class="flex space-x-2">
                                <button onclick="editInspection('${item.id}')" class="text-amber-600 hover:text-amber-800 text-sm font-medium">수정</button>
                                <button onclick="deleteDocById('inspection', '${item.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">삭제</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">담당: ${item.inspector} | 결과: <span class="${resultClass}">${item.result}</span></p>
                        <p class="text-xs mt-1 text-gray-600 truncate">${item.details}</p>
                    </div>
                `;
            }).join('');

        elements.inspectionList.innerHTML = listHTML || '<p class="text-gray-500">등록된 점검 기록이 없습니다.</p>';
    }

    // 수리 관리 목록 렌더링
    function renderRepairList() {
        const listHTML = repairData.sort((a, b) => new Date(b.date) - new Date(a.date))
            .map(item => {
                const rtu = rtuData.find(r => r.id === item.rtuId);
                const rtuCode = rtu ? rtu.code : '알 수 없음';

                return `
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start">
                            <p class="text-lg font-semibold text-gray-900">${rtuCode} - ${item.date}</p>
                            <div class="flex space-x-2">
                                <button onclick="editRepair('${item.id}')" class="text-amber-600 hover:text-amber-800 text-sm font-medium">수정</button>
                                <button onclick="deleteDocById('repair', '${item.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">삭제</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">담당: ${item.technician} | 비용: ${item.cost.toLocaleString()}원</p>
                        <p class="text-xs mt-1 text-gray-600 truncate">${item.details}</p>
                    </div>
                `;
            }).join('');

        elements.repairList.innerHTML = listHTML || '<p class="text-gray-500">등록된 수리 기록이 없습니다.</p>';
    }
    
    // RTU ID 기반 삭제 (점검/수리)
    async function deleteDocById(collectionName, id) {
        if (!window.confirm(`정말로 이 ${collectionName === 'inspection' ? '점검' : '수리'} 기록을 삭제하시겠습니까?`)) return;
        
        elements.loadingIndicator.classList.remove('hidden');
        try {
            await deleteDoc(doc(db, collectionName, id));
            showMessage('기록이 성공적으로 삭제되었습니다.', 'bg-green-500');
        } catch (error) {
            console.error("삭제 중 오류 발생: ", error);
            showMessage('삭제 중 오류가 발생했습니다.', 'bg-red-500');
        } finally {
            elements.loadingIndicator.classList.add('hidden');
        }
    }


    // ============================
    // Form and UI Logic
    // ============================

    // RTU 관리 Form에 데이터 로드 (수정 모드)
    window.editRtu = function(id) {
        const rtu = rtuData.find(r => r.id === id);
        if (!rtu) return;

        document.getElementById('rtu-id').value = rtu.id;
        document.getElementById('rtu-code').value = rtu.code;
        document.getElementById('rtu-location').value = rtu.location;
        document.getElementById('rtu-model').value = rtu.model;
        document.getElementById('rtu-install-date').value = rtu.installDate;
        document.getElementById('rtu-status').value = rtu.status;
        document.getElementById('rtu-uptime').value = rtu.uptime;
        
        currentRtuImageURL = rtu.imageUrl; // 현재 이미지 URL 저장
        
        const previewHtml = rtu.imageUrl && rtu.imageUrl !== 'placeholder' ? 
            `<img src="${rtu.imageUrl}" class="thumb" alt="현재 RTU 이미지">` :
            `<p class="text-sm text-gray-500">현재 등록된 이미지가 없습니다.</p>`;

        elements.rtuImagePreview.innerHTML = previewHtml;

        document.getElementById('rtu-submit-btn').textContent = 'RTU 정보 업데이트';
    };

    // 점검 관리 Form에 데이터 로드 (수정 모드)
    window.editInspection = function(id) {
        const inspection = inspectionData.find(i => i.id === id);
        if (!inspection) return;

        document.getElementById('inspection-id').value = inspection.id;
        document.getElementById('inspection-rtu-id').value = inspection.rtuId;
        document.getElementById('inspection-date').value = inspection.date;
        document.getElementById('inspection-details').value = inspection.details;
        document.getElementById('inspection-result').value = inspection.result;
        document.getElementById('inspection-inspector').value = inspection.inspector;
        document.getElementById('inspection-submit-btn').textContent = '점검 기록 업데이트';
        
        changeTab('inspection-manage');
    };

    // 수리 관리 Form에 데이터 로드 (수정 모드)
    window.editRepair = function(id) {
        const repair = repairData.find(r => r.id === id);
        if (!repair) return;

        document.getElementById('repair-id').value = repair.id;
        document.getElementById('repair-rtu-id').value = repair.rtuId;
        document.getElementById('repair-date').value = repair.date;
        document.getElementById('repair-details').value = repair.details;
        document.getElementById('repair-cost').value = repair.cost;
        document.getElementById('repair-technician').value = repair.technician;
        document.getElementById('repair-submit-btn').textContent = '수리 기록 업데이트';

        changeTab('repair-manage');
    };

    // RTU Form 초기화
    window.resetRtuForm = function() {
        elements.rtuForm.reset();
        document.getElementById('rtu-id').value = '';
        document.getElementById('rtu-submit-btn').textContent = 'RTU 등록';
        elements.rtuImagePreview.innerHTML = '';
        currentRtuImageURL = null; 
    };
    
    // 점검 Form 초기화
    window.resetInspectionForm = function() {
        elements.inspectionForm.reset();
        document.getElementById('inspection-id').value = '';
        document.getElementById('inspection-submit-btn').textContent = '점검 기록 등록';
    };

    // 수리 Form 초기화
    window.resetRepairForm = function() {
        elements.repairForm.reset();
        document.getElementById('repair-id').value = '';
        document.getElementById('repair-submit-btn').textContent = '수리 기록 등록';
    };

    // RTU 코드를 드롭다운 메뉴에 채우기
    window.populateRtuSelects = function() {
        const options = rtuData.map(rtu => `<option value="${rtu.id}">${rtu.code} - ${rtu.location}</option>`).join('');
        
        elements.inspectionRtuId.innerHTML = options;
        elements.repairRtuId.innerHTML = options;
        
        // 보고서 RTU 선택에는 '전체 RTU' 옵션을 포함
        elements.reportRtuId.innerHTML = '<option value="all">전체 RTU</option>' + options;
    };

    // 탭 변경
    window.changeTab = function(tabId, button) {
        const tabs = ['dashboard', 'rtu-manage', 'inspection-manage', 'repair-manage', 'report-page'];
        tabs.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(tabId).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('tab-active');
        });
        if (button) {
            button.classList.add('tab-active');
        } else {
             // 폼 수정 후 탭 이동 시, 수동으로 탭 활성화 (예: editInspection, editRepair)
            const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (activeBtn) activeBtn.classList.add('tab-active');
        }
    };
    
    // 메시지 표시 (임시 Alert 대신)
    function showMessage(text, bgColor) {
        const msgDiv = document.createElement('div');
        msgDiv.textContent = text;
        msgDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white font-semibold transition-transform duration-300 ${bgColor}`;
        document.body.appendChild(msgDiv);

        setTimeout(() => {
            msgDiv.classList.add('translate-x-full');
            msgDiv.addEventListener('transitionend', () => msgDiv.remove());
        }, 3000);
    }
    
    // ============================
    // Report & Modal Logic
    // ============================

    // 상세 모달 표시
    window.showDetailModal = function(id, type) {
        const data = type === 'rtu' ? rtuData.find(r => r.id === id) :
                     type === 'inspection' ? inspectionData.find(i => i.id === id) :
                     repairData.find(r => r.id === id);

        if (!data) return;

        let contentHTML = '';
        let title = '';
        const dateKey = type === 'rtu' ? '설치일자' : '일자';

        // 공통 정보 (RTU 코드 포함)
        const rtu = rtuData.find(r => r.id === data.rtuId) || rtuData.find(r => r.id === id); // rtuId가 없으면 data 자체가 rtu
        const rtuCode = rtu ? rtu.code : 'N/A';
        
        if (type === 'rtu') {
            title = `RTU 상세: ${data.code}`;
            const thumbUrl = data.imageUrl && data.imageUrl !== 'placeholder' 
                ? data.imageUrl 
                : 'https://placehold.co/200x150/e5e7eb/6b7280?text=NO+IMAGE';

            contentHTML = `
                <div class="text-center mb-4">
                    <img src="${thumbUrl}" class="mx-auto rounded-lg shadow-md max-h-48" alt="RTU 사진" onerror="this.onerror=null;this.src='https://placehold.co/200x150/e5e7eb/6b7280?text=NO+IMAGE';">
                </div>
                <p><strong>위치:</strong> ${data.location}</p>
                <p><strong>모델:</strong> ${data.model}</p>
                <p><strong>설치일:</strong> ${data.installDate}</p>
                <p><strong>상태:</strong> <span class="font-bold text-lg">${data.status}</span></p>
                <p><strong>가동률:</strong> ${data.uptime}%</p>
                <p class="text-xs text-gray-400 mt-4">최종 업데이트: ${new Date(data.updatedAt).toLocaleString()}</p>
            `;
        } else if (type === 'inspection') {
            title = `점검 기록: ${rtuCode} (${data.date})`;
            contentHTML = `
                <p><strong>RTU 코드:</strong> ${rtuCode}</p>
                <p><strong>점검 일자:</strong> ${data.date}</p>
                <p><strong>담당자:</strong> ${data.inspector}</p>
                <p><strong>결과:</strong> <span class="font-bold text-lg">${data.result}</span></p>
                <p class="mt-4"><strong>상세 내용:</strong></p>
                <p class="whitespace-pre-wrap p-3 bg-gray-100 rounded-lg">${data.details}</p>
            `;
        } else if (type === 'repair') {
            title = `수리 기록: ${rtuCode} (${data.date})`;
            contentHTML = `
                <p><strong>RTU 코드:</strong> ${rtuCode}</p>
                <p><strong>수리 일자:</strong> ${data.date}</p>
                <p><strong>담당자:</strong> ${data.technician}</p>
                <p><strong>비용:</strong> ${data.cost.toLocaleString()}원</p>
                <p class="mt-4"><strong>수리 내역:</strong></p>
                <p class="whitespace-pre-wrap p-3 bg-gray-100 rounded-lg">${data.details}</p>
            `;
        }
        
        elements.modalTitle.textContent = title;
        elements.modalContent.innerHTML = contentHTML;
        elements.detailModal.classList.remove('hidden');
    };

    // 보고서 생성 로직
    window.generateReport = function() {
        const rtuId = document.getElementById('report-rtu-id').value;
        const duration = document.getElementById('report-duration').value;
        const output = document.getElementById('report-summary');
        output.innerHTML = '<div class="loader mx-auto"></div><p class="text-sm text-gray-500 mt-3">보고서를 생성하는 중...</p>';

        const targetRtu = rtuId === 'all' ? rtuData : rtuData.filter(r => r.id === rtuId);
        
        let startDate = new Date();
        startDate.setHours(0, 0, 0, 0);

        if (duration === 'last_month') startDate.setMonth(startDate.getMonth() - 1);
        else if (duration === 'last_3_months') startDate.setMonth(startDate.getMonth() - 3);
        else if (duration === 'last_6_months') startDate.setMonth(startDate.getMonth() - 6);
        else if (duration === 'last_year') startDate.setFullYear(startDate.getFullYear() - 1);
        else if (duration === 'all') startDate = new Date(0); // Epoch time

        // 기간 필터링
        const filteredInspections = inspectionData.filter(i => new Date(i.date) >= startDate);
        const filteredRepairs = repairData.filter(r => new Date(r.date) >= startDate);
        
        const totalRtuCount = targetRtu.length;
        let totalRepairCost = 0;
        let inspectionRequiredCount = 0;

        // RTU별 분석
        const rtuReports = targetRtu.map(rtu => {
            const rtuInspections = filteredInspections.filter(i => i.rtuId === rtu.id);
            const rtuRepairs = filteredRepairs.filter(r => r.rtuId === rtu.id);
            
            const totalCost = rtuRepairs.reduce((sum, r) => sum + (r.cost || 0), 0);
            totalRepairCost += totalCost;

            const isInspectionRequired = rtu.status === '점검 필요';
            if (isInspectionRequired) inspectionRequiredCount++;

            return {
                code: rtu.code,
                location: rtu.location,
                status: rtu.status,
                uptime: rtu.uptime,
                inspectionCount: rtuInspections.length,
                repairCount: rtuRepairs.length,
                totalCost: totalCost,
                lastRepairDate: rtuRepairs.length > 0 ? rtuRepairs.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : 'N/A'
            };
        });

        const reportTitle = rtuId === 'all' ? '전체 RTU 통합 보고서' : `${targetRtu[0].code} RTU 상세 보고서`;
        const reportDuration = duration === 'all' ? '전체 기간' : new Date(startDate).toLocaleDateString() + ' 이후';
        
        let reportHTML = `
            <h4 class="text-xl font-bold mb-4 text-gray-800">${reportTitle} (${reportDuration})</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700">대상 RTU</p>
                    <p class="text-xl font-bold">${totalRtuCount}대</p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                    <p class="text-sm text-red-700">총 수리 비용</p>
                    <p class="text-xl font-bold">${totalRepairCost.toLocaleString()}원</p>
                </div>
                <div class="p-3 bg-amber-50 rounded-lg">
                    <p class="text-sm text-amber-700">점검 필요 RTU</p>
                    <p class="text-xl font-bold">${inspectionRequiredCount}대</p>
                </div>
                <div class="p-3 bg-green-50 rounded-lg">
                    <p class="text-sm text-green-700">평균 가동률</p>
                    <p class="text-xl font-bold">${totalRtuCount > 0 ? (targetRtu.reduce((sum, r) => sum + r.uptime, 0) / totalRtuCount).toFixed(1) : 0}%</p>
                </div>
            </div>
            
            <h5 class="text-lg font-bold mt-6 mb-3 border-b pb-2">RTU별 상세 현황</h5>
            <div class="space-y-3">
            ${rtuReports.map(r => `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-bold text-gray-900">${r.code} (${r.location}) - <span class="${r.status === '정상' ? 'text-green-600' : 'text-red-600'}">${r.status}</span></p>
                    <p class="text-sm text-gray-600 mt-1">
                        가동률: ${r.uptime}% | 점검: ${r.inspectionCount}회 | 수리: ${r.repairCount}회 (총 비용: ${r.totalCost.toLocaleString()}원)
                    </p>
                </div>
            `).join('')}
            </div>
        `;

        // 보고서 생성 완료 (지연 시간 없이 바로 표시)
        output.innerHTML = reportHTML;
    };
    
    // ============================
    // Data Export/Import Logic
    // ============================
    
    // 데이터 내보내기 (JSON)
    document.getElementById('export-data').addEventListener('click', () => {
        const dataToExport = {
            rtu: rtuData,
            inspection: inspectionData,
            repair: repairData
        };
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rtu_system_data_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // 데이터 불러오기 (JSON)
    window.importData = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!window.confirm("주의: 현재 Firebase의 모든 데이터가 불러온 파일로 덮어쓰여집니다. 계속하시겠습니까?")) {
            event.target.value = ''; // 파일 선택 취소
            return;
        }
        
        elements.loadingIndicator.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!importedData.rtu || !importedData.inspection || !importedData.repair) {
                    throw new Error("잘못된 JSON 파일 형식입니다.");
                }

                // 덮어쓰기 로직: 기존 데이터 삭제 후 새 데이터 추가
                // 간단한 구현을 위해, 새로운 ID로 추가하는 방식을 사용 (기존 ID 유지 X)

                const collections = [
                    { name: 'rtu', data: importedData.rtu },
                    { name: 'inspection', data: importedData.inspection },
                    { name: 'repair', data: importedData.repair },
                ];
                
                // 기존 데이터 삭제 (간소화된 임시 구현: 실제 서비스에서는 이 방식으로 모든 데이터 삭제는 권장되지 않음)
                // 현재 데이터 ID를 가져와서 모두 삭제
                const deletePromises = [];
                for (const col of ['rtu', 'inspection', 'repair']) {
                    const snapshot = await getDocs(collection(db, col));
                    snapshot.forEach(d => {
                        deletePromises.push(deleteDoc(doc(db, col, d.id)));
                    });
                }
                await Promise.all(deletePromises);


                // 새 데이터 추가
                const addPromises = [];
                for (const col of collections) {
                    col.data.forEach(item => {
                        // 기존 ID(item.id)는 사용하지 않고 Firestore가 새 ID를 생성하도록 setDoc을 사용
                        // 단, rtuId는 기존 ID를 참조하고 있으므로 데이터 일관성이 깨질 수 있음
                        // 이 예제에서는 단순화하여 새 ID로 추가합니다.
                        const newId = doc(collection(db, col.name)).id;
                        addPromises.push(setDoc(doc(db, col.name, newId), item));
                    });
                }

                await Promise.all(addPromises);

                showMessage('데이터를 성공적으로 불러오고 Firebase에 저장했습니다.', 'bg-green-500');

            } catch (error) {
                console.error("데이터 가져오기 중 오류 발생:", error);
                showMessage(`데이터 가져오기 실패: ${error.message}`, 'bg-red-500');
            } finally {
                event.target.value = ''; // 파일 선택 초기화
                elements.loadingIndicator.classList.add('hidden');
            }
        };
        reader.readAsText(file);
    };

    // ============================
    // Event Listeners (이벤트 리스너)
    // ============================
    
    // 폼 제출 이벤트 리스너 연결
    elements.rtuForm.addEventListener('submit', saveRtu);
    elements.inspectionForm.addEventListener('submit', saveInspection);
    elements.repairForm.addEventListener('submit', saveRepair);

    // 모달 닫기 이벤트 리스너
    elements.closeModalBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        elements.detailModal.classList.add('hidden');
        currentModalData = { id: null, type: null };
    });

    elements.detailModal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-bg')) {
            elements.detailModal.classList.add('hidden');
            currentModalData = { id: null, type: null };
        }
    });

    // 페이지 초기화 및 리스너 설정
    window.onload = function() {
        // Firebase 리스너 설정 (실시간 데이터 구독 시작)
        setupRealtimeListeners();
        
        // 초기 탭 설정 (대시보드를 먼저 보여줌)
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('rtu-manage').classList.add('hidden');
        document.getElementById('inspection-manage').classList.add('hidden');
        document.getElementById('repair-manage').classList.add('hidden');
        document.getElementById('report-page').classList.add('hidden');
    };
    
</script>
</body>
</html>
