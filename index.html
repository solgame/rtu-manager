<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== 인쇄 미리보기/출력 문제 해결 CSS (추가됨) ========== */
    @media print {
      /* 1. 인쇄에 불필요한 요소 (헤더 버튼, 탭 네비게이션, 폼, 모달 등) 숨기기 */
      .flex-col.sm\\:flex-row.justify-between.items-start.sm\\:items-center.border-b.pb-4.mb-4 > div:nth-child(2), /* CSV 버튼 영역만 숨김 */
      .border-b.border-gray-200, /* 탭 네비게이션 바 숨기기 */
      #rtu-manage .lg\\:col-span-1, /* RTU 등록/수정 폼 */
      #inspection-manage .lg\\:col-span-1, /* 점검 기록 등록 폼 */
      #repair-manage .lg\\:col-span-1, /* 수리 기록 등록 폼 */
      #rtu-pagination,
      #inspection-pagination,
      #repair-pagination, /* 페이지네이션 버튼 */
      #detail-modal, 
      #image-zoom-modal, /* 모달 */
      #report-page .border-t.pt-4, /* 보고서 페이지의 설명 텍스트 */
      .loading, .thumb-detail { 
          display: none !important; /* 로딩 스피너 및 썸네일 디테일 숨김 */
      }
      
      /* 2. 숨겨진 탭 콘텐츠 (tab-page.hidden)를 모두 인쇄에 포함 */
      .tab-page, 
      .tab-page.hidden {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        max-height: none !important; 
      }
      
      /* 3. 목록 영역을 전체 너비로 확장 (폼이 사라진 자리를 채움) */
      .lg\\:col-span-2 { 
          width: 100%;
          max-width: 100%;
          flex: 0 0 100%;
      }
      
      /* 4. 인쇄 시 배경색, 그림자, 테두리 제거하여 용지 절약 및 깔끔하게 출력 */
      .bg-white, .bg-blue-50, .bg-green-50, .bg-gray-50, .bg-red-50, 
      .bg-indigo-50, .bg-pink-50, .bg-teal-50, .border, .shadow-xl, .shadow-lg {
          background-color: transparent !important;
          box-shadow: none !important;
          border: none !important;
      }
      .rounded-2xl, .rounded-xl, .rounded-lg, .rounded-full {
          border-radius: 0 !important;
      }
      
      /* 5. 주요 섹션 사이에 페이지 나누기 적용 */
      #rtu-manage, 
      #inspection-manage, 
      #repair-manage, 
      #report-page {
          page-break-before: always;
      }

      /* 6. 메인 컨테이너 패딩/여백 제거 */
      .max-w-6xl.mx-auto {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      .p-4.sm\\:p-8, .p-6, .mb-4 {
        padding: 0 !important;
        margin-bottom: 0 !important;
      }
    }
    /* ======================================================== */
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">시스템 운영 보고서</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200">
              <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200">
              <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200">
              <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>
          <p class="text-gray-600 border-t pt-4">보다 상세한 데이터 분석 및 보고는 상단의 **데이터 CSV 다운로드/업로드** 버튼을 통해 데이터를 추출하여 진행하실 수 있습니다. 모든 데이터는 Firebase 클라우드에 실시간으로 동기화됩니다.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>로딩 중...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div id="image-zoom-modal" class="modal-bg hidden fixed inset-0 z-[60] flex items-center justify-center p-4" onclick="document.getElementById('image-zoom-modal').classList.add('hidden')">
    <div class="max-w-4xl max-h-[90vh] w-full p-4">
      <img id="zoomed-image" src="" alt="확대 이미지" class="max-w-full max-h-[80vh] w-auto h-auto mx-auto shadow-2xl rounded-lg">
      <button class="absolute top-4 right-4 text-white hover:text-gray-200 transition" onclick="document.getElementById('image-zoom-modal').classList.add('hidden'); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688",
      measurementId: "G-L58S7K0264"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseGet = get;
    window.firebaseRemove = remove;
    window.firebaseInitialized = true;
  </script>

  <script>
    /* ==================== 전역 변수 및 설정 ==================== */
    const STORAGE_KEYS = {
      RTU: 'rtuList',
      INSPECTION: 'inspectionList',
      REPAIR: 'repairList'
    };
    
    let imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];
    let isFirebaseReady = false;
    let currentRtuMode = 'new';
    let currentModalData = { id: null, type: null };

    // Pagination Settings
    const PAGE_SIZE = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    const elements = {
      rtuForm: document.getElementById('rtu-form'),
      rtuCount: document.getElementById('rtu-count'),
      rtuListContainer: document.getElementById('rtu-list'),
      rtuPaginationContainer: document.getElementById('rtu-pagination'),
      inspectionForm: document.getElementById('inspection-form'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionListContainer: document.getElementById('inspection-list'),
      inspectionPaginationContainer: document.getElementById('inspection-pagination'),
      inspectionRtuIdSelect: document.getElementById('inspection-rtu-id'),
      repairForm: document.getElementById('repair-form'),
      repairCount: document.getElementById('repair-count'),
      repairListContainer: document.getElementById('repair-list'),
      repairPaginationContainer: document.getElementById('repair-pagination'),
      repairRtuIdSelect: document.getElementById('repair-rtu-id'),
      detailModal: document.getElementById('detail-modal'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      modalTitle: document.getElementById('modal-title'),
      modalContent: document.getElementById('modal-content'),
      imageZoomModal: document.getElementById('image-zoom-modal'),
      zoomedImage: document.getElementById('zoomed-image'),
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair')
    };

    /* ==================== Firebase 함수 ==================== */
    function waitForFirebase() {
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (window.firebaseInitialized) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);
      });
    }

    async function loadFromFirebase() {
      await waitForFirebase();

      const rtuRef = window.firebaseRef(window.firebaseDB, 'rtuList');
      window.firebaseOnValue(rtuRef, (snapshot) => {
        const data = snapshot.val();
        rtuList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
        }
      });

      const inspectionRef = window.firebaseRef(window.firebaseDB, 'inspectionList');
      window.firebaseOnValue(inspectionRef, (snapshot) => {
        const data = snapshot.val();
        inspectionList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
        }
      });

      const repairRef = window.firebaseRef(window.firebaseDB, 'repairList');
      window.firebaseOnValue(repairRef, (snapshot) => {
        const data = snapshot.val();
        repairList = data ? Object.values(data) : [];
        if (isFirebaseReady) { 
          // 수리 기록 미표시 오류 수정: onValue 콜백이 정상적으로 리스트를 업데이트하고 렌더링하도록 보장
          renderRepairList(repairCurrentPage);
          updateDashboard();
        }
      });

      isFirebaseReady = true;
    }

    async function saveToFirebase(key, list) {
      await waitForFirebase();
      const dbRef = window.firebaseRef(window.firebaseDB, key);
      const dataToSave = {};
      list.forEach(item => {
        dataToSave[item.id] = item;
      });
      try {
        await window.firebaseSet(dbRef, dataToSave);
        console.log(`${key} saved successfully!`);
      } catch (error) {
        console.error(`Error saving ${key}:`, error);
        alert(`데이터 저장 중 오류가 발생했습니다: ${error.message}`);
      }
    }

    async function deleteFromFirebase(key, id) {
      await waitForFirebase();
      const itemRef = window.firebaseRef(window.firebaseDB, `${key}/${id}`);
      try {
        await window.firebaseRemove(itemRef);
        console.log(`${key} item ${id} deleted successfully!`);
      } catch (error) {
        console.error(`Error deleting ${key} item:`, error);
        alert(`데이터 삭제 중 오류가 발생했습니다: ${error.message}`);
      }
    }

    /* ==================== 유틸리티 함수 ==================== */
    function getStatusColor(status) {
      switch (status) {
        case '작동중':
        case '정상':
          return 'bg-green-100 text-green-800';
        case '주의':
        case '진행중':
          return 'bg-yellow-100 text-yellow-800';
        case '정지됨':
        case '요청':
          return 'bg-gray-100 text-gray-800';
        case '점검필요':
        case '불량':
        case '소손/교체필요':
        case '오류':
          return 'bg-red-100 text-red-800';
        case '완료':
          return 'bg-blue-100 text-blue-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    function generateId(prefix = 'ID') {
      return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    }

    function formatNumber(num) {
      return num ? num.toLocaleString() : 'N/A';
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('ko-KR');
    }
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    /* ==================== 대시보드 함수 ==================== */
    function updateDashboard() {
      // RTU Counts
      elements.dashboardTotal.textContent = formatNumber(rtuList.length);
      const runningCount = rtuList.filter(rtu => rtu.status === '작동중').length;
      const stoppedCount = rtuList.filter(rtu => rtu.status === '정지됨').length;
      const needsInspectionCount = rtuList.filter(rtu => rtu.status === '점검필요').length;
      elements.dashboardRunning.textContent = formatNumber(runningCount);
      elements.dashboardStopped.textContent = formatNumber(stoppedCount);
      elements.dashboardNeedsInspection.textContent = formatNumber(needsInspectionCount);

      // Monthly Inspection Count
      const startOfMonth = new Date();
      startOfMonth.setDate(1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;

      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }

      // Report Page Update
      elements.reportTotalRtu.textContent = formatNumber(rtuList.length);
      elements.reportTotalInspection.textContent = formatNumber(inspectionList.length);
      elements.reportTotalRepair.textContent = formatNumber(repairList.length);
    }

    /* ==================== RTU 관리 함수 ==================== */
    function populateRtuSelects() {
      // Clear existing options, keep the default one
      [elements.rtuModifySelect, elements.inspectionRtuIdSelect, elements.repairRtuIdSelect].forEach(select => {
        let defaultOption = select.querySelector('option[value=""]');
        select.innerHTML = '';
        if (defaultOption) {
          select.appendChild(defaultOption.cloneNode(true));
        } else {
          select.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>'; // Fallback for inspection/repair selects
        }
      });
      
      // Populate with current RTU list
      rtuList.forEach(rtu => {
        const option = document.createElement('option');
        option.value = rtu.id;
        option.textContent = `${rtu.name} (${rtu.region})`;
        
        // Populate Rtu Modify Select
        elements.rtuModifySelect.appendChild(option.cloneNode(true));

        // Populate Inspection and Repair Selects
        elements.inspectionRtuIdSelect.appendChild(option.cloneNode(true));
        elements.repairRtuIdSelect.appendChild(option.cloneNode(true));
      });
    }

    // RTU 리스트 렌더링 함수 수정: isPrint 플래그 추가
    function renderRtuList(page, isPrint = false) {
      const startIndex = (page - 1) * PAGE_SIZE;
      const endIndex = startIndex + PAGE_SIZE;
      
      // 인쇄 모드일 때는 전체 리스트, 아닐 때는 페이지네이션된 리스트 사용
      const listToRender = isPrint ? rtuList : rtuList.slice(startIndex, endIndex);

      elements.rtuCount.textContent = formatNumber(rtuList.length);
      
      if (rtuList.length === 0) {
        elements.rtuListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>';
        elements.rtuPaginationContainer.innerHTML = '';
        return;
      }
      
      elements.rtuListContainer.innerHTML = listToRender.map(rtu => `
        <div class="bg-gray-50 p-4 rounded-lg shadow border border-gray-200 hover:shadow-md transition duration-150">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-bold text-blue-700">${rtu.name}</h3>
            <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
          <p class="text-sm text-gray-600 mb-2">설치 장소: ${rtu.region} | 모델: ${rtu.model || 'N/A'}</p>
          <div class="flex space-x-2 mt-2">
            <button class="view-detail-btn bg-blue-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-blue-600 transition" data-id="${rtu.id}" data-type="rtu">상세보기</button>
            <button class="modify-rtu-btn bg-yellow-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-yellow-600 transition" data-id="${rtu.id}">수정</button>
            <button class="delete-rtu-btn bg-red-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-red-600 transition" data-id="${rtu.id}" data-name="${rtu.name}">삭제</button>
          </div>
        </div>
      `).join('');
      
      // 인쇄 모드일 때는 페이지네이션을 숨김
      if (isPrint) {
        elements.rtuPaginationContainer.innerHTML = '';
      } else {
        renderPagination(elements.rtuPaginationContainer, rtuList.length, PAGE_SIZE, page, setRtuPage);
      }
    }

    function renderRtuDetail(rtu) {
      let imageHtml = '';
      const imageKeys = ['imageUrl1', 'imageUrl2', 'imageUrl3'];
      const hasImages = imageKeys.some(key => rtu[key]);

      if (hasImages) {
        imageHtml = `
          <h4 class="text-md font-semibold text-gray-800 border-t pt-2 mt-2">장비 사진</h4>
          <div class="flex flex-wrap gap-4 pt-2">
            ${imageKeys.map((key, index) => rtu[key] ? `<img src="${rtu[key]}" alt="Image ${index + 1}" class="thumb-detail" onclick="zoomImage('${rtu[key]}')">` : '').join('')}
          </div>
        `;
      }

      elements.modalContent.innerHTML = `
        <p><span class="font-medium">RTU ID:</span> ${rtu.name}</p>
        <p><span class="font-medium">설치 장소/지역:</span> ${rtu.region}</p>
        <p><span class="font-medium">모델명:</span> ${rtu.model || 'N/A'}</p>
        <p><span class="font-medium">용량:</span> ${rtu.capacity || 'N/A'}</p>
        <p><span class="font-medium">유닛 종류:</span> ${rtu.unitType || 'N/A'}</p>
        <p><span class="font-medium">냉매 종류:</span> ${rtu.refrigerant || 'N/A'}</p>
        <p><span class="font-medium">전기 종류:</span> ${rtu.electricPhase || 'N/A'}</p>
        <p><span class="font-medium">설치(등록) 날짜:</span> ${formatDate(rtu.date)}</p>
        <p><span class="font-medium">고압 상한 설정:</span> ${rtu.pressureHighLimit ? `${rtu.pressureHighLimit} PSI` : 'N/A'}</p>
        <p><span class="font-medium">저압 하한 설정:</span> ${rtu.pressureLowLimit ? `${rtu.pressureLowLimit} PSI` : 'N/A'}</p>
        <p><span class="font-medium">현재 상태:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span></p>
        <p><span class="font-medium">특이사항 및 메모:</span> ${rtu.notes || '없음'}</p>
        ${imageHtml}
      `;
    }
    
    // 글로벌 함수로 노출하여 HTML에서 onClick으로 사용할 수 있게 함
    window.zoomImage = function(imageUrl) {
      elements.zoomedImage.src = imageUrl;
      elements.imageZoomModal.classList.remove('hidden');
    }

    function setRtuPage(page) {
      rtuCurrentPage = page;
      renderRtuList(page);
    }

    /* ==================== 점검 기록 함수 ==================== */
    // 점검 기록 리스트 렌더링 함수 수정: isPrint 플래그 추가
    function renderInspectionList(page, isPrint = false) {
      const startIndex = (page - 1) * PAGE_SIZE;
      const endIndex = startIndex + PAGE_SIZE;
      const sortedList = inspectionList.sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
      
      // 인쇄 모드일 때는 전체 리스트, 아닐 때는 페이지네이션된 리스트 사용
      const paginatedList = isPrint ? sortedList : sortedList.slice(startIndex, endIndex);

      elements.inspectionCount.textContent = formatNumber(inspectionList.length);

      if (inspectionList.length === 0) {
        elements.inspectionListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>';
        elements.inspectionPaginationContainer.innerHTML = '';
        return;
      }

      elements.inspectionListContainer.innerHTML = paginatedList.map(inspection => {
        const rtu = rtuList.find(r => r.id === inspection.rtuId);
        const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
        return `
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200 hover:shadow-md transition duration-150">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-bold text-indigo-700">${rtuName} (${formatDate(inspection.inspectionDate)})</h3>
              <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(inspection.result)}">${inspection.result}</span>
            </div>
            <p class="text-sm text-gray-600 mb-2">점검자: ${inspection.inspector} | 특이사항: ${inspection.notes ? inspection.notes.substring(0, 30) + (inspection.notes.length > 30 ? '...' : '') : '없음'}</p>
            <div class="flex space-x-2 mt-2">
              <button class="view-detail-btn bg-blue-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-blue-600 transition" data-id="${inspection.id}" data-type="inspection">상세보기</button>
              <button class="delete-inspection-btn bg-red-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-red-600 transition" data-id="${inspection.id}">삭제</button>
            </div>
          </div>
        `;
      }).join('');

      // 인쇄 모드일 때는 페이지네이션을 숨김
      if (isPrint) {
        elements.inspectionPaginationContainer.innerHTML = '';
      } else {
        renderPagination(elements.inspectionPaginationContainer, inspectionList.length, PAGE_SIZE, page, setInspectionPage);
      }
    }
    
    function renderInspectionDetail(inspection) {
      const rtu = rtuList.find(r => r.id === inspection.rtuId);
      const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
      
      const checks = [
        { label: '1. 필터', value: inspection.check1 },
        { label: '2. 콘텍터', value: inspection.check2 },
        { label: '3. 콘덴싱 코일', value: inspection.check3 },
        { label: '4. 송풍 모터', value: inspection.check4 },
        { label: '5. 증발기 코일', value: inspection.check5 },
        { label: '6. 고압 센서', value: inspection.check6 },
        { label: '7. 저압 센서', value: inspection.check7 },
        { label: '8. 캐패시터', value: inspection.check8 },
      ];

      elements.modalContent.innerHTML = `
        <p><span class="font-medium">대상 RTU:</span> ${rtuName}</p>
        <p><span class="font-medium">점검 날짜:</span> ${formatDate(inspection.inspectionDate)}</p>
        <p><span class="font-medium">점검자 이름:</span> ${inspection.inspector}</p>
        <p><span class="font-medium">최종 점검 결과:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(inspection.result)}">${inspection.result}</span></p>

        <h4 class="text-md font-semibold text-indigo-800 border-t pt-2 mt-2">부품 점검 상태</h4>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
          ${checks.map(c => `
            <p><span class="font-medium">${c.label}:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(c.value)}">${c.value}</span></p>
          `).join('')}
        </div>

        <h4 class="text-md font-semibold text-yellow-800 border-t pt-2 mt-2">운전 상태 측정 (Comp 1)</h4>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <p><span class="font-medium">고압:</span> ${inspection.comp1Hp ? `${inspection.comp1Hp} PSI` : 'N/A'}</p>
          <p><span class="font-medium">저압:</span> ${inspection.comp1Lp ? `${inspection.comp1Lp} PSI` : 'N/A'}</p>
          <p><span class="font-medium">전류:</span> ${inspection.comp1Amp ? `${inspection.comp1Amp} A` : 'N/A'}</p>
        </div>

        <h4 class="text-md font-semibold text-yellow-800 border-t pt-2 mt-2">운전 상태 측정 (Comp 2)</h4>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <p><span class="font-medium">고압:</span> ${inspection.comp2Hp ? `${inspection.comp2Hp} PSI` : 'N/A'}</p>
          <p><span class="font-medium">저압:</span> ${inspection.comp2Lp ? `${inspection.comp2Lp} PSI` : 'N/A'}</p>
          <p><span class="font-medium">전류:</span> ${inspection.comp2Amp ? `${inspection.comp2Amp} A` : 'N/A'}</p>
        </div>

        <h4 class="text-md font-semibold text-red-800 border-t pt-2 mt-2">온도 측정</h4>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <p><span class="font-medium">과열도:</span> ${inspection.superheat ? `${inspection.superheat} ℉` : 'N/A'}</p>
          <p><span class="font-medium">과냉도:</span> ${inspection.subcool ? `${inspection.subcool} ℉` : 'N/A'}</p>
        </div>

        <h4 class="text-md font-semibold text-gray-800 border-t pt-2 mt-2">특이사항 및 조치 내용</h4>
        <p class="whitespace-pre-wrap">${inspection.notes || '없음'}</p>
      `;
    }

    function setInspectionPage(page) {
      inspectionCurrentPage = page;
      renderInspectionList(page);
    }

    /* ==================== 수리 기록 함수 ==================== */
    // 수리 기록 리스트 렌더링 함수 수정: isPrint 플래그 추가
    function renderRepairList(page, isPrint = false) {
      const startIndex = (page - 1) * PAGE_SIZE;
      const endIndex = startIndex + PAGE_SIZE;
      const sortedList = repairList.sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
      
      // 인쇄 모드일 때는 전체 리스트, 아닐 때는 페이지네이션된 리스트 사용
      const paginatedList = isPrint ? sortedList : sortedList.slice(startIndex, endIndex);

      elements.repairCount.textContent = formatNumber(repairList.length);

      if (repairList.length === 0) {
        elements.repairListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>';
        elements.repairPaginationContainer.innerHTML = '';
        return;
      }

      elements.repairListContainer.innerHTML = paginatedList.map(repair => {
        const rtu = rtuList.find(r => r.id === repair.rtuId);
        const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
        return `
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200 hover:shadow-md transition duration-150">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-bold text-teal-700">${rtuName} (${formatDate(repair.repairDate)})</h3>
              <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(repair.status)}">${repair.status}</span>
            </div>
            <p class="text-sm text-gray-600 mb-2">담당자: ${repair.engineer} | 문제: ${repair.issue ? repair.issue.substring(0, 30) + (repair.issue.length > 30 ? '...' : '') : '없음'}</p>
            <div class="flex space-x-2 mt-2">
              <button class="view-detail-btn bg-blue-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-blue-600 transition" data-id="${repair.id}" data-type="repair">상세보기</button>
              <button class="delete-repair-btn bg-red-500 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-red-600 transition" data-id="${repair.id}">삭제</button>
            </div>
          </div>
        `;
      }).join('');

      // 인쇄 모드일 때는 페이지네이션을 숨김
      if (isPrint) {
        elements.repairPaginationContainer.innerHTML = '';
      } else {
        renderPagination(elements.repairPaginationContainer, repairList.length, PAGE_SIZE, page, setRepairPage);
      }
    }

    function renderRepairDetail(repair) {
      const rtu = rtuList.find(r => r.id === repair.rtuId);
      const rtuName = rtu ? rtu.name : '알 수 없는 RTU';

      elements.modalContent.innerHTML = `
        <p><span class="font-medium">대상 RTU:</span> ${rtuName}</p>
        <p><span class="font-medium">수리 날짜:</span> ${formatDate(repair.repairDate)}</p>
        <p><span class="font-medium">수리 담당자:</span> ${repair.engineer}</p>
        <p><span class="font-medium">처리 상태:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(repair.status)}">${repair.status}</span></p>

        <h4 class="text-md font-semibold text-gray-800 border-t pt-2 mt-2">문제 및 조치 내용</h4>
        <p class="whitespace-pre-wrap">${repair.issue || '없음'}</p>
      `;
    }

    function setRepairPage(page) {
      repairCurrentPage = page;
      renderRepairList(page);
    }
    
    /* ==================== 공통 페이지네이션 함수 ==================== */
    function renderPagination(container, totalItems, pageSize, currentPage, pageChangeHandler) {
      const totalPages = Math.ceil(totalItems / pageSize);
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '<div class="flex space-x-2">';
      
      // Previous Button
      html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''} onclick="window.pageChangeHandlers['${container.id}'](${currentPage - 1})">이전</button>`;
      
      // Page numbers (simplified to show current page and neighbors)
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
          html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm transition" onclick="window.pageChangeHandlers['${container.id}'](1)">1</button>`;
          if (startPage > 2) {
              html += `<span class="py-1 px-3 text-sm text-gray-500">...</span>`;
          }
      }

      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'bg-blue-600 text-white font-bold' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
        html += `<button class="pagination-btn ${activeClass} py-1 px-3 rounded-lg text-sm transition" onclick="window.pageChangeHandlers['${container.id}'](${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
              html += `<span class="py-1 px-3 text-sm text-gray-500">...</span>`;
          }
          html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm transition" onclick="window.pageChangeHandlers['${container.id}'](${totalPages})">${totalPages}</button>`;
      }

      // Next Button
      html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === totalPages ? 'disabled' : ''} onclick="window.pageChangeHandlers['${container.id}'](${currentPage + 1})">다음</button>`;
      
      html += '</div>';
      container.innerHTML = html;
      
      // Register the handler globally for onClick in the dynamically created buttons
      window.pageChangeHandlers = window.pageChangeHandlers || {};
      window.pageChangeHandlers[container.id] = pageChangeHandler;
    }

    /* ==================== 이벤트 리스너 ==================== */
    
    // 탭 전환
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;
        
        // Update tab buttons
        elements.tabBtns.forEach(b => {
          b.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
          b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        btn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
        btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

        // Update tab pages
        elements.tabPages.forEach(page => {
          page.classList.add('hidden');
        });
        document.getElementById(targetTab).classList.remove('hidden');

        // Re-render list on tab switch to ensure fresh view
        if (targetTab === 'rtu-manage') renderRtuList(rtuCurrentPage);
        if (targetTab === 'inspection-manage') renderInspectionList(inspectionCurrentPage);
        if (targetTab === 'repair-manage') renderRepairList(repairCurrentPage);
        if (targetTab === 'dashboard' || targetTab === 'report-page') updateDashboard();
      });
    });
    
    // ====================================================================
    // 1. 인쇄 미리보기 수정 로직 추가
    // ====================================================================
    
    // 인쇄 직전 이벤트: 전체 리스트 렌더링으로 페이지네이션 무시
    window.addEventListener('beforeprint', () => {
        console.log('Before print: Rendering full lists...');
        // isPrint 플래그를 true로 설정하여 전체 데이터를 렌더링
        renderRtuList(1, true);
        renderInspectionList(1, true);
        renderRepairList(1, true);
    });

    // 인쇄 후 이벤트: 원래의 페이지네이션 상태로 복구
    window.addEventListener('afterprint', () => {
        console.log('After print: Restoring paginated lists...');
        // isPrint 플래그 없이 호출하여 현재 페이지의 데이터만 다시 렌더링
        renderRtuList(rtuCurrentPage);
        renderInspectionList(inspectionCurrentPage);
        renderRepairList(repairCurrentPage);
    });
    
    // ====================================================================
    
    // RTU 등록/수정 모드 전환
    elements.modeNewBtn.addEventListener('click', () => {
      currentRtuMode = 'new';
      elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
      elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
      elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
      elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
      elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
      elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
      document.getElementById('rtu-name').classList.remove('hidden');
      elements.rtuModifySelect.classList.add('hidden');
      elements.rtuForm.reset();
      elements.rtuIdForModification.value = '';
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
      updateImagePreview();
    });

    elements.modeModifyBtn.addEventListener('click', () => {
      currentRtuMode = 'modify';
      elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
      elements.rtuSubmitBtn.textContent = 'RTU 정보 수정';
      elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
      elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
      elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
      elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
      document.getElementById('rtu-name').classList.add('hidden');
      elements.rtuModifySelect.classList.remove('hidden');
      elements.rtuForm.reset();
      elements.rtuIdForModification.value = '';
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
      updateImagePreview();
    });

    // RTU 수정 선택 시 폼 데이터 로드
    elements.rtuModifySelect.addEventListener('change', (e) => {
      const rtuId = e.target.value;
      const rtu = rtuList.find(r => r.id === rtuId);

      if (rtu) {
        elements.rtuIdForModification.value = rtu.id;
        document.getElementById('rtu-name').value = rtu.name; // ID 필드는 계속 표시
        document.getElementById('rtu-region').value = rtu.region;
        document.getElementById('rtu-model').value = rtu.model;
        document.getElementById('rtu-capacity').value = rtu.capacity;
        document.getElementById('rtu-unit-type').value = rtu.unitType;
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant;
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase;
        document.getElementById('rtu-date').value = rtu.date;
        document.getElementById('rtu-status').value = rtu.status;
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit;
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit;
        document.getElementById('rtu-notes').value = rtu.notes;
        
        // Load image URLs for preview
        imageBase64Data.imageUrl1 = rtu.imageUrl1 || '';
        imageBase64Data.imageUrl2 = rtu.imageUrl2 || '';
        imageBase64Data.imageUrl3 = rtu.imageUrl3 || '';
        updateImagePreview();

        // Clear file input fields for new uploads
        document.getElementById('rtu-image1').value = '';
        document.getElementById('rtu-image2').value = '';
        document.getElementById('rtu-image3').value = '';

      } else {
        elements.rtuForm.reset();
        elements.rtuIdForModification.value = '';
        imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
        updateImagePreview();
      }
    });

    // RTU 이미지 미리보기 업데이트 함수
    function updateImagePreview() {
      [1, 2, 3].forEach(index => {
        const imgElement = elements[`imagePreview${index}`];
        const imageUrl = imageBase64Data[`imageUrl${index}`];

        if (imageUrl) {
          imgElement.src = imageUrl;
          imgElement.style.display = 'block';
        } else {
          imgElement.src = '';
          imgElement.style.display = 'none';
        }
      });
      
      const hasAnyImage = imageBase64Data.imageUrl1 || imageBase64Data.imageUrl2 || imageBase64Data.imageUrl3;
      if (hasAnyImage) {
        elements.imagePreviewContainer.classList.remove('hidden');
      } else if (currentRtuMode === 'new') {
        elements.imagePreviewContainer.classList.add('hidden');
      } else if (currentRtuMode === 'modify' && elements.rtuModifySelect.value) {
         elements.imagePreviewContainer.classList.remove('hidden');
      } else {
         elements.imagePreviewContainer.classList.add('hidden');
      }
    }

    // 파일 입력 변경 이벤트 리스너
    ['rtu-image1', 'rtu-image2', 'rtu-image3'].forEach((id, index) => {
        document.getElementById(id).addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const key = `imageUrl${index + 1}`;
            
            // 파일이 선택되면 base64로 변환하여 임시 저장
            const base64 = await fileToBase64(file);
            imageBase64Data[key] = base64;
            
            // 미리보기 업데이트
            updateImagePreview();
        });
    });

    // RTU 폼 제출
    elements.rtuForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(elements.rtuForm);
      const data = Object.fromEntries(formData.entries());

      // 폼에서 파일을 선택하지 않은 경우, 기존의 이미지 URL(base64)을 사용
      data.imageUrl1 = imageBase64Data.imageUrl1;
      data.imageUrl2 = imageBase64Data.imageUrl2;
      data.imageUrl3 = imageBase64Data.imageUrl3;

      let newRtu;
      
      if (currentRtuMode === 'new') {
        // New RTU
        const newId = generateId('RTU');
        newRtu = {
          id: newId,
          name: data.name,
          region: data.region,
          model: data.model,
          capacity: data.capacity,
          unitType: data.unitType,
          refrigerant: data.refrigerant,
          electricPhase: data.electricPhase,
          date: data.date,
          status: data.status,
          pressureHighLimit: data.pressureHighLimit,
          pressureLowLimit: data.pressureLowLimit,
          notes: data.notes,
          imageUrl1: data.imageUrl1,
          imageUrl2: data.imageUrl2,
          imageUrl3: data.imageUrl3,
          lastUpdated: new Date().toISOString()
        };
        rtuList.push(newRtu);
        
      } else if (currentRtuMode === 'modify') {
        // Modify RTU
        const rtuId = elements.rtuIdForModification.value;
        if (!rtuId) {
          alert("수정할 RTU를 선택해주세요.");
          return;
        }

        const index = rtuList.findIndex(rtu => rtu.id === rtuId);
        if (index > -1) {
          newRtu = {
            ...rtuList[index], // Preserve old data not in form
            name: data.name,
            region: data.region,
            model: data.model,
            capacity: data.capacity,
            unitType: data.unitType,
            refrigerant: data.refrigerant,
            electricPhase: data.electricPhase,
            date: data.date,
            status: data.status,
            pressureHighLimit: data.pressureHighLimit,
            pressureLowLimit: data.pressureLowLimit,
            notes: data.notes,
            imageUrl1: data.imageUrl1,
            imageUrl2: data.imageUrl2,
            imageUrl3: data.imageUrl3,
            lastUpdated: new Date().toISOString()
          };
          rtuList[index] = newRtu;
        }
      }

      await saveToFirebase(STORAGE_KEYS.RTU, rtuList);
      elements.rtuForm.reset();
      elements.rtuIdForModification.value = '';
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
      updateImagePreview();
      
      if (currentRtuMode === 'modify') {
        // Reset to new mode after successful modification
        elements.modeNewBtn.click();
      }

      alert(currentRtuMode === 'new' ? 'RTU 정보가 성공적으로 등록되었습니다.' : 'RTU 정보가 성공적으로 수정되었습니다.');
      renderRtuList(rtuCurrentPage);
      populateRtuSelects(); // Update select options
      updateDashboard();
    });

    // RTU 삭제
    elements.rtuListContainer.addEventListener('click', async (e) => {
      if (e.target.classList.contains('delete-rtu-btn')) {
        const rtuId = e.target.dataset.id;
        const rtuName = e.target.dataset.name;
        if (confirm(`RTU [${rtuName}]를 정말로 삭제하시겠습니까?\n(관련 점검/수리 기록은 유지됩니다.)`)) {
          await deleteFromFirebase(STORAGE_KEYS.RTU, rtuId);
          rtuList = rtuList.filter(rtu => rtu.id !== rtuId);
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
          alert(`RTU [${rtuName}]가 삭제되었습니다.`);
        }
      } else if (e.target.classList.contains('modify-rtu-btn')) {
        const rtuId = e.target.dataset.id;
        // Switch to modify mode
        elements.modeModifyBtn.click();
        // Set the select box value to trigger form loading
        elements.rtuModifySelect.value = rtuId;
        elements.rtuModifySelect.dispatchEvent(new Event('change'));
      }
    });

    // 점검 기록 폼 제출
    elements.inspectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(elements.inspectionForm);
      const data = Object.fromEntries(formData.entries());

      const newInspection = {
        id: generateId('INS'),
        rtuId: data.rtuId,
        inspectionDate: data.inspectionDate,
        inspector: data.inspector,
        check1: data.check1,
        check2: data.check2,
        check3: data.check3,
        check4: data.check4,
        check5: data.check5,
        check6: data.check6,
        check7: data.check7,
        check8: data.check8,
        comp1Hp: data.comp1Hp || null,
        comp1Lp: data.comp1Lp || null,
        comp1Amp: data.comp1Amp || null,
        comp2Hp: data.comp2Hp || null,
        comp2Lp: data.comp2Lp || null,
        comp2Amp: data.comp2Amp || null,
        superheat: data.superheat || null,
        subcool: data.subcool || null,
        result: data.result,
        notes: data.notes,
        createdAt: new Date().toISOString()
      };

      inspectionList.push(newInspection);
      await saveToFirebase(STORAGE_KEYS.INSPECTION, inspectionList);
      elements.inspectionForm.reset();
      
      alert('점검 기록이 성공적으로 등록되었습니다.');
      renderInspectionList(inspectionCurrentPage);
      updateDashboard();
    });

    // 점검 기록 삭제
    elements.inspectionListContainer.addEventListener('click', async (e) => {
      if (e.target.classList.contains('delete-inspection-btn')) {
        const inspectionId = e.target.dataset.id;
        if (confirm('선택한 점검 기록을 삭제하시겠습니까?')) {
          await deleteFromFirebase(STORAGE_KEYS.INSPECTION, inspectionId);
          inspectionList = inspectionList.filter(item => item.id !== inspectionId);
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
          alert('점검 기록이 삭제되었습니다.');
        }
      }
    });

    // 수리 기록 폼 제출
    elements.repairForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(elements.repairForm);
      const data = Object.fromEntries(formData.entries());

      const newRepair = {
        id: generateId('REP'),
        rtuId: data.rtuId,
        repairDate: data.repairDate,
        engineer: data.engineer,
        status: data.status,
        issue: data.issue,
        createdAt: new Date().toISOString()
      };

      repairList.push(newRepair);
      await saveToFirebase(STORAGE_KEYS.REPAIR, repairList);
      elements.repairForm.reset();
      
      alert('수리 기록이 성공적으로 등록되었습니다.');
      renderRepairList(repairCurrentPage);
      updateDashboard();
    });

    // 수리 기록 삭제
    elements.repairListContainer.addEventListener('click', async (e) => {
      if (e.target.classList.contains('delete-repair-btn')) {
        const repairId = e.target.dataset.id;
        if (confirm('선택한 수리 기록을 삭제하시겠습니까?')) {
          await deleteFromFirebase(STORAGE_KEYS.REPAIR, repairId);
          repairList = repairList.filter(item => item.id !== repairId);
          renderRepairList(repairCurrentPage);
          updateDashboard();
          alert('수리 기록이 삭제되었습니다.');
        }
      }
    });

    // 상세 보기 모달 열기
    [elements.rtuListContainer, elements.inspectionListContainer, elements.repairListContainer].forEach(container => {
      container.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-detail-btn')) {
          const id = e.target.dataset.id;
          const type = e.target.dataset.type;
          
          let data;
          let title;

          if (type === 'rtu') {
            data = rtuList.find(r => r.id === id);
            title = 'RTU 장비 상세 정보';
            renderRtuDetail(data);
          } else if (type === 'inspection') {
            data = inspectionList.find(i => i.id === id);
            title = '점검 기록 상세 정보';
            renderInspectionDetail(data);
          } else if (type === 'repair') {
            data = repairList.find(r => r.id === id);
            title = '수리 기록 상세 정보';
            renderRepairDetail(data);
          }

          if (data) {
            elements.modalTitle.textContent = title;
            elements.detailModal.classList.remove('hidden');
            currentModalData = { id, type };
          }
        }
      });
    });

    // 모달 닫기
    elements.closeModalBtn.addEventListener('click', () => {
      elements.detailModal.classList.add('hidden');
      currentModalData = { id: null, type: null };
    });

    elements.detailModal.addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') {
        elements.detailModal.classList.add('hidden');
        currentModalData = { id: null, type: null };
      }
    });
    
    // 데이터 CSV 다운로드
    document.getElementById('download-data-btn').addEventListener('click', () => {
        const allData = {
            rtuList: rtuList.map(({ imageUrl1, imageUrl2, imageUrl3, ...rest }) => rest), // Remove base64 image data
            inspectionList: inspectionList,
            repairList: repairList
        };
        const jsonString = JSON.stringify(allData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rtu_system_data_${new Date().toISOString().substring(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // 데이터 CSV 업로드 (JSON 파일 로딩)
    document.getElementById('csv-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (confirm('기존의 모든 데이터가 덮어쓰여질 수 있습니다. 계속하시겠습니까?')) {
            try {
                const text = await file.text();
                const uploadedData = JSON.parse(text);

                if (uploadedData.rtuList) {
                    await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'rtuList'), arrayToObject(uploadedData.rtuList));
                }
                if (uploadedData.inspectionList) {
                    await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'inspectionList'), arrayToObject(uploadedData.inspectionList));
                }
                if (uploadedData.repairList) {
                    await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'repairList'), arrayToObject(uploadedData.repairList));
                }

                alert('데이터 업로드가 완료되었으며, Firebase에 동기화되었습니다.');
                e.target.value = ''; // Clear input
                // Firebase onValue listeners will automatically re-render
            } catch (error) {
                console.error('File upload error:', error);
                alert(`파일 처리 중 오류가 발생했습니다. JSON 파일 형식을 확인해주세요.\nError: ${error.message}`);
            }
        }
    });

    function arrayToObject(arr) {
        if (!arr || arr.length === 0) return {};
        return arr.reduce((obj, item) => {
            if (item.id) {
                obj[item.id] = item;
            }
            return obj;
        }, {});
    }


    /* ==================== 초기화 ==================== */
    loadFromFirebase().then(() => {
      // Initial render after loading
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();
    });

  </script>
</body>
</html>