<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (로컬 저장소 - 최종)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    /* 활성화된 탭 스타일 */
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 border-b pb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">RTU 통합 관리 시스템</h1>
          <p class="text-sm text-gray-500">데이터는 **브라우저에 로컬로 저장**됩니다.</p>
        </div>
        <span id="user-display" class="font-semibold text-gray-700">로컬 사용자</span>
      </div>

      <div class="flex border-b border-gray-200 mb-6 overflow-x-auto whitespace-nowrap">
        <button data-tab="dashboard" class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:border-blue-300 transition duration-150 tab-active border-blue-500">
          대시보드 (Dashboard)
        </button>
        <button data-tab="rtu-manage" class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:border-blue-300 transition duration-150">
          장비 등록/관리
        </button>
        <button data-tab="inspection-manage" class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:border-blue-300 transition duration-150">
          점검 등록/관리
        </button>
        <button data-tab="repair-manage" class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:border-blue-300 transition duration-150">
          수리 등록/관리
        </button>
        <button data-tab="report-page" class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:border-blue-300 transition duration-150">
          보고서 (Report)
        </button>
      </div>

      <div id="tab-content">
        
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">장비 상태 및 처리 현황 요약</h2>
          
          <h3 class="text-xl font-medium text-gray-700 mb-3">장비 상태 요약</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-100 text-blue-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">등록된 장비 수</p>
              <p id="dashboard-total" class="text-2xl font-bold mt-1">0</p>
            </div>
            <div class="bg-green-100 text-green-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">작동 중 (Running)</p>
              <p id="dashboard-running" class="text-2xl font-bold mt-1">0</p>
            </div>
            <div class="bg-gray-100 text-gray-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">정지됨 (Stopped)</p>
              <p id="dashboard-stopped" class="text-2xl font-bold mt-1">0</p>
            </div>
            <div class="bg-red-100 text-red-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">점검 필요 (Needs Insp.)</p>
              <p id="dashboard-needs-inspection" class="text-2xl font-bold mt-1">0</p>
            </div>
          </div>

          <h3 class="text-xl font-medium text-gray-700 mb-3 border-t pt-4">처리 현황</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-yellow-100 text-yellow-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">이번 달 점검 건수</p>
              <p id="dashboard-monthly-inspection" class="text-2xl font-bold mt-1">0</p>
            </div>
            <div class="bg-purple-100 text-purple-800 p-4 rounded-xl shadow-md">
              <p class="text-sm">미처리 수리 요청</p>
              <p id="dashboard-pending-repair" class="text-2xl font-bold mt-1">0</p>
            </div>
          </div>
          
          <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">개별 장비 상태 (최근 활동 5건)</h3>
          <div id="dashboard-latest-list" class="space-y-4">
            <p class="text-gray-500 italic">로딩 중...</p>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
            
            <form id="rtu-form" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4" id="rtu-form-title">RTU 장비 등록</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                        <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역</label>
                        <input type="text" id="rtu-region" name="region" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div>
                        <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                        <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량</label>
                        <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 유형</label>
                        <input type="text" id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                        <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                        <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            <option value="작동중">작동 중 (Running)</option>
                            <option value="정지됨">정지됨 (Stopped)</option>
                            <option value="점검필요">점검 필요 (Needs Inspection)</option>
                        </select>
                    </div>
                    <div>
                        <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                        <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            <option value="단상">단상 (Single Phase)</option>
                            <option value="삼상">삼상 (Three Phase)</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div>
                        <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치 날짜</label>
                        <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                </div>

                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">압력 상/하한 설정 (PSI)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 (PSI)</label>
                        <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 (PSI)</label>
                        <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                </div>

                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">장비 사진 등록 (최대 3장)</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <input type="file" id="rtu-image-1" name="image1" accept="image/*" class="hidden-file" onchange="previewImage(event, 1)">
                        <button type="button" onclick="document.getElementById('rtu-image-1').click()" class="w-full bg-white border border-gray-300 rounded-md shadow-sm p-2 text-gray-700 hover:bg-gray-100">사진 1 선택</button>
                    </div>
                    <div>
                        <input type="file" id="rtu-image-2" name="image2" accept="image/*" class="hidden-file" onchange="previewImage(event, 2)">
                        <button type="button" onclick="document.getElementById('rtu-image-2').click()" class="w-full bg-white border border-gray-300 rounded-md shadow-sm p-2 text-gray-700 hover:bg-gray-100">사진 2 선택</button>
                    </div>
                    <div>
                        <input type="file" id="rtu-image-3" name="image3" accept="image/*" class="hidden-file" onchange="previewImage(event, 3)">
                        <button type="button" onclick="document.getElementById('rtu-image-3').click()" class="w-full bg-white border border-gray-300 rounded-md shadow-sm p-2 text-gray-700 hover:bg-gray-100">사진 3 선택</button>
                    </div>
                </div>
                
                <div id="image-preview-container" class="mt-2 hidden flex gap-4">
                    <p class="text-sm font-medium text-gray-700 mb-1">미리보기:</p>
                    <img id="image-preview-1" class="max-h-24 rounded-lg border border-gray-200" alt="사진 1 미리보기"/>
                    <img id="image-preview-2" class="max-h-24 rounded-lg border border-gray-200" alt="사진 2 미리보기"/>
                    <img id="image-preview-3" class="max-h-24 rounded-lg border border-gray-200" alt="사진 3 미리보기"/>
                </div>

                <div class="mt-4">
                <label for="rtu-notes" class="block text-sm font-medium text-gray-700">기타 메모 (특이사항)</label>
                <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></textarea>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 shadow-md" id="rtu-submit-button">RTU 정보 저장</button>
            </form>

            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">등록된 RTU 목록 (<span id="rtu-count">0</span>건)</h2>
            <div id="rtu-list" class="space-y-4">
                </div>
            
        </div>

        <div id="inspection-manage" class="tab-page hidden">
            <form id="inspection-form" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">RTU 성능 점검 등록</h2>
                <div>
                    <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                    <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                        <option value="">-- RTU를 선택하세요 --</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                        <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                        <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                </div>
                
                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">부품 체크 (양호 / 불량 / 재점검 요망)</h3>
                <div class="space-y-1 p-3 border rounded-lg bg-white">
                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">필터</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check1" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check1" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check1" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">콘텍터</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check2" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check2" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check2" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">콘덴싱 코일</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check3" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check3" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check3" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">송풍 모터</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check4" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check4" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check4" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">증발기 코일</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check5" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check5" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check5" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">고압 센서</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check6" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check6" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check6" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">저압 센서</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check7" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check7" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check7" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                    
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 items-center border-b last:border-b-0 py-1">
                        <label class="text-sm font-medium text-gray-700">캐패시터</label>
                        <div class="flex space-x-2 sm:space-x-4 justify-end">
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check8" value="양호" class="form-radio text-blue-600">
                                    <span class="ml-1">양호</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check8" value="불량" class="form-radio text-blue-600">
                                    <span class="ml-1">불량</span>
                                </label>
                            
                                <label class="inline-flex items-center text-xs sm:text-sm whitespace-nowrap">
                                    <input type="radio" name="check8" value="재점검 요망" class="form-radio text-blue-600">
                                    <span class="ml-1">재점검 요망</span>
                                </label>
                            
                        </div>
                    </div>

                </div>

                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">컴프레서 1 측정값 (PSI, ℉, Amps)</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">고압값 (HP, PSI)</label>
                        <input type="number" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">저압값 (LP, PSI)</label>
                        <input type="number" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">암페어 (Amps)</label>
                        <input type="number" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                </div>

                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">컴프레서 2 측정값 (선택 사항)</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">고압값 (HP, PSI)</label>
                        <input type="number" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">저압값 (LP, PSI)</label>
                        <input type="number" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">암페어 (Amps)</label>
                        <input type="number" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                </div>

                <h3 class="text-base font-semibold text-gray-700 border-t pt-4 mt-4">온도 측정 (℉)</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">과열도 (Superheat, ℉)</label>
                        <input type="number" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">과냉도 (Subcool, ℉)</label>
                        <input type="number" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">증발 온도 (Evaporation, ℉)</label>
                        <input type="number" name="evapTemp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" step="0.1">
                    </div>
                </div>

                <div>
                    <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과</label>
                    <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        <option value="정상">정상</option>
                        <option value="주의">주의</option>
                        <option value="수리 필요">수리 필요</option>
                    </select>
                </div>
                <div>
                    <label for="inspection-notes" class="block text-sm font-medium text-gray-700">상세 특이사항</label>
                    <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">점검 정보 저장</button>
            </form>

            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">등록된 점검 목록 (<span id="inspection-count">0</span>건)</h2>
            <div id="inspection-list" class="space-y-4">
                </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
            <form id="repair-form" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">RTU 수리 등록</h2>
                <div>
                    <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                    <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                        <option value="">-- RTU를 선택하세요 --</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                        <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                        <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                </div>
                <div>
                    <label for="repair-issue" class="block text-sm font-medium text-gray-700">발생 문제 및 조치 내용 *</label>
                    <textarea id="repair-issue" name="issue" rows="2" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></textarea>
                </div>
                <div>
                    <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                    <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        <option value="요청">요청 (미처리)</option>
                        <option value="진행중">진행 중</option>
                        <option value="완료">완료</option>
                    </select>
                </div>

                <button type="submit" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">수리 정보 저장</button>
            </form>

            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">등록된 수리 목록 (<span id="repair-count">0</span>건)</h2>
            <div id="repair-list" class="space-y-4">
                </div>
        </div>

        <div id="report-page" class="tab-page hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">보고서 생성 및 통계</h2>
            <div class="bg-gray-100 p-6 rounded-lg text-gray-600">
                <p class="mb-3">이 페이지는 현재 저장된 장비, 점검, 수리 데이터를 기반으로 월별/연도별 현황 및 분석 보고서를 출력하는 기능을 구현할 수 있습니다.</p>
                <h3 class="font-bold mt-4">데이터 현황</h3>
                <ul class="list-disc list-inside ml-4">
                    <li>총 등록 장비: <span id="report-total-rtu" class="font-semibold">0</span>대</li>
                    <li>총 점검 기록: <span id="report-total-inspection" class="font-semibold">0</span>건</li>
                    <li>총 수리 기록: <span id="report-total-repair" class="font-semibold">0</span>건</li>
                </ul>
            </div>
            
            <h3 class="font-bold text-xl text-gray-800 mt-6 border-t pt-4">데이터 다운로드 (CSV)</h3>
            <p class="text-sm text-gray-600 mb-3">저장된 RTU, 점검, 수리 데이터를 엑셀 등에서 열어볼 수 있도록 CSV 파일로 다운로드합니다. (사진 파일 제외)</p>
            <button id="download-data-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md w-full">
                RTU, 점검, 수리 데이터 CSV로 다운로드
            </button>
        </div>

      </div>
      
    </div>
  </div>

  <div id="detail-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full shadow-2xl overflow-y-auto max-h-[90vh]">
      <h3 id="modal-title" class="text-2xl font-bold mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="space-y-3 text-gray-700">
        </div>
      <div class="mt-6 flex justify-end">
        <button id="close-modal-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-150">닫기</button>
      </div>
    </div>
  </div>

  <script>
    /* ============================
       로컬 저장소 및 데이터 구조
       ============================ */
    const STORAGE_KEYS = {
        RTU: 'rtuList',
        INSPECTION: 'inspectionList',
        REPAIR: 'repairList'
    };

    let rtuList = loadList(STORAGE_KEYS.RTU);
    let inspectionList = loadList(STORAGE_KEYS.INSPECTION);
    let repairList = loadList(STORAGE_KEYS.REPAIR);

    // 점검 항목 레이블
    const INSPECTION_CHECK_LABELS = [
        '필터', '콘텍터', '콘덴싱 코일', '송풍 모터', 
        '증발기 코일', '고압 센서', '저압 센서', '캐패시터'
    ];


    function loadList(key) {
        try {
            const json = localStorage.getItem(key);
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error(`로컬 저장소 (${key}) 로드 실패`, e);
            return [];
        }
    }

    function saveList(key, list) {
        try {
            localStorage.setItem(key, JSON.stringify(list));
        } catch (e) {
            console.error(`로컬 저장소 (${key}) 저장 실패`, e);
            alert("데이터 저장에 실패했습니다. 브라우저 저장 공간이 부족할 수 있습니다.");
        }
    }
    
    /* ============================
       UI 요소 및 이벤트 핸들러 초기화
       ============================ */
    const elements = {
        rtuForm: document.getElementById('rtu-form'),
        inspectionForm: document.getElementById('inspection-form'),
        repairForm: document.getElementById('repair-form'), 
        imagePreviewContainer: document.getElementById('image-preview-container'),
        detailModal: document.getElementById('detail-modal'),
        tabButtons: document.querySelectorAll('.tab-btn'),
        inspectionRtuSelect: document.getElementById('inspection-rtu-id'),
        repairRtuSelect: document.getElementById('repair-rtu-id'),
        rtuList: document.getElementById('rtu-list'),
        inspectionList: document.getElementById('inspection-list'),
        repairList: document.getElementById('repair-list'),
        rtuCountSpan: document.getElementById('rtu-count'),
        inspectionCountSpan: document.getElementById('inspection-count'),
        repairCountSpan: document.getElementById('repair-count'),
        // Dashboard Elements
        dashboardTotal: document.getElementById('dashboard-total'),
        dashboardRunning: document.getElementById('dashboard-running'),
        dashboardStopped: document.getElementById('dashboard-stopped'),
        dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
        dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
        dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
        dashboardLatestList: document.getElementById('dashboard-latest-list'),
        // Report Elements
        reportTotalRtu: document.getElementById('report-total-rtu'),
        reportTotalInspection: document.getElementById('report-total-inspection'),
        reportTotalRepair: document.getElementById('report-total-repair'),
        downloadDataBtn: document.getElementById('download-data-btn'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        // New elements for RTU management
        rtuFormTitle: document.getElementById('rtu-form-title'), // ⭐ 새 ID 사용
        rtuSubmitButton: document.getElementById('rtu-submit-button') // ⭐ 새 ID 사용
    };

    let currentModalData = { id: null, type: null }; 
    let editingRtuId = null; // ⭐ 현재 수정 중인 RTU ID

    // --- 탭 전환 로직 ---
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // 버튼 스타일 변경
            elements.tabButtons.forEach(btn => btn.classList.remove('tab-active', 'border-blue-500'));
            button.classList.add('tab-active', 'border-blue-500');

            // 페이지 컨텐츠 전환
            document.querySelectorAll('.tab-page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(targetTab).classList.remove('hidden');

            // 탭에 따른 데이터 갱신
            if (targetTab === 'dashboard') {
                updateDashboard();
            } else if (targetTab === 'rtu-manage') {
                // RTU 탭으로 이동 시 등록 모드로 초기화
                resetRtuForm(); 
                renderRtuList();
            } else if (targetTab === 'inspection-manage') {
                populateRtuSelects(); 
                renderInspectionList();
            } else if (targetTab === 'repair-manage') {
                populateRtuSelects(); 
                renderRepairList();
            } else if (targetTab === 'report-page') {
                updateReportPage();
            }
        });
    });
    
    // --- 이미지 미리보기 (3장 대응) ---
    function previewImage(event, index) {
        const previewEl = document.getElementById(`image-preview-${index}`);
        if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewEl.src = e.target.result;
                elements.imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(event.target.files[0]);
        } else {
             previewEl.src = '';
        }
        
        // 모든 이미지가 비었으면 컨테이너 숨기기
        const allHidden = !document.getElementById('rtu-image-1').files.length && 
                          !document.getElementById('rtu-image-2').files.length && 
                          !document.getElementById('rtu-image-3').files.length;
        if (allHidden && !document.getElementById('image-preview-1').src.includes('data:')) elements.imagePreviewContainer.classList.add('hidden');
        else elements.imagePreviewContainer.classList.remove('hidden');
    }

    window.previewImage = previewImage; 

    // --- RTU 선택 드롭다운 채우기 ---
    function populateRtuSelects() {
        const selects = [elements.inspectionRtuSelect, elements.repairRtuSelect];
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>';
            rtuList.forEach(rtu => {
                const option = document.createElement('option');
                option.value = rtu.id;
                option.textContent = `${rtu.name} (${rtu.region || '지역 미정'})`;
                select.appendChild(option);
            });
            select.value = currentValue; 
        });
    }

    // --- 대시보드 데이터 업데이트 ---
    function updateDashboard() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // 1. 장비 상태 요약
        elements.dashboardTotal.textContent = rtuList.length;
        elements.dashboardRunning.textContent = rtuList.filter(r => r.status === '작동중').length;
        elements.dashboardStopped.textContent = rtuList.filter(r => r.status === '정지됨').length;
        elements.dashboardNeedsInspection.textContent = rtuList.filter(r => r.status === '점검필요').length;

        // 2. 월별 점검 수
        const monthlyInspectionCount = inspectionList.filter(item => {
            // timestamp를 Date 객체로 변환
            const itemDate = new Date(item.timestamp);
            return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
        }).length;
        elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

        // 3. 미처리 수리 요청
        const pendingRepairCount = repairList.filter(item => item.status !== '완료').length;
        elements.dashboardPendingRepair.textContent = pendingRepairCount;

        // 4. 최신 활동 목록
        const allActivities = [
            ...rtuList.map(item => ({ date: new Date(item.timestamp), name: item.name, type: '장비 등록', id: item.id, itemType: 'RTU' })),
            ...inspectionList.map(item => ({ date: new Date(item.timestamp), name: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없는 RTU', type: `점검 (${item.result})`, id: item.id, itemType: '점검' })),
            ...repairList.map(item => ({ date: new Date(item.timestamp), name: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없는 RTU', type: `수리 (${item.status})`, id: item.id, itemType: '수리' }))
        ];

        const sortedActivities = allActivities.sort((a, b) => b.date.getTime() - a.date.getTime());
        const latest5 = sortedActivities.slice(0, 5);

        elements.dashboardLatestList.innerHTML = '';
        if (latest5.length === 0) {
            elements.dashboardLatestList.innerHTML = '<p class="text-gray-500 italic">최근 활동 내역이 없습니다.</p>';
            return;
        }

        latest5.forEach(activity => {
            const dateString = activity.date.toLocaleDateString('ko-KR');
            let color = activity.type.includes('등록') ? 'border-blue-400' : activity.type.includes('수리 (요청)') ? 'border-red-400' : 'border-gray-200';
            
            const item = document.createElement('div');
            item.className = `flex justify-between items-center bg-gray-50 p-3 rounded-lg border-l-4 ${color} shadow-sm`;
            item.innerHTML = `
                <div class="min-w-0">
                    <p class="font-semibold truncate">${activity.type}</p>
                    <p class="text-xs text-gray-500">${activity.name} | ${dateString}</p>
                </div>
                <button onclick="showDetailModal('${activity.id}', '${activity.itemType}')" class="bg-gray-200 text-gray-700 text-sm py-1 px-3 rounded-md hover:bg-gray-300 transition duration-150">상세</button>
            `;
            elements.dashboardLatestList.appendChild(item);
        });
    }

    // --- 보고서 페이지 업데이트 ---
    function updateReportPage() {
        elements.reportTotalRtu.textContent = rtuList.length;
        elements.reportTotalInspection.textContent = inspectionList.length;
        elements.reportTotalRepair.textContent = repairList.length;
    }


    // ⭐ RTU 폼 초기화 및 모드 변경 함수
    function resetRtuForm() {
        elements.rtuForm.reset();
        elements.rtuFormTitle.textContent = 'RTU 장비 등록';
        elements.rtuSubmitButton.textContent = 'RTU 정보 저장';
        editingRtuId = null; 
        document.getElementById('rtu-name').disabled = false; // 등록번호 수정 가능
        
        // 이미지 미리보기 초기화
        for (let i = 1; i <= 3; i++) {
            const previewEl = document.getElementById(`image-preview-${i}`);
            previewEl.src = '';
            const fileInput = document.getElementById(`rtu-image-${i}`);
            // 파일 입력 값 초기화 (새로 등록/수정 시 파일 다시 선택하도록)
            fileInput.value = null; 
        }
        elements.imagePreviewContainer.classList.add('hidden');
    }
    
    // ⭐ RTU 수정 모드로 전환
    window.editRtu = function(rtuId) {
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) return;

        // 폼 초기화 및 수정 모드 설정
        resetRtuForm();
        editingRtuId = rtuId;
        elements.rtuFormTitle.textContent = `RTU 정보 수정: ${rtu.name}`;
        elements.rtuSubmitButton.textContent = 'RTU 정보 수정 완료';
        document.getElementById('rtu-name').disabled = true; // 등록번호는 수정 불가

        // 데이터 폼에 채우기
        const formElements = elements.rtuForm.elements;
        // 텍스트/숫자/날짜/셀렉트 필드 채우기
        for (const key in rtu) {
            const input = formElements.namedItem(key);
            if (input) {
                input.value = rtu[key] || '';
            }
        }
        
        // 이미지 미리보기 채우기 (Base64 데이터가 있으면 로드)
        const imageKeys = ['image1', 'image2', 'image3'];
        let hasImage = false;
        imageKeys.forEach((key, index) => {
            const previewEl = document.getElementById(`image-preview-${index + 1}`);
            if (rtu[key]) {
                previewEl.src = rtu[key];
                hasImage = true;
            } else {
                previewEl.src = '';
            }
        });

        if (hasImage) elements.imagePreviewContainer.classList.remove('hidden');
        else elements.imagePreviewContainer.classList.add('hidden');

        // 스크롤을 폼으로 이동
        window.scrollTo({ top: elements.rtuForm.offsetTop - 20, behavior: 'smooth' });
    }

    // --- RTU 목록 렌더링 (수정 버튼 추가) ---
    function renderRtuList() {
        elements.rtuList.innerHTML = '';
        elements.rtuCountSpan.textContent = rtuList.length;
        if (rtuList.length === 0) {
            elements.rtuList.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 정보가 없습니다. 상단에서 새로 등록할 수 있습니다.</p>';
            return;
        }
        
        const sortedList = [...rtuList].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        const placeholderSvg = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 96 72\' fill=\'%23e5e7eb\'%3E%3Crect width=\'96\' height=\'72\'/%3E%3Cpath fill=\'%236b7280\' d=\'M37 54.8L28.2 46l-6.8 6.8v-1.6l8.4-8.4 8.6 8.6 13.8-13.8L58.2 38l12.4-12.4L73 26.2v14.6h1.2v-16.8H73v1.2L58.2 42.4 44.4 56.2z\'/%3E%3C/svg%3E';

        sortedList.forEach(rtu => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition duration-150 cursor-pointer';
            
            const thumbSrc = rtu.image1 ? rtu.image1 : placeholderSvg;

            item.innerHTML = `
                <div class="flex items-center gap-4 min-w-0">
                    <img src="${thumbSrc}" class="thumb" onerror="this.onerror=null; this.src='${placeholderSvg}';" alt="${rtu.name} 사진"/>
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-semibold text-gray-800 truncate">${rtu.name}</p>
                        <p class="text-sm text-gray-500">${rtu.region || 'N/A'} (${rtu.model || 'N/A'}) - 상태: <span class="font-bold text-${rtu.status === '작동중' ? 'green' : rtu.status === '점검필요' ? 'red' : 'gray'}-600">${rtu.status}</span></p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="event.stopPropagation(); editRtu('${rtu.id}')" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 transition duration-150">수정</button>
                    <button onclick="event.stopPropagation(); showDetailModal('${rtu.id}', 'RTU')" class="view-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-150">상세</button>
                </div>
            `;
            elements.rtuList.appendChild(item);
        });
    }

    // --- 점검 목록 렌더링 ---
    function renderInspectionList() {
        elements.inspectionList.innerHTML = '';
        elements.inspectionCountSpan.textContent = inspectionList.length;
        if (inspectionList.length === 0) {
            elements.inspectionList.innerHTML = '<p class="text-gray-500 italic">등록된 점검 정보가 없습니다.</p>';
            return;
        }

        const sortedList = [...inspectionList].sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));

        sortedList.forEach(item => {
            const rtu = rtuList.find(r => r.id === item.rtuId);
            const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
            
            let resultClass = 'text-gray-600';
            if (item.result === '정상') resultClass = 'text-green-600 font-bold';
            else if (item.result === '주의') resultClass = 'text-yellow-600 font-bold';
            else if (item.result === '수리 필요') resultClass = 'text-red-600 font-bold';

            const listItem = document.createElement('div');
            listItem.className = 'flex items-center justify-between gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition duration-150';
            listItem.innerHTML = `
                <div class="min-w-0 flex-1">
                    <p class="text-lg font-semibold text-gray-800 truncate">${rtuName} (${item.inspectionDate})</p>
                    <p class="text-sm text-gray-500">점검자: ${item.inspector} / 과열도: ${item.superheat || 'N/A'}℉</p>
                </div>
                <p class="${resultClass} font-semibold text-right">${item.result}</p>
                <button onclick="event.stopPropagation(); showDetailModal('${item.id}', '점검')" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-150">상세보기</button>
            `;
            elements.inspectionList.appendChild(listItem);
        });
    }

    // --- 수리 목록 렌더링 ---
    function renderRepairList() {
        elements.repairList.innerHTML = '';
        elements.repairCountSpan.textContent = repairList.length;

        if (repairList.length === 0) {
            elements.repairList.innerHTML = '<p class="text-gray-500 italic">등록된 수리 정보가 없습니다.</p>';
            return;
        }

        const sortedList = [...repairList].sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));

        sortedList.forEach(item => {
            const rtu = rtuList.find(r => r.id === item.rtuId);
            const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
            
            let statusClass = 'bg-gray-200 text-gray-800';
            if (item.status === '요청') statusClass = 'bg-red-500 text-white';
            else if (item.status === '진행중') statusClass = 'bg-yellow-500 text-gray-900';
            else if (item.status === '완료') statusClass = 'bg-green-500 text-white';

            const listItem = document.createElement('div');
            listItem.className = 'flex items-center justify-between gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition duration-150';
            listItem.innerHTML = `
                <div class="min-w-0 flex-1">
                    <p class="text-lg font-semibold text-gray-800 truncate">${rtuName} 수리 요청 (${item.repairDate})</p>
                    <p class="text-sm text-gray-500">담당자: ${item.engineer} / 문제: ${item.issue.substring(0, 20)}...</p>
                </div>
                <span class="text-sm font-semibold py-1 px-3 rounded-full ${statusClass}">${item.status}</span>
                <button onclick="event.stopPropagation(); showDetailModal('${item.id}', '수리')" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-150">상세보기</button>
            `;
            elements.repairList.appendChild(listItem);
        });
    }
    
    // 이 함수는 폼에서 라디오 버튼의 값을 가져오는 헬퍼 함수입니다.
    function getRadioSelected(name) {
        const radios = document.getElementsByName(name);
        for (let i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                return radios[i].value;
            }
        }
        return null; // 선택된 값이 없으면 null 반환
    }

    // --- 폼 제출 핸들러 ---
    elements.rtuForm.addEventListener('submit', handleRtuSubmit);
    elements.inspectionForm.addEventListener('submit', handleInspectionSubmit);
    elements.repairForm.addEventListener('submit', handleRepairSubmit); 

    async function handleRtuSubmit(e) {
        e.preventDefault();
        const formData = new FormData(elements.rtuForm);
        
        let rtuData = {
            name: formData.get('name'),
            region: formData.get('region'),
            model: formData.get('model'),
            capacity: formData.get('capacity'),
            unitType: formData.get('unitType'),
            refrigerant: formData.get('refrigerant'),
            status: formData.get('status'),
            electricPhase: formData.get('electricPhase'),
            date: formData.get('date'),
            pressureHighLimit: formData.get('pressureHighLimit'),
            pressureLowLimit: formData.get('pressureLowLimit'),
            notes: formData.get('notes'),
        };

        const fileInputs = [document.getElementById('rtu-image-1'), document.getElementById('rtu-image-2'), document.getElementById('rtu-image-3')];
        let imagesToLoad = [];
        let isImageChanged = false; // 이미지 파일이 새로 선택되었는지 여부 (Base64 변환이 필요함을 의미)

        // 이미지 처리
        for (let i = 0; i < fileInputs.length; i++) {
            const input = fileInputs[i];
            const key = `image${i + 1}`;
            
            // 1. 파일이 새로 선택된 경우 (수정/등록 공통)
            if (input.files.length > 0) {
                isImageChanged = true;
                imagesToLoad.push(new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        rtuData[key] = event.target.result;
                        resolve();
                    };
                    reader.readAsDataURL(input.files[0]);
                }));
            } 
            // 2. 수정 모드이고 파일 입력이 비어 있는 경우: 기존 데이터 유지
            else if (editingRtuId) {
                const existingRtu = rtuList.find(r => r.id === editingRtuId);
                // 기존 데이터에 해당 이미지가 있다면 그대로 사용
                if (existingRtu && existingRtu[key]) {
                    rtuData[key] = existingRtu[key]; 
                } else {
                    rtuData[key] = null;
                }
            } 
            // 3. 등록 모드이고 파일 입력이 비어 있는 경우: null
            else {
                rtuData[key] = null;
            }
        }

        await Promise.all(imagesToLoad);
        
        // ⭐ 수정 로직
        if (editingRtuId) {
            const index = rtuList.findIndex(r => r.id === editingRtuId);
            if (index !== -1) {
                // 기존 데이터에 새 데이터 덮어쓰기 (timestamp는 최초 등록 시간 유지)
                rtuList[index] = { ...rtuList[index], ...rtuData };
                alert('RTU 정보가 성공적으로 수정되었습니다.');
            }
        } 
        // ⭐ 등록 로직
        else {
            rtuData.id = Date.now().toString();
            rtuData.timestamp = new Date().toLocaleString('ko-KR');
            rtuList.push(rtuData);
        }

        await processDataSaved(elements.rtuForm, renderRtuList, STORAGE_KEYS.RTU, rtuList);
        
        // 폼 초기화 및 등록 모드로 전환
        resetRtuForm();
    }

    async function handleInspectionSubmit(e) {
        e.preventDefault();
        const formData = new FormData(elements.inspectionForm);
        const data = {
            id: Date.now().toString(),
            rtuId: formData.get('rtuId'),
            inspectionDate: formData.get('inspectionDate'),
            inspector: formData.get('inspector'),
            // Component Check (1-8)
            check1: getRadioSelected('check1'), 
            check2: getRadioSelected('check2'), 
            check3: getRadioSelected('check3'), 
            check4: getRadioSelected('check4'), 
            check5: getRadioSelected('check5'), 
            check6: getRadioSelected('check6'), 
            check7: getRadioSelected('check7'), 
            check8: getRadioSelected('check8'), 
            // Comp 1
            comp1Hp: formData.get('comp1Hp'),
            comp1Lp: formData.get('comp1Lp'),
            comp1Amp: formData.get('comp1Amp'),
            // Comp 2
            comp2Hp: formData.get('comp2Hp'),
            comp2Lp: formData.get('comp2Lp'),
            comp2Amp: formData.get('comp2Amp'),
            // Temperature
            superheat: formData.get('superheat'),
            subcool: formData.get('subcool'),
            evapTemp: formData.get('evapTemp'),
            result: formData.get('result'),
            notes: formData.get('notes'),
            timestamp: new Date().toLocaleString('ko-KR')
        };
        
        // 필수 체크 항목이 하나라도 누락되었는지 확인
        for(let i = 1; i <= 8; i++) {
            if (!data[`check${i}`]) {
                alert(`${INSPECTION_CHECK_LABELS[i-1]} 상태를 반드시 선택해야 합니다.`);
                return;
            }
        }
        
        inspectionList.push(data);
        await processDataSaved(elements.inspectionForm, renderInspectionList, STORAGE_KEYS.INSPECTION, inspectionList);
    }

    async function handleRepairSubmit(e) { 
        e.preventDefault();
        const formData = new FormData(elements.repairForm);
        const data = {
            id: Date.now().toString(),
            rtuId: formData.get('rtuId'),
            repairDate: formData.get('repairDate'),
            engineer: formData.get('engineer'),
            issue: formData.get('issue'),
            status: formData.get('status'),
            timestamp: new Date().toLocaleString('ko-KR')
        };
        repairList.push(data);
        await processDataSaved(elements.repairForm, renderRepairList, STORAGE_KEYS.REPAIR, repairList);
    }
    
    // 데이터 저장 후 UI 업데이트 공통 함수
    async function processDataSaved(form, renderFunc, key, list) {
        saveList(key, list); 
        form.reset();
        elements.imagePreviewContainer.classList.add('hidden');
        renderFunc(); 
        updateDashboard();
        populateRtuSelects(); // 드롭다운 갱신
        alert('정보가 성공적으로 저장되었습니다.');
    }

    // --- 상세보기 모달 ---
    window.showDetailModal = function(id, type) {
        let item, listKey, list;

        if (type === 'RTU') { listKey = STORAGE_KEYS.RTU; list = rtuList; } 
        else if (type === '점검') { listKey = STORAGE_KEYS.INSPECTION; list = inspectionList; }
        else if (type === '수리') { listKey = STORAGE_KEYS.REPAIR; list = repairList; }
        
        item = list.find(r => r.id === id);
        if (!item) return;

        currentModalData = { id: id, type: type, listKey: listKey };
        document.getElementById('modal-title').textContent = `${type} 상세 정보`;
        let contentHtml = '';

        if (type === 'RTU') {
            const images = [item.image1, item.image2, item.image3].filter(img => img);
            const imageHtml = images.length > 0 ? images.map((img, index) => `<img src="${img}" class="w-full max-h-64 object-contain rounded-lg mb-2 border border-gray-200" alt="RTU 사진 ${index+1}"/>`).join('') : '<p class="text-gray-500 italic">등록된 사진 없음</p>';
            
            contentHtml = `
                <div class="space-y-4">
                    ${imageHtml}
                    <div class="border-t pt-2 space-y-1">
                        <p><strong>RTU ID:</strong> ${item.name}</p>
                        <p><strong>상태:</strong> <span class="font-bold text-${item.status === '작동중' ? 'green' : item.status === '점검필요' ? 'red' : 'gray'}-600">${item.status}</span></p>
                        <p><strong>설치 장소:</strong> ${item.region || 'N/A'}</p>
                        <p><strong>모델명 / 용량:</strong> ${item.model || 'N/A'} / ${item.capacity || 'N/A'}</p>
                        <p><strong>유닛 유형 / 냉매:</strong> ${item.unitType || 'N/A'} / ${item.refrigerant || 'N/A'}</p>
                        <p><strong>전기 종류:</strong> ${item.electricPhase || 'N/A'}</p>
                        <p><strong>설치 날짜:</strong> ${item.date || 'N/A'}</p>
                    </div>
                    <div class="border-t pt-2 space-y-1">
                        <h4 class="font-semibold">압력 상/하한 (PSI)</h4>
                        <p><strong>고압 상한:</strong> ${item.pressureHighLimit || 'N/A'} PSI</p>
                        <p><strong>저압 하한:</strong> ${item.pressureLowLimit || 'N/A'} PSI</p>
                    </div>
                    <div class="border-t pt-2 space-y-1">
                        <h4 class="font-semibold">기타 메모:</h4>
                        <p class="whitespace-pre-wrap">${item.notes ? item.notes : '없음'}</p>
                    </div>
                    <p class="text-xs text-gray-400 pt-2">최초 등록 시간: ${item.timestamp}</p>
                </div>
            `;
        } else if (type === '점검') {
            const rtu = rtuList.find(r => r.id === item.rtuId);

            // 점검 항목 상세 표시
            let checkItemsHtml = '<h4 class="font-semibold mt-3 border-t pt-2">부품 상태 체크</h4><ul class="list-disc list-inside ml-4">';
            INSPECTION_CHECK_LABELS.forEach((label, index) => {
                const checkStatus = item[`check${index + 1}`] || '미선택';
                let statusColor = checkStatus === '양호' ? 'text-green-600' : checkStatus === '불량' ? 'text-red-600' : 'text-yellow-600';
                checkItemsHtml += `<li>${label}: <span class="font-bold ${statusColor}">${checkStatus}</span></li>`;
            });
            checkItemsHtml += '</ul>';

            contentHtml = `
                <p><strong>대상 RTU:</strong> ${rtu ? rtu.name : '삭제된 RTU'}</p>
                <p><strong>점검 날짜:</strong> ${item.inspectionDate}</p>
                <p><strong>점검자:</strong> ${item.inspector}</p>
                <p><strong>최종 결과:</strong> <span class="font-bold text-${item.result === '정상' ? 'green' : item.result === '주의' ? 'yellow' : 'red'}-600">${item.result}</span></p>
                
                ${checkItemsHtml}

                <h4 class="font-semibold mt-3 border-t pt-2">측정 데이터</h4>
                <p><strong>컴프레서 1:</strong> HP ${item.comp1Hp || 'N/A'}PSI / LP ${item.comp1Lp || 'N/A'}PSI / AMP ${item.comp1Amp || 'N/A'}</p>
                <p><strong>컴프레서 2:</strong> HP ${item.comp2Hp || 'N/A'}PSI / LP ${item.comp2Lp || 'N/A'}PSI / AMP ${item.comp2Amp || 'N/A'}</p>
                <p><strong>온도 측정 (℉):</strong> 과열도 ${item.superheat || 'N/A'}℉ / 과냉도 ${item.subcool || 'N/A'}℉ / 증발 온도 ${item.evapTemp || 'N/A'}℉</p>
                <h4 class="font-semibold mt-3">상세 특이사항:</h4>
                <p class="whitespace-pre-wrap">${item.notes ? item.notes : '없음'}</p>
                <p class="text-xs text-gray-400 mt-4">등록 시간: ${item.timestamp}</p>
            `;
        } else if (type === '수리') {
            const rtu = rtuList.find(r => r.id === item.rtuId);
            contentHtml = `
                <p><strong>대상 RTU:</strong> ${rtu ? rtu.name : '삭제된 RTU'}</p>
                <p><strong>요청/완료일:</strong> ${item.repairDate}</p>
                <p><strong>수리 담당자:</strong> ${item.engineer}</p>
                <p><strong>처리 상태:</strong> <span class="font-bold text-${item.status === '완료' ? 'green' : item.status === '진행중' ? 'yellow' : 'red'}-600">${item.status}</span></p>
                <h4 class="font-semibold mt-3">발생 문제 및 조치:</h4>
                <p class="whitespace-pre-wrap">${item.issue}</p>
                <p class="text-xs text-gray-400 mt-4">등록 시간: ${item.timestamp}</p>
            `;
        }

        document.getElementById('modal-content').innerHTML = contentHtml;
        elements.detailModal.classList.remove('hidden');
    }
    
    // --- 데이터 다운로드 기능 ---
    function convertToCSV(data, title) {
        if (data.length === 0) return '';

        // 이미지(Base64)와 timestamp를 제외한 키 필터링
        const keys = Object.keys(data[0]).filter(key => 
            !key.startsWith('image') && key !== 'timestamp' && key !== 'id'
        );

        // 헤더 행 생성 (필요에 따라 한글 레이블로 변경 가능)
        const header = ['ID', '등록시간', ...keys].join(',');

        // 데이터 행 생성
        const rows = data.map(row => {
            const values = [row.id, row.timestamp];
            keys.forEach(key => {
                let value = row[key] === null || row[key] === undefined ? '' : String(row[key]);
                
                // 콤마, 따옴표, 줄바꿈이 포함된 값은 이스케이프 (CSV 표준)
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                values.push(value);
            });
            return values.join(',');
        });

        return `${title}\n${header}\n${rows.join('\n')}`;
    }

    function downloadData(filename, data) {
        const blob = new Blob([data], { type: 'text/csv;charset=utf-8;\uFEFF' }); // \uFEFF for UTF-8 BOM (Excel 호환성)
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function handleDataDownload() {
        const today = new Date().toISOString().slice(0, 10);
        let allCsvContent = [];
        
        // RTU Data
        const rtuCsv = convertToCSV(rtuList, 'RTU_장비_등록_Data');
        if (rtuCsv) allCsvContent.push(rtuCsv);

        // Inspection Data
        const inspectionCsv = convertToCSV(inspectionList, 'RTU_성능_점검_Data');
        if (inspectionCsv) allCsvContent.push(inspectionCsv);

        // Repair Data
        const repairCsv = convertToCSV(repairList, 'RTU_수리_기록_Data');
        if (repairCsv) allCsvContent.push(repairCsv);

        if (allCsvContent.length === 0) {
            alert("다운로드할 데이터가 없습니다.");
            return;
        }

        // 각 데이터 섹션을 구분하여 하나의 파일로 만듭니다.
        const finalCsv = allCsvContent.join('\n\n\n'); 
        
        downloadData(`RTU_Management_Data_Export_${today}.csv`, finalCsv);
    }


    /* ============================
       초기화 (페이지 로드 시 실행)
       ============================ */
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- 초기 데이터 로드 및 렌더링 ---
        updateDashboard();
        populateRtuSelects();
        
        // 초기 탭 설정 (대시보드를 먼저 보여줌)
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('rtu-manage').classList.add('hidden');
        document.getElementById('inspection-manage').classList.add('hidden');
        document.getElementById('repair-manage').classList.add('hidden');
        document.getElementById('report-page').classList.add('hidden');
        
        // --- 모달 이벤트 리스너 ---
        // 1. 닫기 버튼 작동
        elements.closeModalBtn.addEventListener('click', () => {
            elements.detailModal.classList.add('hidden');
            currentModalData = { id: null, type: null };
        });

        // 2. 모달 외부 클릭 시 닫기
        elements.detailModal.addEventListener('click', (e) => {
            // modal-bg 클래스가 있는 배경을 클릭했을 때만 닫기
            if (e.target.classList.contains('modal-bg')) {
                elements.detailModal.classList.add('hidden');
                currentModalData = { id: null, type: null };
            }
        });

        // --- 데이터 다운로드 버튼 리스너 ---
        elements.downloadDataBtn.addEventListener('click', handleDataDownload);

        console.warn("데이터는 브라우저의 localStorage에만 저장되며, 브라우저를 변경하거나 기록을 삭제하면 데이터가 손실될 수 있습니다.");
    });
  </script>
</body>
</html>