<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== 보고서 인쇄를 위한 CSS 추가 (print-only는 사용하지 않음) ========== */
    .print-only { display: none; } /* 기존 코드에서 남아있는 print-only는 display:none; 상태 유지 */
    @media print {
      /* 앱의 기본 배경과 테두리를 숨겨 인쇄 영역을 깔끔하게 만듭니다. */
      .print-container, #main-app-container { /* 인쇄 문제 해결: 메인 컨테이너 강제 표시 */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* 인쇄 시 숨겨야 할 요소 (버튼, 메뉴 등) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* 인쇄 시 상세 보고서 내용만 표시를 위해 report-page와 detail-view를 강제 표시 */
      #report-page, #report-detail-view { /* 인쇄 문제 해결: 보고서 관련 요소 강제 표시 및 정리 */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* 상태 태그의 배경색은 인쇄 시 제거 */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* 인쇄 시 잘 보이도록 테두리 추가 */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">시스템 운영 보고서</h2>
          <p class="text-gray-600 mb-6 print-hidden">아래 요약 항목을 클릭하시면 상세 목록을 확인하고 인쇄하실 수 있습니다. 🖨️</p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="report-rtu-summary" class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 cursor-pointer hover:bg-indigo-100 transition duration-150">
              <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div id="report-inspection-summary" class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200 cursor-pointer hover:bg-pink-100 transition duration-150">
              <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div id="report-repair-summary" class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200 cursor-pointer hover:bg-teal-100 transition duration-150">
              <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>
          
          <div id="report-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-lg border hidden">
            <p class="text-gray-500">보고서를 보려면 위의 요약 항목을 클릭하세요.</p>
          </div>
          
          <p class="text-gray-600 border-t pt-4 mt-8 print-hidden">보다 상세한 데이터 분석 및 보고는 상단의 **데이터 CSV 다운로드/업로드** 버튼을 통해 데이터를 추출하여 진행하실 수 있습니다.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>로딩 중...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div id="image-zoom-modal" class="modal-bg hidden fixed inset-0 z-[60] flex items-center justify-center p-4" onclick="document.getElementById('image-zoom-modal').classList.add('hidden')">
    <div class="max-w-4xl max-h-[90vh] w-full p-4">
      <img id="zoomed-image" src="" alt="확대 이미지" class="max-w-full max-h-[80vh] w-auto h-auto mx-auto shadow-2xl rounded-lg">
      <button class="absolute top-4 right-4 text-white hover:text-gray-200 transition" onclick="document.getElementById('image-zoom-modal').classList.add('hidden'); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688",
      measurementId: "G-L58S7K0264"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseGet = get;
    window.firebaseRemove = remove;
    window.firebaseInitialized = true;
  </script>

  <script>
    /* ==================== 전역 변수 및 설정 ==================== */
    const STORAGE_KEYS = {
      RTU: 'rtuList',
      INSPECTION: 'inspectionList',
      REPAIR: 'repairList'
    };
    
    let imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];
    let isFirebaseReady = false;
    let currentRtuMode = 'new';
    let currentModalData = { id: null, type: null };

    // Pagination Settings
    const PAGE_SIZE = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    const elements = {
      rtuForm: document.getElementById('rtu-form'),
      rtuCount: document.getElementById('rtu-count'),
      rtuListContainer: document.getElementById('rtu-list'),
      rtuPaginationContainer: document.getElementById('rtu-pagination'),
      inspectionForm: document.getElementById('inspection-form'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionListContainer: document.getElementById('inspection-list'),
      inspectionPaginationContainer: document.getElementById('inspection-pagination'),
      inspectionRtuIdSelect: document.getElementById('inspection-rtu-id'),
      repairForm: document.getElementById('repair-form'),
      repairCount: document.getElementById('repair-count'),
      repairListContainer: document.getElementById('repair-list'),
      repairPaginationContainer: document.getElementById('repair-pagination'),
      repairRtuIdSelect: document.getElementById('repair-rtu-id'),
      detailModal: document.getElementById('detail-modal'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      modalTitle: document.getElementById('modal-title'),
      modalContent: document.getElementById('modal-content'),
      imageZoomModal: document.getElementById('image-zoom-modal'),
      zoomedImage: document.getElementById('zoomed-image'),
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair'),
      // [신규] 보고서 상세 기능 관련 요소
      reportRtuSummary: document.getElementById('report-rtu-summary'),
      reportInspectionSummary: document.getElementById('report-inspection-summary'),
      reportRepairSummary: document.getElementById('report-repair-summary'),
      reportDetailView: document.getElementById('report-detail-view') 
    };

    /* ==================== Firebase 함수 ==================== */

    function waitForFirebase() {
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (window.firebaseInitialized) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);
      });
    }

    async function loadFromFirebase() {
      await waitForFirebase();

      const rtuRef = window.firebaseRef(window.firebaseDB, 'rtuList');
      window.firebaseOnValue(rtuRef, (snapshot) => {
        const data = snapshot.val();
        rtuList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
        }
      });

      const inspectionRef = window.firebaseRef(window.firebaseDB, 'inspectionList');
      window.firebaseOnValue(inspectionRef, (snapshot) => {
        const data = snapshot.val();
        inspectionList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
        }
      });

      const repairRef = window.firebaseRef(window.firebaseDB, 'repairList');
      window.firebaseOnValue(repairRef, (snapshot) => {
        const data = snapshot.val();
        repairList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          // 수리 기록 미표시 오류 수정: onValue 콜백이 정상적으로 리스트를 업데이트하고 렌더링하도록 보장
          renderRepairList(repairCurrentPage);
          updateDashboard();
        }
      });

      isFirebaseReady = true;
    }

    async function saveToFirebase(key, list) {
      await waitForFirebase();
      const dbRef = window.firebaseRef(window.firebaseDB, key);
      const dataObject = list.reduce((acc, item) => {
        acc[item.id] = item;
        return acc;
      }, {});
      await window.firebaseSet(dbRef, dataObject);
    }

    async function deleteRtu(rtuId) {
      await waitForFirebase();
      const rtuRef = window.firebaseRef(window.firebaseDB, `rtuList/${rtuId}`);
      await window.firebaseRemove(rtuRef);

      // 관련 점검 및 수리 기록은 장비 ID를 사용하여 필터링되어 화면에 표시되지만, 
      // 데이터베이스에서는 삭제하지 않아 (기록 보존) 장비명이 [구-장비번호]로 표시됩니다. 
      // 이는 현재 `getRtuInfo` 로직으로 처리됩니다.
    }

    /* ==================== 헬퍼 함수 ==================== */

    // RTU 정보를 기반으로 이름과 상태를 가져오는 헬퍼 함수
    function getRtuInfo(rtuId) {
      const rtu = rtuList.find(r => r.name === rtuId);
      if (rtu) {
        return { name: rtu.name, status: rtu.status };
      }
      // 요청하신 대로 장비 삭제 시 "[구-"지워진 장비번호"]" 형식으로 표시
      return { 
        name: `[구-"${rtuId}"]`, 
        status: '삭제됨' 
      };
    }

    // 상태에 따른 Tailwind CSS 색상 클래스 반환
    function getStatusColor(status) {
      switch (status) {
        case '작동중':
          return 'bg-green-100 text-green-800';
        case '정지됨':
          return 'bg-gray-100 text-gray-800';
        case '점검필요':
          return 'bg-red-100 text-red-800';
        case '주의':
          return 'bg-yellow-100 text-yellow-800';
        case '삭제됨': // <-- 삭제된 장비에 대한 상태 추가
          return 'bg-slate-200 text-slate-700';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    // 파일 로더 헬퍼
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve('');
        const reader = new FileReader();
        reader.onload = (event) => resolve(event.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // 날짜 포맷 헬퍼
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      // 날짜 객체 생성 시 표준 포맷이 아닐 경우 오류 방지
      const date = new Date(dateString);
      if (isNaN(date)) return dateString; // 유효하지 않은 날짜는 원본 문자열 반환

      return date.toLocaleDateString('ko-KR', {
        year: 'numeric', month: '2-digit', day: '2-digit'
      });
    }

    // CSV 다운로드 헬퍼
    function downloadCSV(filename, data) {
      const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + data.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    /* ==================== RTU 관리 로직 ==================== */

    function populateRtuSelects() {
      const options = rtuList.map(rtu => `<option value="${rtu.name}">${rtu.name} (${rtu.region})</option>`).join('');
      elements.inspectionRtuIdSelect.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>' + options;
      elements.repairRtuIdSelect.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>' + options;
      
      const modifyOptions = rtuList.map(rtu => `<option value="${rtu.name}">${rtu.name} (${rtu.region})</option>`).join('');
      elements.rtuModifySelect.innerHTML = '<option value="">-- 수정할 RTU를 선택하세요 --</option>' + modifyOptions;
    }

    // RTU 등록 목록 렌더링 함수 (썸네일 이미지 추가)
    function renderRtuItem(rtu) {
      const statusColor = getStatusColor(rtu.status);
      const firstImageUrl = rtu.imageUrl1; // 첫 번째 이미지를 썸네일로 사용

      return `
        <div class="rtu-item bg-white p-4 rounded-lg shadow border border-gray-100 hover:shadow-md transition duration-150 flex justify-between items-center">
            <div class="flex items-center flex-grow min-w-0">
                ${firstImageUrl ? `<img src="${firstImageUrl}" alt="${rtu.name} Image" class="thumb mr-4 flex-shrink-0 cursor-pointer" onclick="zoomImage(this.src)">` : ''}
                <div class="flex-grow min-w-0">
                    <div class="flex items-center space-x-3 mb-1">
                        <span class="text-xl font-bold text-gray-800 truncate">${rtu.name}</span>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor} flex-shrink-0">${rtu.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate mb-1">설치 장소: ${rtu.region}</p>
                    <p class="text-xs text-gray-500 truncate">모델: ${rtu.model || 'N/A'} | 용량: ${rtu.capacity || 'N/A'} | 설치일: ${formatDate(rtu.date)}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                <button data-id="${rtu.name}" class="detail-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-300 transition duration-150">상세</button>
                <button data-id="${rtu.name}" class="modify-rtu-btn bg-blue-500 text-white text-sm font-medium py-1 px-3 rounded-full hover:bg-blue-600 transition duration-150">수정</button>
                <button data-id="${rtu.name}" class="delete-rtu-btn bg-red-500 text-white text-sm font-medium py-1 px-3 rounded-full hover:bg-red-600 transition duration-150">삭제</button>
            </div>
        </div>
      `;
    }

    function renderRtuList(page) {
      const sortedList = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date));
      const totalPages = Math.ceil(sortedList.length / PAGE_SIZE);
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedList.slice(startIndex, startIndex + PAGE_SIZE);

      elements.rtuCount.textContent = sortedList.length;
      
      if (paginatedList.length === 0) {
        elements.rtuListContainer.innerHTML = '<p class="text-gray-500 italic p-4">등록된 RTU 장비가 없습니다.</p>';
        elements.rtuPaginationContainer.innerHTML = '';
        return;
      }

      elements.rtuListContainer.innerHTML = paginatedList.map(renderRtuItem).join('');
      renderPagination(elements.rtuPaginationContainer, totalPages, page, (p) => {
        rtuCurrentPage = p;
        renderRtuList(rtuCurrentPage);
      });

      // 이벤트 리스너 재할당
      document.querySelectorAll('.detail-btn').forEach(btn => btn.addEventListener('click', (e) => showDetailModal(e.target.dataset.id, 'rtu')));
      document.querySelectorAll('.modify-rtu-btn').forEach(btn => btn.addEventListener('click', (e) => loadRtuForModification(e.target.dataset.id)));
      document.querySelectorAll('.delete-rtu-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteRtu(e.target.dataset.id)));
    }
    
    // RTU 등록/수정 폼 핸들러
    elements.rtuForm.addEventListener('submit', handleRtuFormSubmit);
    
    // 수정 모드 변경 핸들러
    elements.modeNewBtn.addEventListener('click', () => switchRtuMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => switchRtuMode('modify'));
    elements.rtuModifySelect.addEventListener('change', (e) => {
      const rtuId = e.target.value;
      if (rtuId) {
        fillRtuForm(rtuId);
      } else {
        resetRtuForm(false);
      }
    });

    /* ==================== 점검 기록 로직 ==================== */

    function renderInspectionItem(inspection) {
      const rtuInfo = getRtuInfo(inspection.rtuId);
      const statusColor = getStatusColor(rtuInfo.status);
      const resultColor = inspection.result === '정상' ? 'bg-green-100 text-green-800' : 
                          inspection.result === '주의' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';

      return `
        <div class="inspection-item bg-white p-4 rounded-lg shadow border border-gray-100 hover:shadow-md transition duration-150">
          <div class="flex items-center space-x-3 mb-2">
            <span class="text-lg font-bold text-gray-800">${rtuInfo.name}</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor}">${rtuInfo.status}</span>
          </div>
          <p class="text-sm text-gray-600 mb-1">점검 날짜: ${formatDate(inspection.inspectionDate)} | 점검자: ${inspection.inspector}</p>
          <div class="flex items-center space-x-2 mt-2">
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${resultColor}">결과: ${inspection.result}</span>
            <button data-id="${inspection.id}" class="detail-btn bg-gray-200 text-gray-700 text-xs font-medium py-1 px-3 rounded-full hover:bg-gray-300 transition duration-150">상세 보기</button>
          </div>
        </div>
      `;
    }

    function renderInspectionList(page) {
      const sortedList = inspectionList.sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
      const totalPages = Math.ceil(sortedList.length / PAGE_SIZE);
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedList.slice(startIndex, startIndex + PAGE_SIZE);

      elements.inspectionCount.textContent = sortedList.length;

      if (paginatedList.length === 0) {
        elements.inspectionListContainer.innerHTML = '<p class="text-gray-500 italic p-4">등록된 점검 기록이 없습니다.</p>';
        elements.inspectionPaginationContainer.innerHTML = '';
        return;
      }

      elements.inspectionListContainer.innerHTML = paginatedList.map(renderInspectionItem).join('');
      renderPagination(elements.inspectionPaginationContainer, totalPages, page, (p) => {
        inspectionCurrentPage = p;
        renderInspectionList(inspectionCurrentPage);
      });

      document.querySelectorAll('#inspection-list .detail-btn').forEach(btn => btn.addEventListener('click', (e) => showDetailModal(e.target.dataset.id, 'inspection')));
    }

    // 점검 기록 폼 핸들러
    elements.inspectionForm.addEventListener('submit', handleInspectionFormSubmit);

    /* ==================== 수리 기록 로직 ==================== */

    function renderRepairItem(repair) {
      const rtuInfo = getRtuInfo(repair.rtuId);
      const rtuStatusColor = getStatusColor(rtuInfo.status);
      let repairStatusColor;
      
      switch(repair.status) {
        case '요청':
          repairStatusColor = 'bg-red-100 text-red-800';
          break;
        case '진행중':
          repairStatusColor = 'bg-yellow-100 text-yellow-800';
          break;
        case '완료':
          repairStatusColor = 'bg-green-100 text-green-800';
          break;
        default:
          repairStatusColor = 'bg-gray-100 text-gray-800';
      }

      return `
        <div class="repair-item bg-white p-4 rounded-lg shadow border border-gray-100 hover:shadow-md transition duration-150">
          <div class="flex items-center space-x-3 mb-2">
            <span class="text-lg font-bold text-gray-800">${rtuInfo.name}</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${rtuStatusColor}">${rtuInfo.status}</span>
          </div>
          <p class="text-sm text-gray-600 mb-1">날짜: ${formatDate(repair.repairDate)} | 담당자: ${repair.engineer}</p>
          <div class="flex items-center space-x-2 mt-2">
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${repairStatusColor}">처리 상태: ${repair.status}</span>
            <button data-id="${repair.id}" class="detail-btn bg-gray-200 text-gray-700 text-xs font-medium py-1 px-3 rounded-full hover:bg-gray-300 transition duration-150">상세 보기</button>
          </div>
        </div>
      `;
    }

    function renderRepairList(page) {
      const sortedList = repairList.sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
      const totalPages = Math.ceil(sortedList.length / PAGE_SIZE);
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedList.slice(startIndex, startIndex + PAGE_SIZE);

      elements.repairCount.textContent = sortedList.length;

      if (paginatedList.length === 0) {
        elements.repairListContainer.innerHTML = '<p class="text-gray-500 italic p-4">등록된 수리 기록이 없습니다.</p>';
        elements.repairPaginationContainer.innerHTML = '';
        return;
      }

      elements.repairListContainer.innerHTML = paginatedList.map(renderRepairItem).join('');
      renderPagination(elements.repairPaginationContainer, totalPages, page, (p) => {
        repairCurrentPage = p;
        renderRepairList(repairCurrentPage);
      });

      document.querySelectorAll('#repair-list .detail-btn').forEach(btn => btn.addEventListener('click', (e) => showDetailModal(e.target.dataset.id, 'repair')));
    }

    // 수리 기록 폼 핸들러
    elements.repairForm.addEventListener('submit', handleRepairFormSubmit);


    /* ==================== 공통 함수 (Pagination, Modal, Dashboard) ==================== */

    function renderPagination(container, totalPages, currentPage, pageChangeHandler) {
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      const createButton = (text, page, isDisabled) => {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.classList.add('pagination-btn', 'px-3', 'py-1', 'mx-1', 'text-sm', 'rounded-md', 'transition', 'duration-150');
        if (page === currentPage) {
          btn.classList.add('bg-blue-600', 'text-white', 'font-semibold');
        } else if (!isDisabled) {
          btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
          btn.addEventListener('click', () => pageChangeHandler(page));
        } else {
          btn.disabled = true;
        }
        return btn;
      };

      // Previous button
      container.appendChild(createButton('이전', currentPage - 1, currentPage === 1));

      // Page number buttons
      for (let i = startPage; i <= endPage; i++) {
        container.appendChild(createButton(i, i, false));
      }

      // Next button
      container.appendChild(createButton('다음', currentPage + 1, currentPage === totalPages));
    }


    function updateDashboard() {
      // RTU Stats
      const totalRtu = rtuList.length;
      const running = rtuList.filter(rtu => rtu.status === '작동중').length;
      const stopped = rtuList.filter(rtu => rtu.status === '정지됨').length;
      const needsInspection = rtuList.filter(rtu => rtu.status === '점검필요').length;

      elements.dashboardTotal.textContent = totalRtu;
      elements.dashboardRunning.textContent = running;
      elements.dashboardStopped.textContent = stopped;
      elements.dashboardNeedsInspection.textContent = needsInspection;

      // Monthly Inspection Count
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;

      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }

      // Report Page Update
      elements.reportTotalRtu.textContent = rtuList.length;
      elements.reportTotalInspection.textContent = inspectionList.length;
      elements.reportTotalRepair.textContent = repairList.length;
    }


    /* ==================== 이벤트 핸들러 (폼 제출, 삭제, 모달) ==================== */

    async function handleRtuFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => { data[key] = value; });

      let rtuId = data.name;

      // 수정 모드 처리
      if (currentRtuMode === 'modify') {
        rtuId = elements.rtuIdForModification.value;
        if (!rtuId) {
          alert("수정할 RTU를 선택해주세요.");
          return;
        }
        const existingRtu = rtuList.find(r => r.id === rtuId);
        if (existingRtu && existingRtu.name !== data.name) {
           // name이 변경된 경우 (사용자 실수 또는 의도적) 경고
           if (rtuList.some(r => r.name === data.name && r.id !== rtuId)) {
                alert("경고: RTU ID는 변경할 수 없으며, 기존 ID와 일치해야 합니다. 변경 없이 저장합니다.");
                data.name = existingRtu.name; // 기존 이름 유지
            }
        }
        data.id = rtuId;
        data.lastUpdated = new Date().toISOString();
        const originalRtu = rtuList.find(r => r.id === rtuId);
        // 기존 이미지 URL을 유지하거나, 새 파일이 있으면 업로드된 파일의 dataURL을 사용합니다.
        data.imageUrl1 = data.imageUrl1 && data.imageUrl1.size > 0 ? imageBase64Data.imageUrl1 : (originalRtu ? originalRtu.imageUrl1 : '');
        data.imageUrl2 = data.imageUrl2 && data.imageUrl2.size > 0 ? imageBase64Data.imageUrl2 : (originalRtu ? originalRtu.imageUrl2 : '');
        data.imageUrl3 = data.imageUrl3 && data.imageUrl3.size > 0 ? imageBase64Data.imageUrl3 : (originalRtu ? originalRtu.imageUrl3 : '');

        rtuList = rtuList.map(rtu => (rtu.id === rtuId ? { ...rtu, ...data } : rtu));
        alert("RTU 정보가 성공적으로 수정되었습니다.");
      } else {
        // 신규 등록 모드 처리
        if (rtuList.some(r => r.name === rtuId)) {
          alert("오류: 이미 존재하는 RTU 등록번호/ID 입니다.");
          return;
        }
        data.id = rtuId; // ID로 name 사용 (Firebase 키)
        data.date = data.date || new Date().toISOString().split('T')[0];
        data.lastUpdated = new Date().toISOString();
        data.imageUrl1 = imageBase64Data.imageUrl1;
        data.imageUrl2 = imageBase64Data.imageUrl2;
        data.imageUrl3 = imageBase64Data.imageUrl3;
        
        rtuList.push(data);
        alert("RTU 장비가 성공적으로 등록되었습니다.");
      }
      
      await saveToFirebase(STORAGE_KEYS.RTU, rtuList);
      resetRtuForm(true);
      switchRtuMode('new'); // 저장 후 등록 모드로 전환
    }

    async function handleInspectionFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => { data[key] = value; });

      data.id = `insp_${Date.now()}`;
      inspectionList.push(data);

      await saveToFirebase(STORAGE_KEYS.INSPECTION, inspectionList);
      alert("점검 기록이 성공적으로 저장되었습니다.");
      form.reset();
    }

    async function handleRepairFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => { data[key] = value; });

      data.id = `repair_${Date.now()}`;
      repairList.push(data);

      await saveToFirebase(STORAGE_KEYS.REPAIR, repairList);
      alert("수리 기록이 성공적으로 저장되었습니다.");
      form.reset();
    }

    async function handleDeleteRtu(rtuId) {
      if (confirm(`정말로 RTU '${rtuId}' 장비를 삭제하시겠습니까? (점검/수리 기록은 보존됨)`)) {
        await deleteRtu(rtuId);
        alert("RTU 장비가 삭제되었습니다.");
        // Firebase onValue 콜백으로 인해 리스트는 자동으로 업데이트됩니다.
      }
    }
    
    // 모달 관련 함수
    function showDetailModal(id, type) {
      currentModalData = { id, type };
      let data, title, contentHTML;

      if (type === 'rtu') {
        data = rtuList.find(r => r.name === id);
        if (!data) {
          title = "장비 없음";
          contentHTML = "<p>해당 RTU 장비를 찾을 수 없습니다.</p>";
        } else {
            title = `RTU 상세 정보: ${data.name}`;
            contentHTML = `
              <p><strong>등록번호/ID:</strong> ${data.name}</p>
              <p><strong>설치 장소/지역:</strong> ${data.region}</p>
              <p><strong>현재 상태:</strong> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(data.status)}">${data.status}</span></p>
              <p><strong>설치(등록) 날짜:</strong> ${formatDate(data.date)}</p>
              <p><strong>모델명:</strong> ${data.model || 'N/A'}</p>
              <p><strong>용량:</strong> ${data.capacity || 'N/A'}</p>
              <p><strong>유닛 종류:</strong> ${data.unitType || 'N/A'}</p>
              <p><strong>냉매 종류:</strong> ${data.refrigerant || 'N/A'}</p>
              <p><strong>전기 종류:</strong> ${data.electricPhase || 'N/A'}</p>
              <p><strong>고압 상한 설정 (PSI):</strong> ${data.pressureHighLimit || 'N/A'}</p>
              <p><strong>저압 하한 설정 (PSI):</strong> ${data.pressureLowLimit || 'N/A'}</p>
              <p class="mt-4"><strong>특이사항 및 메모:</strong></p>
              <p class="whitespace-pre-wrap border p-2 rounded-md bg-gray-50">${data.notes || '없음'}</p>
              <div class="mt-4 border-t pt-4">
                <p class="font-semibold">장비 사진:</p>
                <div class="flex flex-wrap gap-3 mt-2">
                  ${data.imageUrl1 ? `<img src="${data.imageUrl1}" alt="Image 1" class="thumb-detail" onclick="zoomImage(this.src)">` : '<div class="thumb-detail bg-gray-200 flex items-center justify-center text-xs text-gray-500">사진 1 없음</div>'}
                  ${data.imageUrl2 ? `<img src="${data.imageUrl2}" alt="Image 2" class="thumb-detail" onclick="zoomImage(this.src)">` : '<div class="thumb-detail bg-gray-200 flex items-center justify-center text-xs text-gray-500">사진 2 없음</div>'}
                  ${data.imageUrl3 ? `<img src="${data.imageUrl3}" alt="Image 3" class="thumb-detail" onclick="zoomImage(this.src)">` : '<div class="thumb-detail bg-gray-200 flex items-center justify-center text-xs text-gray-500">사진 3 없음</div>'}
                </div>
              </div>
            `;
        }
      } else if (type === 'inspection') {
        data = inspectionList.find(i => i.id === id);
        if (!data) {
          title = "점검 기록 없음";
          contentHTML = "<p>해당 점검 기록을 찾을 수 없습니다.</p>";
        } else {
            const rtuInfo = getRtuInfo(data.rtuId);
            title = `점검 기록 상세 (RTU: ${rtuInfo.name})`;
            const resultColor = data.result === '정상' ? 'bg-green-100 text-green-800' : 
                              data.result === '주의' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
            contentHTML = `
              <p><strong>대상 RTU:</strong> ${rtuInfo.name}</p>
              <p><strong>점검 날짜:</strong> ${formatDate(data.inspectionDate)}</p>
              <p><strong>점검자:</strong> ${data.inspector}</p>
              <p><strong>최종 점검 결과:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${resultColor}">${data.result}</span></p>
              
              <h4 class="text-md font-semibold mt-4 border-t pt-2">부품 점검 상태</h4>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <p><strong>1. 필터:</strong> ${data.check1}</p>
                <p><strong>2. 콘텍터:</strong> ${data.check2}</p>
                <p><strong>3. 콘덴싱 코일:</strong> ${data.check3}</p>
                <p><strong>4. 송풍 모터:</strong> ${data.check4}</p>
                <p><strong>5. 증발기 코일:</strong> ${data.check5}</p>
                <p><strong>6. 고압 센서:</strong> ${data.check6}</p>
                <p><strong>7. 저압 센서:</strong> ${data.check7}</p>
                <p><strong>8. 캐패시터:</strong> ${data.check8}</p>
              </div>
              
              <h4 class="text-md font-semibold mt-4 border-t pt-2">운전 상태 측정</h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="font-medium text-gray-700">Comp 1</p>
                  <p class="text-sm">고압: ${data.comp1Hp || 'N/A'} PSI</p>
                  <p class="text-sm">저압: ${data.comp1Lp || 'N/A'} PSI</p>
                  <p class="text-sm">전류: ${data.comp1Amp || 'N/A'} A</p>
                </div>
                <div>
                  <p class="font-medium text-gray-700">Comp 2</p>
                  <p class="text-sm">고압: ${data.comp2Hp || 'N/A'} PSI</p>
                  <p class="text-sm">저압: ${data.comp2Lp || 'N/A'} PSI</p>
                  <p class="text-sm">전류: ${data.comp2Amp || 'N/A'} A</p>
                </div>
              </div>

              <h4 class="text-md font-semibold mt-4 border-t pt-2">온도 측정</h4>
              <div class="grid grid-cols-2 gap-4">
                <p class="text-sm"><strong>과열도:</strong> ${data.superheat || 'N/A'} ℉</p>
                <p class="text-sm"><strong>과냉도:</strong> ${data.subcool || 'N/A'} ℉</p>
              </div>

              <p class="mt-4"><strong>특이사항 및 조치 내용:</strong></p>
              <p class="whitespace-pre-wrap border p-2 rounded-md bg-gray-50">${data.notes || '없음'}</p>
            `;
        }
      } else if (type === 'repair') {
        data = repairList.find(r => r.id === id);
        if (!data) {
          title = "수리 기록 없음";
          contentHTML = "<p>해당 수리 기록을 찾을 수 없습니다.</p>";
        } else {
            const rtuInfo = getRtuInfo(data.rtuId);
            title = `수리 기록 상세 (RTU: ${rtuInfo.name})`;
            let repairStatusColor;
            switch(data.status) {
              case '요청':
                repairStatusColor = 'bg-red-100 text-red-800';
                break;
              case '진행중':
                repairStatusColor = 'bg-yellow-100 text-yellow-800';
                break;
              case '완료':
                repairStatusColor = 'bg-green-100 text-green-800';
                break;
              default:
                repairStatusColor = 'bg-gray-100 text-gray-800';
            }
            contentHTML = `
              <p><strong>대상 RTU:</strong> ${rtuInfo.name}</p>
              <p><strong>수리 요청/완료 날짜:</strong> ${formatDate(data.repairDate)}</p>
              <p><strong>수리 담당자:</strong> ${data.engineer}</p>
              <p><strong>처리 상태:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${repairStatusColor}">${data.status}</span></p>
              <p class="mt-4"><strong>문제 및 조치 내용:</strong></p>
              <p class="whitespace-pre-wrap border p-2 rounded-md bg-gray-50">${data.issue || '없음'}</p>
            `;
        }
      } else {
        title = "오류";
        contentHTML = "<p>요청된 데이터 타입을 찾을 수 없습니다.</p>";
      }

      elements.modalTitle.textContent = title;
      elements.modalContent.innerHTML = contentHTML;
      elements.detailModal.classList.remove('hidden');
    }
    
    // 이미지 파일 로드 및 미리보기 업데이트
    document.getElementById('rtu-image1').addEventListener('change', (e) => handleImageUpload(e.target, elements.imagePreview1, 'imageUrl1'));
    document.getElementById('rtu-image2').addEventListener('change', (e) => handleImageUpload(e.target, elements.imagePreview2, 'imageUrl2'));
    document.getElementById('rtu-image3').addEventListener('change', (e) => handleImageUpload(e.target, elements.imagePreview3, 'imageUrl3'));

    async function handleImageUpload(input, previewElement, key) {
      if (input.files.length > 0) {
        try {
          const dataURL = await readFileAsDataURL(input.files[0]);
          imageBase64Data[key] = dataURL;
          previewElement.src = dataURL;
          previewElement.style.display = 'block';
          elements.imagePreviewContainer.classList.remove('hidden');
        } catch (error) {
          console.error("Error reading file:", error);
          alert("파일을 읽는 중 오류가 발생했습니다.");
        }
      } else {
        imageBase64Data[key] = '';
        previewElement.src = '';
        previewElement.style.display = 'none';
      }
      if (!imageBase64Data.imageUrl1 && !imageBase64Data.imageUrl2 && !imageBase64Data.imageUrl3) {
        elements.imagePreviewContainer.classList.add('hidden');
      }
    }

    // RTU 모드 전환 함수
    function switchRtuMode(mode) {
      currentRtuMode = mode;
      
      if (mode === 'new') {
        elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
        elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
        elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
        elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
        
        document.getElementById('rtu-name').classList.remove('hidden');
        elements.rtuModifySelect.classList.add('hidden');
        document.getElementById('rtu-name').parentNode.classList.remove('hidden');
        
        elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
        resetRtuForm(true);
      } else if (mode === 'modify') {
        elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
        elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
        elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');

        document.getElementById('rtu-name').classList.add('hidden');
        elements.rtuModifySelect.classList.remove('hidden');
        document.getElementById('rtu-name').parentNode.classList.add('hidden');

        elements.rtuSubmitBtn.textContent = 'RTU 정보 수정';
        resetRtuForm(false); // 폼 리셋 (선택된 RTU가 없다면 비어있음)
      }
    }
    
    // RTU 수정 모드로 전환하고 데이터 로드
    function loadRtuForModification(rtuId) {
      switchRtuMode('modify');
      elements.rtuModifySelect.value = rtuId;
      fillRtuForm(rtuId);
      // RTU 목록 탭이 아닌 경우 RTU 관리 탭으로 이동
      if (document.querySelector('.tab-btn[data-tab="rtu-manage"]').classList.contains('tab-active') === false) {
        showTab('rtu-manage');
      }
      
      // 스크롤을 폼 위치로 이동
      elements.rtuForm.scrollIntoView({ behavior: 'smooth' });
    }

    // 선택된 RTU 정보로 폼 채우기
    function fillRtuForm(rtuId) {
      const rtu = rtuList.find(r => r.name === rtuId);
      if (!rtu) return;

      elements.rtuIdForModification.value = rtu.name; 
      
      // 이름 필드는 숨겨져 있지만, 수정 모드에서는 수정할 수 없으므로 기존 값을 저장합니다.
      document.getElementById('rtu-name').value = rtu.name; 

      document.getElementById('rtu-region').value = rtu.region || '';
      document.getElementById('rtu-model').value = rtu.model || '';
      document.getElementById('rtu-capacity').value = rtu.capacity || '';
      document.getElementById('rtu-unit-type').value = rtu.unitType || '패키지';
      document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
      document.getElementById('rtu-electric-phase').value = rtu.electricPhase || '단상';
      document.getElementById('rtu-date').value = rtu.date || '';
      document.getElementById('rtu-status').value = rtu.status || '작동중';
      document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
      document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
      document.getElementById('rtu-notes').value = rtu.notes || '';

      // 이미지 미리보기 업데이트 (기존 이미지를 유지)
      imageBase64Data = { 
        imageUrl1: rtu.imageUrl1 || '', 
        imageUrl2: rtu.imageUrl2 || '', 
        imageUrl3: rtu.imageUrl3 || '' 
      };
      
      elements.imagePreview1.src = rtu.imageUrl1 || '';
      elements.imagePreview1.style.display = rtu.imageUrl1 ? 'block' : 'none';
      elements.imagePreview2.src = rtu.imageUrl2 || '';
      elements.imagePreview2.style.display = rtu.imageUrl2 ? 'block' : 'none';
      elements.imagePreview3.src = rtu.imageUrl3 || '';
      elements.imagePreview3.style.display = rtu.imageUrl3 ? 'block' : 'none';

      if (rtu.imageUrl1 || rtu.imageUrl2 || rtu.imageUrl3) {
        elements.imagePreviewContainer.classList.remove('hidden');
      } else {
        elements.imagePreviewContainer.classList.add('hidden');
      }
    }
    
    // RTU 폼 리셋
    function resetRtuForm(fullReset = true) {
      elements.rtuForm.reset();
      elements.rtuIdForModification.value = '';
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };

      elements.imagePreview1.src = '';
      elements.imagePreview2.src = '';
      elements.imagePreview3.src = '';
      elements.imagePreview1.style.display = 'none';
      elements.imagePreview2.style.display = 'none';
      elements.imagePreview3.style.display = 'none';
      elements.imagePreviewContainer.classList.add('hidden');
      
      if (fullReset) {
         // 신규 등록 모드일 때만 이름 필드를 활성화 (수정 모드에서는 숨겨진 상태에서 초기화하지 않음)
         document.getElementById('rtu-name').classList.remove('hidden');
         document.getElementById('rtu-name').parentNode.classList.remove('hidden');
         elements.rtuModifySelect.classList.add('hidden');
         elements.rtuModifySelect.value = '';
      } else {
        // 수정 모드 리셋
        elements.rtuModifySelect.value = ''; // 선택 박스만 초기화
      }
    }

    // 탭 전환 로직
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;
        showTab(targetTab);
      });
    });

    function showTab(targetTab) {
      elements.tabBtns.forEach(b => {
        b.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
        b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      });

      elements.tabPages.forEach(p => {
        p.classList.add('hidden');
      });

      const activeBtn = document.querySelector(`.tab-btn[data-tab="${targetTab}"]`);
      activeBtn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
      activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

      document.getElementById(targetTab).classList.remove('hidden');

      // 탭 전환 시 해당 리스트를 다시 렌더링하여 최신 상태를 반영
      if (targetTab === 'rtu-manage') {
        renderRtuList(rtuCurrentPage);
      } else if (targetTab === 'inspection-manage') {
        renderInspectionList(inspectionCurrentPage);
      } else if (targetTab === 'repair-manage') {
        renderRepairList(repairCurrentPage);
      } else if (targetTab === 'dashboard' || targetTab === 'report-page') {
        updateDashboard();
        // 보고서 탭으로 이동 시 상세 목록 숨기기
        elements.reportDetailView.classList.add('hidden');
      }
    }

    // 모달 닫기 버튼
    elements.closeModalBtn.addEventListener('click', () => {
      elements.detailModal.classList.add('hidden');
    });

    // 모달 외부 클릭 시 닫기
    elements.detailModal.addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') {
        elements.detailModal.classList.add('hidden');
      }
    });

    // 이미지 확대 모달
    window.zoomImage = function(src) {
      elements.zoomedImage.src = src;
      elements.imageZoomModal.classList.remove('hidden');
    }

    // [수정] 보고서 상세 목록 렌더링 함수 (print-only 제거)
    function renderReportDetail(type) {
      elements.reportDetailView.classList.remove('hidden');
      
      let list = [];
      let title = '';
      let tableHTML = '';
      const currentDate = formatDate(new Date().toISOString().split('T')[0]);

      if (type === 'rtu') {
        list = rtuList.sort((a, b) => new Date(b.date) - new Date(a.date));
        title = `RTU 등록 목록`;
        tableHTML = `
          <table class="w-full text-sm text-left text-gray-500 mt-4 border-collapse">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="py-2 px-3 border-b">RTU ID</th>
                <th scope="col" class="py-2 px-3 border-b">설치 지역</th>
                <th scope="col" class="py-2 px-3 border-b">현재 상태</th>
                <th scope="col" class="py-2 px-3 border-b">모델명/용량</th>
                <th scope="col" class="py-2 px-3 border-b">설치일</th>
                <th scope="col" class="py-2 px-3 border-b print-hidden">상세</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(rtu => `
                <tr class="bg-white border-b hover:bg-gray-50">
                  <td class="py-2 px-3 font-medium text-gray-900 whitespace-nowrap">${rtu.name}</td>
                  <td class="py-2 px-3">${rtu.region}</td>
                  <td class="py-2 px-3"><span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span></td>
                  <td class="py-2 px-3">${rtu.model || 'N/A'} / ${rtu.capacity || 'N/A'}</td>
                  <td class="py-2 px-3">${formatDate(rtu.date)}</td>
                  <td class="py-2 px-3 print-hidden"><button data-id="${rtu.name}" data-type="rtu" class="report-detail-btn text-blue-600 hover:underline">보기</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else if (type === 'inspection') {
        list = inspectionList.sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
        title = `점검 기록 목록`;
        tableHTML = `
          <table class="w-full text-sm text-left text-gray-500 mt-4 border-collapse">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="py-2 px-3 border-b">RTU ID</th>
                <th scope="col" class="py-2 px-3 border-b">점검 날짜</th>
                <th scope="col" class="py-2 px-3 border-b">점검자</th>
                <th scope="col" class="py-2 px-3 border-b">최종 결과</th>
                <th scope="col" class="py-2 px-3 border-b">고압(PSI) / 저압(PSI)</th>
                <th scope="col" class="py-2 px-3 border-b print-hidden">상세</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(insp => {
                const rtuInfo = getRtuInfo(insp.rtuId);
                const resultColor = insp.result === '정상' ? 'bg-green-100 text-green-800' : insp.result === '주의' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                return `
                <tr class="bg-white border-b hover:bg-gray-50">
                  <td class="py-2 px-3 font-medium text-gray-900 whitespace-nowrap">${rtuInfo.name}</td>
                  <td class="py-2 px-3">${formatDate(insp.inspectionDate)}</td>
                  <td class="py-2 px-3">${insp.inspector}</td>
                  <td class="py-2 px-3"><span class="px-2 py-0.5 text-xs font-semibold rounded ${resultColor}">${insp.result}</span></td>
                  <td class="py-2 px-3">${insp.comp1Hp || 'N/A'} / ${insp.comp1Lp || 'N/A'}</td>
                  <td class="py-2 px-3 print-hidden"><button data-id="${insp.id}" data-type="inspection" class="report-detail-btn text-blue-600 hover:underline">보기</button></td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } else if (type === 'repair') {
        list = repairList.sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
        title = `수리 기록 목록`;
        tableHTML = `
          <table class="w-full text-sm text-left text-gray-500 mt-4 border-collapse">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="py-2 px-3 border-b">RTU ID</th>
                <th scope="col" class="py-2 px-3 border-b">수리 날짜</th>
                <th scope="col" class="py-2 px-3 border-b">담당자</th>
                <th scope="col" class="py-2 px-3 border-b">처리 상태</th>
                <th scope="col" class="py-2 px-3 border-b">문제 요약</th>
                <th scope="col" class="py-2 px-3 border-b print-hidden">상세</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(repair => {
                const rtuInfo = getRtuInfo(repair.rtuId);
                let repairStatusColor;
                switch(repair.status) {
                  case '요청': repairStatusColor = 'bg-red-100 text-red-800'; break;
                  case '진행중': repairStatusColor = 'bg-yellow-100 text-yellow-800'; break;
                  case '완료': repairStatusColor = 'bg-green-100 text-green-800'; break;
                  default: repairStatusColor = 'bg-gray-100 text-gray-800';
                }
                return `
                <tr class="bg-white border-b hover:bg-gray-50">
                  <td class="py-2 px-3 font-medium text-gray-900 whitespace-nowrap">${rtuInfo.name}</td>
                  <td class="py-2 px-3">${formatDate(repair.repairDate)}</td>
                  <td class="py-2 px-3">${repair.engineer}</td>
                  <td class="py-2 px-3"><span class="px-2 py-0.5 text-xs font-semibold rounded ${repairStatusColor}">${repair.status}</span></td>
                  <td class="py-2 px-3 max-w-xs overflow-hidden truncate">${repair.issue ? repair.issue.substring(0, 30) + (repair.issue.length > 30 ? '...' : '') : '없음'}</td>
                  <td class="py-2 px-3 print-hidden"><button data-id="${repair.id}" data-type="repair" class="report-detail-btn text-blue-600 hover:underline">보기</button></td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } else {
        elements.reportDetailView.innerHTML = '<p class="text-red-500">잘못된 보고서 유형입니다.</p>';
        return;
      }
      
      // print-only <div>를 제거하고, 화면에서만 보여야 할 요소에 print-hidden 추가
      elements.reportDetailView.innerHTML = `
            <h3 class="text-2xl font-bold text-gray-800 mb-2">${title} (${list.length}건)</h3>
            <div class="flex justify-between items-center mb-4 print-hidden">
                <p class="text-sm text-gray-600">데이터 기준: ${currentDate}</p>
                <button id="print-report-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2m-6 10v4m-2-4h4m4-4h2a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2"></path><path d="M17 9v2"></path></svg>
                    보고서 인쇄
                </button>
            </div>
            ${tableHTML}
            <div class="flex justify-center mt-6 print-hidden">
                <button id="hide-report-btn" class="text-gray-500 hover:text-gray-700 font-medium text-sm">목록 닫기</button>
            </div>
      `;

      // 인쇄 및 닫기 버튼 이벤트 리스너 할당
      document.getElementById('print-report-btn').addEventListener('click', printReport);
      document.getElementById('hide-report-btn').addEventListener('click', () => {
        elements.reportDetailView.classList.add('hidden');
      });
      // 상세 보기 버튼 이벤트 리스너 재할당
      document.querySelectorAll('.report-detail-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        const detailType = e.target.dataset.type;
        showDetailModal(id, detailType);
      }));
    }

    // [신규] 인쇄 함수
    function printReport() {
        window.print();
    }


    // CSV 다운로드 기능
    document.getElementById('download-data-btn').addEventListener('click', () => {
      if (confirm("RTU, 점검, 수리 데이터를 포함한 모든 데이터를 CSV 파일로 다운로드 하시겠습니까?")) {
        // 1. RTU 데이터
        const rtuHeaders = ["ID", "등록번호/ID", "설치 장소/지역", "모델명", "용량", "유닛 종류", "냉매 종류", "전기 종류", "설치(등록) 날짜", "현재 상태", "고압 상한 설정(PSI)", "저압 하한 설정(PSI)", "특이사항 및 메모", "사진1 URL", "사진2 URL", "사진3 URL", "최종 수정일"];
        const rtuData = rtuList.map(rtu => [
          rtu.id, rtu.name, rtu.region, rtu.model, rtu.capacity, rtu.unitType, rtu.refrigerant, rtu.electricPhase, formatDate(rtu.date), rtu.status, rtu.pressureHighLimit, rtu.pressureLowLimit, rtu.notes ? rtu.notes.replace(/\n/g, ' ') : '', rtu.imageUrl1, rtu.imageUrl2, rtu.imageUrl3, rtu.lastUpdated
        ]);
        downloadCSV("rtu_data.csv", [rtuHeaders, ...rtuData]);

        // 2. 점검 기록 데이터
        const inspectionHeaders = ["ID", "대상 RTU ID", "점검 날짜", "점검자", "필터", "콘텍터", "콘덴싱 코일", "송풍 모터", "증발기 코일", "고압 센서", "저압 센서", "캐패시터", "Comp1 고압(PSI)", "Comp1 저압(PSI)", "Comp1 전류(A)", "Comp2 고압(PSI)", "Comp2 저압(PSI)", "Comp2 전류(A)", "과열도(F)", "과냉도(F)", "최종 점검 결과", "특이사항 및 조치 내용"];
        const inspectionData = inspectionList.map(insp => [
          insp.id, insp.rtuId, formatDate(insp.inspectionDate), insp.inspector, insp.check1, insp.check2, insp.check3, insp.check4, insp.check5, insp.check6, insp.check7, insp.check8, insp.comp1Hp, insp.comp1Lp, insp.comp1Amp, insp.comp2Hp, insp.comp2Lp, insp.comp2Amp, insp.superheat, insp.subcool, insp.result, insp.notes ? insp.notes.replace(/\n/g, ' ') : ''
        ]);
        downloadCSV("inspection_data.csv", [inspectionHeaders, ...inspectionData]);

        // 3. 수리 기록 데이터
        const repairHeaders = ["ID", "대상 RTU ID", "수리 요청/완료 날짜", "수리 담당자", "처리 상태", "문제 및 조치 내용"];
        const repairData = repairList.map(repair => [
          repair.id, repair.rtuId, formatDate(repair.repairDate), repair.engineer, repair.status, repair.issue ? repair.issue.replace(/\n/g, ' ') : ''
        ]);
        downloadCSV("repair_data.csv", [repairHeaders, ...repairData]);

        alert("모든 데이터 다운로드가 완료되었습니다.");
      }
    });

    // CSV 업로드 기능 (간소화된 로직, 실제 구현 시 더 복잡한 파싱 및 유효성 검사 필요)
    document.getElementById('csv-upload').addEventListener('change', async (e) => {
      const files = e.target.files;
      if (files.length === 0) return;

      if (!confirm(`총 ${files.length}개의 CSV 파일을 업로드하여 데이터를 대체/추가하시겠습니까? 데이터 유효성에 따라 오류가 발생할 수 있습니다.`)) {
        e.target.value = ''; // 파일 선택 취소
        return;
      }
      
      const filePromises = Array.from(files).map(file => readFileAsText(file).then(text => ({ name: file.name, content: text })));
      const results = await Promise.all(filePromises);

      let rtuUpdated = false;
      let inspectionUpdated = false;
      let repairUpdated = false;

      results.forEach(result => {
        const lines = result.content.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 2) return; 

        // 헤더 파싱 (쉼표로 분리하고 따옴표 제거)
        const headers = parseCSVLine(lines[0]);
        const dataLines = lines.slice(1);
        
        let targetList = [];
        let keyField = '';
        let listKey = '';

        if (result.name.includes('rtu_data')) {
          targetList = rtuList;
          keyField = 'ID';
          listKey = STORAGE_KEYS.RTU;
          rtuUpdated = true;
        } else if (result.name.includes('inspection_data')) {
          targetList = inspectionList;
          keyField = 'ID';
          listKey = STORAGE_KEYS.INSPECTION;
          inspectionUpdated = true;
        } else if (result.name.includes('repair_data')) {
          targetList = repairList;
          keyField = 'ID';
          listKey = STORAGE_KEYS.REPAIR;
          repairUpdated = true;
        } else {
          console.warn(`Skipping unknown file: ${result.name}`);
          return;
        }
        
        // 데이터 레코드 파싱
        dataLines.forEach(line => {
          const values = parseCSVLine(line);
          if (values.length !== headers.length) return;

          const record = {};
          headers.forEach((header, index) => {
            record[convertHeaderToKey(header)] = values[index];
          });
          
          if (record.id) {
             const existingIndex = targetList.findIndex(item => item.id === record.id);
             if (existingIndex !== -1) {
                // 기존 데이터 업데이트
                targetList[existingIndex] = record;
             } else {
                // 새 데이터 추가
                targetList.push(record);
             }
          }
        });
        
        // Firebase에 저장 (실시간 동기화로 인해 onValue 콜백이 리렌더링을 처리합니다)
        saveToFirebase(listKey, targetList); 
      });

      if (rtuUpdated || inspectionUpdated || repairUpdated) {
         alert("CSV 데이터 처리가 완료되었습니다. 화면에 반영되는 데 시간이 걸릴 수 있습니다.");
      } else {
         alert("처리할 유효한 데이터 파일이 없습니다.");
      }

      e.target.value = ''; // 파일 선택 초기화
    });

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => resolve(event.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsText(file, 'utf-8');
      });
    }

    function parseCSVLine(line) {
        // 간단한 CSV 파서: 쉼표로 분리하되, 큰따옴표 안의 쉼표는 무시하고, 따옴표를 제거합니다.
        const result = [];
        let inQuotes = false;
        let currentField = '';
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(currentField.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                currentField = '';
            } else {
                currentField += char;
            }
        }
        result.push(currentField.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        return result;
    }

    function convertHeaderToKey(header) {
      switch (header.trim()) {
        case "ID": return "id";
        case "등록번호/ID": return "name";
        case "설치 장소/지역": return "region";
        case "모델명": return "model";
        case "용량": return "capacity";
        case "유닛 종류": return "unitType";
        case "냉매 종류": return "refrigerant";
        case "전기 종류": return "electricPhase";
        case "설치(등록) 날짜": return "date";
        case "현재 상태": return "status";
        case "고압 상한 설정(PSI)": return "pressureHighLimit";
        case "저압 하한 설정(PSI)": return "pressureLowLimit";
        case "특이사항 및 메모": return "notes";
        case "사진1 URL": return "imageUrl1";
        case "사진2 URL": return "imageUrl2";
        case "사진3 URL": return "imageUrl3";
        case "최종 수정일": return "lastUpdated";
        case "대상 RTU ID": return "rtuId";
        case "점검 날짜": return "inspectionDate";
        case "점검자": return "inspector";
        case "필터": return "check1";
        case "콘텍터": return "check2";
        case "콘덴싱 코일": return "check3";
        case "송풍 모터": return "check4";
        case "증발기 코일": return "check5";
        case "고압 센서": return "check6";
        case "저압 센서": return "check7";
        case "캐패시터": return "check8";
        case "Comp1 고압(PSI)": return "comp1Hp";
        case "Comp1 저압(PSI)": return "comp1Lp";
        case "Comp1 전류(A)": return "comp1Amp";
        case "Comp2 고압(PSI)": return "comp2Hp";
        case "Comp2 저압(PSI)": return "comp2Lp";
        case "Comp2 전류(A)": return "comp2Amp";
        case "과열도(F)": return "superheat";
        case "과냉도(F)": return "subcool";
        case "최종 점검 결과": return "result";
        case "수리 요청/완료 날짜": return "repairDate";
        case "수리 담당자": return "engineer";
        case "처리 상태": return "status";
        case "문제 및 조치 내용": return "issue";
        default:
          return header.trim().toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
      }
    }


    /* ==================== 초기화 ==================== */

    // 모든 리스트를 렌더링하고 대시보드를 업데이트합니다.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();

      // [신규] 보고서 요약 클릭 이벤트 리스너 추가
      elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
      });
      elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
      });
      elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
      });

    }).catch(console.error);
    
    // 페이지 로드 시 기본 탭 활성화 (대시보드)는 HTML 구조로 이미 처리됨
  </script>
</body>
</html>