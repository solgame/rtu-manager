<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== 보고서 인쇄를 위한 CSS 추가 (print-only는 사용하지 않음) ========== */
    .print-only { display: none; } /* 기존 코드에서 남아있는 print-only는 display:none; 상태 유지 */
    @media print {
      /* 앱의 기본 배경과 테두리를 숨겨 인쇄 영역을 깔끔하게 만듭니다. */
      .print-container, #main-app-container { /* 인쇄 문제 해결: 메인 컨테이너 강제 표시 */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* 인쇄 시 숨겨야 할 요소 (버튼, 메뉴 등) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* 인쇄 시 상세 보고서 내용만 표시를 위해 report-page와 detail-view를 강제 표시 */
      #report-page, #report-detail-view { /* 인쇄 문제 해결: 보고서 관련 요소 강제 표시 및 정리 */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* 상태 태그의 배경색은 인쇄 시 제거 */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* 인쇄 시 잘 보이도록 테두리 추가 */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">시스템 운영 보고서</h2>
          <p class="text-gray-600 mb-6 print-hidden">아래 요약 항목을 클릭하시면 상세 목록을 확인하고 인쇄하실 수 있습니다. 🖨️</p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="report-rtu-summary" class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 cursor-pointer hover:bg-indigo-100 transition duration-150">
              <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div id="report-inspection-summary" class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200 cursor-pointer hover:bg-pink-100 transition duration-150">
              <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div id="report-repair-summary" class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200 cursor-pointer hover:bg-teal-100 transition duration-150">
              <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>

          <div id="report-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-lg border hidden">
            <p class="text-gray-500">보고서를 보려면 위의 요약 항목을 클릭하세요.</p>
          </div>

          <p class="text-gray-600 border-t pt-4 mt-8 print-hidden">보다 상세한 데이터 분석 및 보고는 상단의 **데이터 CSV 다운로드/업로드** 버튼을 통해 데이터를 추출하여 진행하실 수 있습니다.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>로딩 중...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="image-zoom-modal" class="modal-bg hidden fixed inset-0 z-[60] flex items-center justify-center p-4" onclick="document.getElementById('image-zoom-modal').classList.add('hidden')">
    <div class="max-w-4xl max-h-[90vh] w-full p-4">
      <img id="zoomed-image" src="" alt="확대 이미지" class="max-w-full max-h-[80vh] w-auto h-auto mx-auto shadow-2xl rounded-lg">
      <button class="absolute top-4 right-4 text-white hover:text-gray-200 transition" onclick="document.getElementById('image-zoom-modal').classList.add('hidden'); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // Firebase configuration and initialization (Note: Replace with your actual config)
    const firebaseConfig = { 
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57...",
      authDomain: "rtu-management-system.firebaseapp.com",
      databaseURL: "https://rtu-management-system-default-rtdb.firebaseio.com",
      projectId: "rtu-management-system",
      storageBucket: "rtu-management-system.appspot.com",
      messagingSenderId: "1056580649987",
      appId: "1:1056580649987:web:f1c5049b4938d227d8e85f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 전역 데이터 저장소
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    // 페이지네이션 설정
    const itemsPerPage = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    // DOM 요소 캐싱
    const elements = {
      // Tabs and Pages
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      rtuManagePage: document.getElementById('rtu-manage'),
      inspectionManagePage: document.getElementById('inspection-manage'),
      repairManagePage: document.getElementById('repair-manage'),
      reportPage: document.getElementById('report-page'),
      
      // RTU Form
      rtuForm: document.getElementById('rtu-form'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdContainer: document.getElementById('rtu-id-container'),
      rtuNameInput: document.getElementById('rtu-name'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),

      // RTU List
      rtuList: document.getElementById('rtu-list'),
      rtuCount: document.getElementById('rtu-count'),
      rtuPagination: document.getElementById('rtu-pagination'),
      
      // Inspection Form
      inspectionForm: document.getElementById('inspection-form'),
      inspectionRtuIdSelect: document.getElementById('inspection-rtu-id'),
      
      // Inspection List
      inspectionList: document.getElementById('inspection-list'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionPagination: document.getElementById('inspection-pagination'),

      // Repair Form
      repairForm: document.getElementById('repair-form'),
      repairRtuIdSelect: document.getElementById('repair-rtu-id'),

      // Repair List
      repairList: document.getElementById('repair-list'),
      repairCount: document.getElementById('repair-count'),
      repairPagination: document.getElementById('repair-pagination'),

      // Dashboard
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      
      // Reports
      reportRtuSummary: document.getElementById('report-rtu-summary'),
      reportInspectionSummary: document.getElementById('report-inspection-summary'),
      reportRepairSummary: document.getElementById('report-repair-summary'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair'),
      reportDetailView: document.getElementById('report-detail-view'),
      
      // Modals
      detailModal: document.getElementById('detail-modal'),
      modalTitle: document.getElementById('modal-title'),
      modalContent: document.getElementById('modal-content'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      imageZoomModal: document.getElementById('image-zoom-modal'),
      zoomedImage: document.getElementById('zoomed-image'),

      // Utility
      csvUpload: document.getElementById('csv-upload'),
      downloadDataBtn: document.getElementById('download-data-btn'),
    };

    /* ==================== 헬퍼 함수 ==================== */

    // 탭 전환
    function switchTab(tabName) {
      elements.tabPages.forEach(page => page.classList.add('hidden'));
      elements.tabBtns.forEach(btn => btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600'));
      elements.tabBtns.forEach(btn => btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300'));

      const activePage = document.getElementById(tabName);
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);

      if (activePage) activePage.classList.remove('hidden');
      if (activeBtn) {
        activeBtn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
        activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      }
      
      // 보고서 페이지에서 다른 탭으로 이동 시 상세 보고서 숨김
      if (tabName !== 'report-page') {
          elements.reportDetailView.classList.add('hidden');
      }

      // 탭 전환 시 스크롤을 맨 위로 이동 (사용자 경험 개선)
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 상태 색상 헬퍼
    function getStatusColor(status) {
      switch (status) {
        case '작동중': return 'bg-green-100 text-green-800 border border-green-200';
        case '정지됨': return 'bg-gray-100 text-gray-800 border border-gray-200';
        case '점검필요': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    function getResultColor(result) {
      switch (result) {
        case '정상': return 'bg-green-100 text-green-800 border border-green-200';
        case '주의': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case '점검필요': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    function getRepairStatusColor(status) {
      switch (status) {
        case '완료': return 'bg-teal-100 text-teal-800 border border-teal-200';
        case '진행중': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case '요청': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    // 파일 로딩 (Firebase에서 데이터 로드)
    function loadFromFirebase() {
      return new Promise((resolve) => {
        const rtuRef = ref(db, 'rtu');
        const inspectionRef = ref(db, 'inspection');
        const repairRef = ref(db, 'repair');

        // RTU 데이터 로드
        onValue(rtuRef, (snapshot) => {
          rtuList = [];
          snapshot.forEach((childSnapshot) => {
            rtuList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          // RTU 업데이트 시 관련 목록 및 대시보드 업데이트
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
        }, { onlyOnce: false });

        // 점검 데이터 로드
        onValue(inspectionRef, (snapshot) => {
          inspectionList = [];
          snapshot.forEach((childSnapshot) => {
            inspectionList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
        }, { onlyOnce: false });

        // 수리 데이터 로드
        onValue(repairRef, (snapshot) => {
          repairList = [];
          snapshot.forEach((childSnapshot) => {
            repairList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          renderRepairList(repairCurrentPage);
          updateDashboard();
          resolve(); // 모든 초기 로드가 완료되면 Promise resolve
        }, { onlyOnce: false });
      });
    }

    // RTU 선택 드롭다운 채우기 (점검/수리 폼)
    function populateRtuSelects() {
      const optionsHtml = `<option value="">-- RTU를 선택하세요 --</option>` + 
        rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');

      elements.inspectionRtuIdSelect.innerHTML = optionsHtml;
      elements.repairRtuIdSelect.innerHTML = optionsHtml;
      
      // 수정 모드 RTU 선택 드롭다운 채우기
      elements.rtuModifySelect.innerHTML = `<option value="">-- 수정할 RTU를 선택하세요 --</option>` + 
        rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');
    }

    // 대시보드 업데이트
    function updateDashboard() {
      const totalRtuCount = rtuList.length;
      const runningCount = rtuList.filter(rtu => rtu.status === '작동중').length;
      const stoppedCount = rtuList.filter(rtu => rtu.status === '정지됨').length;
      const needsInspectionCount = rtuList.filter(rtu => rtu.status === '점검필요').length;

      elements.dashboardTotal.textContent = totalRtuCount;
      elements.dashboardRunning.textContent = runningCount;
      elements.dashboardStopped.textContent = stoppedCount;
      elements.dashboardNeedsInspection.textContent = needsInspectionCount;
      
      // Report Page Summary Update
      elements.reportTotalRtu.textContent = totalRtuCount;
      elements.reportTotalInspection.textContent = inspectionList.length;
      elements.reportTotalRepair.textContent = repairList.length;

      // Monthly Inspection Count
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;

      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }
    }

    /* ==================== 렌더링 함수 (Lists) ==================== */

    // 목록 렌더링 제네릭 함수
    function renderList(list, containerElement, countElement, paginationElement, listType, renderRowFunction) {
      countElement.textContent = list.length;
      
      if (list.length === 0) {
        containerElement.innerHTML = `<p class="text-gray-500 italic">등록된 ${listType} 기록이 없습니다.</p>`;
        paginationElement.innerHTML = '';
        return;
      }
      
      const currentPage = listType === 'RTU' ? rtuCurrentPage : (listType === '점검 기록' ? inspectionCurrentPage : repairCurrentPage);
      const totalPages = Math.ceil(list.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedList = list.slice(startIndex, endIndex);

      let listHtml = '';
      paginatedList.forEach(item => {
        listHtml += renderRowFunction(item);
      });
      containerElement.innerHTML = listHtml;

      // 페이지네이션 렌더링
      renderPagination(paginationElement, totalPages, currentPage, (newPage) => {
        if (listType === 'RTU') {
          rtuCurrentPage = newPage;
          renderRtuList(rtuCurrentPage);
        } else if (listType === '점검 기록') {
          inspectionCurrentPage = newPage;
          renderInspectionList(inspectionCurrentPage);
        } else if (listType === '수리 기록') {
          repairCurrentPage = newPage;
          renderRepairList(repairCurrentPage);
        }
      });
    }
    
    // RTU 목록 렌더링
    function renderRtuList(page) {
        rtuList = rtuList.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderList(rtuList, elements.rtuList, elements.rtuCount, elements.rtuPagination, 'RTU', renderRtuRow);
    }

    // 점검 기록 목록 렌더링
    function renderInspectionList(page) {
        const sortedList = inspectionList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음'
        })).sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));

        renderList(sortedList, elements.inspectionList, elements.inspectionCount, elements.inspectionPagination, '점검 기록', renderInspectionRow);
    }
    
    // 수리 기록 목록 렌더링
    function renderRepairList(page) {
        const sortedList = repairList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음'
        })).sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));

        renderList(sortedList, elements.repairList, elements.repairCount, elements.repairPagination, '수리 기록', renderRepairRow);
    }

    // RTU 행 HTML 생성
    function renderRtuRow(rtu) {
      const statusColor = getStatusColor(rtu.status);
      return `
        <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 flex justify-between items-center hover:bg-gray-100 transition duration-150">
          <div>
            <p class="text-lg font-bold text-gray-800">${rtu.name} (${rtu.region})</p>
            <p class="text-sm text-gray-600 mt-1">모델: ${rtu.model || 'N/A'} | 용량: ${rtu.capacity || 'N/A'}</p>
          </div>
          <div class="flex space-x-3 items-center">
            <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColor}">${rtu.status}</span>
            <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="rtu" data-id="${rtu.id}">상세 보기</button>
          </div>
        </div>
      `;
    }

    // 점검 기록 행 HTML 생성
    function renderInspectionRow(inspection) {
        const resultColor = getResultColor(inspection.result);
        return `
          <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 hover:bg-gray-100 transition duration-150">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-lg font-bold text-gray-800">${inspection.rtuName} (${inspection.inspectionDate})</p>
                <p class="text-sm text-gray-600 mt-1">점검자: ${inspection.inspector} | 최종 결과: <span class="${resultColor} px-2 py-0.5 rounded">${inspection.result || 'N/A'}</span></p>
              </div>
              <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="inspection" data-id="${inspection.id}">상세 보기</button>
            </div>
          </div>
        `;
    }

    // 수리 기록 행 HTML 생성
    function renderRepairRow(repair) {
        const statusColor = getRepairStatusColor(repair.status);
        const issueSnippet = repair.issue ? repair.issue.substring(0, 30) + (repair.issue.length > 30 ? '...' : '') : '내용 없음';

        return `
          <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 hover:bg-gray-100 transition duration-150">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-lg font-bold text-gray-800">${repair.rtuName} (${repair.repairDate})</p>
                <p class="text-sm text-gray-600 mt-1">담당자: ${repair.engineer} | 상태: <span class="${statusColor} px-2 py-0.5 rounded">${repair.status}</span></p>
                <p class="text-xs text-gray-500 mt-1">내용: ${issueSnippet}</p>
              </div>
              <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="repair" data-id="${repair.id}">상세 보기</button>
            </div>
          </div>
        `;
    }

    // 페이지네이션 HTML 생성 및 이벤트 설정
    function renderPagination(container, totalPages, currentPage, onPageChange) {
      container.innerHTML = '';
      if (totalPages <= 1) return;

      let paginationHtml = '';

      // 이전 버튼
      paginationHtml += `<button class="pagination-btn bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-l-lg hover:bg-gray-300 transition duration-150 text-sm" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">이전</button>`;

      // 페이지 번호
      for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
        paginationHtml += `<button class="pagination-btn ${activeClass} font-semibold py-2 px-3 text-sm transition duration-150" data-page="${i}">${i}</button>`;
      }

      // 다음 버튼
      paginationHtml += `<button class="pagination-btn bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-r-lg hover:bg-gray-300 transition duration-150 text-sm" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">다음</button>`;

      container.innerHTML = paginationHtml;

      container.querySelectorAll('.pagination-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          if (!button.disabled) {
            const newPage = parseInt(e.target.dataset.page);
            onPageChange(newPage);
          }
        });
      });
    }
    
    /* ==================== 렌더링 함수 (Details & Report) ==================== */

    // 상세 정보 모달 표시
    function showDetail(type, id) {
      elements.modalContent.innerHTML = '<p class="loading"></p>';
      elements.detailModal.classList.remove('hidden');

      let item = null;
      if (type === 'rtu') {
        item = rtuList.find(r => r.id === id);
        elements.modalTitle.textContent = `RTU 상세 정보: ${item?.name || '로딩 중...'}`;
        if (item) elements.modalContent.innerHTML = renderRtuDetail(item);
      } else if (type === 'inspection') {
        item = inspectionList.find(i => i.id === id);
        elements.modalTitle.textContent = `점검 기록 상세: ${rtuList.find(r => r.id === item?.rtuId)?.name || '로딩 중...'}`;
        if (item) elements.modalContent.innerHTML = renderInspectionDetail(item);
      } else if (type === 'repair') {
        item = repairList.find(r => r.id === id);
        elements.modalTitle.textContent = `수리 기록 상세: ${rtuList.find(r => r.id === item?.rtuId)?.name || '로딩 중...'}`;
        if (item) elements.modalContent.innerHTML = renderRepairDetail(item);
      }
    }

    // RTU 상세 정보 HTML 생성
    function renderRtuDetail(item) {
      const rtuName = item.name;
      const imageUrls = [item.image1, item.image2, item.image3].filter(url => url);
      
      const imageHtml = imageUrls.length > 0 ? `
        <h4 class="text-lg font-semibold text-gray-800 mt-6 border-t pt-4">장비 사진</h4>
        <div class="flex flex-wrap gap-4 mt-2">
          ${imageUrls.map(url => `<img src="${url}" alt="장비 사진" class="thumb-detail" onclick="window.zoomImage('${url}')">`).join('')}
        </div>
      ` : '';
      
      return `
        <div class="space-y-3">
          <p><strong>등록번호/ID:</strong> ${item.name}</p>
          <p><strong>설치 장소/지역:</strong> ${item.region}</p>
          <p><strong>모델명:</strong> ${item.model || 'N/A'}</p>
          <p><strong>용량:</strong> ${item.capacity || 'N/A'}</p>
          <p><strong>유닛 종류:</strong> ${item.unitType || 'N/A'}</p>
          <p><strong>냉매 종류:</strong> ${item.refrigerant || 'N/A'}</p>
          <p><strong>전기 종류:</strong> ${item.electricPhase || 'N/A'}</p>
          <p><strong>설치(등록) 날짜:</strong> ${item.date}</p>
          <p><strong>현재 상태:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${getStatusColor(item.status)}">${item.status}</span></p>
          <p><strong>고압 상한:</strong> ${item.pressureHighLimit || 'N/A'} PSI</p>
          <p><strong>저압 하한:</strong> ${item.pressureLowLimit || 'N/A'} PSI</p>
          <p><strong>특이사항 및 메모:</strong> ${item.notes ? item.notes.replace(/\n/g, '<br>') : '없음'}</p>
          <div class="flex space-x-4 mt-6 border-t pt-4">
            <button class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-150 text-sm" onclick="window.editRtu('${item.id}')">수정 모드로 이동</button>
            <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRtu('${item.id}', '${rtuName}')">삭제</button>
          </div>
          ${imageHtml}
        </div>
      `;
    }
    
    // 점검 기록 상세 정보 HTML 생성
    function renderInspectionDetail(item) {
        const rtuName = rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음';
        const resultColor = getResultColor(item.result);
        
        return `
          <div class="space-y-3">
            <h4 class="text-lg font-bold text-indigo-800 border-b pb-2">기본 정보</h4>
            <p><strong>대상 RTU:</strong> ${rtuName}</p>
            <p><strong>점검 날짜:</strong> ${item.inspectionDate}</p>
            <p><strong>점검자:</strong> ${item.inspector}</p>
            <p><strong>최종 결과:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${resultColor}">${item.result || 'N/A'}</span></p>
            
            <h4 class="text-lg font-bold text-indigo-800 mt-6 border-t pt-4 pb-2">부품 점검 상태</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <p><strong>1. 필터:</strong> ${item.check1}</p>
                <p><strong>2. 콘텍터:</strong> ${item.check2}</p>
                <p><strong>3. 콘덴싱 코일:</strong> ${item.check3}</p>
                <p><strong>4. 송풍 모터:</strong> ${item.check4}</p>
                <p><strong>5. 증발기 코일:</strong> ${item.check5}</p>
                <p><strong>6. 고압 센서:</strong> ${item.check6}</p>
                <p><strong>7. 저압 센서:</strong> ${item.check7}</p>
                <p><strong>8. 캐패시터:</strong> ${item.check8}</p>
            </div>
            
            <h4 class="text-lg font-bold text-red-800 mt-6 border-t pt-4 pb-2">운전 상태 및 온도 측정</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <p><strong>Comp 1 고압:</strong> ${item.comp1Hp || 'N/A'} PSI</p>
                <p><strong>Comp 1 저압:</strong> ${item.comp1Lp || 'N/A'} PSI</p>
                <p><strong>Comp 1 전류:</strong> ${item.comp1Amp || 'N/A'} A</p>
                <p><strong>Comp 2 고압:</strong> ${item.comp2Hp || 'N/A'} PSI</p>
                <p><strong>Comp 2 저압:</strong> ${item.comp2Lp || 'N/A'} PSI</p>
                <p><strong>Comp 2 전류:</strong> ${item.comp2Amp || 'N/A'} A</p>
                <p><strong>과열도:</strong> ${item.superheat || 'N/A'} ℉</p>
                <p><strong>과냉도:</strong> ${item.subcool || 'N/A'} ℉</p>
            </div>
            
            <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4 pb-2">특이사항 및 조치 내용</h4>
            <p class="whitespace-pre-wrap bg-gray-100 p-3 rounded text-sm">${item.notes || '없음'}</p>
            
            <div class="flex space-x-4 mt-6 border-t pt-4">
              <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRecord('${item.id}', 'inspection', '${rtuName} 점검 기록')">삭제</button>
            </div>
          </div>
        `;
    }
    
    // 수리 기록 상세 정보 HTML 생성
    function renderRepairDetail(item) {
        const rtuName = rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음';
        const statusColor = getRepairStatusColor(item.status);

        return `
          <div class="space-y-3">
            <p><strong>대상 RTU:</strong> ${rtuName}</p>
            <p><strong>수리 요청/완료 날짜:</strong> ${item.repairDate}</p>
            <p><strong>수리 담당자:</strong> ${item.engineer}</p>
            <p><strong>처리 상태:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${statusColor}">${item.status}</span></p>
            
            <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4 pb-2">문제 및 조치 내용</h4>
            <p class="whitespace-pre-wrap bg-gray-100 p-3 rounded text-sm">${item.issue.replace(/\n/g, '<br>')}</p>
            
            <div class="flex space-x-4 mt-6 border-t pt-4">
              <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRecord('${item.id}', 'repair', '${rtuName} 수리 기록')">삭제</button>
            </div>
          </div>
        `;
    }

    /* ==================== 렌더링 함수 (Reports) ==================== */

    function renderReportDetail(type) {
      elements.reportDetailView.innerHTML = ''; // 기존 내용 초기화

      let title = '';
      let listData = [];
      let headers = [];
      let contentHtml = '';
      let listId = '';

      if (type === 'rtu') {
        title = `RTU 등록 목록 (${rtuList.length}건)`;
        listData = rtuList;
        headers = ['RTU 등록번호/ID', '설치 장소/지역', '모델명', '용량', '유닛 종류', '설치 날짜', '현재 상태'];
        listId = 'rtu-list-table';
      } else if (type === 'inspection') {
        title = `점검 기록 목록 (${inspectionList.length}건)`;
        listData = inspectionList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음',
          resultText: item.result || '',
        })).sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
        headers = ['점검 날짜', 'RTU 등록번호', '점검자', 'Comp1 고압', 'Comp1 저압', 'Comp1 전류', '최종 결과', '특이사항'];
        listId = 'inspection-list-table';
      } else if (type === 'repair') {
        title = `수리 기록 목록 (${repairList.length}건)`;
        // 데이터를 인쇄를 위해 정렬하고 RTU 이름을 포함합니다.
        listData = repairList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || '알 수 없음',
        })).sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
        headers = ['수리 요청/완료 날짜', 'RTU 등록번호', '담당자', '처리 상태', '문제 및 조치 내용'];
        listId = 'repair-list-table';
      } else {
        return;
      }

      // 1. 제목 및 인쇄 버튼 추가
      contentHtml += `<h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>`;
      contentHtml += `<div class="print-hidden mb-4"><button onclick="window.print()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 text-sm">보고서 인쇄</button></div>`;


      // 2. 테이블 시작
      contentHtml += `<div class="overflow-x-auto"><table id="${listId}" class="min-w-full divide-y divide-gray-200">`;
      
      // 3. 헤더
      contentHtml += `<thead class="bg-gray-50"><tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>`;

      // 4. 바디
      contentHtml += `<tbody class="bg-white divide-y divide-gray-200">`;

      if (listData.length === 0) {
        contentHtml += `<tr><td colspan="${headers.length}" class="px-6 py-4 text-sm font-medium text-gray-500 text-center">등록된 데이터가 없습니다.</td></tr>`;
      } else {
        listData.forEach(item => {
          let rowData = [];
          if (type === 'rtu') {
            rowData = [
              item.name, item.region, item.model || 'N/A', item.capacity || 'N/A', item.unitType || 'N/A', item.date, 
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(item.status)}">${item.status}</span>`
            ];
          } else if (type === 'inspection') {
            rowData = [
              item.inspectionDate, item.rtuName, item.inspector, 
              item.comp1Hp || 'N/A', item.comp1Lp || 'N/A', item.comp1Amp || 'N/A', 
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getResultColor(item.result)}">${item.result || 'N/A'}</span>`,
              item.notes ? item.notes.substring(0, 30) + (item.notes.length > 30 ? '...' : '') : 'N/A'
            ];
          } else if (type === 'repair') {
            // [수정된 부분] 수리 기록의 테이블 행 데이터를 정의합니다.
            rowData = [
              item.repairDate,
              item.rtuName,
              item.engineer,
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getRepairStatusColor(item.status)}">${item.status}</span>`,
              item.issue ? item.issue.substring(0, 50) + (item.issue.length > 50 ? '...' : '') : 'N/A'
            ];
          }

          // Generate table row HTML
          contentHtml += `<tr>${rowData.map(d => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${d}</td>`).join('')}</tr>`;
        });
      }

      // 5. 테이블 끝
      contentHtml += `</tbody></table></div>`;

      // 6. 내용 삽입
      elements.reportDetailView.innerHTML = contentHtml;
    }

    /* ==================== 데이터 처리 함수 ==================== */

    // 데이터 저장 (Firebase)
    function saveToFirebase(path, data, id = null) {
      const targetRef = id ? ref(db, `${path}/${id}`) : ref(db, path);
      // 신규 등록 시 고유 ID 생성 (push)
      if (!id) {
          const newRef = push(targetRef);
          return set(newRef, data);
      }
      // 수정 시 기존 ID 사용 (set)
      return set(targetRef, data);
    }
    
    // RTU 등록/수정 처리
    function handleRtuFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.rtuForm);
      const data = Object.fromEntries(formData.entries());
      const isModification = !!data.rtuIdForModification;
      const rtuId = isModification ? data.rtuIdForModification : null;
      
      // 필수 필드 유효성 검사 (form의 required 속성 사용)
      if (!data.name && !isModification) { // 신규 등록 시 ID 필수
          alert("RTU 등록번호/ID를 입력하세요.");
          return;
      }
      if (!data.region) {
          alert("설치 장소/지역을 입력하세요.");
          return;
      }
      
      // 수정 모드일 때만 rtu-modify-select에서 선택된 ID 사용
      const finalRtuId = isModification ? elements.rtuModifySelect.value : data.name.trim();

      if (isModification && !finalRtuId) {
          alert("수정할 RTU를 선택하세요.");
          return;
      }

      const saveData = {
        name: finalRtuId, // 수정 모드에서는 선택된 ID, 신규 등록에서는 입력된 이름 사용
        region: data.region,
        model: data.model || '',
        capacity: data.capacity || '',
        unitType: data.unitType || '패키지',
        refrigerant: data.refrigerant || 'R-410A',
        electricPhase: data.electricPhase || '삼상',
        date: data.date || new Date().toISOString().substring(0, 10),
        status: data.status || '작동중',
        pressureHighLimit: data.pressureHighLimit ? parseInt(data.pressureHighLimit) : null,
        pressureLowLimit: data.pressureLowLimit ? parseInt(data.pressureLowLimit) : null,
        notes: data.notes || '',
        lastUpdated: new Date().toISOString(), // 마지막 수정일/등록일 기록
        // 이미지 필드는 현재는 URL 대신 파일 이름을 저장한다고 가정하고 처리 로직 생략
        image1: '', // 실제 이미지 처리 로직 필요
        image2: '',
        image3: '',
      };
      
      // 이미지 처리 로직 (Firebase Storage 필요. 여기서는 간단히 URL placeholder 처리)
      const existingRtu = rtuList.find(r => r.id === rtuId);
      if (existingRtu) {
          saveData.image1 = existingRtu.image1 || '';
          saveData.image2 = existingRtu.image2 || '';
          saveData.image3 = existingRtu.image3 || '';
      }

      // 실제로는 Firebase Storage에 파일을 업로드하고 URL을 받아와 저장해야 합니다.
      // 현재는 파일 시스템 상호작용 없이 로컬에서 URL만 처리합니다.
      
      // 데이터베이스에 저장
      const dbPath = 'rtu';
      // 신규 등록 시 rtuId는 null로 전달하여 push로 고유 ID 생성 (또는 name을 ID로 사용)
      const finalSaveId = isModification ? rtuId : saveData.name;
      
      if (!isModification && rtuList.some(r => r.id === finalSaveId)) {
          alert(`오류: ${finalSaveId}는 이미 등록된 RTU ID입니다. 다른 ID를 사용하세요.`);
          return;
      }

      // ID를 name으로 사용하고, key도 name으로 저장 (사용자 요구사항에 맞춤)
      saveToFirebase(dbPath, saveData, finalSaveId)
        .then(() => {
          alert(`RTU 정보가 성공적으로 ${isModification ? '수정' : '등록'}되었습니다!`);
          elements.rtuForm.reset();
          // 폼 모드를 신규 등록으로 리셋
          setRtuFormMode('new'); 
        })
        .catch(error => {
          console.error("Firebase RTU 저장 오류: ", error);
          alert("RTU 정보 저장 중 오류가 발생했습니다. 콘솔을 확인하세요.");
        });
    }

    // 점검 기록 저장 처리
    function handleInspectionFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.inspectionForm);
      const data = Object.fromEntries(formData.entries());
      
      const saveData = {
        rtuId: data.rtuId,
        inspectionDate: data.inspectionDate,
        inspector: data.inspector,
        check1: data.check1,
        check2: data.check2,
        check3: data.check3,
        check4: data.check4,
        check5: data.check5,
        check6: data.check6,
        check7: data.check7,
        check8: data.check8,
        comp1Hp: data.comp1Hp ? parseFloat(data.comp1Hp) : null,
        comp1Lp: data.comp1Lp ? parseFloat(data.comp1Lp) : null,
        comp1Amp: data.comp1Amp ? parseFloat(data.comp1Amp) : null,
        comp2Hp: data.comp2Hp ? parseFloat(data.comp2Hp) : null,
        comp2Lp: data.comp2Lp ? parseFloat(data.comp2Lp) : null,
        comp2Amp: data.comp2Amp ? parseFloat(data.comp2Amp) : null,
        superheat: data.superheat ? parseFloat(data.superheat) : null,
        subcool: data.subcool ? parseFloat(data.subcool) : null,
        result: data.result,
        notes: data.notes,
        timestamp: new Date().toISOString(),
      };
      
      saveToFirebase('inspection', saveData)
        .then(() => {
          alert("점검 기록이 성공적으로 저장되었습니다!");
          elements.inspectionForm.reset();
          // RTU 상태 업데이트: 최종 점검 결과가 '점검필요'인 경우 RTU 상태도 '점검필요'로 변경
          if (saveData.result === '점검필요') {
              const rtuToUpdate = rtuList.find(r => r.id === saveData.rtuId);
              if (rtuToUpdate && rtuToUpdate.status !== '점검필요') {
                  saveToFirebase('rtu', { ...rtuToUpdate, status: '점검필요' }, saveData.rtuId);
              }
          }
        })
        .catch(error => {
          console.error("Firebase 점검 기록 저장 오류: ", error);
          alert("점검 기록 저장 중 오류가 발생했습니다. 콘솔을 확인하세요.");
        });
    }
    
    // 수리 기록 저장 처리
    function handleRepairFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.repairForm);
      const data = Object.fromEntries(formData.entries());
      
      const saveData = {
        rtuId: data.rtuId,
        repairDate: data.repairDate,
        engineer: data.engineer,
        status: data.status,
        issue: data.issue,
        timestamp: new Date().toISOString(),
      };
      
      saveToFirebase('repair', saveData)
        .then(() => {
          alert("수리 기록이 성공적으로 저장되었습니다!");
          elements.repairForm.reset();
          
          // RTU 상태 업데이트: 처리 상태가 '완료'이면 RTU 상태를 '작동중'으로 변경
          if (saveData.status === '완료') {
              const rtuToUpdate = rtuList.find(r => r.id === saveData.rtuId);
              if (rtuToUpdate && rtuToUpdate.status !== '작동중') {
                  saveToFirebase('rtu', { ...rtuToUpdate, status: '작동중' }, saveData.rtuId);
              }
          }
        })
        .catch(error => {
          console.error("Firebase 수리 기록 저장 오류: ", error);
          alert("수리 기록 저장 중 오류가 발생했습니다. 콘솔을 확인하세요.");
        });
    }

    // RTU 수정 모드 전환
    function setRtuFormMode(mode, rtuId = null) {
        if (mode === 'new') {
            elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
            elements.rtuNameInput.classList.remove('hidden');
            elements.rtuModifySelect.classList.add('hidden');
            elements.rtuIdForModification.value = '';
            elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
            elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
        } else if (mode === 'modify') {
            elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
            elements.rtuNameInput.classList.add('hidden');
            elements.rtuModifySelect.classList.remove('hidden');
            elements.rtuIdForModification.value = 'true'; // 수정 모드임을 표시
            elements.rtuSubmitBtn.textContent = 'RTU 정보 수정';
            elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            // 드롭다운 변경 시 폼 데이터 채우기 이벤트 등록 (필요 시)
        }
    }

    // 수정할 RTU 선택 시 폼 채우기
    function fillRtuFormForModification(rtuId) {
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) {
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            return;
        }

        document.getElementById('rtu-region').value = rtu.region || '';
        document.getElementById('rtu-model').value = rtu.model || '';
        document.getElementById('rtu-capacity').value = rtu.capacity || '';
        document.getElementById('rtu-unit-type').value = rtu.unitType || '패키지';
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase || '삼상';
        document.getElementById('rtu-date').value = rtu.date || '';
        document.getElementById('rtu-status').value = rtu.status || '작동중';
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
        document.getElementById('rtu-notes').value = rtu.notes || '';
        
        // 이미지 미리보기 업데이트 (URL이 있는 경우에만 표시)
        const images = [rtu.image1, rtu.image2, rtu.image3];
        const previews = [elements.imagePreview1, elements.imagePreview2, elements.imagePreview3];
        
        let hasImage = false;
        images.forEach((url, index) => {
            if (url) {
                previews[index].src = url;
                previews[index].style.display = 'block';
                hasImage = true;
            } else {
                previews[index].src = '';
                previews[index].style.display = 'none';
            }
        });
        
        if (hasImage) {
            elements.imagePreviewContainer.classList.remove('hidden');
        } else {
            elements.imagePreviewContainer.classList.add('hidden');
        }
    }

    // RTU 삭제
    function deleteRtu(id, name) {
        if (confirm(`정말로 RTU [${name}]의 모든 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
            const rtuRef = ref(db, `rtu/${id}`);
            remove(rtuRef)
                .then(() => {
                    // 관련된 점검 및 수리 기록도 삭제 (필요에 따라)
                    inspectionList.filter(i => i.rtuId === id).forEach(i => remove(ref(db, `inspection/${i.id}`)));
                    repairList.filter(r => r.rtuId === id).forEach(r => remove(ref(db, `repair/${r.id}`)));
                    
                    alert(`RTU [${name}] 및 관련 기록이 삭제되었습니다.`);
                    elements.detailModal.classList.add('hidden');
                    // 목록은 onValue 리스너에 의해 자동으로 업데이트됨
                })
                .catch(error => {
                    console.error("RTU 삭제 오류: ", error);
                    alert("RTU 삭제 중 오류가 발생했습니다. 콘솔을 확인하세요.");
                });
        }
    }
    
    // 점검/수리 기록 삭제
    function deleteRecord(id, type, name) {
        if (confirm(`정말로 ${name} 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
            const recordRef = ref(db, `${type}/${id}`);
            remove(recordRef)
                .then(() => {
                    alert(`${name} 기록이 삭제되었습니다.`);
                    elements.detailModal.classList.add('hidden');
                    // 목록은 onValue 리스너에 의해 자동으로 업데이트됨
                })
                .catch(error => {
                    console.error("기록 삭제 오류: ", error);
                    alert("기록 삭제 중 오류가 발생했습니다. 콘솔을 확인하세요.");
                });
        }
    }
    
    // CSV 다운로드 (데이터 내보내기)
    function downloadCSV() {
        const dataToExport = [
            { title: 'RTU_List', data: rtuList, headers: ['id', 'name', 'region', 'model', 'capacity', 'unitType', 'refrigerant', 'electricPhase', 'date', 'status', 'pressureHighLimit', 'pressureLowLimit', 'notes', 'lastUpdated', 'image1', 'image2', 'image3'] },
            { title: 'Inspection_Log', data: inspectionList, headers: ['id', 'rtuId', 'inspectionDate', 'inspector', 'check1', 'check2', 'check3', 'check4', 'check5', 'check6', 'check7', 'check8', 'comp1Hp', 'comp1Lp', 'comp1Amp', 'comp2Hp', 'comp2Lp', 'comp2Amp', 'superheat', 'subcool', 'result', 'notes', 'timestamp'] },
            { title: 'Repair_Log', data: repairList, headers: ['id', 'rtuId', 'repairDate', 'engineer', 'status', 'issue', 'timestamp'] }
        ];

        // Helper to convert array of objects to CSV string
        const convertToCSV = (data, headers) => {
            const headerRow = headers.join(',') + '\n';
            const rows = data.map(obj => 
                headers.map(header => {
                    let value = obj[header] !== undefined && obj[header] !== null ? obj[header] : '';
                    // 콤마, 따옴표, 줄바꿈 포함 시 따옴표로 묶고 따옴표는 두 번 겹침
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            );
            return headerRow + rows.join('\n');
        };

        let zip;
        try {
            // JSZip 라이브러리가 로드되어 있어야 합니다. (이 파일에는 없으므로, 로컬에서 실행 시 필요)
            zip = new window.JSZip();
        } catch (e) {
            alert('CSV 다운로드를 위해 JSZip 라이브러리가 필요합니다. 로컬 환경에서 로드해주세요. (현재는 지원되지 않습니다.)');
            return;
        }

        dataToExport.forEach(item => {
            const csv = convertToCSV(item.data, item.headers);
            zip.file(`${item.title}.csv`, csv);
        });

        zip.generateAsync({ type: "blob" })
            .then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RTU_Data_Backup_${new Date().toISOString().substring(0, 10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("CSV ZIP 생성 오류:", error);
                alert("데이터 다운로드 중 오류가 발생했습니다.");
            });
    }

    // CSV 업로드 (데이터 가져오기)
    async function handleCSVUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        let rtuData = null;
        let inspectionData = null;
        let repairData = null;

        const parseFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const csv = e.target.result;
                    // PapaParse 라이브러리가 로드되어 있어야 합니다. (이 파일에는 없으므로, 로컬에서 실행 시 필요)
                    try {
                        const results = window.Papa.parse(csv, { 
                            header: true, 
                            skipEmptyLines: true,
                            dynamicTyping: true 
                        });
                        resolve(results.data);
                    } catch (e) {
                        reject(new Error("CSV 파싱 오류. PapaParse 라이브러리가 로드되었는지 확인하세요."));
                    }
                };
                reader.onerror = () => reject(new Error("파일 읽기 오류"));
                reader.readAsText(file, 'utf-8');
            });
        };

        alert('경고: CSV 업로드는 기존 데이터를 덮어쓸 수 있습니다. 현재는 데이터 가져오기만 구현되어 있으며, 실제 데이터 병합/덮어쓰기 로직은 생략되었습니다. (PapaParse 라이브러리 필요)');

        for (const file of files) {
            try {
                const data = await parseFile(file);
                if (file.name.includes('RTU_List')) {
                    rtuData = data;
                } else if (file.name.includes('Inspection_Log')) {
                    inspectionData = data;
                } else if (file.name.includes('Repair_Log')) {
                    repairData = data;
                }
            } catch (error) {
                console.error(`파일 ${file.name} 처리 중 오류:`, error);
                alert(`파일 ${file.name} 처리 중 오류가 발생했습니다.`);
            }
        }
        
        // 실제로 Firebase에 업로드하는 로직 (생략됨)
        console.log("RTU Data to Upload:", rtuData);
        console.log("Inspection Data to Upload:", inspectionData);
        console.log("Repair Data to Upload:", repairData);
        
        // 업로드 후 로딩 상태 해제
        event.target.value = null; // 파일 선택 초기화
    }

    // CSV 헤더 한글-영문 변환 헬퍼 (CSV 업로드/다운로드 시 사용)
    function getEnglishHeader(header) {
      switch (header.trim()) {
        case "RTU 등록번호/ID": return "id";
        case "설치 장소/지역": return "region";
        case "모델명": return "model";
        case "용량 (냉동톤/kW)": return "capacity";
        case "유닛 종류": return "unitType";
        case "냉매 종류": return "refrigerant";
        case "전기 종류": return "electricPhase";
        case "설치(등록) 날짜": return "date";
        case "현재 상태": return "status";
        case "고압 상한 설정 (PSI)": return "pressureHighLimit";
        case "저압 하한 설정 (PSI)": return "pressureLowLimit";
        case "특이사항 및 메모": return "notes";
        case "점검 날짜": return "inspectionDate";
        case "점검자 이름": return "inspector";
        case "최종 점검 결과": return "result";
        case "문제 및 조치 내용": return "issue";
        case "수리 요청/완료 날짜": return "repairDate";
        case "수리 담당자": return "engineer";
        case "처리 상태": return "status";
        default:
          return header.trim().toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
      }
    }


    /* ==================== 초기화 ==================== */

    // 모든 리스트를 렌더링하고 대시보드를 업데이트합니다.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();

      // [신규] 보고서 요약 클릭 이벤트 리스너 추가
      elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
      });
      elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
      });
      elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
      });
    });

    /* ==================== 이벤트 리스너 설정 ==================== */

    // 탭 버튼 이벤트
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // RTU 폼 제출 이벤트
    elements.rtuForm.addEventListener('submit', handleRtuFormSubmit);
    elements.modeNewBtn.addEventListener('click', () => setRtuFormMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => setRtuFormMode('modify'));
    elements.rtuModifySelect.addEventListener('change', (e) => fillRtuFormForModification(e.target.value));

    // 점검 폼 제출 이벤트
    elements.inspectionForm.addEventListener('submit', handleInspectionFormSubmit);

    // 수리 폼 제출 이벤트
    elements.repairForm.addEventListener('submit', handleRepairFormSubmit);
    
    // 모달 닫기 버튼 이벤트
    elements.closeModalBtn.addEventListener('click', () => {
      elements.detailModal.classList.add('hidden');
    });

    // 상세 보기 버튼 클릭 이벤트 위임
    document.addEventListener('click', (e) => {
      if (e.target.matches('.detail-view-btn')) {
        showDetail(e.target.dataset.type, e.target.dataset.id);
      }
    });
    
    // 전체 다운로드 버튼 이벤트 (JSZip 라이브러리가 로드되어 있어야 함)
    elements.downloadDataBtn.addEventListener('click', downloadCSV);

    // CSV 업로드 이벤트
    elements.csvUpload.addEventListener('change', handleCSVUpload);

    // 전역 스코프에 함수 노출 (HTML 인라인 이벤트 핸들러용)
    window.zoomImage = (url) => {
        elements.zoomedImage.src = url;
        elements.imageZoomModal.classList.remove('hidden');
    };
    window.editRtu = (rtuId) => {
        switchTab('rtu-manage');
        setRtuFormMode('modify');
        elements.rtuModifySelect.value = rtuId;
        fillRtuFormForModification(rtuId);
        elements.detailModal.classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    window.deleteRtu = deleteRtu;
    window.deleteRecord = deleteRecord;
    
    // 초기 탭 설정
    switchTab('dashboard');
  </script>
  </body>
</html>