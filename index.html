<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RTU 관리 시스템 v6 (Firebase)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-storage-compat.js"></script>
<style>
body{font-family:Inter,system-ui;background:#f3f4f6}
.thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb}
.input{border:1px solid #d1d5db;padding:.5rem;border-radius:.5rem;width:100%}
.btn{background:#4f46e5;color:#fff;padding:.5rem 1rem;border-radius:.5rem}
.btn-ghost{background:#f3f4f6;color:#374151;padding:.5rem 1rem;border-radius:.5rem;border:1px solid #e5e7eb}
.nav-active{background:#4f46e5;color:#fff}
.card{background:#fff;border-radius:.5rem;padding:1rem;box-shadow:0 4px 12px rgba(15,23,42,0.08)}
.progress-bar{height:6px;background:#c7d2fe;border-radius:3px;overflow:hidden;margin-top:4px}
.progress-bar div{height:100%;background:#4f46e5;width:0%}
</style>
</head>
<body class="min-h-screen p-6">
<div class="max-w-6xl mx-auto">
  <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h1 class="text-2xl font-extrabold text-indigo-700">RTU 관리 시스템 v6 (Firebase)</h1>
    <div class="flex gap-2">
      <button data-view="dashboard" class="btn nav-active">대시보드</button>
      <button data-view="register" class="btn-ghost">장비등록</button>
      <button data-view="inspect" class="btn-ghost">점검등록</button>
      <button data-view="repair" class="btn-ghost">수리등록</button>
      <button data-view="report" class="btn-ghost">보고서</button>
    </div>
  </header>

  <div id="messageBox" class="hidden mb-4 p-3 rounded text-sm"></div>
  <main id="mainArea" class="space-y-6"></main>
</div>

<script>
// ===== Firebase 설정 =====
const firebaseConfig = {
  apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
  authDomain: "rtu-system-han.firebaseapp.com",
  projectId: "rtu-system-han",
  storageBucket: "rtu-system-han.appspot.com",
  messagingSenderId: "960060003353",
  appId: "1:960060003353:web:06932b3da09391c9b0c688",
  measurementId: "G-C2MDK46FFF"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
const DOC = db.collection("rtu_system").doc("main");

let state = { rtu_units: [], inspections: [], repairs: [] };
let editIndex = null; // ✅ 수정 모드 관리용

// ===== 메시지 표시 =====
function showMessage(msg,type='info'){
  const el=document.getElementById('messageBox');
  el.textContent=msg;
  el.className='mb-4 p-3 rounded text-sm '+(type==='error'?'bg-red-100 text-red-700':'bg-green-100 text-green-700');
  el.classList.remove('hidden');
  setTimeout(()=>el.classList.add('hidden'),3000);
}

// ===== 데이터 로드/저장 =====
async function loadState(){
  try{
    const snap=await DOC.get();
    if(snap.exists) state=snap.data();
    else { await DOC.set(state); }
    renderView(currentView);
  }catch(e){console.error(e);showMessage('데이터 로드 실패','error');}
}
async function saveState(){
  try{await DOC.set(state);showMessage('저장 완료');renderView(currentView);}
  catch(e){console.error(e);showMessage('저장 실패','error');}
}

// ===== 네비게이션 =====
const navButtons=document.querySelectorAll('header button[data-view]');
let currentView='dashboard';
navButtons.forEach(b=>{
  b.addEventListener('click',()=>{
    navButtons.forEach(x=>x.classList.remove('nav-active'));
    b.classList.add('nav-active');
    currentView=b.getAttribute('data-view');
    renderView(currentView);
  });
});

// ===== 날짜 자동 =====
function setToday(root=document){
  const t=new Date().toISOString().split('T')[0];
  root.querySelectorAll('input[type="date"]').forEach(i=>{if(!i.value)i.value=t});
}

// ===== View 렌더러 =====
function renderView(v){
  const m=document.getElementById('mainArea');
  if(v==='dashboard')m.innerHTML=renderDashboard();
  if(v==='register')m.innerHTML=renderRegister();
  if(v==='inspect')m.innerHTML=renderInspect();
  if(v==='repair')m.innerHTML=renderRepair();
  if(v==='report')m.innerHTML=renderReport();
  setToday(m);
  wireUp(v);
}

// === 대시보드 ===
function renderDashboard(){
  return `<div class="card text-gray-700">
    <p class="mb-2">총 장비 수: ${state.rtu_units.length}</p>
    <p>점검 내역: ${state.inspections.length} / 수리 내역: ${state.repairs.length}</p>
  </div>`;
}

// === 장비등록 ===
function renderRegister(){
return `<div class="grid md:grid-cols-2 gap-6">
<div class="card">
<h2 class="font-bold mb-3">장비 등록</h2>
<form id="form-rtu" class="space-y-3">
<input id="f_id" class="input" placeholder="RTU ID" required>
<input id="f_model" class="input" placeholder="모델명">
<input id="f_maker" class="input" placeholder="제조사">
<input id="f_ref" class="input" placeholder="냉매">
<input id="f_capacity" class="input" placeholder="용량">
<input id="f_install" type="date" class="input">
<input id="f_loc" class="input" placeholder="위치">
<select id="f_status" class="input"><option>정상</option><option>점검필요</option><option>불량(수리)</option></select>
<textarea id="f_memo" class="input" placeholder="메모"></textarea>
<label>장비 사진 (최대 3장)</label>
<input id="f_imgs" type="file" accept="image/*" multiple>
<div class="progress-bar"><div id="upload-progress"></div></div>
<div id="f_preview" class="flex gap-2 mt-2"></div>
<button class="btn w-full">저장</button>
</form>
</div>
<div class="card">
<h2 class="font-bold mb-3">등록된 장비</h2>
<div id="rtu-list">${renderRtuList()}</div>
</div>
</div>`;
}
function renderRtuList(){
if(!state.rtu_units.length)return `<p class="text-gray-400">없음</p>`;
return state.rtu_units.slice().reverse().map(r=>`
<div class="flex gap-2 border-b py-2">
<div class="w-20 h-14 bg-gray-100 flex justify-center items-center">
${r.images&&r.images[0]?`<img src="${r.images[0]}" class="thumb">`:`<span class="text-xs text-gray-400">이미지없음</span>`}
</div>
<div class="flex-1">
<p class="font-semibold">${r.rtuId}</p>
<p class="text-xs text-gray-500">${r.model||''} · ${r.location||''}</p>
</div>
</div>`).join('');
}

// === 점검등록 ===
function renderInspect(){
return `<div class="grid md:grid-cols-2 gap-6">
<div class="card">
<h2 class="font-bold mb-3">점검 등록</h2>
<form id="form-insp" class="space-y-3">
<select id="i_rtu" class="input" required><option value="">RTU 선택</option>${state.rtu_units.map(r=>`<option>${r.rtuId}</option>`).join('')}</select>
<input id="i_person" class="input" placeholder="점검자">
<input id="i_date" type="date" class="input">
<div class="grid grid-cols-2 gap-2">
<input id="i_p1h" class="input" placeholder="Comp1 고압 (psi)">
<input id="i_p1l" class="input" placeholder="Comp1 저압 (psi)">
<input id="i_p2h" class="input" placeholder="Comp2 고압 (psi)">
<input id="i_p2l" class="input" placeholder="Comp2 저압 (psi)">
</div>
<div class="grid grid-cols-2 gap-2">
<input id="i_overheat" class="input" placeholder="과열도 (°F)">
<input id="i_overcool" class="input" placeholder="과냉도 (°F)">
</div>
<textarea id="i_memo" class="input" placeholder="비고"></textarea>
<input id="i_imgs" type="file" accept="image/*" multiple>
<div id="i_preview" class="flex gap-2 mt-2"></div>
<button class="btn w-full">저장</button>
</form>
</div>
<div class="card">
<h2 class="font-bold mb-3">누적 점검</h2>
<div>${renderInspectList()}</div>
</div>
</div>`;
}
function renderInspectList(){
if(!state.inspections.length)return `<p class="text-gray-400">없음</p>`;
return state.inspections.slice().reverse().map(i=>`
<div class="border-b py-2">
<p class="font-semibold">${i.rtuId}</p>
<p class="text-xs text-gray-500">${i.date} · ${i.inspector}</p>
<div class="flex gap-1 mt-1">${(i.images||[]).map(u=>`<img src="${u}" class="thumb">`).join('')}</div>
</div>`).join('');
}

// === 수리등록 ===
function renderRepair(){
return `<div class="grid md:grid-cols-2 gap-6">
<div class="card">
<h2 class="font-bold mb-3">수리 등록</h2>
<form id="form-rep" class="space-y-3">
<select id="r_rtu" class="input" required><option value="">RTU 선택</option>${state.rtu_units.map(r=>`<option>${r.rtuId}</option>`).join('')}</select>
<input type="date" id="r_date" class="input">
<input id="r_part" class="input" placeholder="부품명">
<input id="r_person" class="input" placeholder="담당자">
<textarea id="r_memo" class="input" placeholder="내용"></textarea>
<label>사진 (최대3장)</label>
<input id="r_imgs" type="file" multiple accept="image/*">
<div id="r_preview" class="flex gap-2 mt-2"></div>
<button class="btn w-full">저장</button>
</form>
</div>
<div class="card">
<h2 class="font-bold mb-3">누적 수리</h2>
<div>${renderRepairList()}</div>
</div>
</div>`;
}
function renderRepairList(){
if(!state.repairs.length)return `<p class="text-gray-400">없음</p>`;
return state.repairs.slice().reverse().map(r=>`
<div class="border-b py-2">
<p class="font-semibold">${r.rtuId}</p>
<p class="text-xs text-gray-500">${r.date} ${r.part||''}</p>
<div class="flex gap-1 mt-1">${(r.images||[]).map(u=>`<img src="${u}" class="thumb">`).join('')}</div>
</div>`).join('');
}

// === 보고서 ===
function renderReport(){
return `<div class="grid md:grid-cols-2 gap-6">
<div class="card"><h2 class="font-bold mb-3">점검</h2>${renderInspectList()}</div>
<div class="card"><h2 class="font-bold mb-3">수리</h2>${renderRepairList()}</div>
</div>`;
}

// ===== 이미지 업로드 함수 =====
async function uploadImages(rtuId,files,prefix,progressId){
  const urls=[];
  for(let i=0;i<files.length;i++){
    const file=files[i];
    const ts=new Date().toISOString().replace(/[:.]/g,'-');
    const path=`rtu_images/${rtuId}/${ts}_${prefix}_${i+1}_${file.name}`;
    const ref=storage.ref().child(path);
    const task=ref.put(file);
    task.on('state_changed',snap=>{
      const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      if(progressId)document.getElementById(progressId).style.width=pct+'%';
    });
    const snap=await task;
    const url=await snap.ref.getDownloadURL();
    urls.push(url);
  }
  return urls;
}

// ===== View Event 연결 =====
function wireUp(v){
  if(v==='register'){
    const f=document.getElementById('form-rtu');
    const fileInput=f.querySelector('#f_imgs');
    const preview=document.getElementById('f_preview');
    fileInput.onchange=()=>{preview.innerHTML='';Array.from(fileInput.files).forEach(fil=>{const img=document.createElement('img');img.src=URL.createObjectURL(fil);img.className='thumb';preview.appendChild(img);});};
    f.onsubmit=async e=>{
      e.preventDefault();
      const id=f.f_id.value.trim();if(!id)return;
      const existed=state.rtu_units.find(r=>r.rtuId===id);
      if(existed&&!editIndex){showMessage('중복된 ID','error');return;}
      const obj={rtuId:id,model:f.f_model.value,manufacturer:f.f_maker.value,refrigerant:f.f_ref.value,capacity:f.f_capacity.value,installDate:f.f_install.value,location:f.f_loc.value,status:f.f_status.value,memo:f.f_memo.value,images:[]};
      const files=Array.from(fileInput.files).slice(0,3);
      if(files.length>0){obj.images=await uploadImages(id,files,'rtu','upload-progress');}
      if(editIndex!==null){state.rtu_units[editIndex]=obj;editIndex=null;}else{state.rtu_units.push(obj);}
      await saveState();f.reset();preview.innerHTML='';document.getElementById('upload-progress').style.width='0%';
    };
  }
  if(v==='inspect'){
    const f=document.getElementById('form-insp');
    const inp=f.querySelector('#i_imgs');
    const pv=document.getElementById('i_preview');
    inp.onchange=()=>{pv.innerHTML='';Array.from(inp.files).forEach(fi=>{const i=document.createElement('img');i.src=URL.createObjectURL(fi);i.className='thumb';pv.appendChild(i);});};
    f.onsubmit=async e=>{
      e.preventDefault();
      const id=f.i_rtu.value;if(!id)return;
      const files=Array.from(inp.files).slice(0,3);
      const urls=files.length?await uploadImages(id,files,'insp'): [];
      state.inspections.push({rtuId:id,inspector:f.i_person.value,date:f.i_date.value,overheating:f.i_overheat.value,overcooling:f.i_overcool.value,images:urls});
      await saveState();f.reset();pv.innerHTML='';
    };
  }
  if(v==='repair'){
    const f=document.getElementById('form-rep');
    const inp=f.querySelector('#r_imgs');
    const pv=document.getElementById('r_preview');
    inp.onchange=()=>{pv.innerHTML='';Array.from(inp.files).forEach(fi=>{const i=document.createElement('img');i.src=URL.createObjectURL(fi);i.className='thumb';pv.appendChild(i);});};
    f.onsubmit=async e=>{
      e.preventDefault();
      const id=f.r_rtu.value;if(!id)return;
      const files=Array.from(inp.files).slice(0,3);
      const urls=files.length?await uploadImages(id,files,'rep'): [];
      state.repairs.push({rtuId:id,date:f.r_date.value,part:f.r_part.value,person:f.r_person.value,notes:f.r_memo.value,images:urls});
      await saveState();f.reset();pv.innerHTML='';
    };
  }
}

// ===== 초기 =====
document.addEventListener('DOMContentLoaded',async()=>{
  renderView('register');
  await loadState();
});
</script>
</body>
</html>
