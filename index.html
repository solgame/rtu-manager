<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">시스템 운영 보고서</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200">
              <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200">
              <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200">
              <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>
          <p class="text-gray-600 border-t pt-4">보다 상세한 데이터 분석 및 보고는 상단의 **데이터 CSV 다운로드/업로드** 버튼을 통해 데이터를 추출하여 진행하실 수 있습니다. 모든 데이터는 Firebase 클라우드에 실시간으로 동기화됩니다.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>로딩 중...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div id="image-zoom-modal" class="modal-bg hidden fixed inset-0 z-[60] flex items-center justify-center p-4" onclick="document.getElementById('image-zoom-modal').classList.add('hidden')">
    <div class="max-w-4xl max-h-[90vh] w-full p-4">
      <img id="zoomed-image" src="" alt="확대 이미지" class="max-w-full max-h-[80vh] w-auto h-auto mx-auto shadow-2xl rounded-lg">
      <button class="absolute top-4 right-4 text-white hover:text-gray-200 transition" onclick="document.getElementById('image-zoom-modal').classList.add('hidden'); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688",
      measurementId: "G-L58S7K0264"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseGet = get;
    window.firebaseRemove = remove;
    window.firebaseInitialized = true;
  </script>

  <script>
    /* ==================== 전역 변수 및 설정 ==================== */
    const STORAGE_KEYS = {
      RTU: 'rtuList',
      INSPECTION: 'inspectionList',
      REPAIR: 'repairList'
    };
    
    let imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];
    let isFirebaseReady = false;
    let currentRtuMode = 'new';
    let currentModalData = { id: null, type: null };

    // Pagination Settings
    const PAGE_SIZE = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    const elements = {
      rtuForm: document.getElementById('rtu-form'),
      rtuCount: document.getElementById('rtu-count'),
      rtuListContainer: document.getElementById('rtu-list'),
      rtuPaginationContainer: document.getElementById('rtu-pagination'),
      inspectionForm: document.getElementById('inspection-form'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionListContainer: document.getElementById('inspection-list'),
      inspectionPaginationContainer: document.getElementById('inspection-pagination'),
      inspectionRtuIdSelect: document.getElementById('inspection-rtu-id'),
      repairForm: document.getElementById('repair-form'),
      repairCount: document.getElementById('repair-count'),
      repairListContainer: document.getElementById('repair-list'),
      repairPaginationContainer: document.getElementById('repair-pagination'),
      repairRtuIdSelect: document.getElementById('repair-rtu-id'),
      detailModal: document.getElementById('detail-modal'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      modalTitle: document.getElementById('modal-title'),
      modalContent: document.getElementById('modal-content'),
      imageZoomModal: document.getElementById('image-zoom-modal'),
      zoomedImage: document.getElementById('zoomed-image'),
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair')
    };
    /* ==================== Firebase 함수 ==================== */
    function waitForFirebase() {
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (window.firebaseInitialized) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);
      });
    }
    async function loadFromFirebase() {
      await waitForFirebase();
      const rtuRef = window.firebaseRef(window.firebaseDB, 'rtuList');
      window.firebaseOnValue(rtuRef, (snapshot) => {
        const data = snapshot.val();
        rtuList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
        }
      });
      const inspectionRef = window.firebaseRef(window.firebaseDB, 'inspectionList');
      window.firebaseOnValue(inspectionRef, (snapshot) => {
        const data = snapshot.val();
        inspectionList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
        }
      });
      const repairRef = window.firebaseRef(window.firebaseDB, 'repairList');
      window.firebaseOnValue(repairRef, (snapshot) => {
        const data = snapshot.val();
        repairList = data ? Object.values(data) : [];
        if (isFirebaseReady) {
          // 수리 기록 미표시 오류 수정: onValue 콜백이 정상적으로 리스트를 업데이트하고 렌더링하도록 보장
          renderRepairList(repairCurrentPage); 
          updateDashboard();
        }
      });
      isFirebaseReady = true;
    }
    async function saveToFirebase(key, list) {
      await waitForFirebase();
      try {
        const dataObject = {};
        list.forEach(item => {
          // ID가 없는 항목을 거릅니다. (CSV 업로드 등으로 인해 발생 가능)
          if(item.id) {
            dataObject[item.id] = item;
          }
        });
        const dataRef = window.firebaseRef(window.firebaseDB, key);
        // set을 호출하면 onValue 리스너가 트리거되어 렌더링을 담당합니다.
        await window.firebaseSet(dataRef, dataObject); 
      } catch (error) {
        console.error(`Error saving to Firebase (${key}):`, error);
        alert('데이터 저장 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.');
      }
    }
    function saveList(key, list) {
      return saveToFirebase(key, list);
    } 
    /* ==================== 유틸리티 함수 ==================== */
    function formatDate(dateString) {
      if (!dateString) return '날짜 정보 없음';
      try {
        const date = new Date(dateString);
        const d = dateString.includes('T') ? new Date(dateString) : new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
        return d.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\. /g, '.').replace(/\.$/, '');
      } catch {
        return dateString.substring(0, 10);
      }
    }
    function getStatusColor(status) {
      switch (status) {
        case '작동중': return 'bg-green-100 text-green-800';
        case '정지됨': return 'bg-gray-100 text-gray-800';
        case '점검필요': return 'bg-red-100 text-red-800';
        case '주의': return 'bg-yellow-100 text-yellow-800';
        case '요청': return 'bg-red-100 text-red-800';
        case '진행중': return 'bg-yellow-100 text-yellow-800';
        case '완료': return 'bg-blue-100 text-blue-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }
    function isUrl(str) {
      try {
        // base64 data URL도 유효한 URL로 간주합니다.
        if (str.startsWith('data:image/')) return true;
        new URL(str);
        return true;
      } catch {
        return false;
      }
    }
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
    } 
    
    /* ==================== 페이지네이션 함수 ==================== */
    function renderPagination(containerElement, totalItems, currentPage, type) {
      const totalPages = Math.ceil(totalItems / PAGE_SIZE);
      containerElement.innerHTML = '';

      if (totalPages <= 1) return;

      let html = `<nav class="flex items-center space-x-2">`;
      
      // Previous button
      html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm hover:bg-gray-300 transition" data-page="${currentPage - 1}" data-type="${type}" ${currentPage === 1 ? 'disabled' : ''}>이전</button>`;

      // Page buttons (Simplified: show up to 5 surrounding pages)
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200';
        html += `<button class="pagination-btn ${isActive} py-2 px-3 rounded-lg text-sm transition" data-page="${i}" data-type="${type}">${i}</button>`;
      }
      
      // Next button
      html += `<button class="pagination-btn bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm hover:bg-gray-300 transition" data-page="${currentPage + 1}" data-type="${type}" ${currentPage === totalPages ? 'disabled' : ''}>다음</button>`;
      
      html += `</nav>`;
      containerElement.innerHTML = html;
    }
    
    function changePage(page, type) {
        if (page < 1) return;
        if (type === 'rtu') {
            const totalPages = Math.ceil(rtuList.length / PAGE_SIZE);
            if (page > totalPages) return;
            rtuCurrentPage = page;
            renderRtuList(page);
        } else if (type === 'inspection') {
            const totalPages = Math.ceil(inspectionList.length / PAGE_SIZE);
            if (page > totalPages) return;
            inspectionCurrentPage = page;
            renderInspectionList(page);
        } else if (type === 'repair') {
            const totalPages = Math.ceil(repairList.length / PAGE_SIZE);
            if (page > totalPages) return;
            repairCurrentPage = page;
            renderRepairList(page);
        }
    }

    /* ==================== 렌더링 함수 (페이지네이션 적용) ==================== */
    function renderRtuList(page) {
      elements.rtuCount.textContent = rtuList.length;
      if (rtuList.length === 0) {
        elements.rtuListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>';
        elements.rtuPaginationContainer.innerHTML = '';
        return;
      }
      
      const sortedRtuList = rtuList.sort((a, b) => new Date(b.date) - new Date(a.date));
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedRtuList.slice(startIndex, startIndex + PAGE_SIZE);
      
      elements.rtuListContainer.innerHTML = paginatedList.map(rtu => {
        // **********************************************
        // [수정된 부분 1] 그림 파일이 없을 때도 상세 보기가 정상 작동하도록,
        // 이미지가 없을 경우 플레이스홀더 DIV를 사용해 구조를 유지하고, 깨진 이미지 아이콘을 방지합니다.
        const hasImage = rtu.imageUrl1 && isUrl(rtu.imageUrl1);
        const thumbHtml = hasImage ? 
            `<img src="${rtu.imageUrl1}" alt="${rtu.name}" class="thumb flex-shrink-0">` : 
            `<div class="thumb flex-shrink-0 bg-gray-200 flex items-center justify-center text-xs text-gray-500 text-center p-1">사진 없음</div>`;
        // **********************************************

        return `
          <div class="bg-gray-50 p-4 rounded-xl shadow border flex items-start space-x-4 hover:shadow-lg transition duration-150">
            ${thumbHtml}
            <div class="flex-grow">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">${rtu.name}</h3>
                <span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(rtu.status)}">${rtu.status}</span>
              </div>
              <p class="text-sm text-gray-600 mt-1">${rtu.region} | ${rtu.model || '모델 정보 없음'}</p>
              <p class="text-xs text-gray-500 mt-1">설치: ${formatDate(rtu.date)}</p>
              <div class="mt-3 space-x-2">
                <button class="text-xs font-semibold text-blue-600 hover:text-blue-800 detail-btn" data-id="${rtu.id}" data-type="rtu">상세 보기</button>
                <button class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 modify-rtu-btn" data-id="${rtu.id}">정보 수정 모드</button>
                <button class="text-xs font-semibold text-red-600 hover:text-red-800 delete-rtu-btn" data-id="${rtu.id}">삭제</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      renderPagination(elements.rtuPaginationContainer, rtuList.length, rtuCurrentPage, 'rtu');
    }
    
    function renderInspectionList(page) {
      elements.inspectionCount.textContent = inspectionList.length;
      if (inspectionList.length === 0) {
        elements.inspectionListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>';
        elements.inspectionPaginationContainer.innerHTML = '';
        return;
      }
      
      const sortedInspectionList = inspectionList.sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedInspectionList.slice(startIndex, startIndex + PAGE_SIZE);
      
      elements.inspectionListContainer.innerHTML = paginatedList.map(inspection => {
        const rtu = rtuList.find(r => r.id === inspection.rtuId);
        const rtuName = rtu ? rtu.name : `[알 수 없음] ${inspection.rtuId}`;
        return `
          <div class="bg-white p-4 rounded-xl shadow border hover:shadow-lg transition duration-150">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-800">${rtuName}</h3>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(inspection.result)}">${inspection.result}</span>
            </div>
            <p class="text-sm text-gray-600 mt-1">점검일: ${formatDate(inspection.inspectionDate)} | 점검자: ${inspection.inspector}</p>
            <p class="text-xs text-gray-500 mt-1 truncate">특이사항: ${inspection.notes || '없음'}</p>
            <div class="mt-3">
              <button class="text-xs font-semibold text-blue-600 hover:text-blue-800 detail-btn" data-id="${inspection.id}" data-type="inspection">상세 보기</button>
              <button class="text-xs font-semibold text-red-600 hover:text-red-800 delete-inspection-btn" data-id="${inspection.id}">삭제</button>
            </div>
          </div>
        `;
      }).join('');

      renderPagination(elements.inspectionPaginationContainer, inspectionList.length, inspectionCurrentPage, 'inspection');
    }

    function renderRepairList(page) {
      elements.repairCount.textContent = repairList.length;
      if (repairList.length === 0) {
        elements.repairListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>';
        elements.repairPaginationContainer.innerHTML = '';
        return;
      }
      
      const sortedRepairList = repairList.sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
      const startIndex = (page - 1) * PAGE_SIZE;
      const paginatedList = sortedRepairList.slice(startIndex, startIndex + PAGE_SIZE);

      elements.repairListContainer.innerHTML = paginatedList.map(repair => {
        const rtu = rtuList.find(r => r.id === repair.rtuId);
        const rtuName = rtu ? rtu.name : `[알 수 없음] ${repair.rtuId}`;
        
        // **********************************************
        // [수정된 부분 2] repair.issue에 값이 없을 때 렌더링 오류가 발생하지 않도록 안전하게 처리
        const issueText = repair.issue || '내용 없음';
        const issueSnippet = issueText.substring(0, 50) + (issueText.length > 50 ? '...' : '');
        // **********************************************

        return `
          <div class="bg-white p-4 rounded-xl shadow border hover:shadow-lg transition duration-150">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-800">${rtuName}</h3>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(repair.status)}">${repair.status}</span>
            </div>
            <p class="text-sm text-gray-600 mt-1">처리일: ${formatDate(repair.repairDate)} | 담당자: ${repair.engineer}</p>
            <p class="text-xs text-gray-500 mt-1 truncate">문제: ${issueSnippet}</p>
            <div class="mt-3">
              <button class="text-xs font-semibold text-blue-600 hover:text-blue-800 detail-btn" data-id="${repair.id}" data-type="repair">상세 보기</button>
              <button class="text-xs font-semibold text-red-600 hover:text-red-800 delete-repair-btn" data-id="${repair.id}">삭제</button>
            </div>
          </div>
        `;
      }).join('');

      renderPagination(elements.repairPaginationContainer, repairList.length, repairCurrentPage, 'repair');
    }

    function populateRtuSelects() {
      const options = rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');
      elements.inspectionRtuIdSelect.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>' + options;
      elements.repairRtuIdSelect.innerHTML = '<option value="">-- RTU를 선택하세요 --</option>' + options;
      elements.rtuModifySelect.innerHTML = '<option value="">-- 수정할 RTU를 선택하세요 --</option>' + options;
    }
    
    function showDetailModal(id, type) {
      currentModalData = { id, type };
      elements.modalTitle.textContent = `${type === 'rtu' ? 'RTU 장비' : type === 'inspection' ? '점검 기록' : '수리 기록'} 상세 정보`;
      elements.modalContent.innerHTML = '<div class="flex justify-center items-center"><div class="loading"></div></div>';
      let data;
      if (type === 'rtu') data = rtuList.find(item => item.id === id);
      else if (type === 'inspection') data = inspectionList.find(item => item.id === id);
      else if (type === 'repair') data = repairList.find(item => item.id === id);
      if (!data) {
        elements.modalContent.innerHTML = '<p class="text-red-500">요청한 정보를 찾을 수 없습니다.</p>';
        elements.detailModal.classList.remove('hidden');
        return;
      }
      let html = '';
      if (type === 'rtu') {
        // 이미지가 등록되지 않아도 상세화면이 열리도록 수정됨
        const imageHtml = [1, 2, 3].map(i => {
          const url = data[`imageUrl${i}`];
          return url && isUrl(url) ? `<img src="${url}" alt="Image ${i}" class="thumb-detail image-zoom" data-src="${url}">` : '';
        }).join('');
        
        html = `
          <p><span class="font-semibold">등록번호/ID:</span> ${data.name}</p>
          <p><span class="font-semibold">설치 장소/지역:</span> ${data.region}</p>
          <p><span class="font-semibold">현재 상태:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(data.status)}">${data.status}</span></p>
          <p><span class="font-semibold">설치(등록) 날짜:</span> ${formatDate(data.date)}</p>
          <p><span class="font-semibold">모델명:</span> ${data.model || '정보 없음'}</p>
          <p><span class="font-semibold">용량 (RT/kW):</span> ${data.capacity || '정보 없음'}</p>
          <p><span class="font-semibold">유닛 종류:</span> ${data.unitType || '정보 없음'}</p>
          <p><span class="font-semibold">냉매 종류:</span> ${data.refrigerant || '정보 없음'}</p>
          <p><span class="font-semibold">전기 종류:</span> ${data.electricPhase || '정보 없음'}</p>
          <p><span class="font-semibold">고압 상한:</span> ${data.pressureHighLimit ? `${data.pressureHighLimit} PSI` : '미설정'}</p>
          <p><span class="font-semibold">저압 하한:</span> ${data.pressureLowLimit ? `${data.pressureLowLimit} PSI` : '미설정'}</p>
          <div class="mt-4 pt-3 border-t"><span class="font-semibold block mb-2">특이사항/메모:</span> ${data.notes.replace(/\n/g, '<br>') || '없음'}</div>
          <div class="mt-4 pt-3 border-t"><span class="font-semibold block mb-2">장비 사진: (클릭시 확대)</span>
            <div id="image-detail-container" class="flex flex-wrap gap-4">
              ${imageHtml}
              ${imageHtml.trim() === '' ? '<p class="text-gray-500">등록된 사진 없음</p>' : ''}
            </div>
          </div>
        `;
      } else if (type === 'inspection') {
        const rtu = rtuList.find(r => r.id === data.rtuId) || {};
        html = `
          <p><span class="font-semibold">대상 RTU:</span> ${rtu.name || data.rtuId} (${rtu.region || '정보 없음'})</p>
          <p><span class="font-semibold">점검 날짜:</span> ${formatDate(data.inspectionDate)}</p>
          <p><span class="font-semibold">점검자:</span> ${data.inspector}</p>
          <p><span class="font-semibold">최종 결과:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(data.result)}">${data.result}</span></p>
          <div class="mt-4 pt-3 border-t">
            <h4 class="font-semibold mb-2 text-md text-indigo-700">부품 점검 상태</h4>
            <div class="grid grid-cols-2 gap-2">
              <p>필터: ${data.check1 || '미기재'}</p><p>콘텍터: ${data.check2 || '미기재'}</p>
              <p>콘덴싱 코일: ${data.check3 || '미기재'}</p><p>송풍 모터: ${data.check4 || '미기재'}</p>
              <p>증발기 코일: ${data.check5 || '미기재'}</p><p>고압 센서: ${data.check6 || '미기재'}</p>
              <p>저압 센서: ${data.check7 || '미기재'}</p><p>캐패시터: ${data.check8 || '미기재'}</p>
            </div>
          </div>
          <div class="mt-4 pt-3 border-t">
            <h4 class="font-semibold mb-2 text-md text-yellow-700">운전 상태 측정 (Comp 1)</h4>
            <div class="grid grid-cols-3 gap-2">
              <p>고압: ${data.comp1Hp ? `${data.comp1Hp} PSI` : '미기재'}</p>
              <p>저압: ${data.comp1Lp ? `${data.comp1Lp} PSI` : '미기재'}</p>
              <p>전류: ${data.comp1Amp ? `${data.comp1Amp} A` : '미기재'}</p>
            </div>
            <h4 class="font-semibold mt-3 mb-2 text-md text-yellow-700">운전 상태 측정 (Comp 2)</h4>
            <div class="grid grid-cols-3 gap-2">
              <p>고압: ${data.comp2Hp ? `${data.comp2Hp} PSI` : '미기재'}</p>
              <p>저압: ${data.comp2Lp ? `${data.comp2Lp} PSI` : '미기재'}</p>
              <p>전류: ${data.comp2Amp ? `${data.comp2Amp} A` : '미기재'}</p>
            </div>
            <h4 class="font-semibold mt-3 mb-2 text-md text-red-700">온도 측정</h4>
            <div class="grid grid-cols-2 gap-2">
              <p>과열도: ${data.superheat ? `${data.superheat} ℉` : '미기재'}</p>
              <p>과냉도: ${data.subcool ? `${data.subcool} ℉` : '미기재'}</p>
            </div>
          </div>
          <div class="mt-4 pt-3 border-t"><span class="font-semibold block mb-2">특이사항 및 조치 내용:</span> ${data.notes.replace(/\n/g, '<br>') || '없음'}</div>
        `;
      } else if (type === 'repair') {
        const rtu = rtuList.find(r => r.id === data.rtuId) || {};
        html = `
          <p><span class="font-semibold">대상 RTU:</span> ${rtu.name || data.rtuId} (${rtu.region || '정보 없음'})</p>
          <p><span class="font-semibold">수리/요청 날짜:</span> ${formatDate(data.repairDate)}</p>
          <p><span class="font-semibold">수리 담당자:</span> ${data.engineer}</p>
          <p><span class="font-semibold">처리 상태:</span> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(data.status)}">${data.status}</span></p>
          <div class="mt-4 pt-3 border-t"><span class="font-semibold block mb-2">문제 및 조치 내용:</span> ${data.issue.replace(/\n/g, '<br>')}</div>
        `;
      }
      elements.modalContent.innerHTML = html;
      elements.detailModal.classList.remove('hidden');
    } 

    function zoomImage(src) {
      elements.zoomedImage.src = src;
      elements.imageZoomModal.classList.remove('hidden');
    }
    
    /* ==================== 이벤트 핸들러 ==================== */
    function handleRtuSubmit(e) {
      e.preventDefault();
      const formData = new FormData(elements.rtuForm);
      const data = Object.fromEntries(formData.entries());
      const now = new Date().toISOString();
      
      let listToSave = [...rtuList];

      if (currentRtuMode === 'new') {
        const existingRtu = listToSave.find(rtu => rtu.name === data.name);
        if (existingRtu) {
          alert('오류: 동일한 RTU 등록번호/ID가 이미 존재합니다. 다른 ID를 사용해주세요.');
          return;
        }
        data.id = generateUniqueId();
        data.date = data.date || now.substring(0, 10);
        data.lastUpdated = now;
        data.imageUrl1 = imageBase64Data.imageUrl1;
        data.imageUrl2 = imageBase64Data.imageUrl2;
        data.imageUrl3 = imageBase64Data.imageUrl3;
        listToSave.push(data);
        alert(`새 RTU 장비 '${data.name}'이(가) 등록되었습니다.`);
      } else {
        const idToModify = elements.rtuIdForModification.value;
        const index = listToSave.findIndex(rtu => rtu.id === idToModify);
        if (index === -1) {
          alert('오류: 수정할 RTU를 찾을 수 없습니다.');
          return;
        }
        const updatedRtu = {
          ...listToSave[index],
          ...data,
          lastUpdated: now,
          // 이미지가 새로 업로드되지 않았다면 기존 URL 유지. 새로 업로드되면 imageBase64Data에 값이 있음.
          imageUrl1: imageBase64Data.imageUrl1 || listToSave[index].imageUrl1, 
          imageUrl2: imageBase64Data.imageUrl2 || listToSave[index].imageUrl2,
          imageUrl3: imageBase64Data.imageUrl3 || listToSave[index].imageUrl3,
        };
        listToSave[index] = updatedRtu;
        alert(`RTU 장비 '${data.name}' 정보가 수정되었습니다.`);
      }

      saveList(STORAGE_KEYS.RTU, listToSave).then(() => {
        elements.rtuForm.reset();
        resetRtuForm();
      });
    }
    function handleInspectionSubmit(e) {
      e.preventDefault();
      const formData = new FormData(elements.inspectionForm);
      const data = Object.fromEntries(formData.entries());
      data.id = generateUniqueId();
      
      const listToSave = [...inspectionList, data]; // 새로운 기록을 추가
      
      saveList(STORAGE_KEYS.INSPECTION, listToSave).then(() => {
        elements.inspectionForm.reset();
        alert('새 점검 기록이 등록되었습니다.');
      });
    }
    function handleRepairSubmit(e) {
      e.preventDefault();
      const formData = new FormData(elements.repairForm);
      const data = Object.fromEntries(formData.entries());
      data.id = generateUniqueId();
      
      const listToSave = [...repairList, data]; // 새로운 기록을 추가
      
      // 수리 기록 미표시 오류 수정: saveList 호출 후 Firebase onValue 리스너가 리스트를 업데이트하고 렌더링하도록 함
      saveList(STORAGE_KEYS.REPAIR, listToSave).then(() => {
        elements.repairForm.reset();
        alert('새 수리 기록이 등록되었습니다.');
      });
    }
    function handleDelete(id, type) {
      if (!confirm(`정말로 이 ${type === 'rtu' ? 'RTU 장비와 관련된 모든 기록' : type === 'inspection' ? '점검 기록' : '수리 기록'}을 삭제하시겠습니까?`)) {
        return;
      }
      if (type === 'rtu') {
        rtuList = rtuList.filter(item => item.id !== id);
        inspectionList = inspectionList.filter(item => item.rtuId !== id);
        repairList = repairList.filter(item => item.rtuId !== id);
        saveList(STORAGE_KEYS.RTU, rtuList).then(() => {
          saveList(STORAGE_KEYS.INSPECTION, inspectionList).then(() => {
            saveList(STORAGE_KEYS.REPAIR, repairList).then(() => {
              alert('RTU 장비 및 관련 기록이 삭제되었습니다.');
              if (currentRtuMode === 'modify' && elements.rtuIdForModification.value === id) {
                setRtuMode('new');
              }
            });
          });
        });
      } else if (type === 'inspection') {
        inspectionList = inspectionList.filter(item => item.id !== id);
        saveList(STORAGE_KEYS.INSPECTION, inspectionList).then(() => alert('점검 기록이 삭제되었습니다.'));
      } else if (type === 'repair') {
        repairList = repairList.filter(item => item.id !== id);
        saveList(STORAGE_KEYS.REPAIR, repairList).then(() => alert('수리 기록이 삭제되었습니다.'));
      }
    }
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const fileIndex = e.target.id.slice(-1); // e.g., 'rtu-image1' -> '1'
          imageBase64Data[`imageUrl${fileIndex}`] = event.target.result;
          const previewElement = elements[`imagePreview${fileIndex}`];
          previewElement.src = event.target.result;
          previewElement.style.display = 'block';
          elements.imagePreviewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }
    function setRtuMode(mode, rtuId = null) {
      currentRtuMode = mode;
      if (mode === 'new') {
        elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
        elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
        elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
        elements.rtuFormTitle.textContent = 'RTU 장비 신규 등록';
        document.getElementById('rtu-name').classList.remove('hidden');
        elements.rtuModifySelect.classList.add('hidden');
        elements.rtuSubmitBtn.textContent = 'RTU 정보 저장';
        elements.rtuIdForModification.value = '';
        elements.rtuForm.reset();
        resetRtuForm();
      } else if (mode === 'modify') {
        elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
        elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
        elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
        elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
        elements.rtuFormTitle.textContent = 'RTU 장비 정보 수정';
        document.getElementById('rtu-name').classList.add('hidden');
        elements.rtuModifySelect.classList.remove('hidden');
        elements.rtuSubmitBtn.textContent = 'RTU 정보 수정 저장';
        if (rtuId) {
          loadRtuForModification(rtuId);
        } else {
          elements.rtuForm.reset();
          resetRtuForm();
        }
      }
    }
    function loadRtuForModification(rtuId) {
      const rtu = rtuList.find(r => r.id === rtuId);
      if (!rtu) {
        alert('선택한 RTU 정보를 찾을 수 없습니다.');
        return;
      }
      elements.rtuIdForModification.value = rtu.id;
      // Populate form fields
      document.getElementById('rtu-name').value = rtu.name; 
      document.getElementById('rtu-region').value = rtu.region || '';
      document.getElementById('rtu-model').value = rtu.model || '';
      document.getElementById('rtu-capacity').value = rtu.capacity || '';
      document.getElementById('rtu-unit-type').value = rtu.unitType || '패키지';
      document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
      document.getElementById('rtu-electric-phase').value = rtu.electricPhase || '단상';
      document.getElementById('rtu-date').value = rtu.date || '';
      document.getElementById('rtu-status').value = rtu.status || '작동중';
      document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
      document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
      document.getElementById('rtu-notes').value = rtu.notes || '';
      // Reset image base64 data for new uploads, but display old images
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
      elements.imagePreviewContainer.classList.add('hidden');
      [1, 2, 3].forEach(i => {
        const url = rtu[`imageUrl${i}`];
        const preview = elements[`imagePreview${i}`];
        if (url && isUrl(url)) {
          preview.src = url;
          preview.style.display = 'block';
          elements.imagePreviewContainer.classList.remove('hidden');
        } else {
          preview.src = '';
          preview.style.display = 'none';
        }
        // Clear file inputs
        document.getElementById(`rtu-image${i}`).value = '';
      });
      // Set the select element to the current RTU
      elements.rtuModifySelect.value = rtuId;
    }
    function resetRtuForm() {
      // Clear base64 image data and previews
      imageBase64Data = { imageUrl1: '', imageUrl2: '', imageUrl3: '' };
      [1, 2, 3].forEach(i => {
        const preview = elements[`imagePreview${i}`];
        preview.src = '';
        preview.style.display = 'none';
        // Clear file inputs
        document.getElementById(`rtu-image${i}`).value = '';
      });
      elements.imagePreviewContainer.classList.add('hidden');
    } 
    /* ==================== CSV 처리 함수 ==================== */
    function convertToCsv(data, type) {
      if (data.length === 0) return '';
      let headers;
      let csvRows;
      if (type === 'rtu') {
        headers = ['ID', '등록번호', '설치지역', '모델명', '용량', '유닛종류', '냉매종류', '전기종류', '설치날짜', '현재상태', '고압상한(PSI)', '저압하한(PSI)', '메모', '사진URL1', '사진URL2', '사진URL3', '최종수정일'];
        csvRows = data.map(rtu => [
          rtu.id, rtu.name, rtu.region, rtu.model, rtu.capacity, rtu.unitType, rtu.refrigerant, rtu.electricPhase,
          rtu.date, rtu.status, rtu.pressureHighLimit, rtu.pressureLowLimit, `"${(rtu.notes || '').replace(/"/g, '""').replace(/\n/g, '\\n')}"`,
          rtu.imageUrl1, rtu.imageUrl2, rtu.imageUrl3, rtu.lastUpdated
        ].join(','));
      } else if (type === 'inspection') {
        headers = ['ID', 'RTU_ID', '점검일자', '점검자', '결과', '필터', '콘텍터', '콘덴싱코일', '송풍모터', '증발기코일', '고압센서', '저압센서', '캐패시터', 'Comp1_고압(PSI)', 'Comp1_저압(PSI)', 'Comp1_전류(A)', 'Comp2_고압(PSI)', 'Comp2_저압(PSI)', 'Comp2_전류(A)', '과열도(F)', '과냉도(F)', '노트'];
        csvRows = data.map(i => [
          i.id, i.rtuId, i.inspectionDate, i.inspector, i.result, i.check1, i.check2, i.check3, i.check4, i.check5, i.check6, i.check7, i.check8,
          i.comp1Hp, i.comp1Lp, i.comp1Amp, i.comp2Hp, i.comp2Lp, i.comp2Amp, i.superheat, i.subcool, `"${(i.notes || '').replace(/"/g, '""').replace(/\n/g, '\\n')}"`
        ].join(','));
      } else if (type === 'repair') {
        headers = ['ID', 'RTU_ID', '수리일자', '담당자', '상태', '문제및조치내용'];
        csvRows = data.map(r => [
          r.id, r.rtuId, r.repairDate, r.engineer, r.status, `"${(r.issue || '').replace(/"/g, '""').replace(/\n/g, '\\n')}"`
        ].join(','));
      } else {
        return '';
      }
      return [headers.join(','), ...csvRows].join('\n');
    }
    function downloadCsv(data, filename) {
      const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    document.getElementById('download-data-btn').addEventListener('click', () => {
      const rtuCsv = convertToCsv(rtuList, 'rtu');
      const inspectionCsv = convertToCsv(inspectionList, 'inspection');
      const repairCsv = convertToCsv(repairList, 'repair');
      if (rtuCsv) downloadCsv(rtuCsv, 'rtu_data.csv');
      if (inspectionCsv) downloadCsv(inspectionCsv, 'inspection_data.csv');
      if (repairCsv) downloadCsv(repairCsv, 'repair_data.csv');
      if (!rtuCsv && !inspectionCsv && !repairCsv) {
        alert('다운로드할 데이터가 없습니다.');
      } else {
        alert('데이터 다운로드가 완료되었습니다. 3개의 파일(rtu_data, inspection_data, repair_data)을 확인해주세요.');
      }
    });
    function parseCsv(csvText, type) {
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',');
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        let currentLine = lines[i];
        let row = [];
        let inQuote = false;
        let start = 0;
        for (let j = 0; j < currentLine.length; j++) {
          if (currentLine[j] === '"') {
            inQuote = !inQuote;
          } else if (currentLine[j] === ',' && !inQuote) {
            let value = currentLine.substring(start, j).trim();
            if (value.startsWith('"') && value.endsWith('"')) {
              value = value.substring(1, value.length - 1).replace(/""/g, '"').replace(/\\n/g, '\n');
            }
            row.push(value);
            start = j + 1;
          }
        }
        let finalValue = currentLine.substring(start).trim();
        if (finalValue.startsWith('"') && finalValue.endsWith('"')) {
          finalValue = finalValue.substring(1, finalValue.length - 1).replace(/""/g, '"').replace(/\\n/g, '\n');
        }
        row.push(finalValue);
        if (row.length !== headers.length) {
          console.warn(`Skipping row ${i} due to column count mismatch. Expected ${headers.length}, got ${row.length}.`);
          continue;
        }
        let item = {};
        for (let k = 0; k < headers.length; k++) {
          let key = '';
          let value = row[k];
          if (type === 'rtu') {
            switch (headers[k]) {
              case 'ID': key = 'id'; break; case '등록번호': key = 'name'; break; case '설치지역': key = 'region'; break;
              case '모델명': key = 'model'; break; case '용량': key = 'capacity'; break; case '유닛종류': key = 'unitType'; break;
              case '냉매종류': key = 'refrigerant'; break; case '전기종류': key = 'electricPhase'; break; case '설치날짜': key = 'date'; break;
              case '현재상태': key = 'status'; break; case '고압상한(PSI)': key = 'pressureHighLimit'; break; case '저압하한(PSI)': key = 'pressureLowLimit'; break;
              case '메모': key = 'notes'; break; case '사진URL1': key = 'imageUrl1'; break; case '사진URL2': key = 'imageUrl2'; break;
              case '사진URL3': key = 'imageUrl3'; break; case '최종수정일': key = 'lastUpdated'; break;
            }
          } else if (type === 'inspection') {
            switch (headers[k]) {
              case 'ID': key = 'id'; break; case 'RTU_ID': key = 'rtuId'; break; case '점검일자': key = 'inspectionDate'; break;
              case '점검자': key = 'inspector'; break; case '결과': key = 'result'; break; case '필터': key = 'check1'; break;
              case '콘텍터': key = 'check2'; break; case '콘덴싱코일': key = 'check3'; break; case '송풍모터': key = 'check4'; break;
              case '증발기코일': key = 'check5'; break; case '고압센서': key = 'check6'; break; case '저압센서': key = 'check7'; break;
              case '캐패시터': key = 'check8'; break; case 'Comp1_고압(PSI)': key = 'comp1Hp'; break; case 'Comp1_저압(PSI)': key = 'comp1Lp'; break;
              case 'Comp1_전류(A)': key = 'comp1Amp'; break; case 'Comp2_고압(PSI)': key = 'comp2Hp'; break; case 'Comp2_저압(PSI)': key = 'comp2Lp'; break;
              case 'Comp2_전류(A)': key = 'comp2Amp'; break; case '과열도(F)': key = 'superheat'; break; case '과냉도(F)': key = 'subcool'; break;
              case '노트': key = 'notes'; break;
            }
            if (value && ['comp1Hp', 'comp1Lp', 'comp1Amp', 'comp2Hp', 'comp2Lp', 'comp2Amp', 'superheat', 'subcool'].includes(key)) {
                value = parseFloat(value);
            }
          } else if (type === 'repair') {
            switch (headers[k]) {
              case 'ID': key = 'id'; break; case 'RTU_ID': key = 'rtuId'; break; case '수리일자': key = 'repairDate'; break;
              case '담당자': key = 'engineer'; break; case '상태': key = 'status'; break; case '문제및조치내용': key = 'issue'; break;
            }
          }
          if (key) item[key] = value;
        }
        if (item.id) data.push(item);
      }
      return data;
    }
    document.getElementById('csv-upload').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      let rtuData = [];
      let inspectionData = [];
      let repairData = [];
      for (const file of files) {
        if (file.name.includes('rtu_data')) {
          const text = await file.text();
          rtuData = parseCsv(text, 'rtu');
        } else if (file.name.includes('inspection_data')) {
          const text = await file.text();
          inspectionData = parseCsv(text, 'inspection');
        } else if (file.name.includes('repair_data')) {
          const text = await file.text();
          repairData = parseCsv(text, 'repair');
        }
      }
      if (rtuData.length > 0) {
        await saveList(STORAGE_KEYS.RTU, rtuData);
        console.log(`RTU 데이터 ${rtuData.length}건 업로드 및 저장 완료.`);
      }
      if (inspectionData.length > 0) {
        await saveList(STORAGE_KEYS.INSPECTION, inspectionData);
        console.log(`점검 데이터 ${inspectionData.length}건 업로드 및 저장 완료.`);
      }
      if (repairData.length > 0) {
        await saveList(STORAGE_KEYS.REPAIR, repairData);
        console.log(`수리 데이터 ${repairData.length}건 업로드 및 저장 완료.`);
      }
      if (rtuData.length + inspectionData.length + repairData.length > 0) {
        alert('선택한 CSV 데이터가 Firebase에 성공적으로 업로드 및 동기화되었습니다. (기존 데이터 덮어쓰기)');
      } else {
        alert('유효한 RTU/점검/수리 CSV 파일이 선택되지 않았습니다. 파일명에 "rtu_data", "inspection_data", "repair_data" 중 하나가 포함되어야 합니다.');
      }
    }); 
    /* ==================== 초기화 및 이벤트 등록 ==================== */
    document.addEventListener('DOMContentLoaded', () => {
      // Load data from Firebase on startup
      loadFromFirebase();
      // Tab switching logic
      elements.tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          elements.tabBtns.forEach(b => {
            b.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
            b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          });
          btn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
          btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          elements.tabPages.forEach(page => {
            page.classList.add('hidden');
          });
          document.getElementById(tab).classList.remove('hidden');
          // Update data on tab switch for immediate changes (e.g. dashboard)
          if (tab === 'dashboard' || tab === 'report-page') {
            updateDashboard();
          }
        });
      });
      // Form submission
      elements.rtuForm.addEventListener('submit', handleRtuSubmit);
      elements.inspectionForm.addEventListener('submit', handleInspectionSubmit);
      elements.repairForm.addEventListener('submit', handleRepairSubmit);
      // Delete/Detail events (Delegation)
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-rtu-btn')) {
          handleDelete(e.target.dataset.id, 'rtu');
        } else if (e.target.classList.contains('delete-inspection-btn')) {
          handleDelete(e.target.dataset.id, 'inspection');
        } else if (e.target.classList.contains('delete-repair-btn')) {
          handleDelete(e.target.dataset.id, 'repair');
        } else if (e.target.classList.contains('detail-btn')) {
          showDetailModal(e.target.dataset.id, e.target.dataset.type);
        } else if (e.target.classList.contains('modify-rtu-btn')) {
          setRtuMode('modify', e.target.dataset.id);
          document.getElementById('rtu-manage').classList.remove('hidden');
          document.querySelector('[data-tab="rtu-manage"]').click();
        } else if (e.target.classList.contains('pagination-btn')) {
            const page = parseInt(e.target.dataset.page);
            const type = e.target.dataset.type;
            changePage(page, type);
        } else if (e.target.classList.contains('image-zoom')) {
            const src = e.target.dataset.src;
            zoomImage(src);
        }
      });
      // Modal close
      elements.closeModalBtn.addEventListener('click', () => {
        elements.detailModal.classList.add('hidden');
      });
      elements.detailModal.addEventListener('click', (e) => {
        if (e.target === elements.detailModal) {
          elements.detailModal.classList.add('hidden');
        }
      });
      // Image upload
      document.getElementById('rtu-image1').addEventListener('change', handleImageUpload);
      document.getElementById('rtu-image2').addEventListener('change', handleImageUpload);
      document.getElementById('rtu-image3').addEventListener('change', handleImageUpload);
      // RTU Mode Switch
      elements.modeNewBtn.addEventListener('click', () => setRtuMode('new'));
      elements.modeModifyBtn.addEventListener('click', () => setRtuMode('modify'));
      // RTU Modification Select Change
      elements.rtuModifySelect.addEventListener('change', (e) => {
        const selectedId = e.target.value;
        if (selectedId) {
          loadRtuForModification(selectedId);
        } else {
          elements.rtuForm.reset();
          resetRtuForm();
          elements.rtuIdForModification.value = '';
        }
      });
    });
    // 대시보드 업데이트 함수 (페이지네이션과는 별개)
    function updateDashboard() {
      elements.dashboardTotal.textContent = rtuList.length;
      const runningCount = rtuList.filter(rtu => rtu.status === '작동중').length;
      const stoppedCount = rtuList.filter(rtu => rtu.status === '정지됨').length;
      const needsInspectionCount = rtuList.filter(rtu => rtu.status === '점검필요').length;
      elements.dashboardRunning.textContent = runningCount;
      elements.dashboardStopped.textContent = stoppedCount;
      elements.dashboardNeedsInspection.textContent = needsInspectionCount;
      // Monthly Inspection Count
      const startOfMonth = new Date();
      startOfMonth.setDate(1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;
      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;
      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }
      // Report Page Update
      elements.reportTotalRtu.textContent = rtuList.length;
      elements.reportTotalInspection.textContent = inspectionList.length;
      elements.reportTotalRepair.textContent = repairList.length;
    }
  </script>
</body>
</html>