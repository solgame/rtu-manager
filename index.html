<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (Firebase í´ë¼ìš°ë“œ ë™ê¸°í™”)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb í´ë˜ìŠ¤ê°€ ì´ë¯¸ì§€ë¿ë§Œ ì•„ë‹ˆë¼ í”Œë ˆì´ìŠ¤í™€ë”ì—ë„ ì ìš©ë˜ë„ë¡ ìœ ì§€í•©ë‹ˆë‹¤. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== ë³´ê³ ì„œ ì¸ì‡„ë¥¼ ìœ„í•œ CSS ì¶”ê°€ (print-onlyëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ) ========== */
    .print-only { display: none; } /* ê¸°ì¡´ ì½”ë“œì—ì„œ ë‚¨ì•„ìˆëŠ” print-onlyëŠ” display:none; ìƒíƒœ ìœ ì§€ */
    @media print {
      /* ì•±ì˜ ê¸°ë³¸ ë°°ê²½ê³¼ í…Œë‘ë¦¬ë¥¼ ìˆ¨ê²¨ ì¸ì‡„ ì˜ì—­ì„ ê¹”ë”í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. */
      .print-container, #main-app-container { /* ì¸ì‡„ ë¬¸ì œ í•´ê²°: ë©”ì¸ ì»¨í…Œì´ë„ˆ ê°•ì œ í‘œì‹œ */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* ì¸ì‡„ ì‹œ ìˆ¨ê²¨ì•¼ í•  ìš”ì†Œ (ë²„íŠ¼, ë©”ë‰´ ë“±) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* ì¸ì‡„ ì‹œ ìƒì„¸ ë³´ê³ ì„œ ë‚´ìš©ë§Œ í‘œì‹œë¥¼ ìœ„í•´ report-pageì™€ detail-viewë¥¼ ê°•ì œ í‘œì‹œ */
      #report-page, #report-detail-view { /* ì¸ì‡„ ë¬¸ì œ í•´ê²°: ë³´ê³ ì„œ ê´€ë ¨ ìš”ì†Œ ê°•ì œ í‘œì‹œ ë° ì •ë¦¬ */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* ìƒíƒœ íƒœê·¸ì˜ ë°°ê²½ìƒ‰ì€ ì¸ì‡„ ì‹œ ì œê±° */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* ì¸ì‡„ ì‹œ ì˜ ë³´ì´ë„ë¡ í…Œë‘ë¦¬ ì¶”ê°€ */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ë°ì´í„° CSV ì—…ë¡œë“œ
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ë°ì´í„° CSV ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU ë“±ë¡/ê´€ë¦¬</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">ì ê²€ ê¸°ë¡</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">ìˆ˜ë¦¬ ê¸°ë¡</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">ë³´ê³ ì„œ</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">ì´ ë“±ë¡ ì¥ë¹„ ìˆ˜</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">ì‘ë™ì¤‘</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">ì •ì§€ë¨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">ì ê²€ í•„ìš”</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ìµœê·¼ ì²˜ë¦¬ í˜„í™©</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">ì´ë²ˆ ë‹¬ ì ê²€ ê±´ìˆ˜</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">ë¯¸ì²˜ë¦¬ ìˆ˜ë¦¬ ìš”ì²­</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ê°œë³„ ì¥ë¹„ ìƒíƒœ (ìµœê·¼ ë“±ë¡/ìˆ˜ì •)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">ì‹ ê·œ ë“±ë¡</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">ì •ë³´ ìˆ˜ì •</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU ì¥ë¹„ ì‹ ê·œ ë“±ë¡</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU ë“±ë¡ë²ˆí˜¸/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­ *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">ëª¨ë¸ëª…</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">ìœ ë‹› ì¢…ë¥˜</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="íŒ¨í‚¤ì§€">íŒ¨í‚¤ì§€</option>
                    <option value="ì¹ ëŸ¬">ì¹ ëŸ¬</option>
                    <option value="ëƒ‰ê°íƒ‘">ëƒ‰ê°íƒ‘</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">ëƒ‰ë§¤ ì¢…ë¥˜</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">ì „ê¸° ì¢…ë¥˜</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ë‹¨ìƒ">ë‹¨ìƒ (Single Phase)</option>
                    <option value="ì‚¼ìƒ">ì‚¼ìƒ (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">í˜„ì¬ ìƒíƒœ *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ì‘ë™ì¤‘">ì‘ë™ì¤‘</option>
                    <option value="ì •ì§€ë¨">ì •ì§€ë¨</option>
                    <option value="ì ê²€í•„ìš”">ì ê²€í•„ìš”</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">ê³ ì•• ìƒí•œ ì„¤ì • (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">ì €ì•• í•˜í•œ ì„¤ì • (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">ì¥ë¹„ ì‚¬ì§„ (ìµœëŒ€ 3ì¥)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 1 ì—…ë¡œë“œ</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 2 ì—…ë¡œë“œ</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 3 ì—…ë¡œë“œ</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU ì •ë³´ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU ë“±ë¡ ëª©ë¡ (<span id="rtu-count">0</span>ê±´)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ RTU ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ì ê²€ ê¸°ë¡ ë“±ë¡</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">ì ê²€ ë‚ ì§œ *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">ì ê²€ì ì´ë¦„ *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">ë¶€í’ˆ ì ê²€ ìƒíƒœ</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. í•„í„°</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="êµì²´í•„ìš”">êµì²´í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. ì½˜í…í„°</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì†Œì†/êµì²´í•„ìš”">ì†Œì†/êµì²´í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. ì½˜ë´ì‹± ì½”ì¼</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                        <option value="ì˜¤ì—¼/ì²­ì†Œí•„ìš”">ì˜¤ì—¼/ì²­ì†Œí•„ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. ì†¡í’ ëª¨í„°</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì†ŒìŒ/ìˆ˜ë¦¬í•„ìš”">ì†ŒìŒ/ìˆ˜ë¦¬í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. ì¦ë°œê¸° ì½”ì¼</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                        <option value="ì˜¤ì—¼/ì²­ì†Œí•„ìš”">ì˜¤ì—¼/ì²­ì†Œí•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. ê³ ì•• ì„¼ì„œ</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì˜¤ë¥˜">ì˜¤ë¥˜</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. ì €ì•• ì„¼ì„œ</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì˜¤ë¥˜">ì˜¤ë¥˜</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. ìºíŒ¨ì‹œí„°</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ë¶ˆëŸ‰">ë¶ˆëŸ‰</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">ìš´ì „ ìƒíƒœ ì¸¡ì • (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">ê³ ì•• (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">ì €ì•• (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">ì „ë¥˜ (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">ìš´ì „ ìƒíƒœ ì¸¡ì • (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">ê³ ì•• (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">ì €ì•• (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">ì „ë¥˜ (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">ì˜¨ë„ ì¸¡ì •</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">ê³¼ì—´ë„ (â„‰)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">ê³¼ëƒ‰ë„ (â„‰)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">ìµœì¢… ì ê²€ ê²°ê³¼ *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ì •ìƒ">ì •ìƒ</option>
                    <option value="ì£¼ì˜">ì£¼ì˜</option>
                    <option value="ì ê²€í•„ìš”">ì ê²€í•„ìš”</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">ì ê²€ ê¸°ë¡ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">ì ê²€ ê¸°ë¡ ëª©ë¡ (<span id="inspection-count">0</span>ê±´)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ ì ê²€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ìˆ˜ë¦¬ ê¸°ë¡ ë“±ë¡</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ë‹´ë‹¹ì *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">ì²˜ë¦¬ ìƒíƒœ *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ìš”ì²­">ìš”ì²­ (ë¯¸ì²˜ë¦¬)</option>
                    <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                    <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš© *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">ìˆ˜ë¦¬ ê¸°ë¡ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">ìˆ˜ë¦¬ ê¸°ë¡ ëª©ë¡ (<span id="repair-count">0</span>ê±´)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ ìˆ˜ë¦¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">ì‹œìŠ¤í…œ ìš´ì˜ ë³´ê³ ì„œ</h2>
          <p class="text-gray-600 mb-6 print-hidden">ì•„ë˜ ìš”ì•½ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ ìƒì„¸ ëª©ë¡ì„ í™•ì¸í•˜ê³  ì¸ì‡„í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ–¨ï¸</p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="report-rtu-summary" class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 cursor-pointer hover:bg-indigo-100 transition duration-150">
              <p class="text-sm font-medium text-indigo-600">ì´ ë“±ë¡ RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div id="report-inspection-summary" class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200 cursor-pointer hover:bg-pink-100 transition duration-150">
              <p class="text-sm font-medium text-pink-600">ì´ ì ê²€ ê¸°ë¡ ê±´ìˆ˜</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div id="report-repair-summary" class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200 cursor-pointer hover:bg-teal-100 transition duration-150">
              <p class="text-sm font-medium text-teal-600">ì´ ìˆ˜ë¦¬ ê¸°ë¡ ê±´ìˆ˜</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>

          <div id="report-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-lg border hidden">
            <p class="text-gray-500">ë³´ê³ ì„œë¥¼ ë³´ë ¤ë©´ ìœ„ì˜ ìš”ì•½ í•­ëª©ì„ í´ë¦­í•˜ì„¸ìš”.</p>
          </div>

          <p class="text-gray-600 border-t pt-4 mt-8 print-hidden">ë³´ë‹¤ ìƒì„¸í•œ ë°ì´í„° ë¶„ì„ ë° ë³´ê³ ëŠ” ìƒë‹¨ì˜ **ë°ì´í„° CSV ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ** ë²„íŠ¼ì„ í†µí•´ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ì§„í–‰í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal-bg hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ìƒì„¸ ì •ë³´</h3>
      <div id="modal-content" class="text-gray-700 space-y-2 text-sm">
        <p>ë¡œë”© ì¤‘...</p>
      </div>
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="image-zoom-modal" class="modal-bg hidden fixed inset-0 z-[60] flex items-center justify-center p-4" onclick="document.getElementById('image-zoom-modal').classList.add('hidden')">
    <div class="max-w-4xl max-h-[90vh] w-full p-4">
      <img id="zoomed-image" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-full max-h-[80vh] w-auto h-auto mx-auto shadow-2xl rounded-lg">
      <button class="absolute top-4 right-4 text-white hover:text-gray-200 transition" onclick="document.getElementById('image-zoom-modal').classList.add('hidden'); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // Firebase configuration and initialization (Note: Replace with your actual config)
    const firebaseConfig = { 
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57...",
      authDomain: "rtu-management-system.firebaseapp.com",
      databaseURL: "https://rtu-management-system-default-rtdb.firebaseio.com",
      projectId: "rtu-management-system",
      storageBucket: "rtu-management-system.appspot.com",
      messagingSenderId: "1056580649987",
      appId: "1:1056580649987:web:f1c5049b4938d227d8e85f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
    const itemsPerPage = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    // DOM ìš”ì†Œ ìºì‹±
    const elements = {
      // Tabs and Pages
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabPages: document.querySelectorAll('.tab-page'),
      rtuManagePage: document.getElementById('rtu-manage'),
      inspectionManagePage: document.getElementById('inspection-manage'),
      repairManagePage: document.getElementById('repair-manage'),
      reportPage: document.getElementById('report-page'),
      
      // RTU Form
      rtuForm: document.getElementById('rtu-form'),
      rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
      modeNewBtn: document.getElementById('mode-new-btn'),
      modeModifyBtn: document.getElementById('mode-modify-btn'),
      rtuFormTitle: document.getElementById('rtu-form-title'),
      rtuIdContainer: document.getElementById('rtu-id-container'),
      rtuNameInput: document.getElementById('rtu-name'),
      rtuModifySelect: document.getElementById('rtu-modify-select'),
      rtuIdForModification: document.getElementById('rtu-id-for-modification'),
      imagePreviewContainer: document.getElementById('image-preview-container'),
      imagePreview1: document.getElementById('image-preview-1'),
      imagePreview2: document.getElementById('image-preview-2'),
      imagePreview3: document.getElementById('image-preview-3'),

      // RTU List
      rtuList: document.getElementById('rtu-list'),
      rtuCount: document.getElementById('rtu-count'),
      rtuPagination: document.getElementById('rtu-pagination'),
      
      // Inspection Form
      inspectionForm: document.getElementById('inspection-form'),
      inspectionRtuIdSelect: document.getElementById('inspection-rtu-id'),
      
      // Inspection List
      inspectionList: document.getElementById('inspection-list'),
      inspectionCount: document.getElementById('inspection-count'),
      inspectionPagination: document.getElementById('inspection-pagination'),

      // Repair Form
      repairForm: document.getElementById('repair-form'),
      repairRtuIdSelect: document.getElementById('repair-rtu-id'),

      // Repair List
      repairList: document.getElementById('repair-list'),
      repairCount: document.getElementById('repair-count'),
      repairPagination: document.getElementById('repair-pagination'),

      // Dashboard
      dashboardTotal: document.getElementById('dashboard-total'),
      dashboardRunning: document.getElementById('dashboard-running'),
      dashboardStopped: document.getElementById('dashboard-stopped'),
      dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
      dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
      dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
      dashboardLatestList: document.getElementById('dashboard-latest-list'),
      
      // Reports
      reportRtuSummary: document.getElementById('report-rtu-summary'),
      reportInspectionSummary: document.getElementById('report-inspection-summary'),
      reportRepairSummary: document.getElementById('report-repair-summary'),
      reportTotalRtu: document.getElementById('report-total-rtu'),
      reportTotalInspection: document.getElementById('report-total-inspection'),
      reportTotalRepair: document.getElementById('report-total-repair'),
      reportDetailView: document.getElementById('report-detail-view'),
      
      // Modals
      detailModal: document.getElementById('detail-modal'),
      modalTitle: document.getElementById('modal-title'),
      modalContent: document.getElementById('modal-content'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      imageZoomModal: document.getElementById('image-zoom-modal'),
      zoomedImage: document.getElementById('zoomed-image'),

      // Utility
      csvUpload: document.getElementById('csv-upload'),
      downloadDataBtn: document.getElementById('download-data-btn'),
    };

    /* ==================== í—¬í¼ í•¨ìˆ˜ ==================== */

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      elements.tabPages.forEach(page => page.classList.add('hidden'));
      elements.tabBtns.forEach(btn => btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600'));
      elements.tabBtns.forEach(btn => btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300'));

      const activePage = document.getElementById(tabName);
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);

      if (activePage) activePage.classList.remove('hidden');
      if (activeBtn) {
        activeBtn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
        activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      }
      
      // ë³´ê³ ì„œ í˜ì´ì§€ì—ì„œ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ìƒì„¸ ë³´ê³ ì„œ ìˆ¨ê¹€
      if (tabName !== 'report-page') {
          elements.reportDetailView.classList.add('hidden');
      }

      // íƒ­ ì „í™˜ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ìƒíƒœ ìƒ‰ìƒ í—¬í¼
    function getStatusColor(status) {
      switch (status) {
        case 'ì‘ë™ì¤‘': return 'bg-green-100 text-green-800 border border-green-200';
        case 'ì •ì§€ë¨': return 'bg-gray-100 text-gray-800 border border-gray-200';
        case 'ì ê²€í•„ìš”': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    function getResultColor(result) {
      switch (result) {
        case 'ì •ìƒ': return 'bg-green-100 text-green-800 border border-green-200';
        case 'ì£¼ì˜': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case 'ì ê²€í•„ìš”': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    function getRepairStatusColor(status) {
      switch (status) {
        case 'ì™„ë£Œ': return 'bg-teal-100 text-teal-800 border border-teal-200';
        case 'ì§„í–‰ì¤‘': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case 'ìš”ì²­': return 'bg-red-100 text-red-800 border border-red-200';
        default: return 'bg-slate-200 text-slate-800 border border-slate-300';
      }
    }

    // íŒŒì¼ ë¡œë”© (Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ)
    function loadFromFirebase() {
      return new Promise((resolve) => {
        const rtuRef = ref(db, 'rtu');
        const inspectionRef = ref(db, 'inspection');
        const repairRef = ref(db, 'repair');

        // RTU ë°ì´í„° ë¡œë“œ
        onValue(rtuRef, (snapshot) => {
          rtuList = [];
          snapshot.forEach((childSnapshot) => {
            rtuList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          // RTU ì—…ë°ì´íŠ¸ ì‹œ ê´€ë ¨ ëª©ë¡ ë° ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
          renderRtuList(rtuCurrentPage);
          populateRtuSelects();
          updateDashboard();
        }, { onlyOnce: false });

        // ì ê²€ ë°ì´í„° ë¡œë“œ
        onValue(inspectionRef, (snapshot) => {
          inspectionList = [];
          snapshot.forEach((childSnapshot) => {
            inspectionList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          renderInspectionList(inspectionCurrentPage);
          updateDashboard();
        }, { onlyOnce: false });

        // ìˆ˜ë¦¬ ë°ì´í„° ë¡œë“œ
        onValue(repairRef, (snapshot) => {
          repairList = [];
          snapshot.forEach((childSnapshot) => {
            repairList.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });
          renderRepairList(repairCurrentPage);
          updateDashboard();
          resolve(); // ëª¨ë“  ì´ˆê¸° ë¡œë“œê°€ ì™„ë£Œë˜ë©´ Promise resolve
        }, { onlyOnce: false });
      });
    }

    // RTU ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (ì ê²€/ìˆ˜ë¦¬ í¼)
    function populateRtuSelects() {
      const optionsHtml = `<option value="">-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>` + 
        rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');

      elements.inspectionRtuIdSelect.innerHTML = optionsHtml;
      elements.repairRtuIdSelect.innerHTML = optionsHtml;
      
      // ìˆ˜ì • ëª¨ë“œ RTU ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      elements.rtuModifySelect.innerHTML = `<option value="">-- ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>` + 
        rtuList.map(rtu => `<option value="${rtu.id}">${rtu.name} (${rtu.region})</option>`).join('');
    }

    // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateDashboard() {
      const totalRtuCount = rtuList.length;
      const runningCount = rtuList.filter(rtu => rtu.status === 'ì‘ë™ì¤‘').length;
      const stoppedCount = rtuList.filter(rtu => rtu.status === 'ì •ì§€ë¨').length;
      const needsInspectionCount = rtuList.filter(rtu => rtu.status === 'ì ê²€í•„ìš”').length;

      elements.dashboardTotal.textContent = totalRtuCount;
      elements.dashboardRunning.textContent = runningCount;
      elements.dashboardStopped.textContent = stoppedCount;
      elements.dashboardNeedsInspection.textContent = needsInspectionCount;
      
      // Report Page Summary Update
      elements.reportTotalRtu.textContent = totalRtuCount;
      elements.reportTotalInspection.textContent = inspectionList.length;
      elements.reportTotalRepair.textContent = repairList.length;

      // Monthly Inspection Count
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      startOfMonth.setHours(0, 0, 0, 0);
      const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
      elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

      // Pending Repair Count
      const pendingRepairCount = repairList.filter(repair => repair.status === 'ìš”ì²­' || repair.status === 'ì§„í–‰ì¤‘').length;
      elements.dashboardPendingRepair.textContent = pendingRepairCount;

      // Latest RTU List
      const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);
      if (latestRtu.length === 0) {
        elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
          <div class="flex justify-between items-center py-2 border-b last:border-b-0">
            <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
            <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
          </div>
        `).join('');
      }
    }

    /* ==================== ë Œë”ë§ í•¨ìˆ˜ (Lists) ==================== */

    // ëª©ë¡ ë Œë”ë§ ì œë„¤ë¦­ í•¨ìˆ˜
    function renderList(list, containerElement, countElement, paginationElement, listType, renderRowFunction) {
      countElement.textContent = list.length;
      
      if (list.length === 0) {
        containerElement.innerHTML = `<p class="text-gray-500 italic">ë“±ë¡ëœ ${listType} ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        paginationElement.innerHTML = '';
        return;
      }
      
      const currentPage = listType === 'RTU' ? rtuCurrentPage : (listType === 'ì ê²€ ê¸°ë¡' ? inspectionCurrentPage : repairCurrentPage);
      const totalPages = Math.ceil(list.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedList = list.slice(startIndex, endIndex);

      let listHtml = '';
      paginatedList.forEach(item => {
        listHtml += renderRowFunction(item);
      });
      containerElement.innerHTML = listHtml;

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPagination(paginationElement, totalPages, currentPage, (newPage) => {
        if (listType === 'RTU') {
          rtuCurrentPage = newPage;
          renderRtuList(rtuCurrentPage);
        } else if (listType === 'ì ê²€ ê¸°ë¡') {
          inspectionCurrentPage = newPage;
          renderInspectionList(inspectionCurrentPage);
        } else if (listType === 'ìˆ˜ë¦¬ ê¸°ë¡') {
          repairCurrentPage = newPage;
          renderRepairList(repairCurrentPage);
        }
      });
    }
    
    // RTU ëª©ë¡ ë Œë”ë§
    function renderRtuList(page) {
        rtuList = rtuList.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderList(rtuList, elements.rtuList, elements.rtuCount, elements.rtuPagination, 'RTU', renderRtuRow);
    }

    // ì ê²€ ê¸°ë¡ ëª©ë¡ ë Œë”ë§
    function renderInspectionList(page) {
        const sortedList = inspectionList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'
        })).sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));

        renderList(sortedList, elements.inspectionList, elements.inspectionCount, elements.inspectionPagination, 'ì ê²€ ê¸°ë¡', renderInspectionRow);
    }
    
    // ìˆ˜ë¦¬ ê¸°ë¡ ëª©ë¡ ë Œë”ë§
    function renderRepairList(page) {
        const sortedList = repairList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'
        })).sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));

        renderList(sortedList, elements.repairList, elements.repairCount, elements.repairPagination, 'ìˆ˜ë¦¬ ê¸°ë¡', renderRepairRow);
    }

    // RTU í–‰ HTML ìƒì„±
    function renderRtuRow(rtu) {
      const statusColor = getStatusColor(rtu.status);
      return `
        <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 flex justify-between items-center hover:bg-gray-100 transition duration-150">
          <div>
            <p class="text-lg font-bold text-gray-800">${rtu.name} (${rtu.region})</p>
            <p class="text-sm text-gray-600 mt-1">ëª¨ë¸: ${rtu.model || 'N/A'} | ìš©ëŸ‰: ${rtu.capacity || 'N/A'}</p>
          </div>
          <div class="flex space-x-3 items-center">
            <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColor}">${rtu.status}</span>
            <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="rtu" data-id="${rtu.id}">ìƒì„¸ ë³´ê¸°</button>
          </div>
        </div>
      `;
    }

    // ì ê²€ ê¸°ë¡ í–‰ HTML ìƒì„±
    function renderInspectionRow(inspection) {
        const resultColor = getResultColor(inspection.result);
        return `
          <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 hover:bg-gray-100 transition duration-150">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-lg font-bold text-gray-800">${inspection.rtuName} (${inspection.inspectionDate})</p>
                <p class="text-sm text-gray-600 mt-1">ì ê²€ì: ${inspection.inspector} | ìµœì¢… ê²°ê³¼: <span class="${resultColor} px-2 py-0.5 rounded">${inspection.result || 'N/A'}</span></p>
              </div>
              <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="inspection" data-id="${inspection.id}">ìƒì„¸ ë³´ê¸°</button>
            </div>
          </div>
        `;
    }

    // ìˆ˜ë¦¬ ê¸°ë¡ í–‰ HTML ìƒì„±
    function renderRepairRow(repair) {
        const statusColor = getRepairStatusColor(repair.status);
        const issueSnippet = repair.issue ? repair.issue.substring(0, 30) + (repair.issue.length > 30 ? '...' : '') : 'ë‚´ìš© ì—†ìŒ';

        return `
          <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200 hover:bg-gray-100 transition duration-150">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-lg font-bold text-gray-800">${repair.rtuName} (${repair.repairDate})</p>
                <p class="text-sm text-gray-600 mt-1">ë‹´ë‹¹ì: ${repair.engineer} | ìƒíƒœ: <span class="${statusColor} px-2 py-0.5 rounded">${repair.status}</span></p>
                <p class="text-xs text-gray-500 mt-1">ë‚´ìš©: ${issueSnippet}</p>
              </div>
              <button class="text-blue-600 hover:text-blue-800 font-medium text-sm detail-view-btn" data-type="repair" data-id="${repair.id}">ìƒì„¸ ë³´ê¸°</button>
            </div>
          </div>
        `;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ HTML ìƒì„± ë° ì´ë²¤íŠ¸ ì„¤ì •
    function renderPagination(container, totalPages, currentPage, onPageChange) {
      container.innerHTML = '';
      if (totalPages <= 1) return;

      let paginationHtml = '';

      // ì´ì „ ë²„íŠ¼
      paginationHtml += `<button class="pagination-btn bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-l-lg hover:bg-gray-300 transition duration-150 text-sm" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">ì´ì „</button>`;

      // í˜ì´ì§€ ë²ˆí˜¸
      for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
        paginationHtml += `<button class="pagination-btn ${activeClass} font-semibold py-2 px-3 text-sm transition duration-150" data-page="${i}">${i}</button>`;
      }

      // ë‹¤ìŒ ë²„íŠ¼
      paginationHtml += `<button class="pagination-btn bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-r-lg hover:bg-gray-300 transition duration-150 text-sm" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">ë‹¤ìŒ</button>`;

      container.innerHTML = paginationHtml;

      container.querySelectorAll('.pagination-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          if (!button.disabled) {
            const newPage = parseInt(e.target.dataset.page);
            onPageChange(newPage);
          }
        });
      });
    }
    
    /* ==================== ë Œë”ë§ í•¨ìˆ˜ (Details & Report) ==================== */

    // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
    function showDetail(type, id) {
      elements.modalContent.innerHTML = '<p class="loading"></p>';
      elements.detailModal.classList.remove('hidden');

      let item = null;
      if (type === 'rtu') {
        item = rtuList.find(r => r.id === id);
        elements.modalTitle.textContent = `RTU ìƒì„¸ ì •ë³´: ${item?.name || 'ë¡œë”© ì¤‘...'}`;
        if (item) elements.modalContent.innerHTML = renderRtuDetail(item);
      } else if (type === 'inspection') {
        item = inspectionList.find(i => i.id === id);
        elements.modalTitle.textContent = `ì ê²€ ê¸°ë¡ ìƒì„¸: ${rtuList.find(r => r.id === item?.rtuId)?.name || 'ë¡œë”© ì¤‘...'}`;
        if (item) elements.modalContent.innerHTML = renderInspectionDetail(item);
      } else if (type === 'repair') {
        item = repairList.find(r => r.id === id);
        elements.modalTitle.textContent = `ìˆ˜ë¦¬ ê¸°ë¡ ìƒì„¸: ${rtuList.find(r => r.id === item?.rtuId)?.name || 'ë¡œë”© ì¤‘...'}`;
        if (item) elements.modalContent.innerHTML = renderRepairDetail(item);
      }
    }

    // RTU ìƒì„¸ ì •ë³´ HTML ìƒì„±
    function renderRtuDetail(item) {
      const rtuName = item.name;
      const imageUrls = [item.image1, item.image2, item.image3].filter(url => url);
      
      const imageHtml = imageUrls.length > 0 ? `
        <h4 class="text-lg font-semibold text-gray-800 mt-6 border-t pt-4">ì¥ë¹„ ì‚¬ì§„</h4>
        <div class="flex flex-wrap gap-4 mt-2">
          ${imageUrls.map(url => `<img src="${url}" alt="ì¥ë¹„ ì‚¬ì§„" class="thumb-detail" onclick="window.zoomImage('${url}')">`).join('')}
        </div>
      ` : '';
      
      return `
        <div class="space-y-3">
          <p><strong>ë“±ë¡ë²ˆí˜¸/ID:</strong> ${item.name}</p>
          <p><strong>ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­:</strong> ${item.region}</p>
          <p><strong>ëª¨ë¸ëª…:</strong> ${item.model || 'N/A'}</p>
          <p><strong>ìš©ëŸ‰:</strong> ${item.capacity || 'N/A'}</p>
          <p><strong>ìœ ë‹› ì¢…ë¥˜:</strong> ${item.unitType || 'N/A'}</p>
          <p><strong>ëƒ‰ë§¤ ì¢…ë¥˜:</strong> ${item.refrigerant || 'N/A'}</p>
          <p><strong>ì „ê¸° ì¢…ë¥˜:</strong> ${item.electricPhase || 'N/A'}</p>
          <p><strong>ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ:</strong> ${item.date}</p>
          <p><strong>í˜„ì¬ ìƒíƒœ:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${getStatusColor(item.status)}">${item.status}</span></p>
          <p><strong>ê³ ì•• ìƒí•œ:</strong> ${item.pressureHighLimit || 'N/A'} PSI</p>
          <p><strong>ì €ì•• í•˜í•œ:</strong> ${item.pressureLowLimit || 'N/A'} PSI</p>
          <p><strong>íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨:</strong> ${item.notes ? item.notes.replace(/\n/g, '<br>') : 'ì—†ìŒ'}</p>
          <div class="flex space-x-4 mt-6 border-t pt-4">
            <button class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-150 text-sm" onclick="window.editRtu('${item.id}')">ìˆ˜ì • ëª¨ë“œë¡œ ì´ë™</button>
            <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRtu('${item.id}', '${rtuName}')">ì‚­ì œ</button>
          </div>
          ${imageHtml}
        </div>
      `;
    }
    
    // ì ê²€ ê¸°ë¡ ìƒì„¸ ì •ë³´ HTML ìƒì„±
    function renderInspectionDetail(item) {
        const rtuName = rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
        const resultColor = getResultColor(item.result);
        
        return `
          <div class="space-y-3">
            <h4 class="text-lg font-bold text-indigo-800 border-b pb-2">ê¸°ë³¸ ì •ë³´</h4>
            <p><strong>ëŒ€ìƒ RTU:</strong> ${rtuName}</p>
            <p><strong>ì ê²€ ë‚ ì§œ:</strong> ${item.inspectionDate}</p>
            <p><strong>ì ê²€ì:</strong> ${item.inspector}</p>
            <p><strong>ìµœì¢… ê²°ê³¼:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${resultColor}">${item.result || 'N/A'}</span></p>
            
            <h4 class="text-lg font-bold text-indigo-800 mt-6 border-t pt-4 pb-2">ë¶€í’ˆ ì ê²€ ìƒíƒœ</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <p><strong>1. í•„í„°:</strong> ${item.check1}</p>
                <p><strong>2. ì½˜í…í„°:</strong> ${item.check2}</p>
                <p><strong>3. ì½˜ë´ì‹± ì½”ì¼:</strong> ${item.check3}</p>
                <p><strong>4. ì†¡í’ ëª¨í„°:</strong> ${item.check4}</p>
                <p><strong>5. ì¦ë°œê¸° ì½”ì¼:</strong> ${item.check5}</p>
                <p><strong>6. ê³ ì•• ì„¼ì„œ:</strong> ${item.check6}</p>
                <p><strong>7. ì €ì•• ì„¼ì„œ:</strong> ${item.check7}</p>
                <p><strong>8. ìºíŒ¨ì‹œí„°:</strong> ${item.check8}</p>
            </div>
            
            <h4 class="text-lg font-bold text-red-800 mt-6 border-t pt-4 pb-2">ìš´ì „ ìƒíƒœ ë° ì˜¨ë„ ì¸¡ì •</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <p><strong>Comp 1 ê³ ì••:</strong> ${item.comp1Hp || 'N/A'} PSI</p>
                <p><strong>Comp 1 ì €ì••:</strong> ${item.comp1Lp || 'N/A'} PSI</p>
                <p><strong>Comp 1 ì „ë¥˜:</strong> ${item.comp1Amp || 'N/A'} A</p>
                <p><strong>Comp 2 ê³ ì••:</strong> ${item.comp2Hp || 'N/A'} PSI</p>
                <p><strong>Comp 2 ì €ì••:</strong> ${item.comp2Lp || 'N/A'} PSI</p>
                <p><strong>Comp 2 ì „ë¥˜:</strong> ${item.comp2Amp || 'N/A'} A</p>
                <p><strong>ê³¼ì—´ë„:</strong> ${item.superheat || 'N/A'} â„‰</p>
                <p><strong>ê³¼ëƒ‰ë„:</strong> ${item.subcool || 'N/A'} â„‰</p>
            </div>
            
            <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4 pb-2">íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©</h4>
            <p class="whitespace-pre-wrap bg-gray-100 p-3 rounded text-sm">${item.notes || 'ì—†ìŒ'}</p>
            
            <div class="flex space-x-4 mt-6 border-t pt-4">
              <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRecord('${item.id}', 'inspection', '${rtuName} ì ê²€ ê¸°ë¡')">ì‚­ì œ</button>
            </div>
          </div>
        `;
    }
    
    // ìˆ˜ë¦¬ ê¸°ë¡ ìƒì„¸ ì •ë³´ HTML ìƒì„±
    function renderRepairDetail(item) {
        const rtuName = rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
        const statusColor = getRepairStatusColor(item.status);

        return `
          <div class="space-y-3">
            <p><strong>ëŒ€ìƒ RTU:</strong> ${rtuName}</p>
            <p><strong>ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ:</strong> ${item.repairDate}</p>
            <p><strong>ìˆ˜ë¦¬ ë‹´ë‹¹ì:</strong> ${item.engineer}</p>
            <p><strong>ì²˜ë¦¬ ìƒíƒœ:</strong> <span class="px-2 py-0.5 text-sm font-semibold rounded ${statusColor}">${item.status}</span></p>
            
            <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4 pb-2">ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©</h4>
            <p class="whitespace-pre-wrap bg-gray-100 p-3 rounded text-sm">${item.issue.replace(/\n/g, '<br>')}</p>
            
            <div class="flex space-x-4 mt-6 border-t pt-4">
              <button class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150 text-sm" onclick="window.deleteRecord('${item.id}', 'repair', '${rtuName} ìˆ˜ë¦¬ ê¸°ë¡')">ì‚­ì œ</button>
            </div>
          </div>
        `;
    }

    /* ==================== ë Œë”ë§ í•¨ìˆ˜ (Reports) ==================== */

    function renderReportDetail(type) {
      elements.reportDetailView.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

      let title = '';
      let listData = [];
      let headers = [];
      let contentHtml = '';
      let listId = '';

      if (type === 'rtu') {
        title = `RTU ë“±ë¡ ëª©ë¡ (${rtuList.length}ê±´)`;
        listData = rtuList;
        headers = ['RTU ë“±ë¡ë²ˆí˜¸/ID', 'ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­', 'ëª¨ë¸ëª…', 'ìš©ëŸ‰', 'ìœ ë‹› ì¢…ë¥˜', 'ì„¤ì¹˜ ë‚ ì§œ', 'í˜„ì¬ ìƒíƒœ'];
        listId = 'rtu-list-table';
      } else if (type === 'inspection') {
        title = `ì ê²€ ê¸°ë¡ ëª©ë¡ (${inspectionList.length}ê±´)`;
        listData = inspectionList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
          resultText: item.result || '',
        })).sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
        headers = ['ì ê²€ ë‚ ì§œ', 'RTU ë“±ë¡ë²ˆí˜¸', 'ì ê²€ì', 'Comp1 ê³ ì••', 'Comp1 ì €ì••', 'Comp1 ì „ë¥˜', 'ìµœì¢… ê²°ê³¼', 'íŠ¹ì´ì‚¬í•­'];
        listId = 'inspection-list-table';
      } else if (type === 'repair') {
        title = `ìˆ˜ë¦¬ ê¸°ë¡ ëª©ë¡ (${repairList.length}ê±´)`;
        // ë°ì´í„°ë¥¼ ì¸ì‡„ë¥¼ ìœ„í•´ ì •ë ¬í•˜ê³  RTU ì´ë¦„ì„ í¬í•¨í•©ë‹ˆë‹¤.
        listData = repairList.map(item => ({
          ...item,
          rtuName: rtuList.find(r => r.id === item.rtuId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
        })).sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
        headers = ['ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ', 'RTU ë“±ë¡ë²ˆí˜¸', 'ë‹´ë‹¹ì', 'ì²˜ë¦¬ ìƒíƒœ', 'ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©'];
        listId = 'repair-list-table';
      } else {
        return;
      }

      // 1. ì œëª© ë° ì¸ì‡„ ë²„íŠ¼ ì¶”ê°€
      contentHtml += `<h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>`;
      contentHtml += `<div class="print-hidden mb-4"><button onclick="window.print()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 text-sm">ë³´ê³ ì„œ ì¸ì‡„</button></div>`;


      // 2. í…Œì´ë¸” ì‹œì‘
      contentHtml += `<div class="overflow-x-auto"><table id="${listId}" class="min-w-full divide-y divide-gray-200">`;
      
      // 3. í—¤ë”
      contentHtml += `<thead class="bg-gray-50"><tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>`;

      // 4. ë°”ë””
      contentHtml += `<tbody class="bg-white divide-y divide-gray-200">`;

      if (listData.length === 0) {
        contentHtml += `<tr><td colspan="${headers.length}" class="px-6 py-4 text-sm font-medium text-gray-500 text-center">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      } else {
        listData.forEach(item => {
          let rowData = [];
          if (type === 'rtu') {
            rowData = [
              item.name, item.region, item.model || 'N/A', item.capacity || 'N/A', item.unitType || 'N/A', item.date, 
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(item.status)}">${item.status}</span>`
            ];
          } else if (type === 'inspection') {
            rowData = [
              item.inspectionDate, item.rtuName, item.inspector, 
              item.comp1Hp || 'N/A', item.comp1Lp || 'N/A', item.comp1Amp || 'N/A', 
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getResultColor(item.result)}">${item.result || 'N/A'}</span>`,
              item.notes ? item.notes.substring(0, 30) + (item.notes.length > 30 ? '...' : '') : 'N/A'
            ];
          } else if (type === 'repair') {
            // [ìˆ˜ì •ëœ ë¶€ë¶„] ìˆ˜ë¦¬ ê¸°ë¡ì˜ í…Œì´ë¸” í–‰ ë°ì´í„°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
            rowData = [
              item.repairDate,
              item.rtuName,
              item.engineer,
              `<span class="px-2 py-0.5 text-xs font-semibold rounded ${getRepairStatusColor(item.status)}">${item.status}</span>`,
              item.issue ? item.issue.substring(0, 50) + (item.issue.length > 50 ? '...' : '') : 'N/A'
            ];
          }

          // Generate table row HTML
          contentHtml += `<tr>${rowData.map(d => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${d}</td>`).join('')}</tr>`;
        });
      }

      // 5. í…Œì´ë¸” ë
      contentHtml += `</tbody></table></div>`;

      // 6. ë‚´ìš© ì‚½ì…
      elements.reportDetailView.innerHTML = contentHtml;
    }

    /* ==================== ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ ==================== */

    // ë°ì´í„° ì €ì¥ (Firebase)
    function saveToFirebase(path, data, id = null) {
      const targetRef = id ? ref(db, `${path}/${id}`) : ref(db, path);
      // ì‹ ê·œ ë“±ë¡ ì‹œ ê³ ìœ  ID ìƒì„± (push)
      if (!id) {
          const newRef = push(targetRef);
          return set(newRef, data);
      }
      // ìˆ˜ì • ì‹œ ê¸°ì¡´ ID ì‚¬ìš© (set)
      return set(targetRef, data);
    }
    
    // RTU ë“±ë¡/ìˆ˜ì • ì²˜ë¦¬
    function handleRtuFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.rtuForm);
      const data = Object.fromEntries(formData.entries());
      const isModification = !!data.rtuIdForModification;
      const rtuId = isModification ? data.rtuIdForModification : null;
      
      // í•„ìˆ˜ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ (formì˜ required ì†ì„± ì‚¬ìš©)
      if (!data.name && !isModification) { // ì‹ ê·œ ë“±ë¡ ì‹œ ID í•„ìˆ˜
          alert("RTU ë“±ë¡ë²ˆí˜¸/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
      }
      if (!data.region) {
          alert("ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
      }
      
      // ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ rtu-modify-selectì—ì„œ ì„ íƒëœ ID ì‚¬ìš©
      const finalRtuId = isModification ? elements.rtuModifySelect.value : data.name.trim();

      if (isModification && !finalRtuId) {
          alert("ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•˜ì„¸ìš”.");
          return;
      }

      const saveData = {
        name: finalRtuId, // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì„ íƒëœ ID, ì‹ ê·œ ë“±ë¡ì—ì„œëŠ” ì…ë ¥ëœ ì´ë¦„ ì‚¬ìš©
        region: data.region,
        model: data.model || '',
        capacity: data.capacity || '',
        unitType: data.unitType || 'íŒ¨í‚¤ì§€',
        refrigerant: data.refrigerant || 'R-410A',
        electricPhase: data.electricPhase || 'ì‚¼ìƒ',
        date: data.date || new Date().toISOString().substring(0, 10),
        status: data.status || 'ì‘ë™ì¤‘',
        pressureHighLimit: data.pressureHighLimit ? parseInt(data.pressureHighLimit) : null,
        pressureLowLimit: data.pressureLowLimit ? parseInt(data.pressureLowLimit) : null,
        notes: data.notes || '',
        lastUpdated: new Date().toISOString(), // ë§ˆì§€ë§‰ ìˆ˜ì •ì¼/ë“±ë¡ì¼ ê¸°ë¡
        // ì´ë¯¸ì§€ í•„ë“œëŠ” í˜„ì¬ëŠ” URL ëŒ€ì‹  íŒŒì¼ ì´ë¦„ì„ ì €ì¥í•œë‹¤ê³  ê°€ì •í•˜ê³  ì²˜ë¦¬ ë¡œì§ ìƒëµ
        image1: '', // ì‹¤ì œ ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ í•„ìš”
        image2: '',
        image3: '',
      };
      
      // ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ (Firebase Storage í•„ìš”. ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ URL placeholder ì²˜ë¦¬)
      const existingRtu = rtuList.find(r => r.id === rtuId);
      if (existingRtu) {
          saveData.image1 = existingRtu.image1 || '';
          saveData.image2 = existingRtu.image2 || '';
          saveData.image3 = existingRtu.image3 || '';
      }

      // ì‹¤ì œë¡œëŠ” Firebase Storageì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  URLì„ ë°›ì•„ì™€ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
      // í˜„ì¬ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ ìƒí˜¸ì‘ìš© ì—†ì´ ë¡œì»¬ì—ì„œ URLë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      
      // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
      const dbPath = 'rtu';
      // ì‹ ê·œ ë“±ë¡ ì‹œ rtuIdëŠ” nullë¡œ ì „ë‹¬í•˜ì—¬ pushë¡œ ê³ ìœ  ID ìƒì„± (ë˜ëŠ” nameì„ IDë¡œ ì‚¬ìš©)
      const finalSaveId = isModification ? rtuId : saveData.name;
      
      if (!isModification && rtuList.some(r => r.id === finalSaveId)) {
          alert(`ì˜¤ë¥˜: ${finalSaveId}ëŠ” ì´ë¯¸ ë“±ë¡ëœ RTU IDì…ë‹ˆë‹¤. ë‹¤ë¥¸ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.`);
          return;
      }

      // IDë¥¼ nameìœ¼ë¡œ ì‚¬ìš©í•˜ê³ , keyë„ nameìœ¼ë¡œ ì €ì¥ (ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­ì— ë§ì¶¤)
      saveToFirebase(dbPath, saveData, finalSaveId)
        .then(() => {
          alert(`RTU ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ${isModification ? 'ìˆ˜ì •' : 'ë“±ë¡'}ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          elements.rtuForm.reset();
          // í¼ ëª¨ë“œë¥¼ ì‹ ê·œ ë“±ë¡ìœ¼ë¡œ ë¦¬ì…‹
          setRtuFormMode('new'); 
        })
        .catch(error => {
          console.error("Firebase RTU ì €ì¥ ì˜¤ë¥˜: ", error);
          alert("RTU ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }

    // ì ê²€ ê¸°ë¡ ì €ì¥ ì²˜ë¦¬
    function handleInspectionFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.inspectionForm);
      const data = Object.fromEntries(formData.entries());
      
      const saveData = {
        rtuId: data.rtuId,
        inspectionDate: data.inspectionDate,
        inspector: data.inspector,
        check1: data.check1,
        check2: data.check2,
        check3: data.check3,
        check4: data.check4,
        check5: data.check5,
        check6: data.check6,
        check7: data.check7,
        check8: data.check8,
        comp1Hp: data.comp1Hp ? parseFloat(data.comp1Hp) : null,
        comp1Lp: data.comp1Lp ? parseFloat(data.comp1Lp) : null,
        comp1Amp: data.comp1Amp ? parseFloat(data.comp1Amp) : null,
        comp2Hp: data.comp2Hp ? parseFloat(data.comp2Hp) : null,
        comp2Lp: data.comp2Lp ? parseFloat(data.comp2Lp) : null,
        comp2Amp: data.comp2Amp ? parseFloat(data.comp2Amp) : null,
        superheat: data.superheat ? parseFloat(data.superheat) : null,
        subcool: data.subcool ? parseFloat(data.subcool) : null,
        result: data.result,
        notes: data.notes,
        timestamp: new Date().toISOString(),
      };
      
      saveToFirebase('inspection', saveData)
        .then(() => {
          alert("ì ê²€ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          elements.inspectionForm.reset();
          // RTU ìƒíƒœ ì—…ë°ì´íŠ¸: ìµœì¢… ì ê²€ ê²°ê³¼ê°€ 'ì ê²€í•„ìš”'ì¸ ê²½ìš° RTU ìƒíƒœë„ 'ì ê²€í•„ìš”'ë¡œ ë³€ê²½
          if (saveData.result === 'ì ê²€í•„ìš”') {
              const rtuToUpdate = rtuList.find(r => r.id === saveData.rtuId);
              if (rtuToUpdate && rtuToUpdate.status !== 'ì ê²€í•„ìš”') {
                  saveToFirebase('rtu', { ...rtuToUpdate, status: 'ì ê²€í•„ìš”' }, saveData.rtuId);
              }
          }
        })
        .catch(error => {
          console.error("Firebase ì ê²€ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜: ", error);
          alert("ì ê²€ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }
    
    // ìˆ˜ë¦¬ ê¸°ë¡ ì €ì¥ ì²˜ë¦¬
    function handleRepairFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(elements.repairForm);
      const data = Object.fromEntries(formData.entries());
      
      const saveData = {
        rtuId: data.rtuId,
        repairDate: data.repairDate,
        engineer: data.engineer,
        status: data.status,
        issue: data.issue,
        timestamp: new Date().toISOString(),
      };
      
      saveToFirebase('repair', saveData)
        .then(() => {
          alert("ìˆ˜ë¦¬ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          elements.repairForm.reset();
          
          // RTU ìƒíƒœ ì—…ë°ì´íŠ¸: ì²˜ë¦¬ ìƒíƒœê°€ 'ì™„ë£Œ'ì´ë©´ RTU ìƒíƒœë¥¼ 'ì‘ë™ì¤‘'ìœ¼ë¡œ ë³€ê²½
          if (saveData.status === 'ì™„ë£Œ') {
              const rtuToUpdate = rtuList.find(r => r.id === saveData.rtuId);
              if (rtuToUpdate && rtuToUpdate.status !== 'ì‘ë™ì¤‘') {
                  saveToFirebase('rtu', { ...rtuToUpdate, status: 'ì‘ë™ì¤‘' }, saveData.rtuId);
              }
          }
        })
        .catch(error => {
          console.error("Firebase ìˆ˜ë¦¬ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜: ", error);
          alert("ìˆ˜ë¦¬ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }

    // RTU ìˆ˜ì • ëª¨ë“œ ì „í™˜
    function setRtuFormMode(mode, rtuId = null) {
        if (mode === 'new') {
            elements.rtuFormTitle.textContent = 'RTU ì¥ë¹„ ì‹ ê·œ ë“±ë¡';
            elements.rtuNameInput.classList.remove('hidden');
            elements.rtuModifySelect.classList.add('hidden');
            elements.rtuIdForModification.value = '';
            elements.rtuSubmitBtn.textContent = 'RTU ì •ë³´ ì €ì¥';
            elements.modeNewBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeNewBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeModifyBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
        } else if (mode === 'modify') {
            elements.rtuFormTitle.textContent = 'RTU ì¥ë¹„ ì •ë³´ ìˆ˜ì •';
            elements.rtuNameInput.classList.add('hidden');
            elements.rtuModifySelect.classList.remove('hidden');
            elements.rtuIdForModification.value = 'true'; // ìˆ˜ì • ëª¨ë“œì„ì„ í‘œì‹œ
            elements.rtuSubmitBtn.textContent = 'RTU ì •ë³´ ìˆ˜ì •';
            elements.modeModifyBtn.classList.remove('bg-gray-200', 'text-gray-700');
            elements.modeModifyBtn.classList.add('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.remove('bg-blue-600', 'text-white');
            elements.modeNewBtn.classList.add('bg-gray-200', 'text-gray-700');
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ í¼ ë°ì´í„° ì±„ìš°ê¸° ì´ë²¤íŠ¸ ë“±ë¡ (í•„ìš” ì‹œ)
        }
    }

    // ìˆ˜ì •í•  RTU ì„ íƒ ì‹œ í¼ ì±„ìš°ê¸°
    function fillRtuFormForModification(rtuId) {
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) {
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            return;
        }

        document.getElementById('rtu-region').value = rtu.region || '';
        document.getElementById('rtu-model').value = rtu.model || '';
        document.getElementById('rtu-capacity').value = rtu.capacity || '';
        document.getElementById('rtu-unit-type').value = rtu.unitType || 'íŒ¨í‚¤ì§€';
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase || 'ì‚¼ìƒ';
        document.getElementById('rtu-date').value = rtu.date || '';
        document.getElementById('rtu-status').value = rtu.status || 'ì‘ë™ì¤‘';
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
        document.getElementById('rtu-notes').value = rtu.notes || '';
        
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (URLì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ)
        const images = [rtu.image1, rtu.image2, rtu.image3];
        const previews = [elements.imagePreview1, elements.imagePreview2, elements.imagePreview3];
        
        let hasImage = false;
        images.forEach((url, index) => {
            if (url) {
                previews[index].src = url;
                previews[index].style.display = 'block';
                hasImage = true;
            } else {
                previews[index].src = '';
                previews[index].style.display = 'none';
            }
        });
        
        if (hasImage) {
            elements.imagePreviewContainer.classList.remove('hidden');
        } else {
            elements.imagePreviewContainer.classList.add('hidden');
        }
    }

    // RTU ì‚­ì œ
    function deleteRtu(id, name) {
        if (confirm(`ì •ë§ë¡œ RTU [${name}]ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            const rtuRef = ref(db, `rtu/${id}`);
            remove(rtuRef)
                .then(() => {
                    // ê´€ë ¨ëœ ì ê²€ ë° ìˆ˜ë¦¬ ê¸°ë¡ë„ ì‚­ì œ (í•„ìš”ì— ë”°ë¼)
                    inspectionList.filter(i => i.rtuId === id).forEach(i => remove(ref(db, `inspection/${i.id}`)));
                    repairList.filter(r => r.rtuId === id).forEach(r => remove(ref(db, `repair/${r.id}`)));
                    
                    alert(`RTU [${name}] ë° ê´€ë ¨ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    elements.detailModal.classList.add('hidden');
                    // ëª©ë¡ì€ onValue ë¦¬ìŠ¤ë„ˆì— ì˜í•´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
                })
                .catch(error => {
                    console.error("RTU ì‚­ì œ ì˜¤ë¥˜: ", error);
                    alert("RTU ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
                });
        }
    }
    
    // ì ê²€/ìˆ˜ë¦¬ ê¸°ë¡ ì‚­ì œ
    function deleteRecord(id, type, name) {
        if (confirm(`ì •ë§ë¡œ ${name} ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            const recordRef = ref(db, `${type}/${id}`);
            remove(recordRef)
                .then(() => {
                    alert(`${name} ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    elements.detailModal.classList.add('hidden');
                    // ëª©ë¡ì€ onValue ë¦¬ìŠ¤ë„ˆì— ì˜í•´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
                })
                .catch(error => {
                    console.error("ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜: ", error);
                    alert("ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
                });
        }
    }
    
    // CSV ë‹¤ìš´ë¡œë“œ (ë°ì´í„° ë‚´ë³´ë‚´ê¸°)
    function downloadCSV() {
        const dataToExport = [
            { title: 'RTU_List', data: rtuList, headers: ['id', 'name', 'region', 'model', 'capacity', 'unitType', 'refrigerant', 'electricPhase', 'date', 'status', 'pressureHighLimit', 'pressureLowLimit', 'notes', 'lastUpdated', 'image1', 'image2', 'image3'] },
            { title: 'Inspection_Log', data: inspectionList, headers: ['id', 'rtuId', 'inspectionDate', 'inspector', 'check1', 'check2', 'check3', 'check4', 'check5', 'check6', 'check7', 'check8', 'comp1Hp', 'comp1Lp', 'comp1Amp', 'comp2Hp', 'comp2Lp', 'comp2Amp', 'superheat', 'subcool', 'result', 'notes', 'timestamp'] },
            { title: 'Repair_Log', data: repairList, headers: ['id', 'rtuId', 'repairDate', 'engineer', 'status', 'issue', 'timestamp'] }
        ];

        // Helper to convert array of objects to CSV string
        const convertToCSV = (data, headers) => {
            const headerRow = headers.join(',') + '\n';
            const rows = data.map(obj => 
                headers.map(header => {
                    let value = obj[header] !== undefined && obj[header] !== null ? obj[header] : '';
                    // ì½¤ë§ˆ, ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆ í¬í•¨ ì‹œ ë”°ì˜´í‘œë¡œ ë¬¶ê³  ë”°ì˜´í‘œëŠ” ë‘ ë²ˆ ê²¹ì¹¨
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            );
            return headerRow + rows.join('\n');
        };

        let zip;
        try {
            // JSZip ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ì´ íŒŒì¼ì—ëŠ” ì—†ìœ¼ë¯€ë¡œ, ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ í•„ìš”)
            zip = new window.JSZip();
        } catch (e) {
            alert('CSV ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ JSZip ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¡œì»¬ í™˜ê²½ì—ì„œ ë¡œë“œí•´ì£¼ì„¸ìš”. (í˜„ì¬ëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)');
            return;
        }

        dataToExport.forEach(item => {
            const csv = convertToCSV(item.data, item.headers);
            zip.file(`${item.title}.csv`, csv);
        });

        zip.generateAsync({ type: "blob" })
            .then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RTU_Data_Backup_${new Date().toISOString().substring(0, 10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error("CSV ZIP ìƒì„± ì˜¤ë¥˜:", error);
                alert("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // CSV ì—…ë¡œë“œ (ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
    async function handleCSVUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        let rtuData = null;
        let inspectionData = null;
        let repairData = null;

        const parseFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const csv = e.target.result;
                    // PapaParse ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ì´ íŒŒì¼ì—ëŠ” ì—†ìœ¼ë¯€ë¡œ, ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ í•„ìš”)
                    try {
                        const results = window.Papa.parse(csv, { 
                            header: true, 
                            skipEmptyLines: true,
                            dynamicTyping: true 
                        });
                        resolve(results.data);
                    } catch (e) {
                        reject(new Error("CSV íŒŒì‹± ì˜¤ë¥˜. PapaParse ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."));
                    }
                };
                reader.onerror = () => reject(new Error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜"));
                reader.readAsText(file, 'utf-8');
            });
        };

        alert('ê²½ê³ : CSV ì—…ë¡œë“œëŠ” ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ë§Œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, ì‹¤ì œ ë°ì´í„° ë³‘í•©/ë®ì–´ì“°ê¸° ë¡œì§ì€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤. (PapaParse ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš”)');

        for (const file of files) {
            try {
                const data = await parseFile(file);
                if (file.name.includes('RTU_List')) {
                    rtuData = data;
                } else if (file.name.includes('Inspection_Log')) {
                    inspectionData = data;
                } else if (file.name.includes('Repair_Log')) {
                    repairData = data;
                }
            } catch (error) {
                console.error(`íŒŒì¼ ${file.name} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
                alert(`íŒŒì¼ ${file.name} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }
        }
        
        // ì‹¤ì œë¡œ Firebaseì— ì—…ë¡œë“œí•˜ëŠ” ë¡œì§ (ìƒëµë¨)
        console.log("RTU Data to Upload:", rtuData);
        console.log("Inspection Data to Upload:", inspectionData);
        console.log("Repair Data to Upload:", repairData);
        
        // ì—…ë¡œë“œ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
        event.target.value = null; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
    }

    // CSV í—¤ë” í•œê¸€-ì˜ë¬¸ ë³€í™˜ í—¬í¼ (CSV ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ ì‹œ ì‚¬ìš©)
    function getEnglishHeader(header) {
      switch (header.trim()) {
        case "RTU ë“±ë¡ë²ˆí˜¸/ID": return "id";
        case "ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­": return "region";
        case "ëª¨ë¸ëª…": return "model";
        case "ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)": return "capacity";
        case "ìœ ë‹› ì¢…ë¥˜": return "unitType";
        case "ëƒ‰ë§¤ ì¢…ë¥˜": return "refrigerant";
        case "ì „ê¸° ì¢…ë¥˜": return "electricPhase";
        case "ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ": return "date";
        case "í˜„ì¬ ìƒíƒœ": return "status";
        case "ê³ ì•• ìƒí•œ ì„¤ì • (PSI)": return "pressureHighLimit";
        case "ì €ì•• í•˜í•œ ì„¤ì • (PSI)": return "pressureLowLimit";
        case "íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨": return "notes";
        case "ì ê²€ ë‚ ì§œ": return "inspectionDate";
        case "ì ê²€ì ì´ë¦„": return "inspector";
        case "ìµœì¢… ì ê²€ ê²°ê³¼": return "result";
        case "ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©": return "issue";
        case "ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ": return "repairDate";
        case "ìˆ˜ë¦¬ ë‹´ë‹¹ì": return "engineer";
        case "ì²˜ë¦¬ ìƒíƒœ": return "status";
        default:
          return header.trim().toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
      }
    }


    /* ==================== ì´ˆê¸°í™” ==================== */

    // ëª¨ë“  ë¦¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§í•˜ê³  ëŒ€ì‹œë³´ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();

      // [ì‹ ê·œ] ë³´ê³ ì„œ ìš”ì•½ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
      });
      elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
      });
      elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
      });
    });

    /* ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ==================== */

    // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // RTU í¼ ì œì¶œ ì´ë²¤íŠ¸
    elements.rtuForm.addEventListener('submit', handleRtuFormSubmit);
    elements.modeNewBtn.addEventListener('click', () => setRtuFormMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => setRtuFormMode('modify'));
    elements.rtuModifySelect.addEventListener('change', (e) => fillRtuFormForModification(e.target.value));

    // ì ê²€ í¼ ì œì¶œ ì´ë²¤íŠ¸
    elements.inspectionForm.addEventListener('submit', handleInspectionFormSubmit);

    // ìˆ˜ë¦¬ í¼ ì œì¶œ ì´ë²¤íŠ¸
    elements.repairForm.addEventListener('submit', handleRepairFormSubmit);
    
    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    elements.closeModalBtn.addEventListener('click', () => {
      elements.detailModal.classList.add('hidden');
    });

    // ìƒì„¸ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
    document.addEventListener('click', (e) => {
      if (e.target.matches('.detail-view-btn')) {
        showDetail(e.target.dataset.type, e.target.dataset.id);
      }
    });
    
    // ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ (JSZip ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•¨)
    elements.downloadDataBtn.addEventListener('click', downloadCSV);

    // CSV ì—…ë¡œë“œ ì´ë²¤íŠ¸
    elements.csvUpload.addEventListener('change', handleCSVUpload);

    // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ (HTML ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ìš©)
    window.zoomImage = (url) => {
        elements.zoomedImage.src = url;
        elements.imageZoomModal.classList.remove('hidden');
    };
    window.editRtu = (rtuId) => {
        switchTab('rtu-manage');
        setRtuFormMode('modify');
        elements.rtuModifySelect.value = rtuId;
        fillRtuFormForModification(rtuId);
        elements.detailModal.classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    window.deleteRtu = deleteRtu;
    window.deleteRecord = deleteRecord;
    
    // ì´ˆê¸° íƒ­ ì„¤ì •
    switchTab('dashboard');
  </script>
  </body>
</html>