<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (Firebase ë™ê¸°í™” ìµœì¢…)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    /* í™œì„±í™”ëœ íƒ­ ìŠ¤íƒ€ì¼ */
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <div class="flex space-x-2">
            <button id="add-rtu-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                + RTU ì¶”ê°€
            </button>
            <button id="download-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                ë°ì´í„° ë‹¤ìš´ë¡œë“œ (CSV)
            </button>
        </div>
      </div>

      <div class="mb-6">
        <div class="flex border-b border-gray-200 overflow-x-auto pb-1">
          <button data-tab="dashboard" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150 tab-active">
            ëŒ€ì‹œë³´ë“œ
          </button>
          <button data-tab="rtu" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            RTU ëª©ë¡
          </button>
          <button data-tab="inspection" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            ì ê²€ ê¸°ë¡
          </button>
          <button data-tab="repair" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            ìˆ˜ë¦¬ ê¸°ë¡
          </button>
          <button data-tab="report" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            ë³´ê³ ì„œ
          </button>
        </div>
      </div>

      <div id="dashboard-tab-content" class="tab-content">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</h2>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
            <p class="font-bold text-blue-700">ì•Œë¦¼:</p>
            <p class="text-sm text-blue-600">RTU í˜„í™©, ìµœê·¼ ì´ë²¤íŠ¸, í†µê³„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">ì´ ë“±ë¡ RTU</p>
                <p id="dashboard-total-rtu" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">ìµœê·¼ 30ì¼ ì ê²€</p>
                <p id="dashboard-recent-inspection" class="text-3xl font-bold text-indigo-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">ë¯¸ì™„ë£Œ ìˆ˜ë¦¬ ê±´</p>
                <p id="dashboard-unresolved-repair" class="text-3xl font-bold text-orange-600">0</p>
            </div>
        </div>
      </div>
      
      <div id="rtu-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">ë“±ë¡ëœ RTU</h2>
        <div id="rtu-list-container" class="space-y-4">
          </div>
      </div>

      <div id="inspection-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">ì ê²€ ê¸°ë¡</h2>
        <button id="add-inspection-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-3 mb-4 text-sm rounded-lg shadow transition duration-150">
            + ìƒˆ ì ê²€ ê¸°ë¡ ì¶”ê°€
        </button>
        <div id="inspection-list-container" class="space-y-4">
          </div>
      </div>

      <div id="repair-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">ìˆ˜ë¦¬ ê¸°ë¡</h2>
        <button id="add-repair-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-1 px-3 mb-4 text-sm rounded-lg shadow transition duration-150">
            + ìƒˆ ìˆ˜ë¦¬ ê¸°ë¡ ì¶”ê°€
        </button>
        <div id="repair-list-container" class="space-y-4">
          </div>
      </div>
      
      <div id="report-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">í†µí•© ë³´ê³ ì„œ</h2>
        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
            <p class="font-bold text-green-700">ì •ë³´:</p>
            <p class="text-sm text-green-600">ê¸°ê°„ë³„/RTUë³„ ë³´ê³ ì„œ ìƒì„± ë° ë°ì´í„° í•„í„°ë§ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ì˜ì—­ì…ë‹ˆë‹¤.</p>
        </div>
        <div class="p-6 bg-white rounded-lg shadow">
            <p class="text-lg font-semibold mb-4">ë³´ê³ ì„œ ìƒì„± ì˜µì…˜</p>
            <div class="flex flex-wrap gap-4">
                <input type="date" class="border p-2 rounded">
                <span>~</span>
                <input type="date" class="border p-2 rounded">
                <select class="border p-2 rounded">
                    <option>ì „ì²´ RTU</option>
                </select>
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    ë³´ê³ ì„œ ìƒì„±
                </button>
            </div>
        </div>
      </div>

    </div>
  </div>

  <div id="detail-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 sm:p-8">
      <h3 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">RTU ë“±ë¡</h3>
      <form id="data-form" class="space-y-4">
        <input type="hidden" id="data-doc-id" name="docId">
        <input type="hidden" id="data-type" value="rtu">
        <input type="hidden" id="data-mode" value="add">

        <div id="rtu-fields" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">ì¥ë¹„ ëª…ì¹­</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-location" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜ ì¥ì†Œ</label>
                    <input type="text" id="rtu-location" name="location" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-model" class="block text-sm font-medium text-gray-700">ì¥ë¹„ ëª¨ë¸</label>
                    <input type="text" id="rtu-model" name="model" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-serial" class="block text-sm font-medium text-gray-700">ì¼ë ¨ë²ˆí˜¸</label>
                    <input type="text" id="rtu-serial" name="serial" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-manufacturer" class="block text-sm font-medium text-gray-700">ì œì¡°ì‚¬</label>
                    <input type="text" id="rtu-manufacturer" name="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-firmwareVersion" class="block text-sm font-medium text-gray-700">íŒì›¨ì–´ ë²„ì „</label>
                    <input type="text" id="rtu-firmwareVersion" name="firmwareVersion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="rtu-installDate" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜ ì¼ì</label>
                    <input type="date" id="rtu-installDate" name="installDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-warrantyExpiration" class="block text-sm font-medium text-gray-700">ë³´ì¦ ë§Œë£Œì¼</label>
                    <input type="date" id="rtu-warrantyExpiration" name="warrantyExpiration" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="rtu-operatingStatus" class="block text-sm font-medium text-gray-700">ìš´ì˜ ìƒíƒœ</label>
                    <select id="rtu-operatingStatus" name="operatingStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì ê²€í•„ìš”">ì ê²€ í•„ìš”</option>
                        <option value="ì˜¤ë¥˜">ì˜¤ë¥˜ ë°œìƒ</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="rtu-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ ì‚¬í•­</label>
                <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
        </div>

        <div id="inspection-fields" class="space-y-4 hidden">
            <div>
                <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU</label>
                <select id="inspection-rtu-id" name="rtuDocId" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="inspection-date" class="block text-sm font-medium text-gray-700">ì ê²€ ì¼ì</label>
                    <input type="date" id="inspection-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">ì ê²€ì ì´ë¦„</label>
                    <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <div>
                <label for="inspection-status" class="block text-sm font-medium text-gray-700">ì ê²€ ìƒíƒœ</label>
                <select id="inspection-status" name="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="ì •ìƒ">ì •ìƒ</option>
                    <option value="ì£¼ì˜">ì£¼ì˜ (ì¶”ê°€ ì ê²€ í•„ìš”)</option>
                    <option value="ìˆ˜ë¦¬ìš”ë§">ìˆ˜ë¦¬ ìš”ë§ (ì¦‰ì‹œ ìˆ˜ë¦¬ í•„ìš”)</option>
                </select>
            </div>
            <div>
                <label for="inspection-result" class="block text-sm font-medium text-gray-700">ì ê²€ ìƒì„¸ ë‚´ìš©</label>
                <textarea id="inspection-result" name="result" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div>
                <label for="inspection-file" class="block text-sm font-medium text-gray-700">ì²¨ë¶€ ì‚¬ì§„</label>
                <input type="file" id="inspection-file" name="file" accept="image/*" class="mt-1 block w-full">
            </div>
            <div id="inspection-image-preview-area" class="flex flex-wrap gap-2 pt-2"></div>
        </div>

        <div id="repair-fields" class="space-y-4 hidden">
            <div>
                <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU</label>
                <select id="repair-rtu-id" name="rtuDocId" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="repair-date" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ì¼ì</label>
                    <input type="date" id="repair-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="repair-technician" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ë‹´ë‹¹ì</label>
                    <input type="text" id="repair-technician" name="technician" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <div>
                <label for="repair-content" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ë‚´ìš©</label>
                <textarea id="repair-content" name="content" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div>
                <label for="repair-isCompleted" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ì™„ë£Œ ì—¬ë¶€</label>
                <select id="repair-isCompleted" name="isCompleted" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="false">ë¯¸ì™„ë£Œ</option>
                    <option value="true">ì™„ë£Œ</option>
                </select>
            </div>
        </div>


        <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
          <button type="button" id="close-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
            ë‹«ê¸°
          </button>
          <button type="submit" id="save-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
            ì €ì¥
          </button>
        </div>
      </form>
      
      <div id="detail-log-area" class="space-y-4 border-t pt-4 hidden mt-6">
            </div>
    </div>
  </div>

  <div id="image-preview-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-full max-h-[90vh] overflow-hidden p-2 relative">
        <button onclick="document.getElementById('image-preview-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-black/50 rounded-full p-1 z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="preview-image" src="" alt="Image Preview" class="max-w-full max-h-[85vh] object-contain">
    </div>
  </div>

  <script>
    // =================================================================
    // âš ï¸ ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì • ê°’ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
    // =================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688"
    };

    // Firebase ì´ˆê¸°í™” ë° Firestore ì¸ìŠ¤í„´ìŠ¤
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =================================================================
    // 3. ê¸€ë¡œë²Œ ë°ì´í„° ë° ìš”ì†Œ ê´€ë¦¬
    // =================================================================
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    const elements = {
        rtuListContainer: document.getElementById('rtu-list-container'),
        inspectionListContainer: document.getElementById('inspection-list-container'),
        repairListContainer: document.getElementById('repair-list-container'),
        detailModal: document.getElementById('detail-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        dataForm: document.getElementById('data-form'),
        modalTitle: document.getElementById('modal-title'),
        dataType: document.getElementById('data-type'),
        dataDocId: document.getElementById('data-doc-id'),
        dataMode: document.getElementById('data-mode'),
        saveDataBtn: document.getElementById('save-data-btn'),
        rtuFields: document.getElementById('rtu-fields'),
        inspectionFields: document.getElementById('inspection-fields'),
        repairFields: document.getElementById('repair-fields'),
        tabBtns: document.querySelectorAll('.tab-btn'),
        tabContents: document.querySelectorAll('.tab-content'),
        detailLogArea: document.getElementById('detail-log-area')
    };

    const COLLECTIONS = {
        RTU: 'rtus',
        INSPECTION: 'inspections',
        REPAIR: 'repairs'
    };

    // =================================================================
    // 4. ë°ì´í„° ë¡œë“œ ë¡œì§ (onSnapshot: Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”)
    // =================================================================

    function initFirebaseListeners() {
        // RTU ëª©ë¡ ì‹¤ì‹œê°„ ë™ê¸°í™”
        db.collection(COLLECTIONS.RTU).orderBy('name', 'asc').onSnapshot(snapshot => {
            rtuList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderRtuList();
            populateRtuSelects(); 
            updateDashboard(); 
        }, error => {
            console.error("RTU List fetching error:", error);
        });

        // ì ê²€ ê¸°ë¡ ì‹¤ì‹œê°„ ë™ê¸°í™”
        db.collection(COLLECTIONS.INSPECTION).orderBy('date', 'desc').onSnapshot(snapshot => {
            inspectionList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderInspectionList();
            updateDashboard(); 
        }, error => {
            console.error("Inspection List fetching error:", error);
        });

        // ìˆ˜ë¦¬ ê¸°ë¡ ì‹¤ì‹œê°„ ë™ê¸°í™”
        db.collection(COLLECTIONS.REPAIR).orderBy('date', 'desc').onSnapshot(snapshot => {
            repairList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderRepairList();
            updateDashboard(); 
        }, error => {
            console.error("Repair List fetching error:", error);
        });
    }

    // =================================================================
    // 5. CRUD í•¨ìˆ˜ (Firebase Firestore ì‚¬ìš© ë° ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”)
    // =================================================================

    async function handleDataSubmit(e) {
        e.preventDefault();
        
        const type = elements.dataType.value;
        const mode = elements.dataMode.value;
        const docId = elements.dataDocId.value;
        const formData = new FormData(elements.dataForm);
        const data = {};
        
        // í¼ ë°ì´í„° ê°ì²´í™”
        formData.forEach((value, key) => {
            if (key !== 'docId' && key !== 'mode' && key !== 'file') {
                 // isCompleted í•„ë“œëŠ” ë¬¸ìì—´ "true" / "false"ë¥¼ ë¶ˆë¦¬ì–¸ìœ¼ë¡œ ë³€í™˜
                if (key === 'isCompleted') {
                    data[key] = (value === 'true');
                } else {
                    data[key] = value;
                }
            }
        });
        
        try {
            elements.saveDataBtn.disabled = true;
            elements.saveDataBtn.textContent = 'ì €ì¥ ì¤‘...';

            if (mode === 'add') {
                await db.collection(COLLECTIONS[type.toUpperCase()]).add({ 
                    ...data, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`${type.toUpperCase()} ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else if (mode === 'edit') {
                await db.collection(COLLECTIONS[type.toUpperCase()]).doc(docId).update({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`${type.toUpperCase()} ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            closeModal();

        } catch (error) {
            console.error(`Error saving ${type}:`, error);
            // **ì €ì¥ ë¨¹í†µ í˜„ìƒ í•´ê²°ì„ ìœ„í•œ ì—ëŸ¬ ë©”ì‹œì§€ ê°•ì œ ì¶œë ¥**
            alert(`
                ğŸš¨ ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤! ğŸš¨
                
                [ê°€ì¥ í”í•œ ì›ì¸: Firebase Firestore ë³´ì•ˆ ê·œì¹™]
                Firebase ì½˜ì†”ì˜ Firestore ê·œì¹™ì„ "allow read, write: if true;"ë¡œ ì„¤ì •í–ˆëŠ”ì§€ **ë‹¤ì‹œ í•œë²ˆ í™•ì¸**í•´ì£¼ì„¸ìš”.
                
                [ì—ëŸ¬ ìƒì„¸ ë‚´ìš©]
                ${error.message}
            `);

        } finally {
            elements.saveDataBtn.disabled = false;
            elements.saveDataBtn.textContent = (mode === 'add') ? 'ì €ì¥' : 'ìˆ˜ì • ì™„ë£Œ';
        }
    }

    // ì‚­ì œ í•¨ìˆ˜ (Firebase ì—°ë™)
    async function deleteRtu(docId) {
        if (!confirm('ì •ë§ë¡œ ì´ RTUë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ëœ ëª¨ë“  ì ê²€ ë° ìˆ˜ë¦¬ ê¸°ë¡ë„ ì‚­ì œë©ë‹ˆë‹¤.')) return;
        try {
            await db.collection(COLLECTIONS.RTU).doc(docId).delete();
            // ê´€ë ¨ ê¸°ë¡ ì¼ê´„ ì‚­ì œ
            const batch = db.batch();
            const inspectionRefs = await db.collection(COLLECTIONS.INSPECTION).where('rtuDocId', '==', docId).get();
            inspectionRefs.docs.forEach(doc => batch.delete(doc.ref));
            const repairRefs = await db.collection(COLLECTIONS.REPAIR).where('rtuDocId', '==', docId).get();
            repairRefs.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert('RTU ë° ê´€ë ¨ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error("Error deleting RTU:", error);
            alert(`ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    async function deleteInspection(docId) {
        if (!confirm('ì •ë§ë¡œ ì´ ì ê²€ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await db.collection(COLLECTIONS.INSPECTION).doc(docId).delete();
            alert('ì ê²€ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error("Error deleting inspection:", error);
            alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        }
    }

    async function deleteRepair(docId) {
        if (!confirm('ì •ë§ë¡œ ì´ ìˆ˜ë¦¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await db.collection(COLLECTIONS.REPAIR).doc(docId).delete();
            alert('ìˆ˜ë¦¬ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error("Error deleting repair:", error);
            alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        }
    }


    // =================================================================
    // 6. UI ë° í—¬í¼ í•¨ìˆ˜
    // =================================================================
    
    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
    function updateDashboard() {
        document.getElementById('dashboard-total-rtu').textContent = rtuList.length;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentInspections = inspectionList.filter(item => {
            const dateStr = item.date;
            const date = dateStr ? new Date(dateStr) : new Date(0); 
            return date > thirtyDaysAgo;
        });
        document.getElementById('dashboard-recent-inspection').textContent = recentInspections.length;

        const unresolvedRepairs = repairList.filter(item => item.isCompleted === false || item.isCompleted === 'false').length; 
        document.getElementById('dashboard-unresolved-repair').textContent = unresolvedRepairs;
    }

    function openModal() {
        elements.detailModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        elements.detailModal.classList.add('hidden');
        document.body.style.overflow = '';
        elements.dataForm.reset();
        elements.saveDataBtn.classList.remove('hidden');
        elements.detailLogArea.classList.add('hidden');
        document.getElementById('inspection-image-preview-area').innerHTML = ''; 
    }

    function switchTab(tabName) {
        elements.tabBtns.forEach(btn => {
            btn.classList.toggle('tab-active', btn.dataset.tab === tabName);
        });

        elements.tabContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== `${tabName}-tab-content`);
        });
        
        // +ë²„íŠ¼ ì œì–´
        document.getElementById('add-rtu-btn').classList.toggle('hidden', tabName !== 'rtu');
        document.getElementById('add-inspection-btn').classList.toggle('hidden', tabName !== 'inspection');
        document.getElementById('add-repair-btn').classList.toggle('hidden', tabName !== 'repair');
        
        if (tabName === 'dashboard') {
            updateDashboard();
        }
    }

    // ëª¨ë‹¬ í•„ë“œ ì „í™˜ í•¨ìˆ˜
    function switchDataFields(type, mode) {
        elements.rtuFields.classList.toggle('hidden', type !== 'rtu');
        elements.inspectionFields.classList.toggle('hidden', type !== 'inspection');
        elements.repairFields.classList.toggle('hidden', type !== 'repair');
        
        // ëª¨ë‹¬ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        elements.modalTitle.textContent = 
            (type === 'rtu' ? 'RTU' : (type === 'inspection' ? 'ì ê²€ ê¸°ë¡' : 'ìˆ˜ë¦¬ ê¸°ë¡')) 
            + (mode === 'add' ? ' ë“±ë¡' : (mode === 'edit' ? ' ìˆ˜ì •' : ' ìƒì„¸'));

        const isDetail = mode === 'detail';
        const fields = elements.dataForm.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            if (field.type !== 'hidden') {
                // ìƒì„¸ ë³´ê¸° ëª¨ë“œì—ì„œë§Œ ë¹„í™œì„±í™”
                field.disabled = isDetail;
            }
        });

        if (type === 'inspection') {
            document.getElementById('inspection-file').classList.toggle('hidden', isDetail);
        }

        elements.saveDataBtn.classList.toggle('hidden', isDetail);
    }
    
    // ì ê²€/ìˆ˜ë¦¬ ëª¨ë‹¬ì˜ RTU ì„ íƒ ëª©ë¡ì„ ì±„ìš°ëŠ” í•¨ìˆ˜
    function populateRtuSelects() {
        const selectRtuIns = document.getElementById('inspection-rtu-id');
        const selectRtuRep = document.getElementById('repair-rtu-id');

        [selectRtuIns, selectRtuRep].forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- RTU ì„ íƒ --</option>'; 
            rtuList.forEach(rtu => {
                const option = document.createElement('option');
                option.value = rtu.docId;
                option.textContent = rtu.name;
                select.appendChild(option);
            });
            select.value = currentValue;
        });
    }

    // ë“±ë¡ ëª¨ë“œë¡œ ëª¨ë‹¬ ì—´ê¸°
    function openAddModal(type) {
        elements.dataType.value = type;
        elements.dataMode.value = 'add';
        elements.dataDocId.value = '';
        elements.dataForm.reset();
        elements.saveDataBtn.textContent = 'ì €ì¥';
        
        switchDataFields(type, 'add');
        openModal();
    }
    
    // ìˆ˜ì • ëª¨ë“œ í•¨ìˆ˜
    function editData(type, docId) {
        const list = (type === 'rtu') ? rtuList : (type === 'inspection' ? inspectionList : repairList);
        const data = list.find(item => item.docId === docId);
        if (!data) return;

        elements.dataType.value = type;
        elements.dataMode.value = 'edit';
        elements.dataDocId.value = docId;
        elements.saveDataBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
        
        elements.dataForm.reset();
        for (const key in data) {
            const value = data[key];
            const fieldId = `${type}-${key.toLowerCase().replace('docid', 'rtu-id')}`;
            const field = document.getElementById(fieldId);
            
            if (field) {
                if (field.type === 'date') {
                     // ë‚ ì§œ í•„ë“œëŠ” YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
                    field.value = (value && value.toDate) ? value.toDate().toISOString().split('T')[0] : value || '';
                } else if (key === 'isCompleted' && field.tagName === 'SELECT') {
                    // ì™„ë£Œ ì—¬ë¶€ í•„ë“œëŠ” "true" / "false" ë¬¸ìì—´ë¡œ ì„¤ì •
                    field.value = (value === true || value === 'true') ? 'true' : 'false';
                } else {
                    field.value = value || '';
                }
            }
        }
        
        switchDataFields(type, 'edit');
        openModal();
    }
    
    // ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function showDataDetail(type, docId) {
        const list = (type === 'rtu') ? rtuList : (type === 'inspection' ? inspectionList : repairList);
        const data = list.find(item => item.docId === docId);
        if (!data) return;

        elements.dataType.value = type;
        elements.dataMode.value = 'detail';
        elements.dataDocId.value = docId;
        
        elements.dataForm.reset();
        for (const key in data) {
            // ìƒì„¸ ë³´ê¸° ì‹œ ê°’ ì„¤ì • (ë‚ ì§œëŠ” ë¡œì»¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
            const dateValue = (data[key] && data[key].toDate) ? new Date(data[key].toDate()).toLocaleDateString() : data[key];
            const value = dateValue;

            const field = document.getElementById(`${type}-${key.toLowerCase().replace('docid', 'rtu-id')}`);
            if (field) {
                if (field.tagName === 'SELECT') {
                    if (key === 'rtuDocId') {
                        const rtu = rtuList.find(r => r.docId === data.rtuDocId);
                        field.value = rtu ? rtu.name : value;
                    } else if (key === 'isCompleted') {
                        field.value = (value === true || value === 'true') ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ';
                    } else {
                        field.value = value || '';
                    }
                } else {
                    field.value = value || '';
                }
            }
        }

        switchDataFields(type, 'detail');
        elements.detailLogArea.classList.toggle('hidden', type !== 'rtu'); 

        // RTU ìƒì„¸ ëª¨ë“œì¼ ê²½ìš°, ì ê²€/ìˆ˜ë¦¬ ê¸°ë¡ ë Œë”ë§
        if (type === 'rtu') {
            const rtuInspections = inspectionList.filter(i => i.rtuDocId === docId);
            const rtuRepairs = repairList.filter(r => r.rtuDocId === docId);
            
            elements.detailLogArea.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-800">ì ê²€ ê¸°ë¡ (${rtuInspections.length}ê±´)</h4>
                ${rtuInspections.map(i => `<div class="p-2 border-l-4 border-indigo-400 bg-indigo-50 text-sm cursor-pointer" onclick="showDataDetail('inspection', '${i.docId}')">
                    ${i.date} - ì ê²€ì: ${i.inspector} - ê²°ê³¼: ${i.status}
                </div>`).join('') || '<p class="text-gray-500 text-sm">ê¸°ë¡ ì—†ìŒ</p>'}
                <h4 class="text-lg font-semibold text-gray-800 mt-4">ìˆ˜ë¦¬ ê¸°ë¡ (${rtuRepairs.length}ê±´)</h4>
                ${rtuRepairs.map(r => `<div class="p-2 border-l-4 border-orange-400 bg-orange-50 text-sm cursor-pointer" onclick="showDataDetail('repair', '${r.docId}')">
                    ${r.date} - ë‹´ë‹¹ì: ${r.technician} - ì™„ë£Œ: ${r.isCompleted ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'}
                </div>`).join('') || '<p class="text-gray-500 text-sm">ê¸°ë¡ ì—†ìŒ</p>'}
            `;
        }

        openModal();
    }
    
    // RTU ëª©ë¡ ë Œë”ë§
    function renderRtuList() {
        elements.rtuListContainer.innerHTML = rtuList.map(rtu => `
            <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('rtu', '${rtu.docId}')">
                    <p class="text-lg font-semibold text-gray-800 truncate">${rtu.name} (${rtu.operatingStatus || 'N/A'})</p>
                    <p class="text-sm text-gray-500">${rtu.location} / ëª¨ë¸: ${rtu.model || 'N/A'}</p>
                    <p class="text-xs text-gray-400">ì„¤ì¹˜ì¼: ${rtu.installDate || 'N/A'} | ì œì¡°ì‚¬: ${rtu.manufacturer || 'N/A'}</p>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="editData('rtu', '${rtu.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">ìˆ˜ì •</button>
                    <button onclick="deleteRtu('${rtu.docId}')" class="text-red-600 hover:text-red-800 text-sm">ì‚­ì œ</button>
                </div>
            </div>
        `).join('') || '<p class="text-gray-500">ë“±ë¡ëœ RTUê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // ì ê²€ ëª©ë¡ ë Œë”ë§
    function renderInspectionList() {
        elements.inspectionListContainer.innerHTML = inspectionList.map(item => {
            const rtu = rtuList.find(r => r.docId === item.rtuDocId);
            const rtuName = rtu ? rtu.name : 'ì•Œ ìˆ˜ ì—†ëŠ” RTU';
            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('inspection', '${item.docId}')">
                        <p class="text-lg font-semibold text-indigo-800 truncate">${rtuName} (${item.date})</p>
                        <p class="text-sm text-gray-600">ì ê²€ì: ${item.inspector} / ê²°ê³¼: ${item.status}</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editData('inspection', '${item.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">ìˆ˜ì •</button>
                        <button onclick="deleteInspection('${item.docId}')" class="text-red-600 hover:text-red-800 text-sm">ì‚­ì œ</button>
                    </div>
                </div>
            `;
        }).join('') || '<p class="text-gray-500">ë“±ë¡ëœ ì ê²€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // ìˆ˜ë¦¬ ëª©ë¡ ë Œë”ë§
    function renderRepairList() {
        elements.repairListContainer.innerHTML = repairList.map(item => {
            const rtu = rtuList.find(r => r.docId === item.rtuDocId);
            const rtuName = rtu ? rtu.name : 'ì•Œ ìˆ˜ ì—†ëŠ” RTU';
            const isCompletedText = item.isCompleted === true || item.isCompleted === 'true' ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ';
            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('repair', '${item.docId}')">
                        <p class="text-lg font-semibold text-orange-800 truncate">${rtuName} (${item.date})</p>
                        <p class="text-sm text-gray-600">ë‹´ë‹¹ì: ${item.technician} / ìƒíƒœ: ${isCompletedText}</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editData('repair', '${item.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">ìˆ˜ì •</button>
                        <button onclick="deleteRepair('${item.docId}')" class="text-red-600 hover:text-red-800 text-sm">ì‚­ì œ</button>
                    </div>
                </div>
            `;
        }).join('') || '<p class="text-gray-500">ë“±ë¡ëœ ìˆ˜ë¦¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
    
    // CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (Firebase ì—°ë™)
    function downloadDataAsCsv() {
        alert('CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì´ ê³§ ì‹¤í–‰ë©ë‹ˆë‹¤. (Firebase ë°ì´í„° ê¸°ë°˜)');
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        
        // RTU ëª©ë¡
        csvContent += "=== RTU ëª©ë¡ ===\n";
        const rtuHeaders = ["DocID", "Name", "Location", "Model", "Serial", "Manufacturer", "FirmwareVersion", "InstallDate", "WarrantyExpiration", "OperatingStatus", "Notes", "CreatedAt"];
        csvContent += rtuHeaders.join(",") + "\n";
        rtuList.forEach(item => {
            const row = [
                item.docId,
                `"${item.name.replace(/"/g, '""')}"`,
                `"${item.location.replace(/"/g, '""')}"`,
                `"${item.model || ''}"`,
                `"${item.serial || ''}"`,
                `"${item.manufacturer || ''}"`,
                `"${item.firmwareVersion || ''}"`,
                `"${item.installDate || ''}"`,
                `"${item.warrantyExpiration || ''}"`,
                `"${item.operatingStatus || ''}"`,
                `"${item.notes || ''}"`,
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });
        
        // ì ê²€ ê¸°ë¡
        csvContent += "\n=== ì ê²€ ê¸°ë¡ ===\n";
        const inspectionHeaders = ["DocID", "RTU_DocID", "Date", "Inspector", "Status", "Result", "CreatedAt"];
        csvContent += inspectionHeaders.join(",") + "\n";
        inspectionList.forEach(item => {
             const row = [
                item.docId,
                item.rtuDocId,
                `"${item.date || ''}"`,
                `"${item.inspector || ''}"`,
                `"${item.status || ''}"`,
                `"${item.result ? item.result.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });

        // ìˆ˜ë¦¬ ê¸°ë¡
        csvContent += "\n=== ìˆ˜ë¦¬ ê¸°ë¡ ===\n";
        const repairHeaders = ["DocID", "RTU_DocID", "Date", "Technician", "Content", "IsCompleted", "CreatedAt"];
        csvContent += repairHeaders.join(",") + "\n";
        repairList.forEach(item => {
             const row = [
                item.docId,
                item.rtuDocId,
                `"${item.date || ''}"`,
                `"${item.technician || ''}"`,
                `"${item.content ? item.content.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                item.isCompleted ? 'TRUE' : 'FALSE',
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });
        
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `RTU_Integrated_Data_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    // =================================================================
    // 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
    // =================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Firebase ë°ì´í„° ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        initFirebaseListeners(); 
        
        // ì´ˆê¸° íƒ­ ì„¤ì •
        switchTab('dashboard');

        // ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById('add-rtu-btn').addEventListener('click', () => openAddModal('rtu'));
        document.getElementById('add-inspection-btn').addEventListener('click', () => openAddModal('inspection'));
        document.getElementById('add-repair-btn').addEventListener('click', () => openAddModal('repair'));

        // ë°ì´í„° ì €ì¥ í¼ ì´ë²¤íŠ¸ ì—°ê²°
        elements.dataForm.addEventListener('submit', handleDataSubmit);

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ì—°ê²°
        elements.closeModalBtn.addEventListener('click', closeModal);
        elements.detailModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-bg')) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !elements.detailModal.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        elements.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë¡œì§ ì—°ê²°
        document.getElementById('download-data-btn').addEventListener('click', downloadDataAsCsv);
        
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (HTMLì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
        window.editData = editData;
        window.deleteRtu = deleteRtu;
        window.deleteInspection = deleteInspection;
        window.deleteRepair = deleteRepair;
        window.showDataDetail = showDataDetail;
        
        // ì´ë¯¸ì§€ ê´€ë ¨ ê¸°ëŠ¥ì€ Firebase Storage ì—°ë™ì´ í•„ìš”í•˜ë¯€ë¡œ ì•Œë¦¼ ì²˜ë¦¬
        window.previewImage = () => alert("ì´ë¯¸ì§€ ê¸°ëŠ¥ì€ Firebase Storage ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.openImageInNewTab = () => alert("ì´ë¯¸ì§€ ê¸°ëŠ¥ì€ Firebase Storage ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    });
  </script>
</body>
</html>