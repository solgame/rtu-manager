<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 동기화 최종)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    /* 활성화된 탭 스타일 */
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">RTU 통합 관리 시스템</h1>
        <div class="flex space-x-2">
            <button id="add-rtu-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                + RTU 추가
            </button>
            <button id="download-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                데이터 다운로드 (CSV)
            </button>
        </div>
      </div>

      <div class="mb-6">
        <div class="flex border-b border-gray-200 overflow-x-auto pb-1">
          <button data-tab="dashboard" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150 tab-active">
            대시보드
          </button>
          <button data-tab="rtu" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            RTU 목록
          </button>
          <button data-tab="inspection" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            점검 기록
          </button>
          <button data-tab="repair" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            수리 기록
          </button>
          <button data-tab="report" class="tab-btn py-2 px-4 text-sm sm:text-base text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition duration-150">
            보고서
          </button>
        </div>
      </div>

      <div id="dashboard-tab-content" class="tab-content">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">시스템 대시보드</h2>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
            <p class="font-bold text-blue-700">알림:</p>
            <p class="text-sm text-blue-600">RTU 현황, 최근 이벤트, 통계가 실시간으로 표시됩니다.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">총 등록 RTU</p>
                <p id="dashboard-total-rtu" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">최근 30일 점검</p>
                <p id="dashboard-recent-inspection" class="text-3xl font-bold text-indigo-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <p class="text-sm text-gray-500">미완료 수리 건</p>
                <p id="dashboard-unresolved-repair" class="text-3xl font-bold text-orange-600">0</p>
            </div>
        </div>
      </div>
      
      <div id="rtu-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">등록된 RTU</h2>
        <div id="rtu-list-container" class="space-y-4">
          </div>
      </div>

      <div id="inspection-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">점검 기록</h2>
        <button id="add-inspection-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-3 mb-4 text-sm rounded-lg shadow transition duration-150">
            + 새 점검 기록 추가
        </button>
        <div id="inspection-list-container" class="space-y-4">
          </div>
      </div>

      <div id="repair-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">수리 기록</h2>
        <button id="add-repair-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-1 px-3 mb-4 text-sm rounded-lg shadow transition duration-150">
            + 새 수리 기록 추가
        </button>
        <div id="repair-list-container" class="space-y-4">
          </div>
      </div>
      
      <div id="report-tab-content" class="tab-content hidden">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">통합 보고서</h2>
        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
            <p class="font-bold text-green-700">정보:</p>
            <p class="text-sm text-green-600">기간별/RTU별 보고서 생성 및 데이터 필터링 기능을 구현할 수 있는 영역입니다.</p>
        </div>
        <div class="p-6 bg-white rounded-lg shadow">
            <p class="text-lg font-semibold mb-4">보고서 생성 옵션</p>
            <div class="flex flex-wrap gap-4">
                <input type="date" class="border p-2 rounded">
                <span>~</span>
                <input type="date" class="border p-2 rounded">
                <select class="border p-2 rounded">
                    <option>전체 RTU</option>
                </select>
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    보고서 생성
                </button>
            </div>
        </div>
      </div>

    </div>
  </div>

  <div id="detail-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 sm:p-8">
      <h3 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">RTU 등록</h3>
      <form id="data-form" class="space-y-4">
        <input type="hidden" id="data-doc-id" name="docId">
        <input type="hidden" id="data-type" value="rtu">
        <input type="hidden" id="data-mode" value="add">

        <div id="rtu-fields" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">장비 명칭</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-location" class="block text-sm font-medium text-gray-700">설치 장소</label>
                    <input type="text" id="rtu-location" name="location" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-model" class="block text-sm font-medium text-gray-700">장비 모델</label>
                    <input type="text" id="rtu-model" name="model" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-serial" class="block text-sm font-medium text-gray-700">일련번호</label>
                    <input type="text" id="rtu-serial" name="serial" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="rtu-manufacturer" class="block text-sm font-medium text-gray-700">제조사</label>
                    <input type="text" id="rtu-manufacturer" name="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-firmwareVersion" class="block text-sm font-medium text-gray-700">펌웨어 버전</label>
                    <input type="text" id="rtu-firmwareVersion" name="firmwareVersion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="rtu-installDate" class="block text-sm font-medium text-gray-700">설치 일자</label>
                    <input type="date" id="rtu-installDate" name="installDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="rtu-warrantyExpiration" class="block text-sm font-medium text-gray-700">보증 만료일</label>
                    <input type="date" id="rtu-warrantyExpiration" name="warrantyExpiration" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="rtu-operatingStatus" class="block text-sm font-medium text-gray-700">운영 상태</label>
                    <select id="rtu-operatingStatus" name="operatingStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="정상">정상</option>
                        <option value="점검필요">점검 필요</option>
                        <option value="오류">오류 발생</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이 사항</label>
                <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
        </div>

        <div id="inspection-fields" class="space-y-4 hidden">
            <div>
                <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU</label>
                <select id="inspection-rtu-id" name="rtuDocId" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 일자</label>
                    <input type="date" id="inspection-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름</label>
                    <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <div>
                <label for="inspection-status" class="block text-sm font-medium text-gray-700">점검 상태</label>
                <select id="inspection-status" name="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="정상">정상</option>
                    <option value="주의">주의 (추가 점검 필요)</option>
                    <option value="수리요망">수리 요망 (즉시 수리 필요)</option>
                </select>
            </div>
            <div>
                <label for="inspection-result" class="block text-sm font-medium text-gray-700">점검 상세 내용</label>
                <textarea id="inspection-result" name="result" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div>
                <label for="inspection-file" class="block text-sm font-medium text-gray-700">첨부 사진</label>
                <input type="file" id="inspection-file" name="file" accept="image/*" class="mt-1 block w-full">
            </div>
            <div id="inspection-image-preview-area" class="flex flex-wrap gap-2 pt-2"></div>
        </div>

        <div id="repair-fields" class="space-y-4 hidden">
            <div>
                <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU</label>
                <select id="repair-rtu-id" name="rtuDocId" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 일자</label>
                    <input type="date" id="repair-date" name="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="repair-technician" class="block text-sm font-medium text-gray-700">수리 담당자</label>
                    <input type="text" id="repair-technician" name="technician" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <div>
                <label for="repair-content" class="block text-sm font-medium text-gray-700">수리 내용</label>
                <textarea id="repair-content" name="content" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div>
                <label for="repair-isCompleted" class="block text-sm font-medium text-gray-700">수리 완료 여부</label>
                <select id="repair-isCompleted" name="isCompleted" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="false">미완료</option>
                    <option value="true">완료</option>
                </select>
            </div>
        </div>


        <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
          <button type="button" id="close-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
            닫기
          </button>
          <button type="submit" id="save-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
            저장
          </button>
        </div>
      </form>
      
      <div id="detail-log-area" class="space-y-4 border-t pt-4 hidden mt-6">
            </div>
    </div>
  </div>

  <div id="image-preview-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-full max-h-[90vh] overflow-hidden p-2 relative">
        <button onclick="document.getElementById('image-preview-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-black/50 rounded-full p-1 z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="preview-image" src="" alt="Image Preview" class="max-w-full max-h-[85vh] object-contain">
    </div>
  </div>

  <script>
    // =================================================================
    // ⚠️ 사용자님의 Firebase 설정 값이 적용되었습니다.
    // =================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
      authDomain: "rtu-system-han.firebaseapp.com",
      projectId: "rtu-system-han",
      storageBucket: "rtu-system-han.firebasestorage.app",
      messagingSenderId: "960060003353",
      appId: "1:960060003353:web:0185fc4a392235fab0c688"
    };

    // Firebase 초기화 및 Firestore 인스턴스
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =================================================================
    // 3. 글로벌 데이터 및 요소 관리
    // =================================================================
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    const elements = {
        rtuListContainer: document.getElementById('rtu-list-container'),
        inspectionListContainer: document.getElementById('inspection-list-container'),
        repairListContainer: document.getElementById('repair-list-container'),
        detailModal: document.getElementById('detail-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        dataForm: document.getElementById('data-form'),
        modalTitle: document.getElementById('modal-title'),
        dataType: document.getElementById('data-type'),
        dataDocId: document.getElementById('data-doc-id'),
        dataMode: document.getElementById('data-mode'),
        saveDataBtn: document.getElementById('save-data-btn'),
        rtuFields: document.getElementById('rtu-fields'),
        inspectionFields: document.getElementById('inspection-fields'),
        repairFields: document.getElementById('repair-fields'),
        tabBtns: document.querySelectorAll('.tab-btn'),
        tabContents: document.querySelectorAll('.tab-content'),
        detailLogArea: document.getElementById('detail-log-area')
    };

    const COLLECTIONS = {
        RTU: 'rtus',
        INSPECTION: 'inspections',
        REPAIR: 'repairs'
    };

    // =================================================================
    // 4. 데이터 로드 로직 (onSnapshot: Firebase 실시간 동기화)
    // =================================================================

    function initFirebaseListeners() {
        // RTU 목록 실시간 동기화
        db.collection(COLLECTIONS.RTU).orderBy('name', 'asc').onSnapshot(snapshot => {
            rtuList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderRtuList();
            populateRtuSelects(); 
            updateDashboard(); 
        }, error => {
            console.error("RTU List fetching error:", error);
        });

        // 점검 기록 실시간 동기화
        db.collection(COLLECTIONS.INSPECTION).orderBy('date', 'desc').onSnapshot(snapshot => {
            inspectionList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderInspectionList();
            updateDashboard(); 
        }, error => {
            console.error("Inspection List fetching error:", error);
        });

        // 수리 기록 실시간 동기화
        db.collection(COLLECTIONS.REPAIR).orderBy('date', 'desc').onSnapshot(snapshot => {
            repairList = snapshot.docs.map(doc => ({
                docId: doc.id,
                ...doc.data()
            }));
            renderRepairList();
            updateDashboard(); 
        }, error => {
            console.error("Repair List fetching error:", error);
        });
    }

    // =================================================================
    // 5. CRUD 함수 (Firebase Firestore 사용 및 오류 처리 강화)
    // =================================================================

    async function handleDataSubmit(e) {
        e.preventDefault();
        
        const type = elements.dataType.value;
        const mode = elements.dataMode.value;
        const docId = elements.dataDocId.value;
        const formData = new FormData(elements.dataForm);
        const data = {};
        
        // 폼 데이터 객체화
        formData.forEach((value, key) => {
            if (key !== 'docId' && key !== 'mode' && key !== 'file') {
                 // isCompleted 필드는 문자열 "true" / "false"를 불리언으로 변환
                if (key === 'isCompleted') {
                    data[key] = (value === 'true');
                } else {
                    data[key] = value;
                }
            }
        });
        
        try {
            elements.saveDataBtn.disabled = true;
            elements.saveDataBtn.textContent = '저장 중...';

            if (mode === 'add') {
                await db.collection(COLLECTIONS[type.toUpperCase()]).add({ 
                    ...data, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`${type.toUpperCase()} 기록이 성공적으로 등록되었습니다.`);
            } else if (mode === 'edit') {
                await db.collection(COLLECTIONS[type.toUpperCase()]).doc(docId).update({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`${type.toUpperCase()} 정보가 성공적으로 수정되었습니다.`);
            }
            closeModal();

        } catch (error) {
            console.error(`Error saving ${type}:`, error);
            // **저장 먹통 현상 해결을 위한 에러 메시지 강제 출력**
            alert(`
                🚨 데이터 저장 중 오류가 발생했습니다! 🚨
                
                [가장 흔한 원인: Firebase Firestore 보안 규칙]
                Firebase 콘솔의 Firestore 규칙을 "allow read, write: if true;"로 설정했는지 **다시 한번 확인**해주세요.
                
                [에러 상세 내용]
                ${error.message}
            `);

        } finally {
            elements.saveDataBtn.disabled = false;
            elements.saveDataBtn.textContent = (mode === 'add') ? '저장' : '수정 완료';
        }
    }

    // 삭제 함수 (Firebase 연동)
    async function deleteRtu(docId) {
        if (!confirm('정말로 이 RTU를 삭제하시겠습니까? 관련된 모든 점검 및 수리 기록도 삭제됩니다.')) return;
        try {
            await db.collection(COLLECTIONS.RTU).doc(docId).delete();
            // 관련 기록 일괄 삭제
            const batch = db.batch();
            const inspectionRefs = await db.collection(COLLECTIONS.INSPECTION).where('rtuDocId', '==', docId).get();
            inspectionRefs.docs.forEach(doc => batch.delete(doc.ref));
            const repairRefs = await db.collection(COLLECTIONS.REPAIR).where('rtuDocId', '==', docId).get();
            repairRefs.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert('RTU 및 관련 기록이 모두 삭제되었습니다.');
        } catch (error) {
            console.error("Error deleting RTU:", error);
            alert(`데이터 삭제 중 오류가 발생했습니다: ${error.message}`);
        }
    }

    async function deleteInspection(docId) {
        if (!confirm('정말로 이 점검 기록을 삭제하시겠습니까?')) return;
        try {
            await db.collection(COLLECTIONS.INSPECTION).doc(docId).delete();
            alert('점검 기록이 삭제되었습니다.');
        } catch (error) {
            console.error("Error deleting inspection:", error);
            alert(`삭제 중 오류 발생: ${error.message}`);
        }
    }

    async function deleteRepair(docId) {
        if (!confirm('정말로 이 수리 기록을 삭제하시겠습니까?')) return;
        try {
            await db.collection(COLLECTIONS.REPAIR).doc(docId).delete();
            alert('수리 기록이 삭제되었습니다.');
        } catch (error) {
            console.error("Error deleting repair:", error);
            alert(`삭제 중 오류 발생: ${error.message}`);
        }
    }


    // =================================================================
    // 6. UI 및 헬퍼 함수
    // =================================================================
    
    // 대시보드 데이터 업데이트 함수 (이전과 동일)
    function updateDashboard() {
        document.getElementById('dashboard-total-rtu').textContent = rtuList.length;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentInspections = inspectionList.filter(item => {
            const dateStr = item.date;
            const date = dateStr ? new Date(dateStr) : new Date(0); 
            return date > thirtyDaysAgo;
        });
        document.getElementById('dashboard-recent-inspection').textContent = recentInspections.length;

        const unresolvedRepairs = repairList.filter(item => item.isCompleted === false || item.isCompleted === 'false').length; 
        document.getElementById('dashboard-unresolved-repair').textContent = unresolvedRepairs;
    }

    function openModal() {
        elements.detailModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        elements.detailModal.classList.add('hidden');
        document.body.style.overflow = '';
        elements.dataForm.reset();
        elements.saveDataBtn.classList.remove('hidden');
        elements.detailLogArea.classList.add('hidden');
        document.getElementById('inspection-image-preview-area').innerHTML = ''; 
    }

    function switchTab(tabName) {
        elements.tabBtns.forEach(btn => {
            btn.classList.toggle('tab-active', btn.dataset.tab === tabName);
        });

        elements.tabContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== `${tabName}-tab-content`);
        });
        
        // +버튼 제어
        document.getElementById('add-rtu-btn').classList.toggle('hidden', tabName !== 'rtu');
        document.getElementById('add-inspection-btn').classList.toggle('hidden', tabName !== 'inspection');
        document.getElementById('add-repair-btn').classList.toggle('hidden', tabName !== 'repair');
        
        if (tabName === 'dashboard') {
            updateDashboard();
        }
    }

    // 모달 필드 전환 함수
    function switchDataFields(type, mode) {
        elements.rtuFields.classList.toggle('hidden', type !== 'rtu');
        elements.inspectionFields.classList.toggle('hidden', type !== 'inspection');
        elements.repairFields.classList.toggle('hidden', type !== 'repair');
        
        // 모달 타이틀 업데이트
        elements.modalTitle.textContent = 
            (type === 'rtu' ? 'RTU' : (type === 'inspection' ? '점검 기록' : '수리 기록')) 
            + (mode === 'add' ? ' 등록' : (mode === 'edit' ? ' 수정' : ' 상세'));

        const isDetail = mode === 'detail';
        const fields = elements.dataForm.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            if (field.type !== 'hidden') {
                // 상세 보기 모드에서만 비활성화
                field.disabled = isDetail;
            }
        });

        if (type === 'inspection') {
            document.getElementById('inspection-file').classList.toggle('hidden', isDetail);
        }

        elements.saveDataBtn.classList.toggle('hidden', isDetail);
    }
    
    // 점검/수리 모달의 RTU 선택 목록을 채우는 함수
    function populateRtuSelects() {
        const selectRtuIns = document.getElementById('inspection-rtu-id');
        const selectRtuRep = document.getElementById('repair-rtu-id');

        [selectRtuIns, selectRtuRep].forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- RTU 선택 --</option>'; 
            rtuList.forEach(rtu => {
                const option = document.createElement('option');
                option.value = rtu.docId;
                option.textContent = rtu.name;
                select.appendChild(option);
            });
            select.value = currentValue;
        });
    }

    // 등록 모드로 모달 열기
    function openAddModal(type) {
        elements.dataType.value = type;
        elements.dataMode.value = 'add';
        elements.dataDocId.value = '';
        elements.dataForm.reset();
        elements.saveDataBtn.textContent = '저장';
        
        switchDataFields(type, 'add');
        openModal();
    }
    
    // 수정 모드 함수
    function editData(type, docId) {
        const list = (type === 'rtu') ? rtuList : (type === 'inspection' ? inspectionList : repairList);
        const data = list.find(item => item.docId === docId);
        if (!data) return;

        elements.dataType.value = type;
        elements.dataMode.value = 'edit';
        elements.dataDocId.value = docId;
        elements.saveDataBtn.textContent = '수정 완료';
        
        elements.dataForm.reset();
        for (const key in data) {
            const value = data[key];
            const fieldId = `${type}-${key.toLowerCase().replace('docid', 'rtu-id')}`;
            const field = document.getElementById(fieldId);
            
            if (field) {
                if (field.type === 'date') {
                     // 날짜 필드는 YYYY-MM-DD 형식으로 설정
                    field.value = (value && value.toDate) ? value.toDate().toISOString().split('T')[0] : value || '';
                } else if (key === 'isCompleted' && field.tagName === 'SELECT') {
                    // 완료 여부 필드는 "true" / "false" 문자열로 설정
                    field.value = (value === true || value === 'true') ? 'true' : 'false';
                } else {
                    field.value = value || '';
                }
            }
        }
        
        switchDataFields(type, 'edit');
        openModal();
    }
    
    // 상세 정보 표시 함수
    function showDataDetail(type, docId) {
        const list = (type === 'rtu') ? rtuList : (type === 'inspection' ? inspectionList : repairList);
        const data = list.find(item => item.docId === docId);
        if (!data) return;

        elements.dataType.value = type;
        elements.dataMode.value = 'detail';
        elements.dataDocId.value = docId;
        
        elements.dataForm.reset();
        for (const key in data) {
            // 상세 보기 시 값 설정 (날짜는 로컬 형식으로 변환)
            const dateValue = (data[key] && data[key].toDate) ? new Date(data[key].toDate()).toLocaleDateString() : data[key];
            const value = dateValue;

            const field = document.getElementById(`${type}-${key.toLowerCase().replace('docid', 'rtu-id')}`);
            if (field) {
                if (field.tagName === 'SELECT') {
                    if (key === 'rtuDocId') {
                        const rtu = rtuList.find(r => r.docId === data.rtuDocId);
                        field.value = rtu ? rtu.name : value;
                    } else if (key === 'isCompleted') {
                        field.value = (value === true || value === 'true') ? '완료' : '미완료';
                    } else {
                        field.value = value || '';
                    }
                } else {
                    field.value = value || '';
                }
            }
        }

        switchDataFields(type, 'detail');
        elements.detailLogArea.classList.toggle('hidden', type !== 'rtu'); 

        // RTU 상세 모드일 경우, 점검/수리 기록 렌더링
        if (type === 'rtu') {
            const rtuInspections = inspectionList.filter(i => i.rtuDocId === docId);
            const rtuRepairs = repairList.filter(r => r.rtuDocId === docId);
            
            elements.detailLogArea.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-800">점검 기록 (${rtuInspections.length}건)</h4>
                ${rtuInspections.map(i => `<div class="p-2 border-l-4 border-indigo-400 bg-indigo-50 text-sm cursor-pointer" onclick="showDataDetail('inspection', '${i.docId}')">
                    ${i.date} - 점검자: ${i.inspector} - 결과: ${i.status}
                </div>`).join('') || '<p class="text-gray-500 text-sm">기록 없음</p>'}
                <h4 class="text-lg font-semibold text-gray-800 mt-4">수리 기록 (${rtuRepairs.length}건)</h4>
                ${rtuRepairs.map(r => `<div class="p-2 border-l-4 border-orange-400 bg-orange-50 text-sm cursor-pointer" onclick="showDataDetail('repair', '${r.docId}')">
                    ${r.date} - 담당자: ${r.technician} - 완료: ${r.isCompleted ? '완료' : '미완료'}
                </div>`).join('') || '<p class="text-gray-500 text-sm">기록 없음</p>'}
            `;
        }

        openModal();
    }
    
    // RTU 목록 렌더링
    function renderRtuList() {
        elements.rtuListContainer.innerHTML = rtuList.map(rtu => `
            <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('rtu', '${rtu.docId}')">
                    <p class="text-lg font-semibold text-gray-800 truncate">${rtu.name} (${rtu.operatingStatus || 'N/A'})</p>
                    <p class="text-sm text-gray-500">${rtu.location} / 모델: ${rtu.model || 'N/A'}</p>
                    <p class="text-xs text-gray-400">설치일: ${rtu.installDate || 'N/A'} | 제조사: ${rtu.manufacturer || 'N/A'}</p>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="editData('rtu', '${rtu.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">수정</button>
                    <button onclick="deleteRtu('${rtu.docId}')" class="text-red-600 hover:text-red-800 text-sm">삭제</button>
                </div>
            </div>
        `).join('') || '<p class="text-gray-500">등록된 RTU가 없습니다.</p>';
    }

    // 점검 목록 렌더링
    function renderInspectionList() {
        elements.inspectionListContainer.innerHTML = inspectionList.map(item => {
            const rtu = rtuList.find(r => r.docId === item.rtuDocId);
            const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('inspection', '${item.docId}')">
                        <p class="text-lg font-semibold text-indigo-800 truncate">${rtuName} (${item.date})</p>
                        <p class="text-sm text-gray-600">점검자: ${item.inspector} / 결과: ${item.status}</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editData('inspection', '${item.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">수정</button>
                        <button onclick="deleteInspection('${item.docId}')" class="text-red-600 hover:text-red-800 text-sm">삭제</button>
                    </div>
                </div>
            `;
        }).join('') || '<p class="text-gray-500">등록된 점검 기록이 없습니다.</p>';
    }

    // 수리 목록 렌더링
    function renderRepairList() {
        elements.repairListContainer.innerHTML = repairList.map(item => {
            const rtu = rtuList.find(r => r.docId === item.rtuDocId);
            const rtuName = rtu ? rtu.name : '알 수 없는 RTU';
            const isCompletedText = item.isCompleted === true || item.isCompleted === 'true' ? '완료' : '미완료';
            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center">
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="showDataDetail('repair', '${item.docId}')">
                        <p class="text-lg font-semibold text-orange-800 truncate">${rtuName} (${item.date})</p>
                        <p class="text-sm text-gray-600">담당자: ${item.technician} / 상태: ${isCompletedText}</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editData('repair', '${item.docId}')" class="text-yellow-600 hover:text-yellow-800 text-sm">수정</button>
                        <button onclick="deleteRepair('${item.docId}')" class="text-red-600 hover:text-red-800 text-sm">삭제</button>
                    </div>
                </div>
            `;
        }).join('') || '<p class="text-gray-500">등록된 수리 기록이 없습니다.</p>';
    }
    
    // CSV 다운로드 함수 (Firebase 연동)
    function downloadDataAsCsv() {
        alert('CSV 다운로드 기능이 곧 실행됩니다. (Firebase 데이터 기반)');
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        
        // RTU 목록
        csvContent += "=== RTU 목록 ===\n";
        const rtuHeaders = ["DocID", "Name", "Location", "Model", "Serial", "Manufacturer", "FirmwareVersion", "InstallDate", "WarrantyExpiration", "OperatingStatus", "Notes", "CreatedAt"];
        csvContent += rtuHeaders.join(",") + "\n";
        rtuList.forEach(item => {
            const row = [
                item.docId,
                `"${item.name.replace(/"/g, '""')}"`,
                `"${item.location.replace(/"/g, '""')}"`,
                `"${item.model || ''}"`,
                `"${item.serial || ''}"`,
                `"${item.manufacturer || ''}"`,
                `"${item.firmwareVersion || ''}"`,
                `"${item.installDate || ''}"`,
                `"${item.warrantyExpiration || ''}"`,
                `"${item.operatingStatus || ''}"`,
                `"${item.notes || ''}"`,
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });
        
        // 점검 기록
        csvContent += "\n=== 점검 기록 ===\n";
        const inspectionHeaders = ["DocID", "RTU_DocID", "Date", "Inspector", "Status", "Result", "CreatedAt"];
        csvContent += inspectionHeaders.join(",") + "\n";
        inspectionList.forEach(item => {
             const row = [
                item.docId,
                item.rtuDocId,
                `"${item.date || ''}"`,
                `"${item.inspector || ''}"`,
                `"${item.status || ''}"`,
                `"${item.result ? item.result.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });

        // 수리 기록
        csvContent += "\n=== 수리 기록 ===\n";
        const repairHeaders = ["DocID", "RTU_DocID", "Date", "Technician", "Content", "IsCompleted", "CreatedAt"];
        csvContent += repairHeaders.join(",") + "\n";
        repairList.forEach(item => {
             const row = [
                item.docId,
                item.rtuDocId,
                `"${item.date || ''}"`,
                `"${item.technician || ''}"`,
                `"${item.content ? item.content.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`,
                item.isCompleted ? 'TRUE' : 'FALSE',
                item.createdAt ? new Date(item.createdAt.toDate()).toISOString() : 'N/A'
            ].join(",");
            csvContent += row + "\n";
        });
        
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `RTU_Integrated_Data_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    // =================================================================
    // 7. 이벤트 리스너 및 초기화
    // =================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Firebase 데이터 로드 리스너 초기화
        initFirebaseListeners(); 
        
        // 초기 탭 설정
        switchTab('dashboard');

        // 등록 버튼 이벤트 연결
        document.getElementById('add-rtu-btn').addEventListener('click', () => openAddModal('rtu'));
        document.getElementById('add-inspection-btn').addEventListener('click', () => openAddModal('inspection'));
        document.getElementById('add-repair-btn').addEventListener('click', () => openAddModal('repair'));

        // 데이터 저장 폼 이벤트 연결
        elements.dataForm.addEventListener('submit', handleDataSubmit);

        // 모달 닫기 이벤트 연결
        elements.closeModalBtn.addEventListener('click', closeModal);
        elements.detailModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-bg')) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !elements.detailModal.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // 탭 버튼 이벤트 연결
        elements.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // 다운로드 버튼 로직 연결
        document.getElementById('download-data-btn').addEventListener('click', downloadDataAsCsv);
        
        // 전역 함수 등록 (HTML에서 호출 가능하도록)
        window.editData = editData;
        window.deleteRtu = deleteRtu;
        window.deleteInspection = deleteInspection;
        window.deleteRepair = deleteRepair;
        window.showDataDetail = showDataDetail;
        
        // 이미지 관련 기능은 Firebase Storage 연동이 필요하므로 알림 처리
        window.previewImage = () => alert("이미지 기능은 Firebase Storage 연동이 필요합니다.");
        window.openImageInNewTab = () => alert("이미지 기능은 Firebase Storage 연동이 필요합니다.");
    });
  </script>
</body>
</html>