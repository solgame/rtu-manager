<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (Firebase í´ë¼ìš°ë“œ ë™ê¸°í™”)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb í´ë˜ìŠ¤ê°€ ì´ë¯¸ì§€ë¿ë§Œ ì•„ë‹ˆë¼ í”Œë ˆì´ìŠ¤í™€ë”ì—ë„ ì ìš©ë˜ë„ë¡ ìœ ì§€í•©ë‹ˆë‹¤. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== ë³´ê³ ì„œ ì¸ì‡„ë¥¼ ìœ„í•œ CSS ì¶”ê°€ (print-onlyëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ) ========== */
    .print-only { display: none; } /* ê¸°ì¡´ ì½”ë“œì—ì„œ ë‚¨ì•„ìˆëŠ” print-onlyëŠ” display:none; ìƒíƒœ ìœ ì§€ */
    @media print {
      /* ì•±ì˜ ê¸°ë³¸ ë°°ê²½ê³¼ í…Œë‘ë¦¬ë¥¼ ìˆ¨ê²¨ ì¸ì‡„ ì˜ì—­ì„ ê¹”ë”í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. */
      .print-container, #main-app-container { /* ì¸ì‡„ ë¬¸ì œ í•´ê²°: ë©”ì¸ ì»¨í…Œì´ë„ˆ ê°•ì œ í‘œì‹œ */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* ì¸ì‡„ ì‹œ ìˆ¨ê²¨ì•¼ í•  ìš”ì†Œ (ë²„íŠ¼, ë©”ë‰´ ë“±) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* ì¸ì‡„ ì‹œ ìƒì„¸ ë³´ê³ ì„œ ë‚´ìš©ë§Œ í‘œì‹œë¥¼ ìœ„í•´ report-pageì™€ detail-viewë¥¼ ê°•ì œ í‘œì‹œ */
      #report-page, #report-detail-view { /* ì¸ì‡„ ë¬¸ì œ í•´ê²°: ë³´ê³ ì„œ ê´€ë ¨ ìš”ì†Œ ê°•ì œ í‘œì‹œ ë° ì •ë¦¬ */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* ìƒíƒœ íƒœê·¸ì˜ ë°°ê²½ìƒ‰ì€ ì¸ì‡„ ì‹œ ì œê±° */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* ì¸ì‡„ ì‹œ ì˜ ë³´ì´ë„ë¡ í…Œë‘ë¦¬ ì¶”ê°€ */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ë°ì´í„° CSV ì—…ë¡œë“œ
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ë°ì´í„° CSV ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU ë“±ë¡/ê´€ë¦¬</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">ì ê²€ ê¸°ë¡</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">ìˆ˜ë¦¬ ê¸°ë¡</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">ë³´ê³ ì„œ</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">ì´ ë“±ë¡ ì¥ë¹„ ìˆ˜</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">ì‘ë™ì¤‘</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">ì •ì§€ë¨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">ì ê²€ í•„ìš”</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ìµœê·¼ ì²˜ë¦¬ í˜„í™©</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">ì´ë²ˆ ë‹¬ ì ê²€ ê±´ìˆ˜</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">ë¯¸ì²˜ë¦¬ ìˆ˜ë¦¬ ìš”ì²­</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ê°œë³„ ì¥ë¹„ ìƒíƒœ (ìµœê·¼ ë“±ë¡/ìˆ˜ì •)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">ì‹ ê·œ ë“±ë¡</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">ì •ë³´ ìˆ˜ì •</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU ì¥ë¹„ ì‹ ê·œ ë“±ë¡</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU ë“±ë¡ë²ˆí˜¸/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­ *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">ëª¨ë¸ëª…</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">ìœ ë‹› ì¢…ë¥˜</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="íŒ¨í‚¤ì§€">íŒ¨í‚¤ì§€</option>
                    <option value="ì¹ ëŸ¬">ì¹ ëŸ¬</option>
                    <option value="ëƒ‰ê°íƒ‘">ëƒ‰ê°íƒ‘</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">ëƒ‰ë§¤ ì¢…ë¥˜</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">ì „ê¸° ì¢…ë¥˜</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ë‹¨ìƒ">ë‹¨ìƒ (Single Phase)</option>
                    <option value="ì‚¼ìƒ">ì‚¼ìƒ (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">í˜„ì¬ ìƒíƒœ *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ì‘ë™ì¤‘">ì‘ë™ì¤‘</option>
                    <option value="ì •ì§€ë¨">ì •ì§€ë¨</option>
                    <option value="ì ê²€í•„ìš”">ì ê²€í•„ìš”</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">ê³ ì•• ìƒí•œ ì„¤ì • (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">ì €ì•• í•˜í•œ ì„¤ì • (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">ì¥ë¹„ ì‚¬ì§„ (ìµœëŒ€ 3ì¥)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 1 ì—…ë¡œë“œ</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 2 ì—…ë¡œë“œ</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">ì‚¬ì§„ 3 ì—…ë¡œë“œ</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU ì •ë³´ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU ë“±ë¡ ëª©ë¡ (<span id="rtu-count">0</span>ê±´)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ RTU ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ì ê²€ ê¸°ë¡ ë“±ë¡</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">ì ê²€ ë‚ ì§œ *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">ì ê²€ì ì´ë¦„ *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">ë¶€í’ˆ ì ê²€ ìƒíƒœ</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. í•„í„°</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="êµì²´í•„ìš”">êµì²´í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. ì½˜í…í„°</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì†Œì†/êµì²´í•„ìš”">ì†Œì†/êµì²´í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. ì½˜ë´ì‹± ì½”ì¼</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                        <option value="ì˜¤ì—¼/ì²­ì†Œí•„ìš”">ì˜¤ì—¼/ì²­ì†Œí•„ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. ì†¡í’ ëª¨í„°</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì†ŒìŒ/ìˆ˜ë¦¬í•„ìš”">ì†ŒìŒ/ìˆ˜ë¦¬í•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. ì¦ë°œê¸° ì½”ì¼</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì–‘í˜¸">ì–‘í˜¸</option>
                        <option value="ì˜¤ì—¼/ì²­ì†Œí•„ìš”">ì˜¤ì—¼/ì²­ì†Œí•„ìš”</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. ê³ ì•• ì„¼ì„œ</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì˜¤ë¥˜">ì˜¤ë¥˜</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. ì €ì•• ì„¼ì„œ</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì˜¤ë¥˜">ì˜¤ë¥˜</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. ìºíŒ¨ì‹œí„°</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ë¶ˆëŸ‰">ë¶ˆëŸ‰</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">ìš´ì „ ìƒíƒœ ì¸¡ì • (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">ê³ ì•• (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">ì €ì•• (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">ì „ë¥˜ (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">ìš´ì „ ìƒíƒœ ì¸¡ì • (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">ê³ ì•• (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">ì €ì•• (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">ì „ë¥˜ (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">ì˜¨ë„ ì¸¡ì •</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">ê³¼ì—´ë„ (â„‰)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">ê³¼ëƒ‰ë„ (â„‰)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">ìµœì¢… ì ê²€ ê²°ê³¼ *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ì •ìƒ">ì •ìƒ</option>
                    <option value="ì£¼ì˜">ì£¼ì˜</option>
                    <option value="ì ê²€í•„ìš”">ì ê²€í•„ìš”</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">ì ê²€ ê¸°ë¡ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">ì ê²€ ê¸°ë¡ ëª©ë¡ (<span id="inspection-count">0</span>ê±´)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ ì ê²€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ìˆ˜ë¦¬ ê¸°ë¡ ë“±ë¡</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">ëŒ€ìƒ RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">ìˆ˜ë¦¬ ë‹´ë‹¹ì *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">ì²˜ë¦¬ ìƒíƒœ *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="ìš”ì²­">ìš”ì²­ (ë¯¸ì²˜ë¦¬)</option>
                    <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                    <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš© *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">ìˆ˜ë¦¬ ê¸°ë¡ ì €ì¥</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">ìˆ˜ë¦¬ ê¸°ë¡ ëª©ë¡ (<span id="repair-count">0</span>ê±´)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">ë“±ë¡ëœ ìˆ˜ë¦¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">ì‹œìŠ¤í…œ ìš´ì˜ ë³´ê³ ì„œ</h2>
          <p class="text-gray-600 mb-6 print-hidden">ì•„ë˜ ìš”ì•½ í•­ëª©ì„ í´ë¦­í•˜ì‹œë©´ ìƒì„¸ ëª©ë¡ì„ í™•ì¸í•˜ê³  ì¸ì‡„í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ–¨ï¸</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="report-rtu-summary" class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 cursor-pointer hover:bg-indigo-100 transition duration-150">
              <p class="text-sm font-medium text-indigo-600">ì´ ë“±ë¡ RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div id="report-inspection-summary" class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200 cursor-pointer hover:bg-pink-100 transition duration-150">
              <p class="text-sm font-medium text-pink-600">ì´ ì ê²€ ê¸°ë¡ ê±´ìˆ˜</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div id="report-repair-summary" class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200 cursor-pointer hover:bg-teal-100 transition duration-150">
              <p class="text-sm font-medium text-teal-600">ì´ ìˆ˜ë¦¬ ê¸°ë¡ ê±´ìˆ˜</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>
          <div id="report-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-lg border hidden">
            <div class="flex justify-between items-center mb-4">
              <h3 id="report-title" class="text-2xl font-bold text-gray-800"></h3>
              <button id="report-print-btn" onclick="window.print()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 text-sm print-hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"/>
                </svg>
                ë³´ê³ ì„œ ì¸ì‡„
              </button>
            </div>
            <div id="report-content" class="overflow-x-auto">
              </div>
            <button id="report-back-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150 text-sm mt-6 print-hidden">
              ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="image-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg">
    <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg shadow-2xl p-4">
      <img id="modal-image" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-full max-h-[80vh] object-contain">
      <button id="close-modal-btn" class="absolute top-0 right-0 m-4 text-white bg-gray-800 rounded-full p-2 hover:bg-gray-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script type="module">
    // Firebase ì„¤ì •
    const firebaseConfig = { 
      // ì´ì „ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•˜ì‹œë˜ ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ Firebase ì„¤ì • ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      // ë°ì´í„°ê°€ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ì´ ì„¤ì •ì€ ì„ì˜ì˜ ê°’ìœ¼ë¡œ ë‘ê² ìŠµë‹ˆë‹¤.
      // ë§Œì•½ ë°ì´í„°ê°€ ì—¬ì „íˆ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤ë©´, ì´ ë¶€ë¶„ì„ ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ ì„¤ì • ì •ë³´ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57...",
      authDomain: "rtu-management-system.firebaseapp.com",
      databaseURL: "https://rtu-management-system-default-rtdb.firebaseio.com",
      projectId: "rtu-management-system",
      storageBucket: "rtu-management-system.appspot.com",
      messagingSenderId: "1056580649987",
      appId: "1:1056580649987:web:f1c5049b4938d227d8e85f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();
    const storageRef = storage.ref();

    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
    const itemsPerPage = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    // DOM ìš”ì†Œ ìºì‹œ
    const elements = {
        // Tabs
        tabButtons: document.querySelectorAll('.tab-btn'),
        tabPages: document.querySelectorAll('.tab-page'),
        // Dashboard
        dashboardTotal: document.getElementById('dashboard-total'),
        dashboardRunning: document.getElementById('dashboard-running'),
        dashboardStopped: document.getElementById('dashboard-stopped'),
        dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
        dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
        dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
        dashboardLatestList: document.getElementById('dashboard-latest-list'),
        // RTU Manage
        modeNewBtn: document.getElementById('mode-new-btn'),
        modeModifyBtn: document.getElementById('mode-modify-btn'),
        rtuFormTitle: document.getElementById('rtu-form-title'),
        rtuForm: document.getElementById('rtu-form'),
        rtuIdContainer: document.getElementById('rtu-id-container'),
        rtuNameInput: document.getElementById('rtu-name'),
        rtuModifySelect: document.getElementById('rtu-modify-select'),
        rtuIdForModification: document.getElementById('rtu-id-for-modification'),
        rtuListContainer: document.getElementById('rtu-list'),
        rtuCount: document.getElementById('rtu-count'),
        rtuPagination: document.getElementById('rtu-pagination'),
        rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        imagePreview1: document.getElementById('image-preview-1'),
        imagePreview2: document.getElementById('image-preview-2'),
        imagePreview3: document.getElementById('image-preview-3'),
        rtuImage1: document.getElementById('rtu-image1'),
        rtuImage2: document.getElementById('rtu-image2'),
        rtuImage3: document.getElementById('rtu-image3'),
        // Inspection Manage
        inspectionRtuId: document.getElementById('inspection-rtu-id'),
        inspectionForm: document.getElementById('inspection-form'),
        inspectionListContainer: document.getElementById('inspection-list'),
        inspectionCount: document.getElementById('inspection-count'),
        inspectionPagination: document.getElementById('inspection-pagination'),
        // Repair Manage
        repairRtuId: document.getElementById('repair-rtu-id'),
        repairForm: document.getElementById('repair-form'),
        repairListContainer: document.getElementById('repair-list'),
        repairCount: document.getElementById('repair-count'),
        repairPagination: document.getElementById('repair-pagination'),
        // Modal
        imageModal: document.getElementById('image-modal'),
        modalImage: document.getElementById('modal-image'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        // Report
        reportRtuSummary: document.getElementById('report-rtu-summary'),
        reportInspectionSummary: document.getElementById('report-inspection-summary'),
        reportRepairSummary: document.getElementById('report-repair-summary'),
        reportTotalRtu: document.getElementById('report-total-rtu'),
        reportTotalInspection: document.getElementById('report-total-inspection'),
        reportTotalRepair: document.getElementById('report-total-repair'),
        reportDetailView: document.getElementById('report-detail-view'),
        reportTitle: document.getElementById('report-title'),
        reportContent: document.getElementById('report-content'),
        reportBackBtn: document.getElementById('report-back-btn'),
        reportPage: document.getElementById('report-page'),
        // CSV
        csvUpload: document.getElementById('csv-upload'),
        downloadDataBtn: document.getElementById('download-data-btn')
    };

    /* ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==================== */

    /**
     * ìƒíƒœì— ë”°ë¥¸ Tailwind CSS ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     * @param {string} status RTU ìƒíƒœ ë¬¸ìì—´
     * @returns {string} Tailwind CSS í´ë˜ìŠ¤
     */
    function getStatusColor(status) {
        switch (status) {
            case 'ì‘ë™ì¤‘': return 'bg-green-100 text-green-800';
            case 'ì •ì§€ë¨': return 'bg-gray-100 text-gray-800';
            case 'ì ê²€í•„ìš”': return 'bg-red-100 text-red-800';
            case 'ì£¼ì˜': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-slate-100 text-slate-800';
        }
    }

    /**
     * Unix Timestampë¥¼ 'YYYY-MM-DD' í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {number} timestamp Unix íƒ€ì„ìŠ¤íƒ¬í”„
     * @returns {string} ë‚ ì§œ ë¬¸ìì—´
     */
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toISOString().split('T')[0];
    }
    
    /**
     * íŒŒì¼ ì´ë¦„ì—ì„œ í™•ì¥ìë¥¼ ì œê±°í•œ IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
     * @param {string} fullFileName ì „ì²´ íŒŒì¼ ì´ë¦„
     * @returns {string} íŒŒì¼ ID
     */
    function getFileIdFromStoragePath(fullPath) {
        // fullPath: rtu_images/RTU-001/RTU-001_1_1678886400000.jpg
        const parts = fullPath.split('/');
        const fileNameWithExt = parts[parts.length - 1]; // RTU-001_1_1678886400000.jpg
        const fileNameParts = fileNameWithExt.split('_'); // [RTU-001, 1, 1678886400000.jpg]
        if (fileNameParts.length < 3) return '';
        // RTU ID + index (RTU-001_1)
        return `${fileNameParts[0]}_${fileNameParts[1]}`; 
    }

    /**
     * íŒŒì¼ ì´ë¦„ì„ ì¸ë±ìŠ¤(1, 2, 3)ë³„ë¡œ ì •ë¦¬í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
     * @param {Array<string>} fileList Storage path ë°°ì—´
     * @param {string} rtuName RTU ID
     * @returns {Object<string, string>} ì¸ë±ìŠ¤ë³„ URL (e.g., {'1': 'url1', '2': 'url2'})
     */
    function organizeImages(fileList, rtuName) {
        const organized = {};
        if (!fileList || fileList.length === 0) return organized;
        
        fileList.forEach(url => {
            const parts = url.split('/');
            const filename = parts[parts.length - 1]; // íŒŒì¼ëª…: RTU-001_1_timestamp.jpg
            if (filename.startsWith(rtuName)) {
                const indexMatch = filename.match(/_(\d+)_/);
                if (indexMatch) {
                    const index = indexMatch[1];
                    organized[index] = url;
                }
            }
        });
        return organized;
    }

    /* ==================== Firebase ë°ì´í„° ê´€ë¦¬ ==================== */

    /**
     * Firebaseì—ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
     * @returns {Promise<void>}
     */
    async function loadFromFirebase() {
      // RTU ë°ì´í„° ë¡œë“œ
      const rtuSnapshot = await database.ref('rtu').once('value');
      const rtuObj = rtuSnapshot.val() || {};
      rtuList = Object.keys(rtuObj).map(key => ({ id: key, ...rtuObj[key] })).reverse();
      
      // ì ê²€ ê¸°ë¡ ë¡œë“œ
      const inspectionSnapshot = await database.ref('inspection').once('value');
      const inspectionObj = inspectionSnapshot.val() || {};
      inspectionList = Object.keys(inspectionObj).map(key => ({ id: key, ...inspectionObj[key] })).reverse();

      // ìˆ˜ë¦¬ ê¸°ë¡ ë¡œë“œ
      const repairSnapshot = await database.ref('repair').once('value');
      const repairObj = repairSnapshot.val() || {};
      repairList = Object.keys(repairObj).map(key => ({ id: key, ...repairObj[key] })).reverse();

      console.log(`Loaded ${rtuList.length} RTUs, ${inspectionList.length} Inspections, ${repairList.length} Repairs.`);
    }

    /**
     * ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥í•˜ê³  ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     * @param {string} refPath ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ('rtu', 'inspection', 'repair')
     * @param {Object} data ì €ì¥í•  ë°ì´í„° ê°ì²´
     * @param {string | null} id ìˆ˜ì •í•  ê²½ìš°ì˜ ID (ì‹ ê·œ ë“±ë¡ì´ë©´ null)
     * @returns {Promise<boolean>}
     */
    async function saveToFirebase(refPath, data, id = null) {
      try {
        if (id) {
          // ìˆ˜ì •
          await database.ref(`${refPath}/${id}`).update({
            ...data,
            lastUpdated: Date.now() // ìˆ˜ì • ì‹œê° ì—…ë°ì´íŠ¸
          });
        } else {
          // ì‹ ê·œ ë“±ë¡
          await database.ref(refPath).push({
            ...data,
            date: data.date || formatTimestamp(Date.now()),
            lastUpdated: Date.now() 
          });
        }
        return true;
      } catch (error) {
        console.error("Firebase ì €ì¥ ì‹¤íŒ¨:", error);
        return false;
      }
    }

    /**
     * Firebase Storageì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
     * @param {string} rtuId RTU ID
     * @param {File} file ì—…ë¡œë“œí•  íŒŒì¼ ê°ì²´
     * @param {number} index ì´ë¯¸ì§€ ì¸ë±ìŠ¤ (1, 2, 3)
     * @returns {Promise<string>} íŒŒì¼ ë‹¤ìš´ë¡œë“œ URL
     */
    async function uploadImage(rtuId, file, index) {
      const timestamp = Date.now();
      const fileName = `${rtuId}_${index}_${timestamp}.jpg`; // ê³ ìœ í•œ íŒŒì¼ ì´ë¦„ ìƒì„±
      const imageRef = storageRef.child(`rtu_images/${rtuId}/${fileName}`);
      
      const snapshot = await imageRef.put(file);
      const downloadURL = await snapshot.ref.getDownloadURL();
      return downloadURL;
    }

    /**
     * íŠ¹ì • RTUì˜ ê¸°ì¡´ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ Storageì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.
     * @param {string} rtuId RTU ID
     * @param {Array<string>} urlsToDelete ì‚­ì œí•  ì´ë¯¸ì§€ URL ëª©ë¡
     * @returns {Promise<void>}
     */
    async function deleteImages(rtuId, urlsToDelete) {
        if (!urlsToDelete || urlsToDelete.length === 0) return;

        const deletePromises = urlsToDelete.map(url => {
            // URLì—ì„œ storage referenceë¥¼ ì¶”ì¶œ
            const path = url.split('?')[0].split('%2F').slice(1).join('/');
            const encodedPath = decodeURIComponent(path);
            
            // Storage ì°¸ì¡° ìƒì„±
            const fileRef = storage.refFromURL(url);
            
            // íŒŒì¼ ì‚­ì œ
            return fileRef.delete().catch(error => {
                // íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ì˜ˆì™¸ ì²˜ë¦¬)
                if (error.code !== 'storage/object-not-found') {
                    console.error("íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:", fileRef.fullPath, error);
                }
            });
        });

        await Promise.all(deletePromises);
        console.log(`Deleted ${urlsToDelete.length} images for ${rtuId}.`);
    }

    /* ==================== RTU ë“±ë¡/ìˆ˜ì • ëª¨ë“œ ê´€ë¦¬ ==================== */

    /**
     * RTU í¼ì˜ ëª¨ë“œë¥¼ ì‹ ê·œ ë“±ë¡ ë˜ëŠ” ì •ë³´ ìˆ˜ì •ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
     * @param {string} mode 'new' ë˜ëŠ” 'modify'
     */
    function setRtuFormMode(mode) {
        if (mode === 'new') {
            elements.rtuFormTitle.textContent = "RTU ì¥ë¹„ ì‹ ê·œ ë“±ë¡";
            elements.rtuNameInput.classList.remove('hidden');
            elements.rtuNameInput.required = true;
            elements.rtuModifySelect.classList.add('hidden');
            elements.rtuModifySelect.required = false;
            elements.rtuSubmitBtn.textContent = "RTU ì •ë³´ ì €ì¥";
            elements.rtuIdForModification.value = '';
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
        } else if (mode === 'modify') {
            elements.rtuFormTitle.textContent = "RTU ì¥ë¹„ ì •ë³´ ìˆ˜ì •";
            elements.rtuNameInput.classList.add('hidden');
            elements.rtuNameInput.required = false;
            elements.rtuModifySelect.classList.remove('hidden');
            elements.rtuModifySelect.required = true;
            elements.rtuSubmitBtn.textContent = "RTU ì •ë³´ ìˆ˜ì •";
            
            // ìˆ˜ì • ëª¨ë“œ ì§„ì… ì‹œ, ì„ íƒ ë°•ìŠ¤ ì´ˆê¸°í™”
            elements.rtuModifySelect.value = '';
            // í¼ í•„ë“œ ì´ˆê¸°í™” (ì„ íƒ ì „)
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
        }
        elements.modeNewBtn.classList.toggle('bg-blue-600', mode === 'new');
        elements.modeNewBtn.classList.toggle('text-white', mode === 'new');
        elements.modeNewBtn.classList.toggle('bg-gray-200', mode === 'modify');
        elements.modeNewBtn.classList.toggle('text-gray-700', mode === 'modify');

        elements.modeModifyBtn.classList.toggle('bg-blue-600', mode === 'modify');
        elements.modeModifyBtn.classList.toggle('text-white', mode === 'modify');
        elements.modeModifyBtn.classList.toggle('bg-gray-200', mode === 'new');
        elements.modeModifyBtn.classList.toggle('text-gray-700', mode === 'new');
    }

    /**
     * ìˆ˜ì • í¼ì— RTU ì •ë³´ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
     * @param {string} rtuId RTU ID
     */
    function loadRtuForModification(rtuId) {
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) {
            alert("ì„ íƒëœ RTU ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
            return;
        }

        // í¼ í•„ë“œ ì±„ìš°ê¸°
        elements.rtuIdForModification.value = rtu.id;
        document.getElementById('rtu-region').value = rtu.region || '';
        document.getElementById('rtu-model').value = rtu.model || '';
        document.getElementById('rtu-capacity').value = rtu.capacity || '';
        document.getElementById('rtu-unit-type').value = rtu.unitType || 'íŒ¨í‚¤ì§€';
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase || 'ë‹¨ìƒ';
        document.getElementById('rtu-date').value = rtu.date || '';
        document.getElementById('rtu-status').value = rtu.status || 'ì‘ë™ì¤‘';
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
        document.getElementById('rtu-notes').value = rtu.notes || '';

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ê¸°ì¡´ URL ì„¤ì •
        clearImagePreviews();
        const rtuImages = organizeImages(rtu.imageUrls, rtu.name);
        
        ['1', '2', '3'].forEach(index => {
            const url = rtuImages[index];
            if (url) {
                const imgElement = document.getElementById(`image-preview-${index}`);
                imgElement.src = url;
                imgElement.style.display = 'block';
                imgElement.dataset.existingUrl = url; // ê¸°ì¡´ URL ì €ì¥
            } else {
                // ê¸°ì¡´ URLì´ ì—†ë”ë¼ë„, í¼ ì œì¶œ ì‹œ ë¹„ì–´ìˆëŠ” ìƒíƒœë¡œ ì „ì†¡ë  ìˆ˜ ìˆë„ë¡ data ì†ì„± ì´ˆê¸°í™”
                const imgElement = document.getElementById(`image-preview-${index}`);
                delete imgElement.dataset.existingUrl;
            }
        });
        elements.imagePreviewContainer.classList.remove('hidden');
    }

    /**
     * ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     */
    function clearImagePreviews() {
        ['1', '2', '3'].forEach(index => {
            const imgElement = document.getElementById(`image-preview-${index}`);
            imgElement.src = '';
            imgElement.style.display = 'none';
            delete imgElement.dataset.existingUrl;
            // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ì—…ë¡œë“œ ë²„íŠ¼ì´ ì•„ë‹Œ ì‹¤ì œ input í•„ë“œ)
            const fileInput = document.getElementById(`rtu-image${index}`);
            fileInput.value = '';
        });
    }

    /* ==================== RTU ë Œë”ë§ ë° í˜ì´ì§€ë„¤ì´ì…˜ ==================== */

    /**
     * RTU ëª©ë¡ì„ ë Œë”ë§í•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     * @param {number} page í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
     */
    function renderRtuList(page) {
        rtuCurrentPage = page;
        const totalItems = rtuList.length;
        elements.rtuCount.textContent = totalItems;
        elements.rtuListContainer.innerHTML = '';
        elements.rtuPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.rtuListContainer.innerHTML = '<p class="text-gray-500 italic">ë“±ë¡ëœ RTU ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = rtuList.slice(start, end);

        paginatedItems.forEach(rtu => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-gray-50 rounded-xl shadow-md border hover:bg-gray-100 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-blue-700">${rtu.name}</h3>
                        <p class="text-sm text-gray-600">${rtu.region} | ${rtu.model || 'ëª¨ë¸ ì •ë³´ ì—†ìŒ'}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(rtu.status)}">
                        ${rtu.status}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>ìœ ë‹› ì¢…ë¥˜:</strong> ${rtu.unitType || '-'}</p>
                    <p><strong>ìš©ëŸ‰:</strong> ${rtu.capacity || '-'} | <strong>ëƒ‰ë§¤:</strong> ${rtu.refrigerant || '-'}</p>
                    <p><strong>ì„¤ì¹˜ ë‚ ì§œ:</strong> ${rtu.date}</p>
                    <p><strong>íŠ¹ì´ì‚¬í•­:</strong> ${rtu.notes ? rtu.notes.substring(0, 50) + (rtu.notes.length > 50 ? '...' : '') : 'ì—†ìŒ'}</p>
                </div>
                <div class="mt-4 flex space-x-3 text-sm">
                    <button data-rtu-id="${rtu.id}" class="view-detail-btn text-blue-600 font-semibold hover:text-blue-800 transition">ìƒì„¸ ë³´ê¸°</button>
                    <button data-rtu-id="${rtu.id}" class="edit-btn text-indigo-600 font-semibold hover:text-indigo-800 transition">ìˆ˜ì •</button>
                    <button data-rtu-id="${rtu.id}" class="delete-btn text-red-600 font-semibold hover:text-red-800 transition">ì‚­ì œ</button>
                </div>
            `;
            elements.rtuListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderRtuList, elements.rtuPagination);
    }

    /* ==================== ì ê²€ ê¸°ë¡ ë Œë”ë§ ==================== */
    
    /**
     * ì ê²€ ê¸°ë¡ ëª©ë¡ì„ ë Œë”ë§í•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     * @param {number} page í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
     */
    function renderInspectionList(page) {
        inspectionCurrentPage = page;
        const totalItems = inspectionList.length;
        elements.inspectionCount.textContent = totalItems;
        elements.inspectionListContainer.innerHTML = '';
        elements.inspectionPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.inspectionListContainer.innerHTML = '<p class="text-gray-500 italic">ë“±ë¡ëœ ì ê²€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = inspectionList.slice(start, end);

        paginatedItems.forEach(inspection => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-white rounded-xl shadow-md border hover:bg-gray-50 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-gray-800">${inspection.rtuId} ì ê²€ ê¸°ë¡</h3>
                        <p class="text-sm text-gray-600">ì ê²€ ë‚ ì§œ: <strong>${inspection.inspectionDate}</strong> | ì ê²€ì: ${inspection.inspector}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(inspection.result)}">
                        ${inspection.result}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>Comp1 ì••ë ¥:</strong> ${inspection.comp1Hp || '-'}PSI / ${inspection.comp1Lp || '-'}PSI (H/L)</p>
                    <p><strong>Comp2 ì••ë ¥:</strong> ${inspection.comp2Hp || '-'}PSI / ${inspection.comp2Lp || '-'}PSI (H/L)</p>
                    <p><strong>íŠ¹ì´ì‚¬í•­:</strong> ${inspection.notes ? inspection.notes.substring(0, 50) + (inspection.notes.length > 50 ? '...' : '') : 'ì—†ìŒ'}</p>
                </div>
                <div class="mt-4 flex space-x-3 text-sm">
                    <button data-inspection-id="${inspection.id}" class="view-inspection-detail-btn text-blue-600 font-semibold hover:text-blue-800 transition">ìƒì„¸ ë³´ê¸°</button>
                </div>
            `;
            elements.inspectionListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderInspectionList, elements.inspectionPagination);
    }
    
    /* ==================== ìˆ˜ë¦¬ ê¸°ë¡ ë Œë”ë§ ==================== */

    /**
     * ìˆ˜ë¦¬ ê¸°ë¡ ëª©ë¡ì„ ë Œë”ë§í•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     * @param {number} page í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
     */
    function renderRepairList(page) {
        repairCurrentPage = page;
        const totalItems = repairList.length;
        elements.repairCount.textContent = totalItems;
        elements.repairListContainer.innerHTML = '';
        elements.repairPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.repairListContainer.innerHTML = '<p class="text-gray-500 italic">ë“±ë¡ëœ ìˆ˜ë¦¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = repairList.slice(start, end);

        paginatedItems.forEach(repair => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-white rounded-xl shadow-md border hover:bg-gray-50 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-gray-800">${repair.rtuId} ìˆ˜ë¦¬ ê¸°ë¡</h3>
                        <p class="text-sm text-gray-600">ì²˜ë¦¬ ë‚ ì§œ: <strong>${repair.repairDate}</strong> | ë‹´ë‹¹ì: ${repair.engineer}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(repair.status)}">
                        ${repair.status}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>ë¬¸ì œ/ì¡°ì¹˜:</strong> ${repair.issue ? repair.issue.substring(0, 70) + (repair.issue.length > 70 ? '...' : '') : 'ë‚´ìš© ì—†ìŒ'}</p>
                </div>
            `;
            elements.repairListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderRepairList, elements.repairPagination);
    }
    
    /* ==================== í˜ì´ì§€ë„¤ì´ì…˜ í•¨ìˆ˜ ==================== */

    /**
     * í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
     * @param {number} totalPages ì „ì²´ í˜ì´ì§€ ìˆ˜
     * @param {number} currentPage í˜„ì¬ í˜ì´ì§€
     * @param {function(number): void} renderFunction í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜
     * @param {HTMLElement} container í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì„ ë„£ì„ ì»¨í…Œì´ë„ˆ
     */
    function renderPagination(totalPages, currentPage, renderFunction, container) {
        container.innerHTML = '';
        if (totalPages <= 1) return;

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        const createButton = (text, pageNum, isDisabled = false) => {
            const button = document.createElement('button');
            button.className = `pagination-btn px-4 py-2 mx-1 text-sm rounded-lg transition duration-150 ${isDisabled ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`;
            if (pageNum === currentPage && !isDisabled) {
                button.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
            button.textContent = text;
            button.disabled = isDisabled;
            if (!isDisabled) {
                button.addEventListener('click', () => renderFunction(pageNum));
            }
            return button;
        };

        // ì´ì „ ë²„íŠ¼
        container.appendChild(createButton('ì´ì „', currentPage - 1, currentPage === 1));

        // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
        for (let i = startPage; i <= endPage; i++) {
            container.appendChild(createButton(i, i));
        }

        // ë‹¤ìŒ ë²„íŠ¼
        container.appendChild(createButton('ë‹¤ìŒ', currentPage + 1, currentPage === totalPages));
    }

    /* ==================== ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ ==================== */

    /**
     * RTU ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  RTU ì„ íƒ ë°•ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    function populateRtuSelects() {
        const selects = [
            elements.rtuModifySelect, 
            elements.inspectionRtuId, 
            elements.repairRtuId
        ];

        selects.forEach(select => {
            const originalValue = select.value;
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = select.id === 'rtu-modify-select' ? '-- ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --' : '-- RTUë¥¼ ì„ íƒí•˜ì„¸ìš” --';
            select.appendChild(defaultOption);

            rtuList.forEach(rtu => {
                const option = document.createElement('option');
                option.value = rtu.id;
                option.textContent = `${rtu.name} (${rtu.region})`;
                select.appendChild(option);
            });
            // ê¸°ì¡´ ì„ íƒ ê°’ ë³µì›
            select.value = originalValue;
        });

        // ìˆ˜ì • ëª¨ë“œ ì‹œ RTU ì´ë¦„ ì…ë ¥ í•„ë“œë¥¼ ì„ íƒëœ RTU IDë¡œ ìë™ ì—…ë°ì´íŠ¸
        if (elements.rtuModifySelect.value) {
             elements.rtuNameInput.value = elements.rtuModifySelect.value;
        }
    }

    /* ==================== ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ==================== */

    /**
     * ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    function updateDashboard() {
        // Total RTU Count
        elements.dashboardTotal.textContent = rtuList.length;

        // Status Counts
        const statusCounts = rtuList.reduce((acc, rtu) => {
            acc[rtu.status] = (acc[rtu.status] || 0) + 1;
            return acc;
        }, {});

        elements.dashboardRunning.textContent = statusCounts['ì‘ë™ì¤‘'] || 0;
        elements.dashboardStopped.textContent = statusCounts['ì •ì§€ë¨'] || 0;
        elements.dashboardNeedsInspection.textContent = statusCounts['ì ê²€í•„ìš”'] || 0;

        // Monthly Inspection Count (current month)
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
        elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

        // Pending Repair Count (ìš”ì²­ ë˜ëŠ” ì§„í–‰ì¤‘)
        const pendingRepairCount = repairList.filter(repair => repair.status === 'ìš”ì²­' || repair.status === 'ì§„í–‰ì¤‘').length;
        elements.dashboardPendingRepair.textContent = pendingRepairCount;

        // Latest RTU List
        const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);

        if (latestRtu.length === 0) {
            elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
                <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
                </div>
            `).join('');
        }

        // Report Page Update (Summary)
        elements.reportTotalRtu.textContent = rtuList.length;
        elements.reportTotalInspection.textContent = inspectionList.length;
        elements.reportTotalRepair.textContent = repairList.length;
    }

    /* ==================== CSV ì²˜ë¦¬ í•¨ìˆ˜ ==================== */

    /**
     * JSON ë°ì´í„°ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {Array<Object>} data ë³€í™˜í•  ë°ì´í„° ë°°ì—´
     * @param {Array<string>} headers CSV í—¤ë” ì´ë¦„ ë°°ì—´
     * @param {Object} keyMap ë°ì´í„° ê°ì²´ì˜ í‚¤ì™€ í—¤ë” ì´ë¦„ì˜ ë§¤í•‘
     * @returns {string} CSV ë¬¸ìì—´
     */
    function convertToCSV(data, headers, keyMap) {
        if (data.length === 0) return headers.join(',') + '\n';
        
        const headerRow = headers.join(',') + '\n';
        
        const rows = data.map(item => {
            const values = headers.map(header => {
                const key = keyMap[header];
                let value = item[key] !== undefined && item[key] !== null ? item[key] : '';
                
                if (typeof value === 'string') {
                    // ì‰¼í‘œë‚˜ ë”°ì˜´í‘œê°€ í¬í•¨ëœ ê²½ìš° ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    value = value.replace(/"/g, '""');
                    if (value.includes(',') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                }
                return value;
            });
            return values.join(',');
        }).join('\n');

        return headerRow + rows;
    }

    /**
     * CSV ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
     */
    function downloadData() {
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;

        // 1. RTU ë°ì´í„°
        const rtuHeaders = ["ID", "RTU ë“±ë¡ë²ˆí˜¸/ID", "ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­", "ëª¨ë¸ëª…", "ìœ ë‹› ì¢…ë¥˜", "ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)", "ëƒ‰ë§¤ ì¢…ë¥˜", "ì „ê¸° ì¢…ë¥˜", "ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ", "í˜„ì¬ ìƒíƒœ", "ê³ ì•• ìƒí•œ ì„¤ì • (PSI)", "ì €ì•• í•˜í•œ ì„¤ì • (PSI)", "íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨", "ì´ë¯¸ì§€ URL ëª©ë¡", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„"];
        const rtuKeyMap = {
            "ID": "id", "RTU ë“±ë¡ë²ˆí˜¸/ID": "name", "ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­": "region", "ëª¨ë¸ëª…": "model", "ìœ ë‹› ì¢…ë¥˜": "unitType", "ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)": "capacity", "ëƒ‰ë§¤ ì¢…ë¥˜": "refrigerant", "ì „ê¸° ì¢…ë¥˜": "electricPhase", "ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ": "date", "í˜„ì¬ ìƒíƒœ": "status", "ê³ ì•• ìƒí•œ ì„¤ì • (PSI)": "pressureHighLimit", "ì €ì•• í•˜í•œ ì„¤ì • (PSI)": "pressureLowLimit", "íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨": "notes", 
            "ì´ë¯¸ì§€ URL ëª©ë¡": "imageUrls", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„": "lastUpdated"
        };
        const rtuDataForCSV = rtuList.map(item => ({
            ...item,
            imageUrls: (item.imageUrls || []).join(' | ') // URL ëª©ë¡ì„ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©
        }));
        const rtuCsv = convertToCSV(rtuDataForCSV, rtuHeaders, rtuKeyMap);
        downloadFile(rtuCsv, `RTU_Data_${dateString}.csv`);

        // 2. ì ê²€ ê¸°ë¡
        const inspectionHeaders = ["ID", "RTU ID", "ì ê²€ ë‚ ì§œ", "ì ê²€ì", "ìµœì¢… ì ê²€ ê²°ê³¼", "1. í•„í„°", "2. ì½˜í…í„°", "3. ì½˜ë´ì‹± ì½”ì¼", "4. ì†¡í’ ëª¨í„°", "5. ì¦ë°œê¸° ì½”ì¼", "6. ê³ ì•• ì„¼ì„œ", "7. ì €ì•• ì„¼ì„œ", "8. ìºíŒ¨ì‹œí„°", "Comp1 ê³ ì••(PSI)", "Comp1 ì €ì••(PSI)", "Comp1 ì „ë¥˜(A)", "Comp2 ê³ ì••(PSI)", "Comp2 ì €ì••(PSI)", "Comp2 ì „ë¥˜(A)", "ê³¼ì—´ë„(F)", "ê³¼ëƒ‰ë„(F)", "íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„"];
        const inspectionKeyMap = {
            "ID": "id", "RTU ID": "rtuId", "ì ê²€ ë‚ ì§œ": "inspectionDate", "ì ê²€ì": "inspector", "ìµœì¢… ì ê²€ ê²°ê³¼": "result", "1. í•„í„°": "check1", "2. ì½˜í…í„°": "check2", "3. ì½˜ë´ì‹± ì½”ì¼": "check3", "4. ì†¡í’ ëª¨í„°": "check4", "5. ì¦ë°œê¸° ì½”ì¼": "check5", "6. ê³ ì•• ì„¼ì„œ": "check6", "7. ì €ì•• ì„¼ì„œ": "check7", "8. ìºíŒ¨ì‹œí„°": "check8", "Comp1 ê³ ì••(PSI)": "comp1Hp", "Comp1 ì €ì••(PSI)": "comp1Lp", "Comp1 ì „ë¥˜(A)": "comp1Amp", "Comp2 ê³ ì••(PSI)": "comp2Hp", "Comp2 ì €ì••(PSI)": "comp2Lp", "Comp2 ì „ë¥˜(A)": "comp2Amp", "ê³¼ì—´ë„(F)": "superheat", "ê³¼ëƒ‰ë„(F)": "subcool", "íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©": "notes", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„": "lastUpdated"
        };
        const inspectionCsv = convertToCSV(inspectionList, inspectionHeaders, inspectionKeyMap);
        downloadFile(inspectionCsv, `Inspection_Data_${dateString}.csv`);

        // 3. ìˆ˜ë¦¬ ê¸°ë¡
        const repairHeaders = ["ID", "RTU ID", "ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ", "ìˆ˜ë¦¬ ë‹´ë‹¹ì", "ì²˜ë¦¬ ìƒíƒœ", "ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„"];
        const repairKeyMap = {
            "ID": "id", "RTU ID": "rtuId", "ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ": "repairDate", "ìˆ˜ë¦¬ ë‹´ë‹¹ì": "engineer", "ì²˜ë¦¬ ìƒíƒœ": "status", "ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©": "issue", "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„": "lastUpdated"
        };
        const repairCsv = convertToCSV(repairList, repairHeaders, repairKeyMap);
        downloadFile(repairCsv, `Repair_Data_${dateString}.csv`);
        
        alert("RTU, ì ê²€ ê¸°ë¡, ìˆ˜ë¦¬ ê¸°ë¡ 3ê°€ì§€ ë°ì´í„° íŒŒì¼ì´ ëª¨ë‘ ë‹¤ìš´ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    /**
     * CSV ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
     * @param {string} content íŒŒì¼ ë‚´ìš© (CSV ë¬¸ìì—´)
     * @param {string} fileName íŒŒì¼ ì´ë¦„
     */
    function downloadFile(content, fileName) {
        const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    /* ==================== CSV ì—…ë¡œë“œ í•¨ìˆ˜ ==================== */

    /**
     * CSV íŒŒì¼ì„ ì½ê³  JSON ë°ì´í„°ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {File} file ì—…ë¡œë“œëœ CSV íŒŒì¼
     * @returns {Promise<Object>} { headers: Array<string>, data: Array<Object> }
     */
    function readCsvFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length === 0) {
                        return reject(new Error('íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'));
                    }
                    
                    // ì²« ë²ˆì§¸ ì¤„ì„ í—¤ë”ë¡œ ì²˜ë¦¬í•˜ê³  ë”°ì˜´í‘œ ì œê±°
                    let headers = lines[0].split(',').map(h => h.trim().replace(/^"(.*)"$/, '$1')); 
                    
                    // ë°ì´í„° í–‰ íŒŒì‹±
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        if (!line.trim()) continue;

                        // ê°„ë‹¨í•œ CSV íŒŒì‹± (í°ë”°ì˜´í‘œ ì•ˆì˜ ì‰¼í‘œëŠ” ë¬´ì‹œ)
                        const values = [];
                        let inQuotes = false;
                        let currentVal = '';
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                if (line[j + 1] === '"') { // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ
                                    currentVal += '"';
                                    j++;
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentVal.trim().replace(/^"(.*)"$/, '$1'));
                                currentVal = '';
                            } else {
                                currentVal += char;
                            }
                        }
                        values.push(currentVal.trim().replace(/^"(.*)"$/, '$1')); // ë§ˆì§€ë§‰ ê°’ ì¶”ê°€

                        if (values.length !== headers.length) {
                            console.warn(`í–‰ ${i + 1}ì˜ ì—´ ê°œìˆ˜ê°€ í—¤ë”ì™€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ê±´ë„ˆëœë‹ˆë‹¤. (í—¤ë”: ${headers.length}, ê°’: ${values.length})`);
                            continue;
                        }

                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = values[index];
                        });
                        data.push(item);
                    }
                    
                    resolve({ headers, data });
                } catch (error) {
                    reject(new Error(`CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`));
                }
            };
            reader.onerror = (e) => reject(new Error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜'));
            reader.readAsText(file, 'utf-8');
        });
    }

    /**
     * CSV í—¤ë”ë¥¼ Firebase/JSON í‚¤ ì´ë¦„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @param {string} header CSV í—¤ë” ì´ë¦„
     * @returns {string} JSON í‚¤ ì´ë¦„
     */
    function mapHeaderToKey(header) {
      switch (header.trim()) {
        case "ID": return "id";
        case "RTU ë“±ë¡ë²ˆí˜¸/ID": return "name";
        case "ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­": return "region";
        case "ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)": return "capacity";
        case "ìœ ë‹› ì¢…ë¥˜": return "unitType";
        case "ëƒ‰ë§¤ ì¢…ë¥˜": return "refrigerant";
        case "ì „ê¸° ì¢…ë¥˜": return "electricPhase";
        case "ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ": return "date";
        case "í˜„ì¬ ìƒíƒœ": return "status";
        case "ê³ ì•• ìƒí•œ ì„¤ì • (PSI)": return "pressureHighLimit";
        case "ì €ì•• í•˜í•œ ì„¤ì • (PSI)": "pressureLowLimit";
        case "íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨": return "notes";
        case "ì´ë¯¸ì§€ URL ëª©ë¡": return "imageUrls";
        case "RTU ID": return "rtuId";
        case "ì ê²€ ë‚ ì§œ": return "inspectionDate";
        case "ì ê²€ì": return "inspector";
        case "ìµœì¢… ì ê²€ ê²°ê³¼": return "result";
        case "1. í•„í„°": return "check1";
        case "2. ì½˜í…í„°": return "check2";
        case "3. ì½˜ë´ì‹± ì½”ì¼": return "check3";
        case "4. ì†¡í’ ëª¨í„°": return "check4";
        case "5. ì¦ë°œê¸° ì½”ì¼": return "check5";
        case "6. ê³ ì•• ì„¼ì„œ": return "check6";
        case "7. ì €ì•• ì„¼ì„œ": return "check7";
        case "8. ìºíŒ¨ì‹œí„°": return "check8";
        case "Comp1 ê³ ì••(PSI)": return "comp1Hp";
        case "Comp1 ì €ì••(PSI)": return "comp1Lp";
        case "Comp1 ì „ë¥˜(A)": return "comp1Amp";
        case "Comp2 ê³ ì••(PSI)": return "comp2Hp";
        case "Comp2 ì €ì••(PSI)": return "comp2Lp";
        case "Comp2 ì „ë¥˜(A)": return "comp2Amp";
        case "ê³¼ì—´ë„(F)": return "superheat";
        case "ê³¼ëƒ‰ë„(F)": return "subcool";
        case "ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ": return "repairDate";
        case "ìˆ˜ë¦¬ ë‹´ë‹¹ì": return "engineer";
        case "ì²˜ë¦¬ ìƒíƒœ": return "status";
        case "ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©": return "issue";
        case "ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„": return "lastUpdated"; // ì—…ë°ì´íŠ¸ ì‹œê°„ì€ ë¬´ì‹œí•˜ê³  ìƒˆë¡œ ìƒì„±
        default:
          // ê¸°íƒ€ í—¤ë” (ì˜ˆ: 'model')ëŠ” ì†Œë¬¸ì camelCaseë¡œ ë³€í™˜ ì‹œë„
          return header.trim().toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
      }
    }


    /**
     * CSV ë°ì´í„°ë¥¼ Firebaseì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
     * @param {File[]} files ì—…ë¡œë“œí•  íŒŒì¼ ëª©ë¡
     */
    async function uploadCsvData(files) {
        if (files.length === 0) return;

        let totalUploaded = 0;
        let totalSkipped = 0;
        
        for (const file of files) {
            try {
                const { headers, data: rawData } = await readCsvFile(file);
                
                let refPath = null;
                if (headers.includes("RTU ë“±ë¡ë²ˆí˜¸/ID") && headers.includes("ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­")) {
                    refPath = 'rtu';
                } else if (headers.includes("ì ê²€ ë‚ ì§œ") && headers.includes("ì ê²€ì")) {
                    refPath = 'inspection';
                } else if (headers.includes("ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ") && headers.includes("ìˆ˜ë¦¬ ë‹´ë‹¹ì")) {
                    refPath = 'repair';
                }

                if (!refPath) {
                    alert(`íŒŒì¼ "${file.name}": ë°ì´í„° í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (RTU, ì ê²€, ìˆ˜ë¦¬ ê¸°ë¡ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤)`);
                    continue;
                }

                const keyMap = headers.reduce((map, header) => {
                    map[header] = mapHeaderToKey(header);
                    return map;
                }, {});

                for (const rawItem of rawData) {
                    const mappedItem = {};
                    for (const header in rawItem) {
                        const key = keyMap[header];
                        if (key && key !== 'id' && key !== 'lastUpdated' && rawItem[header].trim() !== '') {
                            // imageUrlsëŠ” ë‹¤ì‹œ ë°°ì—´ë¡œ ë³€í™˜
                            if (key === 'imageUrls') {
                                mappedItem[key] = rawItem[header].split(' | ').filter(url => url.trim() !== '');
                            } else {
                                mappedItem[key] = rawItem[header];
                            }
                        }
                    }

                    // í•„ìˆ˜ í•„ë“œ ê²€ì‚¬
                    if (refPath === 'rtu' && !mappedItem.name) {
                        totalSkipped++;
                        continue;
                    }
                    if (refPath === 'inspection' && (!mappedItem.rtuId || !mappedItem.inspectionDate)) {
                         totalSkipped++;
                         continue;
                    }
                    if (refPath === 'repair' && (!mappedItem.rtuId || !mappedItem.repairDate)) {
                        totalSkipped++;
                        continue;
                    }

                    // IDê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸°/ìˆ˜ì •, ì—†ìœ¼ë©´ ì‹ ê·œ ì¶”ê°€
                    const id = rawItem["ID"] && rawItem["ID"].trim() !== '' ? rawItem["ID"] : null;
                    await saveToFirebase(refPath, mappedItem, id);
                    totalUploaded++;
                }
            } catch (error) {
                alert(`íŒŒì¼ "${file.name}" ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error(error);
            }
        }

        if (totalUploaded > 0) {
            alert(`ì´ ${totalUploaded} ê±´ì˜ ë°ì´í„° ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ê±´ë„ˆë›´ í•­ëª©: ${totalSkipped} ê±´)`);
            await loadFromFirebase();
            renderRtuList(1);
            renderInspectionList(1);
            renderRepairList(1);
            populateRtuSelects();
            updateDashboard();
        } else {
            alert(`ì—…ë¡œë“œí•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê±´ë„ˆë›´ í•­ëª©: ${totalSkipped} ê±´)`);
        }
    }


    /* ==================== ë³´ê³ ì„œ ê´€ë ¨ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë¶€ë¶„) ==================== */

    /**
     * ìƒì„¸ ë³´ê³ ì„œë¥¼ ë Œë”ë§í•˜ê³  ì¸ì‡„ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
     * @param {('rtu'|'inspection'|'repair')} type ë³´ê³ ì„œ íƒ€ì…
     */
    function renderReportDetail(type) {
        const reportTitle = elements.reportTitle;
        const reportContent = elements.reportContent;
        let data = [];
        let titleText = "";
        let tableHeaders = [];
        let tableBody = "";

        switch (type) {
            case 'rtu':
                data = rtuList;
                titleText = "RTU ë“±ë¡ ëª©ë¡";
                tableHeaders = ["RTU ë“±ë¡ë²ˆí˜¸/ID", "ì„¤ì¹˜ ì¥ì†Œ/ì§€ì—­", "ëª¨ë¸ëª…", "ìœ ë‹› ì¢…ë¥˜", "ìš©ëŸ‰ (ëƒ‰ë™í†¤/kW)", "ì„¤ì¹˜(ë“±ë¡) ë‚ ì§œ", "í˜„ì¬ ìƒíƒœ", "íŠ¹ì´ì‚¬í•­ ë° ë©”ëª¨"];
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.region}</td>
                        <td>${item.model || ''}</td>
                        <td>${item.unitType || ''}</td>
                        <td>${item.capacity || ''}</td>
                        <td>${item.date}</td>
                        <td>${item.status}</td>
                        <td>${item.notes || ''}</td>
                    </tr>
                `).join('');
                break;

            case 'inspection':
                data = inspectionList;
                titleText = "ì´ ì ê²€ ê¸°ë¡ ê±´ìˆ˜ ëª©ë¡";
                tableHeaders = ["RTU ID", "ì ê²€ ë‚ ì§œ", "ì ê²€ì", "ìµœì¢… ì ê²€ ê²°ê³¼", "Comp1 ê³ ì••(PSI)", "Comp1 ì €ì••(PSI)", "Comp1 ì „ë¥˜(A)", "Comp2 ê³ ì••(PSI)", "Comp2 ì €ì••(PSI)", "Comp2 ì „ë¥˜(A)", "ê³¼ì—´ë„(F)", "ê³¼ëƒ‰ë„(F)", "íŠ¹ì´ì‚¬í•­ ë° ì¡°ì¹˜ ë‚´ìš©"];
                // 
                // âœ… ì´ ë¶€ë¶„ì´ ìˆ˜ì •ë˜ì–´ ì ê²€ ê¸°ë¡ ë°ì´í„°ê°€ í…Œì´ë¸” í–‰ìœ¼ë¡œ ì˜¬ë°”ë¥´ê²Œ ë Œë”ë§ë©ë‹ˆë‹¤.
                //
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.rtuId}</td>
                        <td>${item.inspectionDate}</td>
                        <td>${item.inspector}</td>
                        <td>${item.result}</td>
                        <td>${item.comp1Hp || ''}</td>
                        <td>${item.comp1Lp || ''}</td>
                        <td>${item.comp1Amp || ''}</td>
                        <td>${item.comp2Hp || ''}</td>
                        <td>${item.comp2Lp || ''}</td>
                        <td>${item.comp2Amp || ''}</td>
                        <td>${item.superheat || ''}</td>
                        <td>${item.subcool || ''}</td>
                        <td>${item.notes || ''}</td>
                    </tr>
                `).join('');
                break;

            case 'repair':
                data = repairList;
                titleText = "ì´ ìˆ˜ë¦¬ ê¸°ë¡ ê±´ìˆ˜ ëª©ë¡";
                tableHeaders = ["RTU ID", "ìˆ˜ë¦¬ ìš”ì²­/ì™„ë£Œ ë‚ ì§œ", "ìˆ˜ë¦¬ ë‹´ë‹¹ì", "ì²˜ë¦¬ ìƒíƒœ", "ë¬¸ì œ ë° ì¡°ì¹˜ ë‚´ìš©"];
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.rtuId}</td>
                        <td>${item.repairDate}</td>
                        <td>${item.engineer}</td>
                        <td>${item.status}</td>
                        <td>${item.issue || ''}</td>
                    </tr>
                `).join('');
                break;
        }

        reportTitle.textContent = titleText;
        
        // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ í¬í•¨í•˜ì—¬ ìµœì¢… HTML ìƒì„±
        const headersHtml = `<thead><tr>${tableHeaders.map(h => `<th class="p-2 text-left bg-gray-100">${h}</th>`).join('')}</tr></thead>`;
        const bodyHtml = `<tbody>${data.length > 0 ? tableBody : '<tr><td colspan="' + tableHeaders.length + '" class="text-center p-4 text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}</tbody>`;

        reportContent.innerHTML = `
            <div class="mb-6">
                <p class="text-sm text-gray-500">ì¸ì‡„ ì‹œê°„: ${new Date().toLocaleString()}</p>
            </div>
            <table class="w-full text-sm text-left text-gray-500 shadow-md sm:rounded-lg">
                ${headersHtml}
                ${bodyHtml}
            </table>
        `;

        // ì¸ì‡„ ë²„íŠ¼ì´ ì´ë¯¸ report-detail-viewì— ìˆì§€ë§Œ, ë°”ë¡œ ì¸ì‡„ ì°½ì„ ë„ìš°ê³  ìˆ¨ê¸°ëŠ” ë¡œì§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // í™”ë©´ì´ ì—…ë°ì´íŠ¸ë  ì‹œê°„ì„ ì£¼ê³  ì¸ì‡„ ì°½ì„ ë„ì›ë‹ˆë‹¤.
        setTimeout(() => {
            // window.print(); // ì‚¬ìš©ìê°€ ì§ì ‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë„ë¡ ìœ ë„
            // elements.reportDetailView.classList.add('hidden'); // ì¸ì‡„ í›„ ë·° ìˆ¨ê¸°ê¸°
        }, 300); 
    }

    /* ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ==================== */

    // íƒ­ ì „í™˜
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            elements.tabButtons.forEach(btn => {
                btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600', 'hover:border-gray-300', 'hover:text-gray-700');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
            button.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');

            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            elements.tabPages.forEach(page => page.classList.add('hidden'));

            // ëŒ€ìƒ í˜ì´ì§€ í‘œì‹œ
            document.getElementById(targetTab).classList.remove('hidden');

            // ë³´ê³ ì„œ í˜ì´ì§€ì—ì„œ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ìƒì„¸ ë·° ìˆ¨ê¸°ê¸°
            if (targetTab !== 'report-page') {
                elements.reportDetailView.classList.add('hidden');
            }
        });
    });

    // RTU ë“±ë¡/ìˆ˜ì • ëª¨ë“œ ë²„íŠ¼
    elements.modeNewBtn.addEventListener('click', () => setRtuFormMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => setRtuFormMode('modify'));

    // RTU ìˆ˜ì • ì‹œ ì„ íƒ ì´ë²¤íŠ¸
    elements.rtuModifySelect.addEventListener('change', (e) => {
        const rtuId = e.target.value;
        if (rtuId) {
            elements.rtuNameInput.value = rtuId; // ID ì…ë ¥ í•„ë“œì— IDë¥¼ ì„ì‹œ ì €ì¥
            loadRtuForModification(rtuId);
        } else {
             elements.rtuForm.reset();
             elements.rtuIdForModification.value = '';
             elements.rtuNameInput.value = '';
             elements.imagePreviewContainer.classList.add('hidden');
             clearImagePreviews();
        }
    });

    // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    ['1', '2', '3'].forEach(index => {
        const fileInput = document.getElementById(`rtu-image${index}`);
        const imgPreview = document.getElementById(`image-preview-${index}`);
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imgPreview.src = event.target.result;
                    imgPreview.style.display = 'block';
                    elements.imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                // íŒŒì¼ ì„ íƒ ì·¨ì†Œ ì‹œ, ê¸°ì¡´ URLì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìˆ¨ê¹€
                if (!imgPreview.dataset.existingUrl) {
                    imgPreview.src = '';
                    imgPreview.style.display = 'none';
                }
            }
        });
    });

    // RTU í¼ ì œì¶œ ì²˜ë¦¬
    elements.rtuForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        elements.rtuSubmitBtn.disabled = true;
        elements.rtuSubmitBtn.innerHTML = '<span class="loading mr-2"></span> ì €ì¥ ì¤‘...';

        const formData = new FormData(elements.rtuForm);
        const rtuIdForModification = elements.rtuIdForModification.value;
        const isModification = !!rtuIdForModification;
        const rtuId = isModification ? rtuIdForModification : formData.get('name').trim();
        
        if (!rtuId) {
             alert('RTU ë“±ë¡ë²ˆí˜¸/IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìˆ˜ì •í•  RTUë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
             elements.rtuSubmitBtn.disabled = false;
             elements.rtuSubmitBtn.textContent = isModification ? "RTU ì •ë³´ ìˆ˜ì •" : "RTU ì •ë³´ ì €ì¥";
             return;
        }

        // 1. ì´ë¯¸ì§€ ì²˜ë¦¬
        let existingRtu = rtuList.find(r => r.id === rtuId);
        let currentImageUrls = existingRtu?.imageUrls || [];
        let urlsToDelete = [];
        let newImageUrls = [];
        let uploadPromises = [];

        // ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í• ì§€/ì‚­ì œí• ì§€ ê²°ì •
        ['1', '2', '3'].forEach(index => {
            const fileInput = document.getElementById(`rtu-image${index}`);
            const imgPreview = document.getElementById(`image-preview-${index}`);
            const existingUrl = imgPreview.dataset.existingUrl;
            
            if (fileInput.files.length > 0) {
                // ìƒˆ íŒŒì¼ì´ ì„ íƒë¨ -> ê¸°ì¡´ URLì€ ì‚­ì œ ëŒ€ìƒ, ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œ ëª©ë¡ì— ì¶”ê°€
                if (existingUrl) {
                    urlsToDelete.push(existingUrl);
                }
                uploadPromises.push(uploadImage(rtuId, fileInput.files[0], index));
            } else if (existingUrl) {
                // ìƒˆ íŒŒì¼ì€ ì—†ì§€ë§Œ ê¸°ì¡´ URLì´ ìˆìŒ -> ìœ ì§€
                newImageUrls.push(existingUrl);
            } 
            // ìƒˆ íŒŒì¼ë„ ì—†ê³  ê¸°ì¡´ URLë„ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ë¹ˆ ìŠ¬ë¡¯ ìœ ì§€)
        });

        // ì‚­ì œ ë° ì—…ë¡œë“œ ì‹¤í–‰
        await deleteImages(rtuId, urlsToDelete);
        const uploadedUrls = await Promise.all(uploadPromises);
        newImageUrls = newImageUrls.concat(uploadedUrls.filter(url => url));


        // 2. ë°ì´í„° ê°ì²´ ìƒì„±
        const rtuData = {
            name: rtuId, // IDë¥¼ nameìœ¼ë¡œ ì‚¬ìš©
            region: formData.get('region') || '',
            model: formData.get('model') || '',
            capacity: formData.get('capacity') || '',
            unitType: formData.get('unitType') || '',
            refrigerant: formData.get('refrigerant') || '',
            electricPhase: formData.get('electricPhase') || '',
            date: formData.get('date') || formatTimestamp(Date.now()),
            status: formData.get('status') || 'ì‘ë™ì¤‘',
            pressureHighLimit: formData.get('pressureHighLimit') || '',
            pressureLowLimit: formData.get('pressureLowLimit') || '',
            notes: formData.get('notes') || '',
            imageUrls: newImageUrls // ìµœì¢… URL ëª©ë¡ ì €ì¥
        };

        // 3. Firebaseì— ì €ì¥
        const success = await saveToFirebase('rtu', rtuData, isModification ? rtuId : null);

        if (success) {
            alert(`RTU ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ${isModification ? 'ìˆ˜ì •' : 'ë“±ë¡'}ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            elements.rtuForm.reset();
            setRtuFormMode('new'); // ë“±ë¡ ëª¨ë“œë¡œ ì´ˆê¸°í™”
            await loadFromFirebase();
            renderRtuList(1);
            populateRtuSelects();
            updateDashboard();
        } else {
            alert(`RTU ì •ë³´ ${isModification ? 'ìˆ˜ì •' : 'ë“±ë¡'}ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
        }

        elements.rtuSubmitBtn.disabled = false;
        elements.rtuSubmitBtn.textContent = isModification ? "RTU ì •ë³´ ìˆ˜ì •" : "RTU ì •ë³´ ì €ì¥";
    });

    // RTU ìƒì„¸ ë³´ê¸° ë²„íŠ¼ ì²˜ë¦¬
    elements.rtuListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-detail-btn')) {
            const rtuId = e.target.dataset.rtuId;
            const rtu = rtuList.find(r => r.id === rtuId);
            if (!rtu) return;

            const rtuDetailModal = document.createElement('div');
            rtuDetailModal.id = 'rtu-detail-modal';
            rtuDetailModal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-bg';
            
            const rtuImages = organizeImages(rtu.imageUrls, rtu.name);
            const imageHtml = ['1', '2', '3'].map(index => rtuImages[index] ? `<img src="${rtuImages[index]}" alt="ì¥ë¹„ ì‚¬ì§„ ${index}" class="thumb-detail cursor-pointer" data-url="${rtuImages[index]}">` : '').join('');
            
            rtuDetailModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-gray-900 border-b pb-3 mb-4">${rtu.name} ìƒì„¸ ì •ë³´</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-gray-700 text-sm">
                        <p><strong>ì„¤ì¹˜ ì¥ì†Œ:</strong> ${rtu.region || '-'}</p>
                        <p><strong>ëª¨ë¸ëª…:</strong> ${rtu.model || '-'}</p>
                        <p><strong>ìœ ë‹› ì¢…ë¥˜:</strong> ${rtu.unitType || '-'}</p>
                        <p><strong>ìš©ëŸ‰:</strong> ${rtu.capacity || '-'}</p>
                        <p><strong>ëƒ‰ë§¤:</strong> ${rtu.refrigerant || '-'}</p>
                        <p><strong>ì „ê¸° ì¢…ë¥˜:</strong> ${rtu.electricPhase || '-'}</p>
                        <p><strong>ì„¤ì¹˜ ë‚ ì§œ:</strong> ${rtu.date || '-'}</p>
                        <p><strong>í˜„ì¬ ìƒíƒœ:</strong> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span></p>
                        <p class="col-span-2"><strong>ê³ ì••/ì €ì•• ì„¤ì •:</strong> ${rtu.pressureHighLimit || '-'} PSI / ${rtu.pressureLowLimit || '-'} PSI (H/L)</p>
                        <p class="col-span-2"><strong>íŠ¹ì´ì‚¬í•­:</strong> <br>${rtu.notes ? rtu.notes.replace(/\n/g, '<br>') : 'ì—†ìŒ'}</p>
                    </div>
                    
                    <div class="mt-6 border-t pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">ì¥ë¹„ ì‚¬ì§„</h4>
                        <div class="flex flex-wrap gap-4">
                            ${imageHtml || '<p class="text-gray-500 text-sm">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                    </div>
                    
                    <button class="close-rtu-detail-modal w-full mt-6 bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-300 transition">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(rtuDetailModal);
            
            // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸°
            rtuDetailModal.querySelectorAll('.thumb-detail').forEach(img => {
                img.addEventListener('click', (e) => {
                    const url = e.target.dataset.url;
                    elements.modalImage.src = url;
                    elements.imageModal.classList.remove('hidden');
                    elements.imageModal.classList.add('flex');
                });
            });

            // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            rtuDetailModal.querySelector('.close-rtu-detail-modal').addEventListener('click', () => {
                rtuDetailModal.remove();
            });

            rtuDetailModal.addEventListener('click', (e) => {
                if (e.target === rtuDetailModal) {
                    rtuDetailModal.remove();
                }
            });
        }
    });

    // RTU ìˆ˜ì • ë²„íŠ¼ ì²˜ë¦¬ (ìˆ˜ì • íƒ­ìœ¼ë¡œ ì´ë™ ë° ë°ì´í„° ë¡œë“œ)
    elements.rtuListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const rtuId = e.target.dataset.rtuId;
            // íƒ­ ì „í™˜
            document.querySelector('[data-tab="rtu-manage"]').click();
            // ìˆ˜ì • ëª¨ë“œ ì „í™˜
            setRtuFormMode('modify');
            // Select ê°’ ì„¤ì • ë° ë°ì´í„° ë¡œë“œ
            elements.rtuModifySelect.value = rtuId;
            elements.rtuNameInput.value = rtuId;
            loadRtuForModification(rtuId);
        }
    });
    
    // RTU ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
    elements.rtuListContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const rtuId = e.target.dataset.rtuId;
            if (confirm(`RTU ID: ${rtuId} ì¥ë¹„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ì ê²€/ìˆ˜ë¦¬ ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤.`)) {
                try {
                    // 1. Storage ì´ë¯¸ì§€ ì‚­ì œ (ì„ íƒì )
                    const rtu = rtuList.find(r => r.id === rtuId);
                    if (rtu && rtu.imageUrls && rtu.imageUrls.length > 0) {
                        await deleteImages(rtuId, rtu.imageUrls);
                    }
                    
                    // 2. Database í•­ëª© ì‚­ì œ
                    await database.ref(`rtu/${rtuId}`).remove();
                    
                    alert(`RTU ID: ${rtuId} ì¥ë¹„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    await loadFromFirebase();
                    renderRtuList(rtuCurrentPage);
                    populateRtuSelects();
                    updateDashboard();
                } catch (error) {
                    console.error("RTU ì‚­ì œ ì‹¤íŒ¨:", error);
                    alert("RTU ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }
    });


    // ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ë‹«ê¸°
    elements.closeModalBtn.addEventListener('click', () => {
        elements.imageModal.classList.add('hidden');
        elements.imageModal.classList.remove('flex');
    });
    elements.imageModal.addEventListener('click', (e) => {
        if (e.target === elements.imageModal) {
            elements.imageModal.classList.add('hidden');
            elements.imageModal.classList.remove('flex');
        }
    });

    // ì ê²€ ê¸°ë¡ í¼ ì œì¶œ
    elements.inspectionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rtuId = elements.inspectionRtuId.value;
        if (!rtuId) {
            alert("ëŒ€ìƒ RTUë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData(elements.inspectionForm);
        const inspectionData = {
            rtuId: rtuId,
            inspectionDate: formData.get('inspectionDate') || formatTimestamp(Date.now()),
            inspector: formData.get('inspector') || '',
            result: formData.get('result') || 'ì •ìƒ',
            notes: formData.get('notes') || '',
            // ë¶€í’ˆ ì ê²€ ìƒíƒœ
            check1: formData.get('check1') || 'ì •ìƒ',
            check2: formData.get('check2') || 'ì •ìƒ',
            check3: formData.get('check3') || 'ì–‘í˜¸',
            check4: formData.get('check4') || 'ì •ìƒ',
            check5: formData.get('check5') || 'ì–‘í˜¸',
            check6: formData.get('check6') || 'ì •ìƒ',
            check7: formData.get('check7') || 'ì •ìƒ',
            check8: formData.get('check8') || 'ì •ìƒ',
            // ìš´ì „ ìƒíƒœ ì¸¡ì •
            comp1Hp: formData.get('comp1Hp') || '',
            comp1Lp: formData.get('comp1Lp') || '',
            comp1Amp: formData.get('comp1Amp') || '',
            comp2Hp: formData.get('comp2Hp') || '',
            comp2Lp: formData.get('comp2Lp') || '',
            comp2Amp: formData.get('comp2Amp') || '',
            // ì˜¨ë„ ì¸¡ì •
            superheat: formData.get('superheat') || '',
            subcool: formData.get('subcool') || '',
        };
        
        const success = await saveToFirebase('inspection', inspectionData);
        if (success) {
            alert('ì ê²€ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            elements.inspectionForm.reset();
            // RTU ëª©ë¡ Select boxëŠ” ìœ ì§€
            elements.inspectionRtuId.value = rtuId; 
            await loadFromFirebase();
            renderInspectionList(1);
            updateDashboard();
        } else {
            alert('ì ê²€ ê¸°ë¡ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // ìˆ˜ë¦¬ ê¸°ë¡ í¼ ì œì¶œ
    elements.repairForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rtuId = elements.repairRtuId.value;
        if (!rtuId) {
            alert("ëŒ€ìƒ RTUë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData(elements.repairForm);
        const repairData = {
            rtuId: rtuId,
            repairDate: formData.get('repairDate') || formatTimestamp(Date.now()),
            engineer: formData.get('engineer') || '',
            status: formData.get('status') || 'ìš”ì²­',
            issue: formData.get('issue') || '',
        };
        
        const success = await saveToFirebase('repair', repairData);
        if (success) {
            alert('ìˆ˜ë¦¬ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            elements.repairForm.reset();
            // RTU ëª©ë¡ Select boxëŠ” ìœ ì§€
            elements.repairRtuId.value = rtuId;
            await loadFromFirebase();
            renderRepairList(1);
            updateDashboard();
        } else {
            alert('ìˆ˜ë¦¬ ê¸°ë¡ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // CSV ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸
    elements.downloadDataBtn.addEventListener('click', downloadData);

    // CSV ì—…ë¡œë“œ ì´ë²¤íŠ¸
    elements.csvUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            if (confirm(`ì´ ${files.length} ê°œì˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒŒì¼ ë‚´ìš©ì˜ "ID"ê°€ ì¼ì¹˜í•˜ë©´ ê°±ì‹ ë©ë‹ˆë‹¤)`)) {
                uploadCsvData(files).finally(() => {
                    // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
                    e.target.value = ''; 
                });
            } else {
                e.target.value = ''; 
            }
        }
    });
    
    // ë³´ê³ ì„œ ìš”ì•½ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
    });
    elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
        window.scrollTo(0, 0); // í˜ì´ì§€ ìµœìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
    });
    elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
        window.scrollTo(0, 0); // í˜ì´ì§€ ìµœìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
    });
    
    // ë³´ê³ ì„œ ìƒì„¸ ë³´ê¸°ì—ì„œ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
    elements.reportBackBtn.addEventListener('click', () => {
        elements.reportDetailView.classList.add('hidden');
    });
    
    // ì ê²€ ê¸°ë¡ ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ (ê°„ë‹¨í•œ ëª¨ë‹¬) - ì—¬ê¸°ì„œëŠ” ìƒì„¸ ë°ì´í„°ë¥¼ ë°”ë¡œ ë³´ì—¬ì£¼ëŠ” ëŒ€ì‹  alertë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
    elements.inspectionListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-inspection-detail-btn')) {
            const inspectionId = e.target.dataset.inspectionId;
            const item = inspectionList.find(i => i.id === inspectionId);
            if (!item) return;

            let detailText = `RTU ID: ${item.rtuId}\nì ê²€ ë‚ ì§œ: ${item.inspectionDate}\nì ê²€ì: ${item.inspector}\nìµœì¢… ê²°ê³¼: ${item.result}\n\n`;
            detailText += `--- ë¶€í’ˆ ì ê²€ ìƒíƒœ ---\n`;
            detailText += `1. í•„í„°: ${item.check1 || '-'}\n`;
            detailText += `2. ì½˜í…í„°: ${item.check2 || '-'}\n`;
            detailText += `3. ì½˜ë´ì‹± ì½”ì¼: ${item.check3 || '-'}\n`;
            detailText += `4. ì†¡í’ ëª¨í„°: ${item.check4 || '-'}\n`;
            detailText += `5. ì¦ë°œê¸° ì½”ì¼: ${item.check5 || '-'}\n`;
            detailText += `6. ê³ ì•• ì„¼ì„œ: ${item.check6 || '-'}\n`;
            detailText += `7. ì €ì•• ì„¼ì„œ: ${item.check7 || '-'}\n`;
            detailText += `8. ìºíŒ¨ì‹œí„°: ${item.check8 || '-'}\n\n`;
            detailText += `--- ìš´ì „ ìƒíƒœ/ì˜¨ë„ ---\n`;
            detailText += `Comp1 H/L/A: ${item.comp1Hp || '-'} / ${item.comp1Lp || '-'} / ${item.comp1Amp || '-'} \n`;
            detailText += `Comp2 H/L/A: ${item.comp2Hp || '-'} / ${item.comp2Lp || '-'} / ${item.comp2Amp || '-'} \n`;
            detailText += `ê³¼ì—´ë„/ê³¼ëƒ‰ë„: ${item.superheat || '-'}â„‰ / ${item.subcool || '-'}â„‰\n\n`;
            detailText += `--- íŠ¹ì´ì‚¬í•­/ì¡°ì¹˜ ë‚´ìš© ---\n${item.notes || 'ì—†ìŒ'}`;

            alert(detailText);
        }
    });

    /* ==================== ì´ˆê¸°í™” ==================== */

    // ëª¨ë“  ë¦¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§í•˜ê³  ëŒ€ì‹œë³´ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();
      
      // ì‹œì‘ ì‹œ RTU ë“±ë¡ ëª¨ë“œë¡œ ì„¤ì •
      setRtuFormMode('new');

    });
  </script>
</body>
</html>