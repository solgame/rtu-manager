<!DOCTYPE HTML>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RTU 통합 관리 시스템 (Firebase 클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f3f4f6; }
    /* .thumb 클래스가 이미지뿐만 아니라 플레이스홀더에도 적용되도록 유지합니다. */
    .thumb { width:96px; height:72px; object-fit:cover; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.08); } 
    .thumb-detail { width: 150px; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.15s; }
    .thumb-detail:hover { transform: scale(1.03); }
    .hidden-file { position:absolute; left:-9999px; }
    .modal-bg { background: rgba(17,24,39,0.6); }
    .tab-active { border-color: #3b82f6 !important; color: #3b82f6; font-weight: 600; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== 보고서 인쇄를 위한 CSS 추가 (print-only는 사용하지 않음) ========== */
    .print-only { display: none; } /* 기존 코드에서 남아있는 print-only는 display:none; 상태 유지 */
    @media print {
      /* 앱의 기본 배경과 테두리를 숨겨 인쇄 영역을 깔끔하게 만듭니다. */
      .print-container, #main-app-container { /* 인쇄 문제 해결: 메인 컨테이너 강제 표시 */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: white !important;
      }
      /* 인쇄 시 숨겨야 할 요소 (버튼, 메뉴 등) */
      .print-hidden, .tab-page:not(#report-page), .tab-btn, .border-b, .mb-4, .pb-4 {
        display: none !important;
      }
      /* 인쇄 시 상세 보고서 내용만 표시를 위해 report-page와 detail-view를 강제 표시 */
      #report-page, #report-detail-view { /* 인쇄 문제 해결: 보고서 관련 요소 강제 표시 및 정리 */
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0 !important;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
      }
      /* 상태 태그의 배경색은 인쇄 시 제거 */
      .bg-green-100, .bg-yellow-100, .bg-red-100, .bg-slate-200, .bg-indigo-100, .bg-pink-100, .bg-teal-100 {
          background-color: transparent !important;
          color: black !important;
          border: 1px solid #ccc !important; /* 인쇄 시 잘 보이도록 테두리 추가 */
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 print-container">
    <div class="bg-white rounded-2xl shadow-xl p-6" id="main-app-container">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-4 print-hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.526.34 1.144.354 1.63.153z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          RTU 통합 관리 시스템
        </h1>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
          <label for="csv-upload" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-150 text-sm cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 업로드
          </label>
          <input type="file" id="csv-upload" accept=".csv" multiple class="hidden-file">
          <button id="download-data-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-150 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            데이터 CSV 다운로드
          </button>
        </div>
      </div>

      <div class="border-b border-gray-200 print-hidden">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
          <button class="tab-btn tab-active border-b-2 border-blue-500 py-3 px-1 text-sm font-medium text-blue-600 transition duration-150" data-tab="dashboard">대시보드</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="rtu-manage">RTU 등록/관리</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="inspection-manage">점검 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="repair-manage">수리 기록</button>
          <button class="tab-btn border-b-2 border-transparent py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150" data-tab="report-page">보고서</button>
        </nav>
      </div>

      <div class="mt-6">
        <div id="dashboard" class="tab-page">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">현재 시스템 상태 요약</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-200">
              <p class="text-sm font-medium text-blue-600">총 등록 장비 수</p>
              <p id="dashboard-total" class="text-3xl font-extrabold text-blue-900 mt-1">0</p>
            </div>
            <div class="bg-green-50 p-5 rounded-xl shadow-lg border border-green-200">
              <p class="text-sm font-medium text-green-600">작동중</p>
              <p id="dashboard-running" class="text-3xl font-extrabold text-green-900 mt-1">0</p>
            </div>
            <div class="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-600">정지됨</p>
              <p id="dashboard-stopped" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-red-50 p-5 rounded-xl shadow-lg border border-red-200">
              <p class="text-sm font-medium text-red-600">점검 필요</p>
              <p id="dashboard-needs-inspection" class="text-3xl font-extrabold text-red-900 mt-1">0</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">최근 처리 현황</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">이번 달 점검 건수</span>
                  <span id="dashboard-monthly-inspection" class="text-xl font-bold text-blue-600">0</span>
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">미처리 수리 요청</span>
                  <span id="dashboard-pending-repair" class="text-xl font-bold text-red-600">0</span>
                </div>
              </div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
              <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">개별 장비 상태 (최근 등록/수정)</h3>
              <div id="dashboard-latest-list" class="space-y-3">
                <p class="text-gray-500">로딩 중...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="rtu-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <div class="flex justify-center mb-4 border-b pb-4">
                <button id="mode-new-btn" class="px-4 py-2 text-sm font-semibold rounded-l-lg bg-blue-600 text-white transition duration-150">신규 등록</button>
                <button id="mode-modify-btn" class="px-4 py-2 text-sm font-semibold rounded-r-lg bg-gray-200 text-gray-700 transition duration-150">정보 수정</button>
              </div>
              <h2 id="rtu-form-title" class="text-xl font-bold text-gray-800 mb-4">RTU 장비 신규 등록</h2>
              <form id="rtu-form" class="space-y-4">
                <input type="hidden" id="rtu-id-for-modification" name="rtuIdForModification" value="">
                <div id="rtu-id-container">
                  <div>
                    <label for="rtu-name" class="block text-sm font-medium text-gray-700">RTU 등록번호/ID *</label>
                    <input type="text" id="rtu-name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <select id="rtu-modify-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 hidden">
                      <option value="">-- 수정할 RTU를 선택하세요 --</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label for="rtu-region" class="block text-sm font-medium text-gray-700">설치 장소/지역 *</label>
                  <input type="text" id="rtu-region" name="region" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-model" class="block text-sm font-medium text-gray-700">모델명</label>
                  <input type="text" id="rtu-model" name="model" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-capacity" class="block text-sm font-medium text-gray-700">용량 (냉동톤/kW)</label>
                  <input type="text" id="rtu-capacity" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-unit-type" class="block text-sm font-medium text-gray-700">유닛 종류</label>
                  <select id="rtu-unit-type" name="unitType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="패키지">패키지</option>
                    <option value="칠러">칠러</option>
                    <option value="냉각탑">냉각탑</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-refrigerant" class="block text-sm font-medium text-gray-700">냉매 종류</label>
                  <input type="text" id="rtu-refrigerant" name="refrigerant" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500" value="R-410A">
                </div>
                <div>
                  <label for="rtu-electric-phase" class="block text-sm font-medium text-gray-700">전기 종류</label>
                  <select id="rtu-electric-phase" name="electricPhase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="단상">단상 (Single Phase)</option>
                    <option value="삼상">삼상 (Three Phase)</option>
                  </select>
                </div>
                <div>
                  <label for="rtu-date" class="block text-sm font-medium text-gray-700">설치(등록) 날짜</label>
                  <input type="date" id="rtu-date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="rtu-status" class="block text-sm font-medium text-gray-700">현재 상태 *</label>
                  <select id="rtu-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="작동중">작동중</option>
                    <option value="정지됨">정지됨</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="rtu-pressure-high" class="block text-sm font-medium text-gray-700">고압 상한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-high" name="pressureHighLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="rtu-pressure-low" class="block text-sm font-medium text-gray-700">저압 하한 설정 (PSI)</label>
                    <input type="number" id="rtu-pressure-low" name="pressureLowLimit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                  </div>
                </div>
                <div>
                  <label for="rtu-notes" class="block text-sm font-medium text-gray-700">특이사항 및 메모</label>
                  <textarea id="rtu-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-3">
                  <label class="block text-sm font-medium text-gray-700">장비 사진 (최대 3장)</label>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image1" name="image1" accept="image/*" class="hidden-file">
                    <label for="rtu-image1" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 1 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image2" name="image2" accept="image/*" class="hidden-file">
                    <label for="rtu-image2" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 2 업로드</label>
                  </div>
                  <div class="flex space-x-2">
                    <input type="file" id="rtu-image3" name="image3" accept="image/*" class="hidden-file">
                    <label for="rtu-image3" class="cursor-pointer bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-150">사진 3 업로드</label>
                  </div>
                </div>
                <div id="image-preview-container" class="mt-4 hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                  <h4 class="text-sm font-medium text-gray-700">이미지 미리보기</h4>
                  <div class="flex flex-wrap gap-4">
                    <img id="image-preview-1" src="" alt="Image 1 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-2" src="" alt="Image 2 Preview" class="thumb" style="display:none;">
                    <img id="image-preview-3" src="" alt="Image 3 Preview" class="thumb" style="display:none;">
                  </div>
                </div>
                <button id="rtu-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">RTU 정보 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">RTU 등록 목록 (<span id="rtu-count">0</span>건)</h2>
              <div id="rtu-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>
              </div>
              <div id="rtu-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="inspection-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-span-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">점검 기록 등록</h2>
              <form id="inspection-form" class="space-y-4">
                <div>
                  <label for="inspection-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="inspection-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-date" class="block text-sm font-medium text-gray-700">점검 날짜 *</label>
                  <input type="date" id="inspection-date" name="inspectionDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="inspection-inspector" class="block text-sm font-medium text-gray-700">점검자 이름 *</label>
                  <input type="text" id="inspection-inspector" name="inspector" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div class="border p-4 rounded-lg bg-indigo-50 space-y-3">
                  <h3 class="text-lg font-semibold text-indigo-800">부품 점검 상태</h3>
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div>
                      <label for="check1" class="block font-medium text-gray-700">1. 필터</label>
                      <select id="check1" name="check1" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="교체필요">교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check2" class="block font-medium text-gray-700">2. 콘텍터</label>
                      <select id="check2" name="check2" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소손/교체필요">소손/교체필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check3" class="block font-medium text-gray-700">3. 콘덴싱 코일</label>
                      <select id="check3" name="check3" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필ayo</option>
                      </select>
                    </div>
                    <div>
                      <label for="check4" class="block font-medium text-gray-700">4. 송풍 모터</label>
                      <select id="check4" name="check4" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="소음/수리필요">소음/수리필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check5" class="block font-medium text-gray-700">5. 증발기 코일</label>
                      <select id="check5" name="check5" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="양호">양호</option>
                        <option value="오염/청소필요">오염/청소필요</option>
                      </select>
                    </div>
                    <div>
                      <label for="check6" class="block font-medium text-gray-700">6. 고압 센서</label>
                      <select id="check6" name="check6" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check7" class="block font-medium text-gray-700">7. 저압 센서</label>
                      <select id="check7" name="check7" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="오류">오류</option>
                      </select>
                    </div>
                    <div>
                      <label for="check8" class="block font-medium text-gray-700">8. 캐패시터</label>
                      <select id="check8" name="check8" class="mt-1 w-full border-gray-300 rounded-md p-1 border">
                        <option value="정상">정상</option>
                        <option value="불량">불량</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="border p-4 rounded-lg bg-red-50 space-y-3">
                  
<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 1)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp1Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp1Hp" name="comp1Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp1Lp" name="comp1Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp1Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp1Amp" name="comp1Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>

<div class="border p-4 rounded-lg bg-yellow-50 space-y-3">
  <h3 class="text-lg font-semibold text-yellow-800">운전 상태 측정 (Comp 2)</h3>
  <div class="grid grid-cols-3 gap-3">
    <div>
      <label for="comp2Hp" class="block text-sm font-medium text-gray-700">고압 (PSI)</label>
      <input type="number" id="comp2Hp" name="comp2Hp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Lp" class="block text-sm font-medium text-gray-700">저압 (PSI)</label>
      <input type="number" id="comp2Lp" name="comp2Lp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
    <div>
      <label for="comp2Amp" class="block text-sm font-medium text-gray-700">전류 (A)</label>
      <input type="number" id="comp2Amp" name="comp2Amp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>
  </div>
</div>
<h3 class="text-lg font-semibold text-red-800">온도 측정</h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label for="superheat" class="block text-sm font-medium text-gray-700">과열도 (℉)</label>
                      <input type="number" step="0.1" id="superheat" name="superheat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                      <label for="subcool" class="block text-sm font-medium text-gray-700">과냉도 (℉)</label>
                      <input type="number" step="0.1" id="subcool" name="subcool" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                    </div>
                  </div>
                </div>
                <div>
                  <label for="inspection-result" class="block text-sm font-medium text-gray-700">최종 점검 결과 *</label>
                  <select id="inspection-result" name="result" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="점검필요">점검필요</option>
                  </select>
                </div>
                <div>
                  <label for="inspection-notes" class="block text-sm font-medium text-gray-700">특이사항 및 조치 내용</label>
                  <textarea id="inspection-notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">점검 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">점검 기록 목록 (<span id="inspection-count">0</span>건)</h2>
              <div id="inspection-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>
              </div>
              <div id="inspection-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="repair-manage" class="tab-page hidden">
          <div class="grid grid-cols-1 lg:col-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border h-fit">
              <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">수리 기록 등록</h2>
              <form id="repair-form" class="space-y-4">
                <div>
                  <label for="repair-rtu-id" class="block text-sm font-medium text-gray-700">대상 RTU *</label>
                  <select id="repair-rtu-id" name="rtuId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="">-- RTU를 선택하세요 --</option>
                  </select>
                </div>
                <div>
                  <label for="repair-date" class="block text-sm font-medium text-gray-700">수리 요청/완료 날짜 *</label>
                  <input type="date" id="repair-date" name="repairDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-engineer" class="block text-sm font-medium text-gray-700">수리 담당자 *</label>
                  <input type="text" id="repair-engineer" name="engineer" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                </div>
                <div>
                  <label for="repair-status" class="block text-sm font-medium text-gray-700">처리 상태 *</label>
                  <select id="repair-status" name="status" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500">
                    <option value="요청">요청 (미처리)</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div>
                  <label for="repair-issue" class="block text-sm font-medium text-gray-700">문제 및 조치 내용 *</label>
                  <textarea id="repair-issue" name="issue" rows="5" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-150 mt-6">수리 기록 저장</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">수리 기록 목록 (<span id="repair-count">0</span>건)</h2>
              <div id="repair-list" class="space-y-4">
                <p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>
              </div>
              <div id="repair-pagination" class="flex justify-center mt-4"></div>
            </div>
          </div>
        </div>

        <div id="report-page" class="tab-page hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 print-hidden">시스템 운영 보고서</h2>
          <p class="text-gray-600 mb-6 print-hidden">아래 요약 항목을 클릭하시면 상세 목록을 확인하고 인쇄하실 수 있습니다. 🖨️</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-hidden">
            <div id="report-rtu-summary" class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 cursor-pointer hover:bg-indigo-100 transition duration-150">
              <p class="text-sm font-medium text-indigo-600">총 등록 RTU</p>
              <p id="report-total-rtu" class="text-3xl font-extrabold text-indigo-900 mt-1">0</p>
            </div>
            <div id="report-inspection-summary" class="bg-pink-50 p-6 rounded-xl shadow-lg border border-pink-200 cursor-pointer hover:bg-pink-100 transition duration-150">
              <p class="text-sm font-medium text-pink-600">총 점검 기록 건수</p>
              <p id="report-total-inspection" class="text-3xl font-extrabold text-pink-900 mt-1">0</p>
            </div>
            <div id="report-repair-summary" class="bg-teal-50 p-6 rounded-xl shadow-lg border border-teal-200 cursor-pointer hover:bg-teal-100 transition duration-150">
              <p class="text-sm font-medium text-teal-600">총 수리 기록 건수</p>
              <p id="report-total-repair" class="text-3xl font-extrabold text-teal-900 mt-1">0</p>
            </div>
          </div>
          <div id="report-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-lg border hidden">
            <div class="flex justify-between items-center mb-4">
              <h3 id="report-title" class="text-2xl font-bold text-gray-800"></h3>
              <button id="report-print-btn" onclick="window.print()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 text-sm print-hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"/>
                </svg>
                보고서 인쇄
              </button>
            </div>
            <div id="report-content" class="overflow-x-auto">
              </div>
            <button id="report-back-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150 text-sm mt-6 print-hidden">
              목록으로 돌아가기
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="image-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg">
    <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg shadow-2xl p-4">
      <img id="modal-image" src="" alt="확대 이미지" class="max-w-full max-h-[80vh] object-contain">
      <button id="close-modal-btn" class="absolute top-0 right-0 m-4 text-white bg-gray-800 rounded-full p-2 hover:bg-gray-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script type="module">
    // Firebase 설정
    const firebaseConfig = { 
      // 이전 단계에서 사용하시던 사용자님의 실제 Firebase 설정 정보를 사용합니다.
      // 데이터가 사라지지 않도록 이 설정은 임의의 값으로 두겠습니다.
      // 만약 데이터가 여전히 보이지 않는다면, 이 부분을 사용자님의 실제 설정 정보로 교체해야 합니다.
      apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57...",
      authDomain: "rtu-management-system.firebaseapp.com",
      databaseURL: "https://rtu-management-system-default-rtdb.firebaseio.com",
      projectId: "rtu-management-system",
      storageBucket: "rtu-management-system.appspot.com",
      messagingSenderId: "1056580649987",
      appId: "1:1056580649987:web:f1c5049b4938d227d8e85f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();
    const storageRef = storage.ref();

    // 전역 데이터 저장소
    let rtuList = [];
    let inspectionList = [];
    let repairList = [];

    // 페이지네이션 설정
    const itemsPerPage = 10;
    let rtuCurrentPage = 1;
    let inspectionCurrentPage = 1;
    let repairCurrentPage = 1;

    // DOM 요소 캐시
    const elements = {
        // Tabs
        tabButtons: document.querySelectorAll('.tab-btn'),
        tabPages: document.querySelectorAll('.tab-page'),
        // Dashboard
        dashboardTotal: document.getElementById('dashboard-total'),
        dashboardRunning: document.getElementById('dashboard-running'),
        dashboardStopped: document.getElementById('dashboard-stopped'),
        dashboardNeedsInspection: document.getElementById('dashboard-needs-inspection'),
        dashboardMonthlyInspection: document.getElementById('dashboard-monthly-inspection'),
        dashboardPendingRepair: document.getElementById('dashboard-pending-repair'),
        dashboardLatestList: document.getElementById('dashboard-latest-list'),
        // RTU Manage
        modeNewBtn: document.getElementById('mode-new-btn'),
        modeModifyBtn: document.getElementById('mode-modify-btn'),
        rtuFormTitle: document.getElementById('rtu-form-title'),
        rtuForm: document.getElementById('rtu-form'),
        rtuIdContainer: document.getElementById('rtu-id-container'),
        rtuNameInput: document.getElementById('rtu-name'),
        rtuModifySelect: document.getElementById('rtu-modify-select'),
        rtuIdForModification: document.getElementById('rtu-id-for-modification'),
        rtuListContainer: document.getElementById('rtu-list'),
        rtuCount: document.getElementById('rtu-count'),
        rtuPagination: document.getElementById('rtu-pagination'),
        rtuSubmitBtn: document.getElementById('rtu-submit-btn'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        imagePreview1: document.getElementById('image-preview-1'),
        imagePreview2: document.getElementById('image-preview-2'),
        imagePreview3: document.getElementById('image-preview-3'),
        rtuImage1: document.getElementById('rtu-image1'),
        rtuImage2: document.getElementById('rtu-image2'),
        rtuImage3: document.getElementById('rtu-image3'),
        // Inspection Manage
        inspectionRtuId: document.getElementById('inspection-rtu-id'),
        inspectionForm: document.getElementById('inspection-form'),
        inspectionListContainer: document.getElementById('inspection-list'),
        inspectionCount: document.getElementById('inspection-count'),
        inspectionPagination: document.getElementById('inspection-pagination'),
        // Repair Manage
        repairRtuId: document.getElementById('repair-rtu-id'),
        repairForm: document.getElementById('repair-form'),
        repairListContainer: document.getElementById('repair-list'),
        repairCount: document.getElementById('repair-count'),
        repairPagination: document.getElementById('repair-pagination'),
        // Modal
        imageModal: document.getElementById('image-modal'),
        modalImage: document.getElementById('modal-image'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        // Report
        reportRtuSummary: document.getElementById('report-rtu-summary'),
        reportInspectionSummary: document.getElementById('report-inspection-summary'),
        reportRepairSummary: document.getElementById('report-repair-summary'),
        reportTotalRtu: document.getElementById('report-total-rtu'),
        reportTotalInspection: document.getElementById('report-total-inspection'),
        reportTotalRepair: document.getElementById('report-total-repair'),
        reportDetailView: document.getElementById('report-detail-view'),
        reportTitle: document.getElementById('report-title'),
        reportContent: document.getElementById('report-content'),
        reportBackBtn: document.getElementById('report-back-btn'),
        reportPage: document.getElementById('report-page'),
        // CSV
        csvUpload: document.getElementById('csv-upload'),
        downloadDataBtn: document.getElementById('download-data-btn')
    };

    /* ==================== 유틸리티 함수 ==================== */

    /**
     * 상태에 따른 Tailwind CSS 색상 클래스를 반환합니다.
     * @param {string} status RTU 상태 문자열
     * @returns {string} Tailwind CSS 클래스
     */
    function getStatusColor(status) {
        switch (status) {
            case '작동중': return 'bg-green-100 text-green-800';
            case '정지됨': return 'bg-gray-100 text-gray-800';
            case '점검필요': return 'bg-red-100 text-red-800';
            case '주의': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-slate-100 text-slate-800';
        }
    }

    /**
     * Unix Timestamp를 'YYYY-MM-DD' 형식의 문자열로 변환합니다.
     * @param {number} timestamp Unix 타임스탬프
     * @returns {string} 날짜 문자열
     */
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toISOString().split('T')[0];
    }
    
    /**
     * 파일 이름에서 확장자를 제거한 ID를 추출합니다.
     * @param {string} fullFileName 전체 파일 이름
     * @returns {string} 파일 ID
     */
    function getFileIdFromStoragePath(fullPath) {
        // fullPath: rtu_images/RTU-001/RTU-001_1_1678886400000.jpg
        const parts = fullPath.split('/');
        const fileNameWithExt = parts[parts.length - 1]; // RTU-001_1_1678886400000.jpg
        const fileNameParts = fileNameWithExt.split('_'); // [RTU-001, 1, 1678886400000.jpg]
        if (fileNameParts.length < 3) return '';
        // RTU ID + index (RTU-001_1)
        return `${fileNameParts[0]}_${fileNameParts[1]}`; 
    }

    /**
     * 파일 이름을 인덱스(1, 2, 3)별로 정리하여 반환합니다.
     * @param {Array<string>} fileList Storage path 배열
     * @param {string} rtuName RTU ID
     * @returns {Object<string, string>} 인덱스별 URL (e.g., {'1': 'url1', '2': 'url2'})
     */
    function organizeImages(fileList, rtuName) {
        const organized = {};
        if (!fileList || fileList.length === 0) return organized;
        
        fileList.forEach(url => {
            const parts = url.split('/');
            const filename = parts[parts.length - 1]; // 파일명: RTU-001_1_timestamp.jpg
            if (filename.startsWith(rtuName)) {
                const indexMatch = filename.match(/_(\d+)_/);
                if (indexMatch) {
                    const index = indexMatch[1];
                    organized[index] = url;
                }
            }
        });
        return organized;
    }

    /* ==================== Firebase 데이터 관리 ==================== */

    /**
     * Firebase에서 모든 데이터를 로드하고 전역 변수에 저장합니다.
     * @returns {Promise<void>}
     */
    async function loadFromFirebase() {
      // RTU 데이터 로드
      const rtuSnapshot = await database.ref('rtu').once('value');
      const rtuObj = rtuSnapshot.val() || {};
      rtuList = Object.keys(rtuObj).map(key => ({ id: key, ...rtuObj[key] })).reverse();
      
      // 점검 기록 로드
      const inspectionSnapshot = await database.ref('inspection').once('value');
      const inspectionObj = inspectionSnapshot.val() || {};
      inspectionList = Object.keys(inspectionObj).map(key => ({ id: key, ...inspectionObj[key] })).reverse();

      // 수리 기록 로드
      const repairSnapshot = await database.ref('repair').once('value');
      const repairObj = repairSnapshot.val() || {};
      repairList = Object.keys(repairObj).map(key => ({ id: key, ...repairObj[key] })).reverse();

      console.log(`Loaded ${rtuList.length} RTUs, ${inspectionList.length} Inspections, ${repairList.length} Repairs.`);
    }

    /**
     * 데이터를 Firebase에 저장하고 성공/실패 여부를 반환합니다.
     * @param {string} refPath 데이터베이스 경로 ('rtu', 'inspection', 'repair')
     * @param {Object} data 저장할 데이터 객체
     * @param {string | null} id 수정할 경우의 ID (신규 등록이면 null)
     * @returns {Promise<boolean>}
     */
    async function saveToFirebase(refPath, data, id = null) {
      try {
        if (id) {
          // 수정
          await database.ref(`${refPath}/${id}`).update({
            ...data,
            lastUpdated: Date.now() // 수정 시각 업데이트
          });
        } else {
          // 신규 등록
          await database.ref(refPath).push({
            ...data,
            date: data.date || formatTimestamp(Date.now()),
            lastUpdated: Date.now() 
          });
        }
        return true;
      } catch (error) {
        console.error("Firebase 저장 실패:", error);
        return false;
      }
    }

    /**
     * Firebase Storage에 이미지를 업로드합니다.
     * @param {string} rtuId RTU ID
     * @param {File} file 업로드할 파일 객체
     * @param {number} index 이미지 인덱스 (1, 2, 3)
     * @returns {Promise<string>} 파일 다운로드 URL
     */
    async function uploadImage(rtuId, file, index) {
      const timestamp = Date.now();
      const fileName = `${rtuId}_${index}_${timestamp}.jpg`; // 고유한 파일 이름 생성
      const imageRef = storageRef.child(`rtu_images/${rtuId}/${fileName}`);
      
      const snapshot = await imageRef.put(file);
      const downloadURL = await snapshot.ref.getDownloadURL();
      return downloadURL;
    }

    /**
     * 특정 RTU의 기존 이미지 파일들을 Storage에서 삭제합니다.
     * @param {string} rtuId RTU ID
     * @param {Array<string>} urlsToDelete 삭제할 이미지 URL 목록
     * @returns {Promise<void>}
     */
    async function deleteImages(rtuId, urlsToDelete) {
        if (!urlsToDelete || urlsToDelete.length === 0) return;

        const deletePromises = urlsToDelete.map(url => {
            // URL에서 storage reference를 추출
            const path = url.split('?')[0].split('%2F').slice(1).join('/');
            const encodedPath = decodeURIComponent(path);
            
            // Storage 참조 생성
            const fileRef = storage.refFromURL(url);
            
            // 파일 삭제
            return fileRef.delete().catch(error => {
                // 파일이 존재하지 않는 경우 (예외 처리)
                if (error.code !== 'storage/object-not-found') {
                    console.error("파일 삭제 실패:", fileRef.fullPath, error);
                }
            });
        });

        await Promise.all(deletePromises);
        console.log(`Deleted ${urlsToDelete.length} images for ${rtuId}.`);
    }

    /* ==================== RTU 등록/수정 모드 관리 ==================== */

    /**
     * RTU 폼의 모드를 신규 등록 또는 정보 수정으로 전환합니다.
     * @param {string} mode 'new' 또는 'modify'
     */
    function setRtuFormMode(mode) {
        if (mode === 'new') {
            elements.rtuFormTitle.textContent = "RTU 장비 신규 등록";
            elements.rtuNameInput.classList.remove('hidden');
            elements.rtuNameInput.required = true;
            elements.rtuModifySelect.classList.add('hidden');
            elements.rtuModifySelect.required = false;
            elements.rtuSubmitBtn.textContent = "RTU 정보 저장";
            elements.rtuIdForModification.value = '';
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
        } else if (mode === 'modify') {
            elements.rtuFormTitle.textContent = "RTU 장비 정보 수정";
            elements.rtuNameInput.classList.add('hidden');
            elements.rtuNameInput.required = false;
            elements.rtuModifySelect.classList.remove('hidden');
            elements.rtuModifySelect.required = true;
            elements.rtuSubmitBtn.textContent = "RTU 정보 수정";
            
            // 수정 모드 진입 시, 선택 박스 초기화
            elements.rtuModifySelect.value = '';
            // 폼 필드 초기화 (선택 전)
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
        }
        elements.modeNewBtn.classList.toggle('bg-blue-600', mode === 'new');
        elements.modeNewBtn.classList.toggle('text-white', mode === 'new');
        elements.modeNewBtn.classList.toggle('bg-gray-200', mode === 'modify');
        elements.modeNewBtn.classList.toggle('text-gray-700', mode === 'modify');

        elements.modeModifyBtn.classList.toggle('bg-blue-600', mode === 'modify');
        elements.modeModifyBtn.classList.toggle('text-white', mode === 'modify');
        elements.modeModifyBtn.classList.toggle('bg-gray-200', mode === 'new');
        elements.modeModifyBtn.classList.toggle('text-gray-700', mode === 'new');
    }

    /**
     * 수정 폼에 RTU 정보를 로드합니다.
     * @param {string} rtuId RTU ID
     */
    function loadRtuForModification(rtuId) {
        const rtu = rtuList.find(r => r.id === rtuId);
        if (!rtu) {
            alert("선택된 RTU 정보를 찾을 수 없습니다.");
            elements.rtuForm.reset();
            elements.imagePreviewContainer.classList.add('hidden');
            clearImagePreviews();
            return;
        }

        // 폼 필드 채우기
        elements.rtuIdForModification.value = rtu.id;
        document.getElementById('rtu-region').value = rtu.region || '';
        document.getElementById('rtu-model').value = rtu.model || '';
        document.getElementById('rtu-capacity').value = rtu.capacity || '';
        document.getElementById('rtu-unit-type').value = rtu.unitType || '패키지';
        document.getElementById('rtu-refrigerant').value = rtu.refrigerant || 'R-410A';
        document.getElementById('rtu-electric-phase').value = rtu.electricPhase || '단상';
        document.getElementById('rtu-date').value = rtu.date || '';
        document.getElementById('rtu-status').value = rtu.status || '작동중';
        document.getElementById('rtu-pressure-high').value = rtu.pressureHighLimit || '';
        document.getElementById('rtu-pressure-low').value = rtu.pressureLowLimit || '';
        document.getElementById('rtu-notes').value = rtu.notes || '';

        // 이미지 미리보기 및 기존 URL 설정
        clearImagePreviews();
        const rtuImages = organizeImages(rtu.imageUrls, rtu.name);
        
        ['1', '2', '3'].forEach(index => {
            const url = rtuImages[index];
            if (url) {
                const imgElement = document.getElementById(`image-preview-${index}`);
                imgElement.src = url;
                imgElement.style.display = 'block';
                imgElement.dataset.existingUrl = url; // 기존 URL 저장
            } else {
                // 기존 URL이 없더라도, 폼 제출 시 비어있는 상태로 전송될 수 있도록 data 속성 초기화
                const imgElement = document.getElementById(`image-preview-${index}`);
                delete imgElement.dataset.existingUrl;
            }
        });
        elements.imagePreviewContainer.classList.remove('hidden');
    }

    /**
     * 이미지 미리보기를 초기화합니다.
     */
    function clearImagePreviews() {
        ['1', '2', '3'].forEach(index => {
            const imgElement = document.getElementById(`image-preview-${index}`);
            imgElement.src = '';
            imgElement.style.display = 'none';
            delete imgElement.dataset.existingUrl;
            // 파일 입력 필드 초기화 (업로드 버튼이 아닌 실제 input 필드)
            const fileInput = document.getElementById(`rtu-image${index}`);
            fileInput.value = '';
        });
    }

    /* ==================== RTU 렌더링 및 페이지네이션 ==================== */

    /**
     * RTU 목록을 렌더링하고 페이지네이션을 처리합니다.
     * @param {number} page 현재 페이지 번호
     */
    function renderRtuList(page) {
        rtuCurrentPage = page;
        const totalItems = rtuList.length;
        elements.rtuCount.textContent = totalItems;
        elements.rtuListContainer.innerHTML = '';
        elements.rtuPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.rtuListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 RTU 장비가 없습니다.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = rtuList.slice(start, end);

        paginatedItems.forEach(rtu => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-gray-50 rounded-xl shadow-md border hover:bg-gray-100 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-blue-700">${rtu.name}</h3>
                        <p class="text-sm text-gray-600">${rtu.region} | ${rtu.model || '모델 정보 없음'}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(rtu.status)}">
                        ${rtu.status}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>유닛 종류:</strong> ${rtu.unitType || '-'}</p>
                    <p><strong>용량:</strong> ${rtu.capacity || '-'} | <strong>냉매:</strong> ${rtu.refrigerant || '-'}</p>
                    <p><strong>설치 날짜:</strong> ${rtu.date}</p>
                    <p><strong>특이사항:</strong> ${rtu.notes ? rtu.notes.substring(0, 50) + (rtu.notes.length > 50 ? '...' : '') : '없음'}</p>
                </div>
                <div class="mt-4 flex space-x-3 text-sm">
                    <button data-rtu-id="${rtu.id}" class="view-detail-btn text-blue-600 font-semibold hover:text-blue-800 transition">상세 보기</button>
                    <button data-rtu-id="${rtu.id}" class="edit-btn text-indigo-600 font-semibold hover:text-indigo-800 transition">수정</button>
                    <button data-rtu-id="${rtu.id}" class="delete-btn text-red-600 font-semibold hover:text-red-800 transition">삭제</button>
                </div>
            `;
            elements.rtuListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderRtuList, elements.rtuPagination);
    }

    /* ==================== 점검 기록 렌더링 ==================== */
    
    /**
     * 점검 기록 목록을 렌더링하고 페이지네이션을 처리합니다.
     * @param {number} page 현재 페이지 번호
     */
    function renderInspectionList(page) {
        inspectionCurrentPage = page;
        const totalItems = inspectionList.length;
        elements.inspectionCount.textContent = totalItems;
        elements.inspectionListContainer.innerHTML = '';
        elements.inspectionPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.inspectionListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 점검 기록이 없습니다.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = inspectionList.slice(start, end);

        paginatedItems.forEach(inspection => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-white rounded-xl shadow-md border hover:bg-gray-50 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-gray-800">${inspection.rtuId} 점검 기록</h3>
                        <p class="text-sm text-gray-600">점검 날짜: <strong>${inspection.inspectionDate}</strong> | 점검자: ${inspection.inspector}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(inspection.result)}">
                        ${inspection.result}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>Comp1 압력:</strong> ${inspection.comp1Hp || '-'}PSI / ${inspection.comp1Lp || '-'}PSI (H/L)</p>
                    <p><strong>Comp2 압력:</strong> ${inspection.comp2Hp || '-'}PSI / ${inspection.comp2Lp || '-'}PSI (H/L)</p>
                    <p><strong>특이사항:</strong> ${inspection.notes ? inspection.notes.substring(0, 50) + (inspection.notes.length > 50 ? '...' : '') : '없음'}</p>
                </div>
                <div class="mt-4 flex space-x-3 text-sm">
                    <button data-inspection-id="${inspection.id}" class="view-inspection-detail-btn text-blue-600 font-semibold hover:text-blue-800 transition">상세 보기</button>
                </div>
            `;
            elements.inspectionListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderInspectionList, elements.inspectionPagination);
    }
    
    /* ==================== 수리 기록 렌더링 ==================== */

    /**
     * 수리 기록 목록을 렌더링하고 페이지네이션을 처리합니다.
     * @param {number} page 현재 페이지 번호
     */
    function renderRepairList(page) {
        repairCurrentPage = page;
        const totalItems = repairList.length;
        elements.repairCount.textContent = totalItems;
        elements.repairListContainer.innerHTML = '';
        elements.repairPagination.innerHTML = '';

        if (totalItems === 0) {
            elements.repairListContainer.innerHTML = '<p class="text-gray-500 italic">등록된 수리 기록이 없습니다.</p>';
            return;
        }

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = repairList.slice(start, end);

        paginatedItems.forEach(repair => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 bg-white rounded-xl shadow-md border hover:bg-gray-50 transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-xl font-bold text-gray-800">${repair.rtuId} 수리 기록</h3>
                        <p class="text-sm text-gray-600">처리 날짜: <strong>${repair.repairDate}</strong> | 담당자: ${repair.engineer}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(repair.status)}">
                        ${repair.status}
                    </span>
                </div>
                <div class="mt-3 text-sm text-gray-700 space-y-1 border-t pt-3">
                    <p><strong>문제/조치:</strong> ${repair.issue ? repair.issue.substring(0, 70) + (repair.issue.length > 70 ? '...' : '') : '내용 없음'}</p>
                </div>
            `;
            elements.repairListContainer.appendChild(itemElement);
        });

        renderPagination(totalPages, page, renderRepairList, elements.repairPagination);
    }
    
    /* ==================== 페이지네이션 함수 ==================== */

    /**
     * 페이지네이션 컨트롤을 렌더링합니다.
     * @param {number} totalPages 전체 페이지 수
     * @param {number} currentPage 현재 페이지
     * @param {function(number): void} renderFunction 페이지 렌더링 함수
     * @param {HTMLElement} container 페이지네이션 버튼을 넣을 컨테이너
     */
    function renderPagination(totalPages, currentPage, renderFunction, container) {
        container.innerHTML = '';
        if (totalPages <= 1) return;

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        const createButton = (text, pageNum, isDisabled = false) => {
            const button = document.createElement('button');
            button.className = `pagination-btn px-4 py-2 mx-1 text-sm rounded-lg transition duration-150 ${isDisabled ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`;
            if (pageNum === currentPage && !isDisabled) {
                button.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
            button.textContent = text;
            button.disabled = isDisabled;
            if (!isDisabled) {
                button.addEventListener('click', () => renderFunction(pageNum));
            }
            return button;
        };

        // 이전 버튼
        container.appendChild(createButton('이전', currentPage - 1, currentPage === 1));

        // 페이지 번호 버튼
        for (let i = startPage; i <= endPage; i++) {
            container.appendChild(createButton(i, i));
        }

        // 다음 버튼
        container.appendChild(createButton('다음', currentPage + 1, currentPage === totalPages));
    }

    /* ==================== 셀렉트 박스 업데이트 ==================== */

    /**
     * RTU 목록을 기반으로 모든 RTU 선택 박스를 업데이트합니다.
     */
    function populateRtuSelects() {
        const selects = [
            elements.rtuModifySelect, 
            elements.inspectionRtuId, 
            elements.repairRtuId
        ];

        selects.forEach(select => {
            const originalValue = select.value;
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = select.id === 'rtu-modify-select' ? '-- 수정할 RTU를 선택하세요 --' : '-- RTU를 선택하세요 --';
            select.appendChild(defaultOption);

            rtuList.forEach(rtu => {
                const option = document.createElement('option');
                option.value = rtu.id;
                option.textContent = `${rtu.name} (${rtu.region})`;
                select.appendChild(option);
            });
            // 기존 선택 값 복원
            select.value = originalValue;
        });

        // 수정 모드 시 RTU 이름 입력 필드를 선택된 RTU ID로 자동 업데이트
        if (elements.rtuModifySelect.value) {
             elements.rtuNameInput.value = elements.rtuModifySelect.value;
        }
    }

    /* ==================== 대시보드 업데이트 ==================== */

    /**
     * 대시보드 요약 정보를 업데이트합니다.
     */
    function updateDashboard() {
        // Total RTU Count
        elements.dashboardTotal.textContent = rtuList.length;

        // Status Counts
        const statusCounts = rtuList.reduce((acc, rtu) => {
            acc[rtu.status] = (acc[rtu.status] || 0) + 1;
            return acc;
        }, {});

        elements.dashboardRunning.textContent = statusCounts['작동중'] || 0;
        elements.dashboardStopped.textContent = statusCounts['정지됨'] || 0;
        elements.dashboardNeedsInspection.textContent = statusCounts['점검필요'] || 0;

        // Monthly Inspection Count (current month)
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthlyInspectionCount = inspectionList.filter(inspection => new Date(inspection.inspectionDate) >= startOfMonth).length;
        elements.dashboardMonthlyInspection.textContent = monthlyInspectionCount;

        // Pending Repair Count (요청 또는 진행중)
        const pendingRepairCount = repairList.filter(repair => repair.status === '요청' || repair.status === '진행중').length;
        elements.dashboardPendingRepair.textContent = pendingRepairCount;

        // Latest RTU List
        const latestRtu = rtuList.sort((a, b) => new Date(b.lastUpdated || b.date) - new Date(a.lastUpdated || a.date)).slice(0, 5);

        if (latestRtu.length === 0) {
            elements.dashboardLatestList.innerHTML = '<p class="text-gray-500">등록된 장비가 없습니다.</p>';
        } else {
            elements.dashboardLatestList.innerHTML = latestRtu.map(rtu => `
                <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <span class="font-medium text-gray-700">${rtu.name} (${rtu.region})</span>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span>
                </div>
            `).join('');
        }

        // Report Page Update (Summary)
        elements.reportTotalRtu.textContent = rtuList.length;
        elements.reportTotalInspection.textContent = inspectionList.length;
        elements.reportTotalRepair.textContent = repairList.length;
    }

    /* ==================== CSV 처리 함수 ==================== */

    /**
     * JSON 데이터를 CSV 문자열로 변환합니다.
     * @param {Array<Object>} data 변환할 데이터 배열
     * @param {Array<string>} headers CSV 헤더 이름 배열
     * @param {Object} keyMap 데이터 객체의 키와 헤더 이름의 매핑
     * @returns {string} CSV 문자열
     */
    function convertToCSV(data, headers, keyMap) {
        if (data.length === 0) return headers.join(',') + '\n';
        
        const headerRow = headers.join(',') + '\n';
        
        const rows = data.map(item => {
            const values = headers.map(header => {
                const key = keyMap[header];
                let value = item[key] !== undefined && item[key] !== null ? item[key] : '';
                
                if (typeof value === 'string') {
                    // 쉼표나 따옴표가 포함된 경우 이스케이프 처리
                    value = value.replace(/"/g, '""');
                    if (value.includes(',') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                }
                return value;
            });
            return values.join(',');
        }).join('\n');

        return headerRow + rows;
    }

    /**
     * CSV 데이터를 다운로드합니다.
     */
    function downloadData() {
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;

        // 1. RTU 데이터
        const rtuHeaders = ["ID", "RTU 등록번호/ID", "설치 장소/지역", "모델명", "유닛 종류", "용량 (냉동톤/kW)", "냉매 종류", "전기 종류", "설치(등록) 날짜", "현재 상태", "고압 상한 설정 (PSI)", "저압 하한 설정 (PSI)", "특이사항 및 메모", "이미지 URL 목록", "최종 업데이트 시간"];
        const rtuKeyMap = {
            "ID": "id", "RTU 등록번호/ID": "name", "설치 장소/지역": "region", "모델명": "model", "유닛 종류": "unitType", "용량 (냉동톤/kW)": "capacity", "냉매 종류": "refrigerant", "전기 종류": "electricPhase", "설치(등록) 날짜": "date", "현재 상태": "status", "고압 상한 설정 (PSI)": "pressureHighLimit", "저압 하한 설정 (PSI)": "pressureLowLimit", "특이사항 및 메모": "notes", 
            "이미지 URL 목록": "imageUrls", "최종 업데이트 시간": "lastUpdated"
        };
        const rtuDataForCSV = rtuList.map(item => ({
            ...item,
            imageUrls: (item.imageUrls || []).join(' | ') // URL 목록을 하나의 문자열로 결합
        }));
        const rtuCsv = convertToCSV(rtuDataForCSV, rtuHeaders, rtuKeyMap);
        downloadFile(rtuCsv, `RTU_Data_${dateString}.csv`);

        // 2. 점검 기록
        const inspectionHeaders = ["ID", "RTU ID", "점검 날짜", "점검자", "최종 점검 결과", "1. 필터", "2. 콘텍터", "3. 콘덴싱 코일", "4. 송풍 모터", "5. 증발기 코일", "6. 고압 센서", "7. 저압 센서", "8. 캐패시터", "Comp1 고압(PSI)", "Comp1 저압(PSI)", "Comp1 전류(A)", "Comp2 고압(PSI)", "Comp2 저압(PSI)", "Comp2 전류(A)", "과열도(F)", "과냉도(F)", "특이사항 및 조치 내용", "최종 업데이트 시간"];
        const inspectionKeyMap = {
            "ID": "id", "RTU ID": "rtuId", "점검 날짜": "inspectionDate", "점검자": "inspector", "최종 점검 결과": "result", "1. 필터": "check1", "2. 콘텍터": "check2", "3. 콘덴싱 코일": "check3", "4. 송풍 모터": "check4", "5. 증발기 코일": "check5", "6. 고압 센서": "check6", "7. 저압 센서": "check7", "8. 캐패시터": "check8", "Comp1 고압(PSI)": "comp1Hp", "Comp1 저압(PSI)": "comp1Lp", "Comp1 전류(A)": "comp1Amp", "Comp2 고압(PSI)": "comp2Hp", "Comp2 저압(PSI)": "comp2Lp", "Comp2 전류(A)": "comp2Amp", "과열도(F)": "superheat", "과냉도(F)": "subcool", "특이사항 및 조치 내용": "notes", "최종 업데이트 시간": "lastUpdated"
        };
        const inspectionCsv = convertToCSV(inspectionList, inspectionHeaders, inspectionKeyMap);
        downloadFile(inspectionCsv, `Inspection_Data_${dateString}.csv`);

        // 3. 수리 기록
        const repairHeaders = ["ID", "RTU ID", "수리 요청/완료 날짜", "수리 담당자", "처리 상태", "문제 및 조치 내용", "최종 업데이트 시간"];
        const repairKeyMap = {
            "ID": "id", "RTU ID": "rtuId", "수리 요청/완료 날짜": "repairDate", "수리 담당자": "engineer", "처리 상태": "status", "문제 및 조치 내용": "issue", "최종 업데이트 시간": "lastUpdated"
        };
        const repairCsv = convertToCSV(repairList, repairHeaders, repairKeyMap);
        downloadFile(repairCsv, `Repair_Data_${dateString}.csv`);
        
        alert("RTU, 점검 기록, 수리 기록 3가지 데이터 파일이 모두 다운로드 되었습니다.");
    }

    /**
     * CSV 데이터를 파일로 다운로드합니다.
     * @param {string} content 파일 내용 (CSV 문자열)
     * @param {string} fileName 파일 이름
     */
    function downloadFile(content, fileName) {
        const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    /* ==================== CSV 업로드 함수 ==================== */

    /**
     * CSV 파일을 읽고 JSON 데이터로 변환합니다.
     * @param {File} file 업로드된 CSV 파일
     * @returns {Promise<Object>} { headers: Array<string>, data: Array<Object> }
     */
    function readCsvFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length === 0) {
                        return reject(new Error('파일 내용이 비어 있습니다.'));
                    }
                    
                    // 첫 번째 줄을 헤더로 처리하고 따옴표 제거
                    let headers = lines[0].split(',').map(h => h.trim().replace(/^"(.*)"$/, '$1')); 
                    
                    // 데이터 행 파싱
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        if (!line.trim()) continue;

                        // 간단한 CSV 파싱 (큰따옴표 안의 쉼표는 무시)
                        const values = [];
                        let inQuotes = false;
                        let currentVal = '';
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                if (line[j + 1] === '"') { // 이스케이프된 따옴표
                                    currentVal += '"';
                                    j++;
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentVal.trim().replace(/^"(.*)"$/, '$1'));
                                currentVal = '';
                            } else {
                                currentVal += char;
                            }
                        }
                        values.push(currentVal.trim().replace(/^"(.*)"$/, '$1')); // 마지막 값 추가

                        if (values.length !== headers.length) {
                            console.warn(`행 ${i + 1}의 열 개수가 헤더와 일치하지 않아 건너뜁니다. (헤더: ${headers.length}, 값: ${values.length})`);
                            continue;
                        }

                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = values[index];
                        });
                        data.push(item);
                    }
                    
                    resolve({ headers, data });
                } catch (error) {
                    reject(new Error(`CSV 파싱 중 오류 발생: ${error.message}`));
                }
            };
            reader.onerror = (e) => reject(new Error('파일 읽기 오류'));
            reader.readAsText(file, 'utf-8');
        });
    }

    /**
     * CSV 헤더를 Firebase/JSON 키 이름으로 변환합니다.
     * @param {string} header CSV 헤더 이름
     * @returns {string} JSON 키 이름
     */
    function mapHeaderToKey(header) {
      switch (header.trim()) {
        case "ID": return "id";
        case "RTU 등록번호/ID": return "name";
        case "설치 장소/지역": return "region";
        case "용량 (냉동톤/kW)": return "capacity";
        case "유닛 종류": return "unitType";
        case "냉매 종류": return "refrigerant";
        case "전기 종류": return "electricPhase";
        case "설치(등록) 날짜": return "date";
        case "현재 상태": return "status";
        case "고압 상한 설정 (PSI)": return "pressureHighLimit";
        case "저압 하한 설정 (PSI)": "pressureLowLimit";
        case "특이사항 및 메모": return "notes";
        case "이미지 URL 목록": return "imageUrls";
        case "RTU ID": return "rtuId";
        case "점검 날짜": return "inspectionDate";
        case "점검자": return "inspector";
        case "최종 점검 결과": return "result";
        case "1. 필터": return "check1";
        case "2. 콘텍터": return "check2";
        case "3. 콘덴싱 코일": return "check3";
        case "4. 송풍 모터": return "check4";
        case "5. 증발기 코일": return "check5";
        case "6. 고압 센서": return "check6";
        case "7. 저압 센서": return "check7";
        case "8. 캐패시터": return "check8";
        case "Comp1 고압(PSI)": return "comp1Hp";
        case "Comp1 저압(PSI)": return "comp1Lp";
        case "Comp1 전류(A)": return "comp1Amp";
        case "Comp2 고압(PSI)": return "comp2Hp";
        case "Comp2 저압(PSI)": return "comp2Lp";
        case "Comp2 전류(A)": return "comp2Amp";
        case "과열도(F)": return "superheat";
        case "과냉도(F)": return "subcool";
        case "수리 요청/완료 날짜": return "repairDate";
        case "수리 담당자": return "engineer";
        case "처리 상태": return "status";
        case "문제 및 조치 내용": return "issue";
        case "최종 업데이트 시간": return "lastUpdated"; // 업데이트 시간은 무시하고 새로 생성
        default:
          // 기타 헤더 (예: 'model')는 소문자 camelCase로 변환 시도
          return header.trim().toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
      }
    }


    /**
     * CSV 데이터를 Firebase에 업로드합니다.
     * @param {File[]} files 업로드할 파일 목록
     */
    async function uploadCsvData(files) {
        if (files.length === 0) return;

        let totalUploaded = 0;
        let totalSkipped = 0;
        
        for (const file of files) {
            try {
                const { headers, data: rawData } = await readCsvFile(file);
                
                let refPath = null;
                if (headers.includes("RTU 등록번호/ID") && headers.includes("설치 장소/지역")) {
                    refPath = 'rtu';
                } else if (headers.includes("점검 날짜") && headers.includes("점검자")) {
                    refPath = 'inspection';
                } else if (headers.includes("수리 요청/완료 날짜") && headers.includes("수리 담당자")) {
                    refPath = 'repair';
                }

                if (!refPath) {
                    alert(`파일 "${file.name}": 데이터 형식을 인식할 수 없습니다. (RTU, 점검, 수리 기록 중 하나여야 합니다)`);
                    continue;
                }

                const keyMap = headers.reduce((map, header) => {
                    map[header] = mapHeaderToKey(header);
                    return map;
                }, {});

                for (const rawItem of rawData) {
                    const mappedItem = {};
                    for (const header in rawItem) {
                        const key = keyMap[header];
                        if (key && key !== 'id' && key !== 'lastUpdated' && rawItem[header].trim() !== '') {
                            // imageUrls는 다시 배열로 변환
                            if (key === 'imageUrls') {
                                mappedItem[key] = rawItem[header].split(' | ').filter(url => url.trim() !== '');
                            } else {
                                mappedItem[key] = rawItem[header];
                            }
                        }
                    }

                    // 필수 필드 검사
                    if (refPath === 'rtu' && !mappedItem.name) {
                        totalSkipped++;
                        continue;
                    }
                    if (refPath === 'inspection' && (!mappedItem.rtuId || !mappedItem.inspectionDate)) {
                         totalSkipped++;
                         continue;
                    }
                    if (refPath === 'repair' && (!mappedItem.rtuId || !mappedItem.repairDate)) {
                        totalSkipped++;
                        continue;
                    }

                    // ID가 있으면 기존 데이터 덮어쓰기/수정, 없으면 신규 추가
                    const id = rawItem["ID"] && rawItem["ID"].trim() !== '' ? rawItem["ID"] : null;
                    await saveToFirebase(refPath, mappedItem, id);
                    totalUploaded++;
                }
            } catch (error) {
                alert(`파일 "${file.name}" 처리 중 오류 발생: ${error.message}`);
                console.error(error);
            }
        }

        if (totalUploaded > 0) {
            alert(`총 ${totalUploaded} 건의 데이터 업로드가 완료되었습니다. (건너뛴 항목: ${totalSkipped} 건)`);
            await loadFromFirebase();
            renderRtuList(1);
            renderInspectionList(1);
            renderRepairList(1);
            populateRtuSelects();
            updateDashboard();
        } else {
            alert(`업로드할 유효한 데이터가 없거나 모두 실패했습니다. (건너뛴 항목: ${totalSkipped} 건)`);
        }
    }


    /* ==================== 보고서 관련 함수 (수정된 부분) ==================== */

    /**
     * 상세 보고서를 렌더링하고 인쇄를 준비합니다.
     * @param {('rtu'|'inspection'|'repair')} type 보고서 타입
     */
    function renderReportDetail(type) {
        const reportTitle = elements.reportTitle;
        const reportContent = elements.reportContent;
        let data = [];
        let titleText = "";
        let tableHeaders = [];
        let tableBody = "";

        switch (type) {
            case 'rtu':
                data = rtuList;
                titleText = "RTU 등록 목록";
                tableHeaders = ["RTU 등록번호/ID", "설치 장소/지역", "모델명", "유닛 종류", "용량 (냉동톤/kW)", "설치(등록) 날짜", "현재 상태", "특이사항 및 메모"];
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.region}</td>
                        <td>${item.model || ''}</td>
                        <td>${item.unitType || ''}</td>
                        <td>${item.capacity || ''}</td>
                        <td>${item.date}</td>
                        <td>${item.status}</td>
                        <td>${item.notes || ''}</td>
                    </tr>
                `).join('');
                break;

            case 'inspection':
                data = inspectionList;
                titleText = "총 점검 기록 건수 목록";
                tableHeaders = ["RTU ID", "점검 날짜", "점검자", "최종 점검 결과", "Comp1 고압(PSI)", "Comp1 저압(PSI)", "Comp1 전류(A)", "Comp2 고압(PSI)", "Comp2 저압(PSI)", "Comp2 전류(A)", "과열도(F)", "과냉도(F)", "특이사항 및 조치 내용"];
                // 
                // ✅ 이 부분이 수정되어 점검 기록 데이터가 테이블 행으로 올바르게 렌더링됩니다.
                //
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.rtuId}</td>
                        <td>${item.inspectionDate}</td>
                        <td>${item.inspector}</td>
                        <td>${item.result}</td>
                        <td>${item.comp1Hp || ''}</td>
                        <td>${item.comp1Lp || ''}</td>
                        <td>${item.comp1Amp || ''}</td>
                        <td>${item.comp2Hp || ''}</td>
                        <td>${item.comp2Lp || ''}</td>
                        <td>${item.comp2Amp || ''}</td>
                        <td>${item.superheat || ''}</td>
                        <td>${item.subcool || ''}</td>
                        <td>${item.notes || ''}</td>
                    </tr>
                `).join('');
                break;

            case 'repair':
                data = repairList;
                titleText = "총 수리 기록 건수 목록";
                tableHeaders = ["RTU ID", "수리 요청/완료 날짜", "수리 담당자", "처리 상태", "문제 및 조치 내용"];
                tableBody = data.map(item => `
                    <tr>
                        <td>${item.rtuId}</td>
                        <td>${item.repairDate}</td>
                        <td>${item.engineer}</td>
                        <td>${item.status}</td>
                        <td>${item.issue || ''}</td>
                    </tr>
                `).join('');
                break;
        }

        reportTitle.textContent = titleText;
        
        // 데이터가 없는 경우를 포함하여 최종 HTML 생성
        const headersHtml = `<thead><tr>${tableHeaders.map(h => `<th class="p-2 text-left bg-gray-100">${h}</th>`).join('')}</tr></thead>`;
        const bodyHtml = `<tbody>${data.length > 0 ? tableBody : '<tr><td colspan="' + tableHeaders.length + '" class="text-center p-4 text-gray-500">데이터가 없습니다.</td></tr>'}</tbody>`;

        reportContent.innerHTML = `
            <div class="mb-6">
                <p class="text-sm text-gray-500">인쇄 시간: ${new Date().toLocaleString()}</p>
            </div>
            <table class="w-full text-sm text-left text-gray-500 shadow-md sm:rounded-lg">
                ${headersHtml}
                ${bodyHtml}
            </table>
        `;

        // 인쇄 버튼이 이미 report-detail-view에 있지만, 바로 인쇄 창을 띄우고 숨기는 로직을 사용합니다.
        // 화면이 업데이트될 시간을 주고 인쇄 창을 띄웁니다.
        setTimeout(() => {
            // window.print(); // 사용자가 직접 버튼을 누르도록 유도
            // elements.reportDetailView.classList.add('hidden'); // 인쇄 후 뷰 숨기기
        }, 300); 
    }

    /* ==================== 이벤트 리스너 설정 ==================== */

    // 탭 전환
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // 모든 탭 버튼 비활성화
            elements.tabButtons.forEach(btn => {
                btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600', 'hover:border-gray-300', 'hover:text-gray-700');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // 선택된 탭 버튼 활성화
            button.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');

            // 모든 페이지 숨기기
            elements.tabPages.forEach(page => page.classList.add('hidden'));

            // 대상 페이지 표시
            document.getElementById(targetTab).classList.remove('hidden');

            // 보고서 페이지에서 다른 탭으로 이동 시 상세 뷰 숨기기
            if (targetTab !== 'report-page') {
                elements.reportDetailView.classList.add('hidden');
            }
        });
    });

    // RTU 등록/수정 모드 버튼
    elements.modeNewBtn.addEventListener('click', () => setRtuFormMode('new'));
    elements.modeModifyBtn.addEventListener('click', () => setRtuFormMode('modify'));

    // RTU 수정 시 선택 이벤트
    elements.rtuModifySelect.addEventListener('change', (e) => {
        const rtuId = e.target.value;
        if (rtuId) {
            elements.rtuNameInput.value = rtuId; // ID 입력 필드에 ID를 임시 저장
            loadRtuForModification(rtuId);
        } else {
             elements.rtuForm.reset();
             elements.rtuIdForModification.value = '';
             elements.rtuNameInput.value = '';
             elements.imagePreviewContainer.classList.add('hidden');
             clearImagePreviews();
        }
    });

    // 이미지 파일 선택 시 미리보기
    ['1', '2', '3'].forEach(index => {
        const fileInput = document.getElementById(`rtu-image${index}`);
        const imgPreview = document.getElementById(`image-preview-${index}`);
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imgPreview.src = event.target.result;
                    imgPreview.style.display = 'block';
                    elements.imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                // 파일 선택 취소 시, 기존 URL이 있으면 유지, 없으면 숨김
                if (!imgPreview.dataset.existingUrl) {
                    imgPreview.src = '';
                    imgPreview.style.display = 'none';
                }
            }
        });
    });

    // RTU 폼 제출 처리
    elements.rtuForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        elements.rtuSubmitBtn.disabled = true;
        elements.rtuSubmitBtn.innerHTML = '<span class="loading mr-2"></span> 저장 중...';

        const formData = new FormData(elements.rtuForm);
        const rtuIdForModification = elements.rtuIdForModification.value;
        const isModification = !!rtuIdForModification;
        const rtuId = isModification ? rtuIdForModification : formData.get('name').trim();
        
        if (!rtuId) {
             alert('RTU 등록번호/ID를 입력하거나 수정할 RTU를 선택해야 합니다.');
             elements.rtuSubmitBtn.disabled = false;
             elements.rtuSubmitBtn.textContent = isModification ? "RTU 정보 수정" : "RTU 정보 저장";
             return;
        }

        // 1. 이미지 처리
        let existingRtu = rtuList.find(r => r.id === rtuId);
        let currentImageUrls = existingRtu?.imageUrls || [];
        let urlsToDelete = [];
        let newImageUrls = [];
        let uploadPromises = [];

        // 기존 이미지를 유지할지/삭제할지 결정
        ['1', '2', '3'].forEach(index => {
            const fileInput = document.getElementById(`rtu-image${index}`);
            const imgPreview = document.getElementById(`image-preview-${index}`);
            const existingUrl = imgPreview.dataset.existingUrl;
            
            if (fileInput.files.length > 0) {
                // 새 파일이 선택됨 -> 기존 URL은 삭제 대상, 새 파일을 업로드 목록에 추가
                if (existingUrl) {
                    urlsToDelete.push(existingUrl);
                }
                uploadPromises.push(uploadImage(rtuId, fileInput.files[0], index));
            } else if (existingUrl) {
                // 새 파일은 없지만 기존 URL이 있음 -> 유지
                newImageUrls.push(existingUrl);
            } 
            // 새 파일도 없고 기존 URL도 없으면 아무것도 하지 않음 (빈 슬롯 유지)
        });

        // 삭제 및 업로드 실행
        await deleteImages(rtuId, urlsToDelete);
        const uploadedUrls = await Promise.all(uploadPromises);
        newImageUrls = newImageUrls.concat(uploadedUrls.filter(url => url));


        // 2. 데이터 객체 생성
        const rtuData = {
            name: rtuId, // ID를 name으로 사용
            region: formData.get('region') || '',
            model: formData.get('model') || '',
            capacity: formData.get('capacity') || '',
            unitType: formData.get('unitType') || '',
            refrigerant: formData.get('refrigerant') || '',
            electricPhase: formData.get('electricPhase') || '',
            date: formData.get('date') || formatTimestamp(Date.now()),
            status: formData.get('status') || '작동중',
            pressureHighLimit: formData.get('pressureHighLimit') || '',
            pressureLowLimit: formData.get('pressureLowLimit') || '',
            notes: formData.get('notes') || '',
            imageUrls: newImageUrls // 최종 URL 목록 저장
        };

        // 3. Firebase에 저장
        const success = await saveToFirebase('rtu', rtuData, isModification ? rtuId : null);

        if (success) {
            alert(`RTU 정보가 성공적으로 ${isModification ? '수정' : '등록'}되었습니다!`);
            elements.rtuForm.reset();
            setRtuFormMode('new'); // 등록 모드로 초기화
            await loadFromFirebase();
            renderRtuList(1);
            populateRtuSelects();
            updateDashboard();
        } else {
            alert(`RTU 정보 ${isModification ? '수정' : '등록'}에 실패했습니다.`);
        }

        elements.rtuSubmitBtn.disabled = false;
        elements.rtuSubmitBtn.textContent = isModification ? "RTU 정보 수정" : "RTU 정보 저장";
    });

    // RTU 상세 보기 버튼 처리
    elements.rtuListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-detail-btn')) {
            const rtuId = e.target.dataset.rtuId;
            const rtu = rtuList.find(r => r.id === rtuId);
            if (!rtu) return;

            const rtuDetailModal = document.createElement('div');
            rtuDetailModal.id = 'rtu-detail-modal';
            rtuDetailModal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-bg';
            
            const rtuImages = organizeImages(rtu.imageUrls, rtu.name);
            const imageHtml = ['1', '2', '3'].map(index => rtuImages[index] ? `<img src="${rtuImages[index]}" alt="장비 사진 ${index}" class="thumb-detail cursor-pointer" data-url="${rtuImages[index]}">` : '').join('');
            
            rtuDetailModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-gray-900 border-b pb-3 mb-4">${rtu.name} 상세 정보</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-gray-700 text-sm">
                        <p><strong>설치 장소:</strong> ${rtu.region || '-'}</p>
                        <p><strong>모델명:</strong> ${rtu.model || '-'}</p>
                        <p><strong>유닛 종류:</strong> ${rtu.unitType || '-'}</p>
                        <p><strong>용량:</strong> ${rtu.capacity || '-'}</p>
                        <p><strong>냉매:</strong> ${rtu.refrigerant || '-'}</p>
                        <p><strong>전기 종류:</strong> ${rtu.electricPhase || '-'}</p>
                        <p><strong>설치 날짜:</strong> ${rtu.date || '-'}</p>
                        <p><strong>현재 상태:</strong> <span class="px-2 py-0.5 text-xs font-semibold rounded ${getStatusColor(rtu.status)}">${rtu.status}</span></p>
                        <p class="col-span-2"><strong>고압/저압 설정:</strong> ${rtu.pressureHighLimit || '-'} PSI / ${rtu.pressureLowLimit || '-'} PSI (H/L)</p>
                        <p class="col-span-2"><strong>특이사항:</strong> <br>${rtu.notes ? rtu.notes.replace(/\n/g, '<br>') : '없음'}</p>
                    </div>
                    
                    <div class="mt-6 border-t pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">장비 사진</h4>
                        <div class="flex flex-wrap gap-4">
                            ${imageHtml || '<p class="text-gray-500 text-sm">등록된 사진이 없습니다.</p>'}
                        </div>
                    </div>
                    
                    <button class="close-rtu-detail-modal w-full mt-6 bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-300 transition">닫기</button>
                </div>
            `;
            document.body.appendChild(rtuDetailModal);
            
            // 이미지 클릭 시 모달 띄우기
            rtuDetailModal.querySelectorAll('.thumb-detail').forEach(img => {
                img.addEventListener('click', (e) => {
                    const url = e.target.dataset.url;
                    elements.modalImage.src = url;
                    elements.imageModal.classList.remove('hidden');
                    elements.imageModal.classList.add('flex');
                });
            });

            // 닫기 버튼 이벤트
            rtuDetailModal.querySelector('.close-rtu-detail-modal').addEventListener('click', () => {
                rtuDetailModal.remove();
            });

            rtuDetailModal.addEventListener('click', (e) => {
                if (e.target === rtuDetailModal) {
                    rtuDetailModal.remove();
                }
            });
        }
    });

    // RTU 수정 버튼 처리 (수정 탭으로 이동 및 데이터 로드)
    elements.rtuListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const rtuId = e.target.dataset.rtuId;
            // 탭 전환
            document.querySelector('[data-tab="rtu-manage"]').click();
            // 수정 모드 전환
            setRtuFormMode('modify');
            // Select 값 설정 및 데이터 로드
            elements.rtuModifySelect.value = rtuId;
            elements.rtuNameInput.value = rtuId;
            loadRtuForModification(rtuId);
        }
    });
    
    // RTU 삭제 버튼 처리
    elements.rtuListContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const rtuId = e.target.dataset.rtuId;
            if (confirm(`RTU ID: ${rtuId} 장비를 삭제하시겠습니까? 관련 점검/수리 기록은 유지됩니다.`)) {
                try {
                    // 1. Storage 이미지 삭제 (선택적)
                    const rtu = rtuList.find(r => r.id === rtuId);
                    if (rtu && rtu.imageUrls && rtu.imageUrls.length > 0) {
                        await deleteImages(rtuId, rtu.imageUrls);
                    }
                    
                    // 2. Database 항목 삭제
                    await database.ref(`rtu/${rtuId}`).remove();
                    
                    alert(`RTU ID: ${rtuId} 장비가 성공적으로 삭제되었습니다.`);
                    await loadFromFirebase();
                    renderRtuList(rtuCurrentPage);
                    populateRtuSelects();
                    updateDashboard();
                } catch (error) {
                    console.error("RTU 삭제 실패:", error);
                    alert("RTU 삭제 중 오류가 발생했습니다.");
                }
            }
        }
    });


    // 이미지 확대 모달 닫기
    elements.closeModalBtn.addEventListener('click', () => {
        elements.imageModal.classList.add('hidden');
        elements.imageModal.classList.remove('flex');
    });
    elements.imageModal.addEventListener('click', (e) => {
        if (e.target === elements.imageModal) {
            elements.imageModal.classList.add('hidden');
            elements.imageModal.classList.remove('flex');
        }
    });

    // 점검 기록 폼 제출
    elements.inspectionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rtuId = elements.inspectionRtuId.value;
        if (!rtuId) {
            alert("대상 RTU를 선택해주세요.");
            return;
        }

        const formData = new FormData(elements.inspectionForm);
        const inspectionData = {
            rtuId: rtuId,
            inspectionDate: formData.get('inspectionDate') || formatTimestamp(Date.now()),
            inspector: formData.get('inspector') || '',
            result: formData.get('result') || '정상',
            notes: formData.get('notes') || '',
            // 부품 점검 상태
            check1: formData.get('check1') || '정상',
            check2: formData.get('check2') || '정상',
            check3: formData.get('check3') || '양호',
            check4: formData.get('check4') || '정상',
            check5: formData.get('check5') || '양호',
            check6: formData.get('check6') || '정상',
            check7: formData.get('check7') || '정상',
            check8: formData.get('check8') || '정상',
            // 운전 상태 측정
            comp1Hp: formData.get('comp1Hp') || '',
            comp1Lp: formData.get('comp1Lp') || '',
            comp1Amp: formData.get('comp1Amp') || '',
            comp2Hp: formData.get('comp2Hp') || '',
            comp2Lp: formData.get('comp2Lp') || '',
            comp2Amp: formData.get('comp2Amp') || '',
            // 온도 측정
            superheat: formData.get('superheat') || '',
            subcool: formData.get('subcool') || '',
        };
        
        const success = await saveToFirebase('inspection', inspectionData);
        if (success) {
            alert('점검 기록이 성공적으로 등록되었습니다.');
            elements.inspectionForm.reset();
            // RTU 목록 Select box는 유지
            elements.inspectionRtuId.value = rtuId; 
            await loadFromFirebase();
            renderInspectionList(1);
            updateDashboard();
        } else {
            alert('점검 기록 등록에 실패했습니다.');
        }
    });

    // 수리 기록 폼 제출
    elements.repairForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rtuId = elements.repairRtuId.value;
        if (!rtuId) {
            alert("대상 RTU를 선택해주세요.");
            return;
        }

        const formData = new FormData(elements.repairForm);
        const repairData = {
            rtuId: rtuId,
            repairDate: formData.get('repairDate') || formatTimestamp(Date.now()),
            engineer: formData.get('engineer') || '',
            status: formData.get('status') || '요청',
            issue: formData.get('issue') || '',
        };
        
        const success = await saveToFirebase('repair', repairData);
        if (success) {
            alert('수리 기록이 성공적으로 등록되었습니다.');
            elements.repairForm.reset();
            // RTU 목록 Select box는 유지
            elements.repairRtuId.value = rtuId;
            await loadFromFirebase();
            renderRepairList(1);
            updateDashboard();
        } else {
            alert('수리 기록 등록에 실패했습니다.');
        }
    });

    // CSV 다운로드 이벤트
    elements.downloadDataBtn.addEventListener('click', downloadData);

    // CSV 업로드 이벤트
    elements.csvUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            if (confirm(`총 ${files.length} 개의 CSV 파일을 업로드하여 기존 데이터를 갱신하거나 새로 추가하시겠습니까? (파일 내용의 "ID"가 일치하면 갱신됩니다)`)) {
                uploadCsvData(files).finally(() => {
                    // 파일 선택 초기화 (같은 파일을 다시 선택할 수 있도록)
                    e.target.value = ''; 
                });
            } else {
                e.target.value = ''; 
            }
        }
    });
    
    // 보고서 요약 클릭 이벤트 리스너
    elements.reportRtuSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('rtu');
    });
    elements.reportInspectionSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('inspection');
        window.scrollTo(0, 0); // 페이지 최상단으로 스크롤 이동
    });
    elements.reportRepairSummary.addEventListener('click', () => {
        elements.reportDetailView.classList.remove('hidden');
        renderReportDetail('repair');
        window.scrollTo(0, 0); // 페이지 최상단으로 스크롤 이동
    });
    
    // 보고서 상세 보기에서 목록으로 돌아가기 버튼
    elements.reportBackBtn.addEventListener('click', () => {
        elements.reportDetailView.classList.add('hidden');
    });
    
    // 점검 기록 상세 보기 기능 (간단한 모달) - 여기서는 상세 데이터를 바로 보여주는 대신 alert로 대체합니다.
    elements.inspectionListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-inspection-detail-btn')) {
            const inspectionId = e.target.dataset.inspectionId;
            const item = inspectionList.find(i => i.id === inspectionId);
            if (!item) return;

            let detailText = `RTU ID: ${item.rtuId}\n점검 날짜: ${item.inspectionDate}\n점검자: ${item.inspector}\n최종 결과: ${item.result}\n\n`;
            detailText += `--- 부품 점검 상태 ---\n`;
            detailText += `1. 필터: ${item.check1 || '-'}\n`;
            detailText += `2. 콘텍터: ${item.check2 || '-'}\n`;
            detailText += `3. 콘덴싱 코일: ${item.check3 || '-'}\n`;
            detailText += `4. 송풍 모터: ${item.check4 || '-'}\n`;
            detailText += `5. 증발기 코일: ${item.check5 || '-'}\n`;
            detailText += `6. 고압 센서: ${item.check6 || '-'}\n`;
            detailText += `7. 저압 센서: ${item.check7 || '-'}\n`;
            detailText += `8. 캐패시터: ${item.check8 || '-'}\n\n`;
            detailText += `--- 운전 상태/온도 ---\n`;
            detailText += `Comp1 H/L/A: ${item.comp1Hp || '-'} / ${item.comp1Lp || '-'} / ${item.comp1Amp || '-'} \n`;
            detailText += `Comp2 H/L/A: ${item.comp2Hp || '-'} / ${item.comp2Lp || '-'} / ${item.comp2Amp || '-'} \n`;
            detailText += `과열도/과냉도: ${item.superheat || '-'}℉ / ${item.subcool || '-'}℉\n\n`;
            detailText += `--- 특이사항/조치 내용 ---\n${item.notes || '없음'}`;

            alert(detailText);
        }
    });

    /* ==================== 초기화 ==================== */

    // 모든 리스트를 렌더링하고 대시보드를 업데이트합니다.
    loadFromFirebase().then(() => {
      renderRtuList(rtuCurrentPage);
      renderInspectionList(inspectionCurrentPage);
      renderRepairList(repairCurrentPage);
      populateRtuSelects();
      updateDashboard();
      
      // 시작 시 RTU 등록 모드로 설정
      setRtuFormMode('new');

    });
  </script>
</body>
</html>